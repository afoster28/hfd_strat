<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Adam Foster, Maciej Staniszewski" />

<meta name="date" content="2024-01-20" />

<title>Quantitative Strategies on High Frequency Data - Project</title>

<script src="QSHFD_Foster_Staniszewski_Final_files/header-attrs-2.22/header-attrs.js"></script>
<script src="QSHFD_Foster_Staniszewski_Final_files/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="QSHFD_Foster_Staniszewski_Final_files/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="QSHFD_Foster_Staniszewski_Final_files/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="QSHFD_Foster_Staniszewski_Final_files/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="QSHFD_Foster_Staniszewski_Final_files/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="QSHFD_Foster_Staniszewski_Final_files/jqueryui-1.13.2/jquery-ui.min.js"></script>
<link href="QSHFD_Foster_Staniszewski_Final_files/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="QSHFD_Foster_Staniszewski_Final_files/tocify-1.9.1/jquery.tocify.js"></script>
<script src="QSHFD_Foster_Staniszewski_Final_files/navigation-1.1/tabsets.js"></script>
<script src="QSHFD_Foster_Staniszewski_Final_files/navigation-1.1/codefolding.js"></script>
<script src="QSHFD_Foster_Staniszewski_Final_files/navigation-1.1/sourceembed.js"></script>
<link href="QSHFD_Foster_Staniszewski_Final_files/pagedtable-1.1/css/pagedtable.css" rel="stylesheet" />
<script src="QSHFD_Foster_Staniszewski_Final_files/pagedtable-1.1/js/pagedtable.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>



<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; } /* Alert */
code span.an { color: #008000; } /* Annotation */
code span.at { } /* Attribute */
code span.bu { } /* BuiltIn */
code span.cf { color: #0000ff; } /* ControlFlow */
code span.ch { color: #008080; } /* Char */
code span.cn { } /* Constant */
code span.co { color: #008000; } /* Comment */
code span.cv { color: #008000; } /* CommentVar */
code span.do { color: #008000; } /* Documentation */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.im { } /* Import */
code span.in { color: #008000; } /* Information */
code span.kw { color: #0000ff; } /* Keyword */
code span.op { } /* Operator */
code span.ot { color: #ff4000; } /* Other */
code span.pp { color: #ff4000; } /* Preprocessor */
code span.sc { color: #008080; } /* SpecialChar */
code span.ss { color: #008080; } /* SpecialString */
code span.st { color: #008080; } /* String */
code span.va { } /* Variable */
code span.vs { color: #008080; } /* VerbatimString */
code span.wa { color: #008000; font-weight: bold; } /* Warning */

.sourceCode .row {
  width: 100%;
}
.sourceCode {
  overflow-x: auto;
}
.code-folding-btn {
  margin-right: -30px;
}
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>


<style type="text/css">
#rmd-source-code {
  display: none;
}
</style>





<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>



<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div id="header">

<div class="btn-group pull-right float-right">
<button type="button" class="btn btn-default btn-xs btn-secondary btn-sm dropdown-toggle" data-toggle="dropdown" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu dropdown-menu-right" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
<li role="separator" class="divider"></li>
<li><a id="rmd-download-source" href="#">Download Rmd</a></li>
</ul>
</div>



<h1 class="title toc-ignore">Quantitative Strategies on High Frequency
Data - Project</h1>
<h4 class="author">Adam Foster, Maciej Staniszewski</h4>
<h4 class="date">2024-01-20</h4>

</div>


<style type="text/css">
body {
  font-family: 'Arial', sans-serif;
  color: #333333; /* Dark grey for text */
}

h1, h2 {
  font-weight: bold;
}

h1, h2, h3, h4, h5, h6 {
  color: #00703C; /* Mint green for headers */
}

a {
  color: #00703C; /* Mint green for links */
}

pre code.r {
  background-color: #f7f7f7 /* Light grey for code block background */
  padding: 5px; /* Add some padding for better readability */
  border-radius: 5px; /* Add rounded corners */
}

blockquote {
  background: #f9f9f9;
  border-left: 10px solid #ccc;
  margin: 1.5em 10px;
  padding: 0.5em 10px;
  quotes: "\201C""\201D""\2018""\2019";
}

blockquote:before {
  color: #ccc;
  content: open-quote;
  font-size: 4em;
  line-height: 0.1em;
  margin-right: 0.25em;
  vertical-align: -0.4em;
}

blockquote p {
  display: inline;
  font-style: italic; /* Make the quoted text italic */
}

.source {
  float: right;
  font-size: 80%;
  font-style: italic;
  color: #888888;
}
</style>
<div id="approach" class="section level1">
<h1>Approach</h1>
<p>For the <code>Quantitative Strategies on High Frequency Data</code>
project, two sets of strategies were developed for two groups of
assets.</p>
<p>For group 1, the asset considered was the futures contract on the
S&amp;P500 index. Multiple combinations within single EMA and crossover
EMA strategies were tested before arriving at the best variant based on
in-sample data across all available quarters.</p>
<p>For group 2, futures contracts on gold and silver were considered.
Multiple combinations within level-based and return-based volatility
breakout pair trading strategies were tested. Similarly, the best
variant was chosen based on in-sample data across all available
quarters.</p>
<p>More details are provided in subsequent sections.</p>
<p>This report contains sufficient R code to effectively run all the
models and analysis, ensuring full reproducibility of results.</p>
</div>
<div id="input" class="section level1">
<h1>Input</h1>
<p>The working directory and quarters were defined. All quarterly data
had to be stored in a subfolder called ‘data’ within the working
directory.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="co">#setwd(&quot;C:\\Users\\afost\\Documents\\UW\\Y2\\S1\\Quantitative Strategies High Frequency Data\\hfd_strat&quot;)</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>selected_quarters <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;2021_Q1&quot;</span>, <span class="st">&quot;2021_Q3&quot;</span>, <span class="st">&quot;2021_Q4&quot;</span>, </span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a>  <span class="st">&quot;2022_Q2&quot;</span>, <span class="st">&quot;2022_Q4&quot;</span>, </span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a>  <span class="st">&quot;2023_Q1&quot;</span>, <span class="st">&quot;2023_Q2&quot;</span>)</span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a>OOS_quarters <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;2021_Q2&quot;</span>,<span class="st">&quot;2022_Q1&quot;</span>,<span class="st">&quot;2022_Q3&quot;</span>,<span class="st">&quot;2023_Q3&quot;</span>,<span class="st">&quot;2023_Q4&quot;</span>)</span></code></pre></div>
</div>
<div id="setup" class="section level1">
<h1>Setup</h1>
<p>Libraries, functions were loaded and system settings were set.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="fu">library</span>(xts)</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="fu">library</span>(chron)</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="fu">library</span>(TTR)</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a><span class="fu">library</span>(tseries)</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a><span class="fu">library</span>(quantmod)</span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a><span class="fu">library</span>(caTools)</span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a><span class="fu">library</span>(lattice)</span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a><span class="fu">library</span>(grDevices)</span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb2-14"><a href="#cb2-14" tabindex="-1"></a><span class="fu">library</span>(cowplot)</span>
<span id="cb2-15"><a href="#cb2-15" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" tabindex="-1"></a><span class="fu">options</span>(<span class="at">scipen=</span><span class="dv">999</span>)</span>
<span id="cb2-17"><a href="#cb2-17" tabindex="-1"></a><span class="fu">Sys.setlocale</span>(<span class="st">&quot;LC_TIME&quot;</span>, <span class="st">&quot;English&quot;</span>)</span></code></pre></div>
<pre><code>## [1] &quot;English_United States.1252&quot;</code></pre>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="fu">Sys.setenv</span>(<span class="at">TZ =</span> <span class="st">&#39;America/New_York&#39;</span>)</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="fu">par</span>(<span class="at">oma=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">2</span>,<span class="dv">0</span>)) <span class="co"># allocate space for plot margins</span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>mySR <span class="ot">&lt;-</span> <span class="cf">function</span>(x, scale) {</span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>  <span class="fu">sqrt</span>(scale) <span class="sc">*</span> <span class="fu">mean</span>(<span class="fu">coredata</span>(x), <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> </span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a>    <span class="fu">sd</span>(<span class="fu">coredata</span>(x), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a>} </span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a>myCalmarRatio <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="co"># x = series of returns</span></span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a>                          <span class="co"># scale parameter = Nt</span></span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a>                          scale) {</span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a>  scale <span class="sc">*</span> <span class="fu">mean</span>(<span class="fu">coredata</span>(x), <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> </span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a>    <span class="fu">maxdrawdown</span>(<span class="fu">cumsum</span>(x))<span class="sc">$</span>maxdrawdown</span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a>  </span>
<span id="cb4-16"><a href="#cb4-16" tabindex="-1"></a>}</span>
<span id="cb4-17"><a href="#cb4-17" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" tabindex="-1"></a>positionVB_new <span class="ot">&lt;-</span> <span class="cf">function</span>(signal, </span>
<span id="cb4-19"><a href="#cb4-19" tabindex="-1"></a>                           lower, </span>
<span id="cb4-20"><a href="#cb4-20" tabindex="-1"></a>                           upper, </span>
<span id="cb4-21"><a href="#cb4-21" tabindex="-1"></a>                           pos_flat, </span>
<span id="cb4-22"><a href="#cb4-22" tabindex="-1"></a>                           strategy)</span>
<span id="cb4-23"><a href="#cb4-23" tabindex="-1"></a>{</span>
<span id="cb4-24"><a href="#cb4-24" tabindex="-1"></a>  <span class="fu">require</span>(xts)</span>
<span id="cb4-25"><a href="#cb4-25" tabindex="-1"></a>  </span>
<span id="cb4-26"><a href="#cb4-26" tabindex="-1"></a>  <span class="co"># lets check thevalue of the strategy parameter</span></span>
<span id="cb4-27"><a href="#cb4-27" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span> strategy <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;mom&quot;</span>, <span class="st">&quot;mr&quot;</span>))</span>
<span id="cb4-28"><a href="#cb4-28" tabindex="-1"></a>  {  <span class="fu">print</span>(<span class="st">&quot;Strategy parameter incorrect. Please use &#39;mom&#39; or &#39;mr&#39;!&quot;</span>)</span>
<span id="cb4-29"><a href="#cb4-29" tabindex="-1"></a>    stop</span>
<span id="cb4-30"><a href="#cb4-30" tabindex="-1"></a>  }</span>
<span id="cb4-31"><a href="#cb4-31" tabindex="-1"></a>  </span>
<span id="cb4-32"><a href="#cb4-32" tabindex="-1"></a>  <span class="co"># convert inputs to simpler objects  </span></span>
<span id="cb4-33"><a href="#cb4-33" tabindex="-1"></a>  signal <span class="ot">=</span> <span class="fu">coredata</span>(signal)</span>
<span id="cb4-34"><a href="#cb4-34" tabindex="-1"></a>  lower <span class="ot">=</span> <span class="fu">coredata</span>(lower)</span>
<span id="cb4-35"><a href="#cb4-35" tabindex="-1"></a>  upper <span class="ot">=</span> <span class="fu">coredata</span>(upper)</span>
<span id="cb4-36"><a href="#cb4-36" tabindex="-1"></a>  pos_flat <span class="ot">=</span> <span class="fu">coredata</span>(pos_flat)</span>
<span id="cb4-37"><a href="#cb4-37" tabindex="-1"></a>  </span>
<span id="cb4-38"><a href="#cb4-38" tabindex="-1"></a>  </span>
<span id="cb4-39"><a href="#cb4-39" tabindex="-1"></a>  <span class="co"># lets first create a vector of 0s</span></span>
<span id="cb4-40"><a href="#cb4-40" tabindex="-1"></a>  position <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">length</span>(signal))</span>
<span id="cb4-41"><a href="#cb4-41" tabindex="-1"></a>  </span>
<span id="cb4-42"><a href="#cb4-42" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="fu">length</span>(signal))</span>
<span id="cb4-43"><a href="#cb4-43" tabindex="-1"></a>  {</span>
<span id="cb4-44"><a href="#cb4-44" tabindex="-1"></a>    <span class="cf">if</span> ( pos_flat[i] <span class="sc">==</span> <span class="dv">1</span> ) position[i] <span class="ot">&lt;-</span> <span class="dv">0</span> </span>
<span id="cb4-45"><a href="#cb4-45" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb4-46"><a href="#cb4-46" tabindex="-1"></a>    { <span class="co"># check if values are nonmissing (otherwise calculations not possible)</span></span>
<span id="cb4-47"><a href="#cb4-47" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(signal[i<span class="dv">-1</span>]) <span class="sc">&amp;</span> </span>
<span id="cb4-48"><a href="#cb4-48" tabindex="-1"></a>          <span class="sc">!</span><span class="fu">is.na</span>(upper[i<span class="dv">-1</span>]) <span class="sc">&amp;</span> </span>
<span id="cb4-49"><a href="#cb4-49" tabindex="-1"></a>          <span class="sc">!</span><span class="fu">is.na</span>(lower[i<span class="dv">-1</span>]))</span>
<span id="cb4-50"><a href="#cb4-50" tabindex="-1"></a>      { </span>
<span id="cb4-51"><a href="#cb4-51" tabindex="-1"></a>        <span class="co"># what if previous position was 0</span></span>
<span id="cb4-52"><a href="#cb4-52" tabindex="-1"></a>        <span class="cf">if</span> (position[i<span class="dv">-1</span>] <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb4-53"><a href="#cb4-53" tabindex="-1"></a>          <span class="cf">if</span> (signal[i<span class="dv">-1</span>] <span class="sc">&gt;</span> upper[i<span class="dv">-1</span>]){position[i] <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">1</span>}</span>
<span id="cb4-54"><a href="#cb4-54" tabindex="-1"></a>          <span class="cf">if</span> (signal[i<span class="dv">-1</span>] <span class="sc">&lt;</span> lower[i<span class="dv">-1</span>]){position[i] <span class="ot">&lt;-</span> <span class="dv">1</span>}</span>
<span id="cb4-55"><a href="#cb4-55" tabindex="-1"></a>        } <span class="cf">else</span> <span class="cf">if</span> (position[i<span class="dv">-1</span>]<span class="sc">==-</span><span class="dv">1</span>){</span>
<span id="cb4-56"><a href="#cb4-56" tabindex="-1"></a>          <span class="co"># what if previous position was -1</span></span>
<span id="cb4-57"><a href="#cb4-57" tabindex="-1"></a>          <span class="cf">if</span> (signal[i<span class="dv">-1</span>] <span class="sc">&gt;</span> lower[i<span class="dv">-1</span>]){position[i] <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">1</span>}</span>
<span id="cb4-58"><a href="#cb4-58" tabindex="-1"></a>          <span class="cf">if</span> (signal[i<span class="dv">-1</span>] <span class="sc">&lt;</span> lower[i<span class="dv">-1</span>]){position[i] <span class="ot">&lt;-</span> <span class="dv">1</span>}</span>
<span id="cb4-59"><a href="#cb4-59" tabindex="-1"></a>        } <span class="cf">else</span> <span class="cf">if</span> (position[i<span class="dv">-1</span>]<span class="sc">==</span><span class="dv">1</span>){</span>
<span id="cb4-60"><a href="#cb4-60" tabindex="-1"></a>          <span class="co"># what if previous position was 1</span></span>
<span id="cb4-61"><a href="#cb4-61" tabindex="-1"></a>          <span class="cf">if</span> (signal[i<span class="dv">-1</span>] <span class="sc">&lt;</span> upper[i<span class="dv">-1</span>]){position[i] <span class="ot">&lt;-</span> <span class="dv">1</span>}</span>
<span id="cb4-62"><a href="#cb4-62" tabindex="-1"></a>          <span class="cf">if</span> (signal[i<span class="dv">-1</span>] <span class="sc">&gt;</span> upper[i<span class="dv">-1</span>]){position[i] <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">1</span>}</span>
<span id="cb4-63"><a href="#cb4-63" tabindex="-1"></a>        }</span>
<span id="cb4-64"><a href="#cb4-64" tabindex="-1"></a>      } <span class="cf">else</span> position[i] <span class="ot">&lt;-</span> position[i<span class="dv">-1</span>]</span>
<span id="cb4-65"><a href="#cb4-65" tabindex="-1"></a>      <span class="co"># if anything is missing, keep previous position</span></span>
<span id="cb4-66"><a href="#cb4-66" tabindex="-1"></a>    }</span>
<span id="cb4-67"><a href="#cb4-67" tabindex="-1"></a>  }</span>
<span id="cb4-68"><a href="#cb4-68" tabindex="-1"></a>  <span class="co"># reverse the position if we use a momentum (&quot;mom&quot;) strategy</span></span>
<span id="cb4-69"><a href="#cb4-69" tabindex="-1"></a>  <span class="cf">if</span>(strategy <span class="sc">==</span> <span class="st">&quot;mom&quot;</span>) position <span class="ot">&lt;-</span> (<span class="sc">-</span>position)</span>
<span id="cb4-70"><a href="#cb4-70" tabindex="-1"></a>  </span>
<span id="cb4-71"><a href="#cb4-71" tabindex="-1"></a>  <span class="co"># return() function clearly indicates </span></span>
<span id="cb4-72"><a href="#cb4-72" tabindex="-1"></a>  <span class="co"># what the function should return</span></span>
<span id="cb4-73"><a href="#cb4-73" tabindex="-1"></a>  <span class="fu">return</span>(position)</span>
<span id="cb4-74"><a href="#cb4-74" tabindex="-1"></a>}</span>
<span id="cb4-75"><a href="#cb4-75" tabindex="-1"></a></span>
<span id="cb4-76"><a href="#cb4-76" tabindex="-1"></a>plotHeatmap <span class="ot">&lt;-</span> <span class="cf">function</span>(data_plot, <span class="co"># dataset (data.frame) with calculations</span></span>
<span id="cb4-77"><a href="#cb4-77" tabindex="-1"></a>                        col_vlabels, <span class="co"># column name with the labels for a vertical axis (string)</span></span>
<span id="cb4-78"><a href="#cb4-78" tabindex="-1"></a>                        col_hlabels, <span class="co"># column name with the labels for a horizontal axis (string)</span></span>
<span id="cb4-79"><a href="#cb4-79" tabindex="-1"></a>                        col_variable, <span class="co"># column name with the variable to show (string)</span></span>
<span id="cb4-80"><a href="#cb4-80" tabindex="-1"></a>                        main,      <span class="co"># title</span></span>
<span id="cb4-81"><a href="#cb4-81" tabindex="-1"></a>                        <span class="at">label_size =</span> <span class="dv">6</span>, <span class="co"># size of labels</span></span>
<span id="cb4-82"><a href="#cb4-82" tabindex="-1"></a>                        <span class="at">save_graph =</span> <span class="cn">FALSE</span>, <span class="co"># whether to save the graph</span></span>
<span id="cb4-83"><a href="#cb4-83" tabindex="-1"></a>                        <span class="at">width =</span> <span class="dv">12</span>,</span>
<span id="cb4-84"><a href="#cb4-84" tabindex="-1"></a>                        <span class="at">height =</span> <span class="dv">8</span>,</span>
<span id="cb4-85"><a href="#cb4-85" tabindex="-1"></a>                        <span class="at">file_name =</span> <span class="cn">NULL</span>) { <span class="co"># filename for saving</span></span>
<span id="cb4-86"><a href="#cb4-86" tabindex="-1"></a>  </span>
<span id="cb4-87"><a href="#cb4-87" tabindex="-1"></a>  <span class="fu">require</span>(ggplot2)</span>
<span id="cb4-88"><a href="#cb4-88" tabindex="-1"></a>  <span class="fu">require</span>(dplyr)</span>
<span id="cb4-89"><a href="#cb4-89" tabindex="-1"></a>  </span>
<span id="cb4-90"><a href="#cb4-90" tabindex="-1"></a>  </span>
<span id="cb4-91"><a href="#cb4-91" tabindex="-1"></a>  data_plot<span class="sc">$</span>labels_ <span class="ot">&lt;-</span> <span class="fu">round</span>(data_plot[, col_variable], <span class="dv">2</span>)</span>
<span id="cb4-92"><a href="#cb4-92" tabindex="-1"></a>  data_plot[, col_hlabels] <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(data_plot[, col_hlabels])</span>
<span id="cb4-93"><a href="#cb4-93" tabindex="-1"></a>  data_plot[, col_vlabels] <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(data_plot[, col_vlabels])</span>
<span id="cb4-94"><a href="#cb4-94" tabindex="-1"></a>  </span>
<span id="cb4-95"><a href="#cb4-95" tabindex="-1"></a>  </span>
<span id="cb4-96"><a href="#cb4-96" tabindex="-1"></a>  p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(data_plot, </span>
<span id="cb4-97"><a href="#cb4-97" tabindex="-1"></a>               <span class="fu">aes_string</span>(<span class="at">x =</span> col_hlabels, </span>
<span id="cb4-98"><a href="#cb4-98" tabindex="-1"></a>                          <span class="at">y =</span> col_vlabels)) <span class="sc">+</span></span>
<span id="cb4-99"><a href="#cb4-99" tabindex="-1"></a>    <span class="fu">geom_raster</span>(<span class="fu">aes_string</span>(<span class="at">fill =</span> col_variable)) <span class="sc">+</span></span>
<span id="cb4-100"><a href="#cb4-100" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb4-101"><a href="#cb4-101" tabindex="-1"></a>    <span class="fu">xlab</span>(col_hlabels) <span class="sc">+</span></span>
<span id="cb4-102"><a href="#cb4-102" tabindex="-1"></a>    <span class="fu">ylab</span>(col_vlabels) <span class="sc">+</span></span>
<span id="cb4-103"><a href="#cb4-103" tabindex="-1"></a>    <span class="fu">ggtitle</span>(main) <span class="sc">+</span></span>
<span id="cb4-104"><a href="#cb4-104" tabindex="-1"></a>    <span class="fu">scale_fill_gradient2</span>(<span class="at">low =</span> <span class="st">&quot;red&quot;</span>,</span>
<span id="cb4-105"><a href="#cb4-105" tabindex="-1"></a>                         <span class="at">high =</span> <span class="st">&quot;darkgreen&quot;</span>,</span>
<span id="cb4-106"><a href="#cb4-106" tabindex="-1"></a>                         <span class="at">mid =</span> <span class="st">&quot;white&quot;</span>,</span>
<span id="cb4-107"><a href="#cb4-107" tabindex="-1"></a>                         <span class="at">midpoint =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb4-108"><a href="#cb4-108" tabindex="-1"></a>    <span class="fu">geom_label</span>(<span class="fu">aes_string</span>(<span class="at">label =</span> <span class="st">&quot;labels_&quot;</span>),</span>
<span id="cb4-109"><a href="#cb4-109" tabindex="-1"></a>               <span class="at">size =</span> label_size) <span class="sc">+</span></span>
<span id="cb4-110"><a href="#cb4-110" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span>, </span>
<span id="cb4-111"><a href="#cb4-111" tabindex="-1"></a>          <span class="at">legend.key.width =</span> <span class="fu">unit</span>(<span class="dv">2</span>, <span class="st">&quot;cm&quot;</span>))</span>
<span id="cb4-112"><a href="#cb4-112" tabindex="-1"></a>  </span>
<span id="cb4-113"><a href="#cb4-113" tabindex="-1"></a>  <span class="cf">if</span>(save_graph) { </span>
<span id="cb4-114"><a href="#cb4-114" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.null</span>(file_name)) <span class="fu">stop</span>(<span class="st">&quot;Please provide the file_name= argument&quot;</span>) <span class="cf">else</span></span>
<span id="cb4-115"><a href="#cb4-115" tabindex="-1"></a>      <span class="fu">ggsave</span>(<span class="at">filename =</span> file_name, </span>
<span id="cb4-116"><a href="#cb4-116" tabindex="-1"></a>             <span class="at">plot =</span> p1, </span>
<span id="cb4-117"><a href="#cb4-117" tabindex="-1"></a>             <span class="at">units =</span> <span class="st">&quot;in&quot;</span>,</span>
<span id="cb4-118"><a href="#cb4-118" tabindex="-1"></a>             <span class="at">width =</span> width, </span>
<span id="cb4-119"><a href="#cb4-119" tabindex="-1"></a>             <span class="at">height =</span> height)</span>
<span id="cb4-120"><a href="#cb4-120" tabindex="-1"></a>  }</span>
<span id="cb4-121"><a href="#cb4-121" tabindex="-1"></a>  </span>
<span id="cb4-122"><a href="#cb4-122" tabindex="-1"></a>  <span class="fu">return</span>(p1)</span>
<span id="cb4-123"><a href="#cb4-123" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="group-1" class="section level1">
<h1>Group 1</h1>
<p>Group 1 data was limited to the S&amp;P500 index. NA values were
inserted in the first and last 10 minutes of the trading session to
avoid trading on volatile and reactive parts of the day and to focus on
intraday trading.</p>
<p>Exponential Moving Average (EMA) was the metric of choice in the
algorithm. The time series is univariate and EMA places greater emphasis
on recent prices than SMA. Both single EMA and crossover EMA were tested
for entry and exit. Single EMA triggered a long position whenever price
exceeded the EMA and short position otherwise; crossover EMA triggered a
long position whenever fast EMA exceeded slow EMA and short position
otherwise. This strategy was termed the momentum strategy being in the
market. A corresponding set of results was generated for the mean
reversion strategy.</p>
<p>In order to determine the optimal parameters for the models, multiple
combinations of EMA time horizons were tested: 10-80 days for single EMA
and every combination of 10-80 days constrained by fast always having to
be fewer days than slow for crossover EMA.</p>
<p>All positions were exited in the first 25 and last 20 minutes of the
trading session and in between sessions. Any remaining missing value was
populated with the previous value for completeness.</p>
<p>Gross P&amp;L (accounting for point values), net P&amp;L (reflecting
transaction costs) and number of trades were calculated. The data was
then aggregated to daily level and the following metrics were
calculated: Sharpe ratio, Calmar ratio, average number of trades,
cumulative sum of gross P&amp;L, cumulative sum of net P&amp;L and a
final test statistic.</p>
<p>The entire process was repeated for all in-sample quarters.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>heatmap_list_single <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>heatmap_list_cross <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>heatmap_list_single_mr <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>heatmap_list_cross_mr <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>sensitivities_single <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a>sensitivities_cross <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a>sensitivities_single_mr <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a>sensitivities_cross_mr <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a><span class="cf">for</span> (selected_quarter <span class="cf">in</span> selected_quarters) {</span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a>  </span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a>  <span class="fu">message</span>(selected_quarter)</span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a>  </span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a>  filename_ <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;data/data1_&quot;</span>, selected_quarter, <span class="st">&quot;.RData&quot;</span>)</span>
<span id="cb5-15"><a href="#cb5-15" tabindex="-1"></a>  <span class="fu">load</span>(filename_)</span>
<span id="cb5-16"><a href="#cb5-16" tabindex="-1"></a>  </span>
<span id="cb5-17"><a href="#cb5-17" tabindex="-1"></a>  <span class="co"># create index of times for this quarter</span></span>
<span id="cb5-18"><a href="#cb5-18" tabindex="-1"></a>  data.group1 <span class="ot">&lt;-</span> <span class="fu">get</span>(<span class="fu">paste0</span>(<span class="st">&quot;data1_&quot;</span>, selected_quarter))</span>
<span id="cb5-19"><a href="#cb5-19" tabindex="-1"></a>  times_ <span class="ot">&lt;-</span> <span class="fu">substr</span>(<span class="fu">index</span>(data.group1), <span class="dv">12</span>, <span class="dv">19</span>)</span>
<span id="cb5-20"><a href="#cb5-20" tabindex="-1"></a>  </span>
<span id="cb5-21"><a href="#cb5-21" tabindex="-1"></a>  <span class="co"># Keep S&amp;P500</span></span>
<span id="cb5-22"><a href="#cb5-22" tabindex="-1"></a>  data.group1 <span class="ot">&lt;-</span> data.group1[, <span class="sc">!</span><span class="fu">colnames</span>(data.group1) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;NQ&quot;</span>)]</span>
<span id="cb5-23"><a href="#cb5-23" tabindex="-1"></a>  </span>
<span id="cb5-24"><a href="#cb5-24" tabindex="-1"></a>  <span class="co"># the following common assumptions were defined:</span></span>
<span id="cb5-25"><a href="#cb5-25" tabindex="-1"></a>  <span class="co"># 1.  do not use in calculations the data from the first </span></span>
<span id="cb5-26"><a href="#cb5-26" tabindex="-1"></a>  <span class="co"># and last 10 minutes of the session (9:31--9:40 and 15:51--16:00)</span></span>
<span id="cb5-27"><a href="#cb5-27" tabindex="-1"></a>  <span class="co"># – put missing values there,</span></span>
<span id="cb5-28"><a href="#cb5-28" tabindex="-1"></a>  </span>
<span id="cb5-29"><a href="#cb5-29" tabindex="-1"></a>  <span class="co"># lets put missing values for these periods</span></span>
<span id="cb5-30"><a href="#cb5-30" tabindex="-1"></a>  data.group1[<span class="st">&quot;T09:31/T09:40&quot;</span>,] <span class="ot">&lt;-</span> <span class="cn">NA</span> </span>
<span id="cb5-31"><a href="#cb5-31" tabindex="-1"></a>  data.group1[<span class="st">&quot;T15:51/T16:00&quot;</span>,] <span class="ot">&lt;-</span><span class="cn">NA</span></span>
<span id="cb5-32"><a href="#cb5-32" tabindex="-1"></a>  </span>
<span id="cb5-33"><a href="#cb5-33" tabindex="-1"></a>  myTheme <span class="ot">&lt;-</span> <span class="fu">chart_theme</span>()</span>
<span id="cb5-34"><a href="#cb5-34" tabindex="-1"></a>  myTheme<span class="sc">$</span>col<span class="sc">$</span>line.col <span class="ot">&lt;-</span> <span class="st">&quot;darkblue&quot;</span></span>
<span id="cb5-35"><a href="#cb5-35" tabindex="-1"></a>  <span class="fu">layout</span>(<span class="fu">matrix</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb5-36"><a href="#cb5-36" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">chart_Series</span>(data.group1<span class="sc">$</span>SP, <span class="at">theme =</span> myTheme))</span>
<span id="cb5-37"><a href="#cb5-37" tabindex="-1"></a>  <span class="fu">layout</span>(<span class="fu">matrix</span>(<span class="dv">1</span>))</span>
<span id="cb5-38"><a href="#cb5-38" tabindex="-1"></a></span>
<span id="cb5-39"><a href="#cb5-39" tabindex="-1"></a></span>
<span id="cb5-40"><a href="#cb5-40" tabindex="-1"></a>  <span class="co"># Momentum</span></span>
<span id="cb5-41"><a href="#cb5-41" tabindex="-1"></a>  </span>
<span id="cb5-42"><a href="#cb5-42" tabindex="-1"></a>  <span class="co"># Single EMA</span></span>
<span id="cb5-43"><a href="#cb5-43" tabindex="-1"></a>  </span>
<span id="cb5-44"><a href="#cb5-44" tabindex="-1"></a>  EMA_pairs <span class="ot">=</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">10</span>), <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">20</span>), <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">30</span>), <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">40</span>), <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">50</span>), <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">60</span>), <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">70</span>), <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">80</span>))</span>
<span id="cb5-45"><a href="#cb5-45" tabindex="-1"></a>  data.group1a <span class="ot">&lt;-</span> data.group1</span>
<span id="cb5-46"><a href="#cb5-46" tabindex="-1"></a>  </span>
<span id="cb5-47"><a href="#cb5-47" tabindex="-1"></a>  <span class="cf">for</span> (pair <span class="cf">in</span> EMA_pairs) {</span>
<span id="cb5-48"><a href="#cb5-48" tabindex="-1"></a>    <span class="co"># lets calculate EMAfast and EMAslow for SP</span></span>
<span id="cb5-49"><a href="#cb5-49" tabindex="-1"></a>    data.group1a<span class="sc">$</span>SP_EMA <span class="ot">&lt;-</span> <span class="fu">EMA</span>(<span class="fu">na.locf</span>(data.group1a<span class="sc">$</span>SP), pair[<span class="dv">2</span>])</span>
<span id="cb5-50"><a href="#cb5-50" tabindex="-1"></a>    </span>
<span id="cb5-51"><a href="#cb5-51" tabindex="-1"></a>    <span class="co"># put missing value whenever the original price is missing</span></span>
<span id="cb5-52"><a href="#cb5-52" tabindex="-1"></a>    data.group1a<span class="sc">$</span>SP_EMA[<span class="fu">is.na</span>(data.group1a<span class="sc">$</span>SP)] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb5-53"><a href="#cb5-53" tabindex="-1"></a>    </span>
<span id="cb5-54"><a href="#cb5-54" tabindex="-1"></a>    <span class="co"># lets calculate the position for the MOMENTUM strategy</span></span>
<span id="cb5-55"><a href="#cb5-55" tabindex="-1"></a>    <span class="co"># if price(t-1) &gt; MA(t-1) =&gt; pos(t) = 1 [long]</span></span>
<span id="cb5-56"><a href="#cb5-56" tabindex="-1"></a>    <span class="co"># if price(t-1) &lt;= MA(t-1) =&gt; pos(t) = -1 [short]</span></span>
<span id="cb5-57"><a href="#cb5-57" tabindex="-1"></a>    <span class="co"># this strategy is always in the market</span></span>
<span id="cb5-58"><a href="#cb5-58" tabindex="-1"></a>    data.group1a<span class="sc">$</span>positionSP.mom <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">lag.xts</span>(data.group1a<span class="sc">$</span>SP) <span class="sc">&gt;</span></span>
<span id="cb5-59"><a href="#cb5-59" tabindex="-1"></a>                                            <span class="fu">lag.xts</span>(data.group1a<span class="sc">$</span>SP_EMA),</span>
<span id="cb5-60"><a href="#cb5-60" tabindex="-1"></a>                                          <span class="dv">1</span>, <span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb5-61"><a href="#cb5-61" tabindex="-1"></a>    </span>
<span id="cb5-62"><a href="#cb5-62" tabindex="-1"></a>    <span class="co"># lets apply the remaining assumptions</span></span>
<span id="cb5-63"><a href="#cb5-63" tabindex="-1"></a>    <span class="co"># - exit all positions 20 minutes before the session end, i.e. at 15:40</span></span>
<span id="cb5-64"><a href="#cb5-64" tabindex="-1"></a>    <span class="co"># - do not trade within the first 25 minutes of stocks quotations (until 9:55)</span></span>
<span id="cb5-65"><a href="#cb5-65" tabindex="-1"></a>    data.group1a<span class="sc">$</span>positionSP.mom[<span class="fu">times</span>(times_) <span class="sc">&lt;=</span> <span class="fu">times</span>(<span class="st">&quot;09:55:00&quot;</span>) <span class="sc">|</span> </span>
<span id="cb5-66"><a href="#cb5-66" tabindex="-1"></a>                                  <span class="fu">times</span>(times_) <span class="sc">&gt;</span> <span class="fu">times</span>(<span class="st">&quot;15:40:00&quot;</span>)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb5-67"><a href="#cb5-67" tabindex="-1"></a>    </span>
<span id="cb5-68"><a href="#cb5-68" tabindex="-1"></a>    </span>
<span id="cb5-69"><a href="#cb5-69" tabindex="-1"></a>    <span class="co"># lets also fill every missing position with the previous one</span></span>
<span id="cb5-70"><a href="#cb5-70" tabindex="-1"></a>    </span>
<span id="cb5-71"><a href="#cb5-71" tabindex="-1"></a>    data.group1a<span class="sc">$</span>positionSP.mom <span class="ot">&lt;-</span> <span class="fu">na.locf</span>(data.group1a<span class="sc">$</span>positionSP.mom, <span class="at">na.rm =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-72"><a href="#cb5-72" tabindex="-1"></a>    </span>
<span id="cb5-73"><a href="#cb5-73" tabindex="-1"></a>    <span class="co"># calculating gross pnl</span></span>
<span id="cb5-74"><a href="#cb5-74" tabindex="-1"></a>    </span>
<span id="cb5-75"><a href="#cb5-75" tabindex="-1"></a>    data.group1a<span class="sc">$</span>pnl_grossSP.mom <span class="ot">&lt;-</span> data.group1a<span class="sc">$</span>positionSP.mom <span class="sc">*</span> <span class="fu">diff.xts</span>(data.group1a<span class="sc">$</span>SP) <span class="sc">*</span> <span class="dv">50</span></span>
<span id="cb5-76"><a href="#cb5-76" tabindex="-1"></a>    </span>
<span id="cb5-77"><a href="#cb5-77" tabindex="-1"></a>    </span>
<span id="cb5-78"><a href="#cb5-78" tabindex="-1"></a>    <span class="co"># number of transactions</span></span>
<span id="cb5-79"><a href="#cb5-79" tabindex="-1"></a>    data.group1a<span class="sc">$</span>ntransSP.mom <span class="ot">&lt;-</span> <span class="fu">abs</span>(<span class="fu">diff.xts</span>(data.group1a<span class="sc">$</span>positionSP.mom))</span>
<span id="cb5-80"><a href="#cb5-80" tabindex="-1"></a>    </span>
<span id="cb5-81"><a href="#cb5-81" tabindex="-1"></a>    data.group1a<span class="sc">$</span>ntransSP.mom[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb5-82"><a href="#cb5-82" tabindex="-1"></a>    </span>
<span id="cb5-83"><a href="#cb5-83" tabindex="-1"></a>    <span class="co"># net pnl</span></span>
<span id="cb5-84"><a href="#cb5-84" tabindex="-1"></a>    data.group1a<span class="sc">$</span>pnl_netSP.mom <span class="ot">&lt;-</span> data.group1a<span class="sc">$</span>pnl_grossSP.mom  <span class="sc">-</span></span>
<span id="cb5-85"><a href="#cb5-85" tabindex="-1"></a>      data.group1a<span class="sc">$</span>ntransSP.mom <span class="sc">*</span> <span class="dv">10</span> <span class="co"># $10 per transaction</span></span>
<span id="cb5-86"><a href="#cb5-86" tabindex="-1"></a>    </span>
<span id="cb5-87"><a href="#cb5-87" tabindex="-1"></a>    <span class="co"># total for strategy</span></span>
<span id="cb5-88"><a href="#cb5-88" tabindex="-1"></a>    </span>
<span id="cb5-89"><a href="#cb5-89" tabindex="-1"></a>    data.group1a<span class="sc">$</span>pnl_gross.mom <span class="ot">&lt;-</span> data.group1a<span class="sc">$</span>pnl_grossSP.mom</span>
<span id="cb5-90"><a href="#cb5-90" tabindex="-1"></a>    data.group1a<span class="sc">$</span>pnl_net.mom <span class="ot">&lt;-</span> data.group1a<span class="sc">$</span>pnl_netSP.mom</span>
<span id="cb5-91"><a href="#cb5-91" tabindex="-1"></a>    </span>
<span id="cb5-92"><a href="#cb5-92" tabindex="-1"></a>    </span>
<span id="cb5-93"><a href="#cb5-93" tabindex="-1"></a>    <span class="co"># aggregate pnls and number of transactions to daily</span></span>
<span id="cb5-94"><a href="#cb5-94" tabindex="-1"></a>    my.endpoints <span class="ot">&lt;-</span> <span class="fu">endpoints</span>(data.group1a, <span class="st">&quot;days&quot;</span>)</span>
<span id="cb5-95"><a href="#cb5-95" tabindex="-1"></a>    </span>
<span id="cb5-96"><a href="#cb5-96" tabindex="-1"></a>    data.group1a.daily <span class="ot">&lt;-</span> <span class="fu">period.apply</span>(data.group1a[,<span class="fu">c</span>(<span class="fu">grep</span>(<span class="st">&quot;pnl&quot;</span>, <span class="fu">names</span>(data.group1a)),</span>
<span id="cb5-97"><a href="#cb5-97" tabindex="-1"></a>                                                       <span class="fu">grep</span>(<span class="st">&quot;ntrans&quot;</span>, <span class="fu">names</span>(data.group1a)))],</span>
<span id="cb5-98"><a href="#cb5-98" tabindex="-1"></a>                                       <span class="at">INDEX =</span> my.endpoints, </span>
<span id="cb5-99"><a href="#cb5-99" tabindex="-1"></a>                                       <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">colSums</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb5-100"><a href="#cb5-100" tabindex="-1"></a>    </span>
<span id="cb5-101"><a href="#cb5-101" tabindex="-1"></a>    <span class="co"># summarize the strategy for this quarter</span></span>
<span id="cb5-102"><a href="#cb5-102" tabindex="-1"></a>    </span>
<span id="cb5-103"><a href="#cb5-103" tabindex="-1"></a>    <span class="co"># SR</span></span>
<span id="cb5-104"><a href="#cb5-104" tabindex="-1"></a>    grossSR <span class="ot">=</span> <span class="fu">mySR</span>(<span class="at">x =</span> data.group1a.daily<span class="sc">$</span>pnl_gross.mom, <span class="at">scale =</span> <span class="dv">252</span>)</span>
<span id="cb5-105"><a href="#cb5-105" tabindex="-1"></a>    netSR <span class="ot">=</span> <span class="fu">mySR</span>(<span class="at">x =</span> data.group1a.daily<span class="sc">$</span>pnl_net.mom, <span class="at">scale =</span> <span class="dv">252</span>)</span>
<span id="cb5-106"><a href="#cb5-106" tabindex="-1"></a>    <span class="co"># CR</span></span>
<span id="cb5-107"><a href="#cb5-107" tabindex="-1"></a>    grossCR <span class="ot">=</span> <span class="fu">myCalmarRatio</span>(<span class="at">x =</span> data.group1a.daily<span class="sc">$</span>pnl_gross.mom, <span class="at">scale =</span> <span class="dv">252</span>)</span>
<span id="cb5-108"><a href="#cb5-108" tabindex="-1"></a>    netCR <span class="ot">=</span> <span class="fu">myCalmarRatio</span>(<span class="at">x =</span> data.group1a.daily<span class="sc">$</span>pnl_net.mom, <span class="at">scale =</span> <span class="dv">252</span>)</span>
<span id="cb5-109"><a href="#cb5-109" tabindex="-1"></a>    </span>
<span id="cb5-110"><a href="#cb5-110" tabindex="-1"></a>    <span class="co"># average number of transactions</span></span>
<span id="cb5-111"><a href="#cb5-111" tabindex="-1"></a>    av.daily.ntrades <span class="ot">=</span> <span class="fu">mean</span>(data.group1a.daily<span class="sc">$</span>ntransSP.mom, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-112"><a href="#cb5-112" tabindex="-1"></a>    <span class="co"># PnL</span></span>
<span id="cb5-113"><a href="#cb5-113" tabindex="-1"></a>    grossPnL <span class="ot">=</span> <span class="fu">sum</span>(data.group1a.daily<span class="sc">$</span>pnl_gross.mom)</span>
<span id="cb5-114"><a href="#cb5-114" tabindex="-1"></a>    netPnL <span class="ot">=</span> <span class="fu">sum</span>(data.group1a.daily<span class="sc">$</span>pnl_net.mom)</span>
<span id="cb5-115"><a href="#cb5-115" tabindex="-1"></a>    <span class="co"># stat</span></span>
<span id="cb5-116"><a href="#cb5-116" tabindex="-1"></a>    stat <span class="ot">=</span> netCR <span class="sc">*</span> <span class="fu">max</span>(<span class="dv">0</span>, <span class="fu">log</span>(<span class="fu">abs</span>(netPnL<span class="sc">/</span><span class="dv">1000</span>)))</span>
<span id="cb5-117"><a href="#cb5-117" tabindex="-1"></a>    </span>
<span id="cb5-118"><a href="#cb5-118" tabindex="-1"></a>    <span class="co"># summary of a particular strategy</span></span>
<span id="cb5-119"><a href="#cb5-119" tabindex="-1"></a>    summary_ <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Close =</span> <span class="dv">1</span>,</span>
<span id="cb5-120"><a href="#cb5-120" tabindex="-1"></a>                           <span class="at">EMA =</span> pair[<span class="dv">2</span>],</span>
<span id="cb5-121"><a href="#cb5-121" tabindex="-1"></a>                           <span class="at">period =</span> selected_quarter, <span class="co"># &quot;2016-08-16 - 2016-11&quot;,</span></span>
<span id="cb5-122"><a href="#cb5-122" tabindex="-1"></a>                           <span class="at">gross.SR =</span> grossSR,</span>
<span id="cb5-123"><a href="#cb5-123" tabindex="-1"></a>                           <span class="at">net.SR =</span> netSR,</span>
<span id="cb5-124"><a href="#cb5-124" tabindex="-1"></a>                           <span class="at">gross.PnL =</span> grossPnL,</span>
<span id="cb5-125"><a href="#cb5-125" tabindex="-1"></a>                           <span class="at">net.PnL =</span> netPnL,</span>
<span id="cb5-126"><a href="#cb5-126" tabindex="-1"></a>                           <span class="at">av.daily.ntrans =</span> av.daily.ntrades,</span>
<span id="cb5-127"><a href="#cb5-127" tabindex="-1"></a>                           <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-128"><a href="#cb5-128" tabindex="-1"></a>    </span>
<span id="cb5-129"><a href="#cb5-129" tabindex="-1"></a>    <span class="co"># putting all summaries together</span></span>
<span id="cb5-130"><a href="#cb5-130" tabindex="-1"></a>    </span>
<span id="cb5-131"><a href="#cb5-131" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">exists</span>(<span class="st">&quot;summary.pair.trading&quot;</span>)) summary.pair.trading <span class="ot">&lt;-</span> summary_ <span class="cf">else</span></span>
<span id="cb5-132"><a href="#cb5-132" tabindex="-1"></a>      summary.pair.trading <span class="ot">&lt;-</span> <span class="fu">rbind</span>(summary.pair.trading, summary_)</span>
<span id="cb5-133"><a href="#cb5-133" tabindex="-1"></a>    </span>
<span id="cb5-134"><a href="#cb5-134" tabindex="-1"></a>    <span class="co"># deleting working files not needed any more</span></span>
<span id="cb5-135"><a href="#cb5-135" tabindex="-1"></a>    <span class="fu">rm</span>(grossSR, netSR, netCR,</span>
<span id="cb5-136"><a href="#cb5-136" tabindex="-1"></a>       grossPnL, netPnL,</span>
<span id="cb5-137"><a href="#cb5-137" tabindex="-1"></a>       av.daily.ntrades, stat,</span>
<span id="cb5-138"><a href="#cb5-138" tabindex="-1"></a>       summary_)</span>
<span id="cb5-139"><a href="#cb5-139" tabindex="-1"></a>  }</span>
<span id="cb5-140"><a href="#cb5-140" tabindex="-1"></a>  </span>
<span id="cb5-141"><a href="#cb5-141" tabindex="-1"></a>  <span class="co"># net.SR - spread av_ratio</span></span>
<span id="cb5-142"><a href="#cb5-142" tabindex="-1"></a>  heatmap_sr_single <span class="ot">&lt;-</span> <span class="fu">plotHeatmap</span>(<span class="at">data_plot =</span> summary.pair.trading, <span class="co"># dataset (data.frame) with calculations</span></span>
<span id="cb5-143"><a href="#cb5-143" tabindex="-1"></a>                                   <span class="at">col_vlabels =</span> <span class="st">&quot;Close&quot;</span>, <span class="co"># column name with the labels for a vertical axis (string)</span></span>
<span id="cb5-144"><a href="#cb5-144" tabindex="-1"></a>                                   <span class="at">col_hlabels =</span> <span class="st">&quot;EMA&quot;</span>, <span class="co"># column name with the labels for a horizontal axis (string)</span></span>
<span id="cb5-145"><a href="#cb5-145" tabindex="-1"></a>                                   <span class="at">col_variable =</span> <span class="st">&quot;net.SR&quot;</span>, <span class="co"># column name with the variable to show (string)</span></span>
<span id="cb5-146"><a href="#cb5-146" tabindex="-1"></a>                                   <span class="at">main =</span> <span class="fu">paste</span>(selected_quarter, <span class="st">&quot;Sensitivity analysis for momentum stategy based on single EMA&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;: &quot;</span>),</span>
<span id="cb5-147"><a href="#cb5-147" tabindex="-1"></a>                                   <span class="at">label_size =</span> <span class="dv">3</span>)</span>
<span id="cb5-148"><a href="#cb5-148" tabindex="-1"></a>  </span>
<span id="cb5-149"><a href="#cb5-149" tabindex="-1"></a>  sensitivities_single[[selected_quarter]] <span class="ot">&lt;-</span> summary.pair.trading</span>
<span id="cb5-150"><a href="#cb5-150" tabindex="-1"></a>  <span class="fu">rm</span>(summary.pair.trading)</span>
<span id="cb5-151"><a href="#cb5-151" tabindex="-1"></a>  heatmap_list_single[[selected_quarter]] <span class="ot">&lt;-</span> heatmap_sr_single</span>
<span id="cb5-152"><a href="#cb5-152" tabindex="-1"></a>  </span>
<span id="cb5-153"><a href="#cb5-153" tabindex="-1"></a>  </span>
<span id="cb5-154"><a href="#cb5-154" tabindex="-1"></a>  <span class="co"># EMA Crossover</span></span>
<span id="cb5-155"><a href="#cb5-155" tabindex="-1"></a>  </span>
<span id="cb5-156"><a href="#cb5-156" tabindex="-1"></a>  EMA_pairs <span class="ot">=</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">20</span>), <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">30</span>), <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">40</span>), <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">50</span>), <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">60</span>), <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">70</span>), <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">80</span>),</span>
<span id="cb5-157"><a href="#cb5-157" tabindex="-1"></a>                   <span class="fu">c</span>(<span class="dv">20</span>, <span class="dv">30</span>), <span class="fu">c</span>(<span class="dv">20</span>, <span class="dv">40</span>), <span class="fu">c</span>(<span class="dv">20</span>, <span class="dv">50</span>), <span class="fu">c</span>(<span class="dv">20</span>, <span class="dv">60</span>), <span class="fu">c</span>(<span class="dv">20</span>, <span class="dv">70</span>), <span class="fu">c</span>(<span class="dv">20</span>, <span class="dv">80</span>),</span>
<span id="cb5-158"><a href="#cb5-158" tabindex="-1"></a>                   <span class="fu">c</span>(<span class="dv">30</span>, <span class="dv">40</span>), <span class="fu">c</span>(<span class="dv">30</span>, <span class="dv">50</span>), <span class="fu">c</span>(<span class="dv">30</span>, <span class="dv">60</span>), <span class="fu">c</span>(<span class="dv">30</span>, <span class="dv">70</span>), <span class="fu">c</span>(<span class="dv">30</span>, <span class="dv">80</span>),</span>
<span id="cb5-159"><a href="#cb5-159" tabindex="-1"></a>                   <span class="fu">c</span>(<span class="dv">40</span>, <span class="dv">50</span>), <span class="fu">c</span>(<span class="dv">40</span>, <span class="dv">60</span>), <span class="fu">c</span>(<span class="dv">40</span>, <span class="dv">70</span>), <span class="fu">c</span>(<span class="dv">40</span>, <span class="dv">80</span>),</span>
<span id="cb5-160"><a href="#cb5-160" tabindex="-1"></a>                   <span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">60</span>), <span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">70</span>), <span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">80</span>),</span>
<span id="cb5-161"><a href="#cb5-161" tabindex="-1"></a>                   <span class="fu">c</span>(<span class="dv">60</span>, <span class="dv">70</span>), <span class="fu">c</span>(<span class="dv">60</span>, <span class="dv">80</span>),</span>
<span id="cb5-162"><a href="#cb5-162" tabindex="-1"></a>                   <span class="fu">c</span>(<span class="dv">70</span>, <span class="dv">80</span>))</span>
<span id="cb5-163"><a href="#cb5-163" tabindex="-1"></a>  </span>
<span id="cb5-164"><a href="#cb5-164" tabindex="-1"></a>  data.group1b <span class="ot">&lt;-</span> data.group1</span>
<span id="cb5-165"><a href="#cb5-165" tabindex="-1"></a>  </span>
<span id="cb5-166"><a href="#cb5-166" tabindex="-1"></a>  <span class="co"># pair &lt;- c(60, 70)</span></span>
<span id="cb5-167"><a href="#cb5-167" tabindex="-1"></a>  <span class="cf">for</span> (pair <span class="cf">in</span> EMA_pairs) {</span>
<span id="cb5-168"><a href="#cb5-168" tabindex="-1"></a>    <span class="co"># lets calculate EMAfast and EMAslow for SP</span></span>
<span id="cb5-169"><a href="#cb5-169" tabindex="-1"></a>    data.group1b<span class="sc">$</span>SP_EMAfast <span class="ot">&lt;-</span> <span class="fu">EMA</span>(<span class="fu">na.locf</span>(data.group1b<span class="sc">$</span>SP), pair[<span class="dv">1</span>])</span>
<span id="cb5-170"><a href="#cb5-170" tabindex="-1"></a>    data.group1b<span class="sc">$</span>SP_EMAslow <span class="ot">&lt;-</span> <span class="fu">EMA</span>(<span class="fu">na.locf</span>(data.group1b<span class="sc">$</span>SP), pair[<span class="dv">2</span>])</span>
<span id="cb5-171"><a href="#cb5-171" tabindex="-1"></a>    </span>
<span id="cb5-172"><a href="#cb5-172" tabindex="-1"></a>    <span class="co"># put missing value whenever the original price is missing</span></span>
<span id="cb5-173"><a href="#cb5-173" tabindex="-1"></a>    data.group1b<span class="sc">$</span>SP_EMAfast[<span class="fu">is.na</span>(data.group1b<span class="sc">$</span>SP)] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb5-174"><a href="#cb5-174" tabindex="-1"></a>    data.group1b<span class="sc">$</span>SP_EMAslow[<span class="fu">is.na</span>(data.group1b<span class="sc">$</span>SP)] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb5-175"><a href="#cb5-175" tabindex="-1"></a>    </span>
<span id="cb5-176"><a href="#cb5-176" tabindex="-1"></a>    <span class="co"># lets calculate the position for the MOMENTUM strategy</span></span>
<span id="cb5-177"><a href="#cb5-177" tabindex="-1"></a>    <span class="co"># if fast MA(t-1) &gt; slow MA(t-1) =&gt; pos(t) = 1 [long]</span></span>
<span id="cb5-178"><a href="#cb5-178" tabindex="-1"></a>    <span class="co"># if fast MA(t-1) &lt;= slow MA(t-1) =&gt; pos(t) = -1 [short]</span></span>
<span id="cb5-179"><a href="#cb5-179" tabindex="-1"></a>    <span class="co"># this strategy is always in the market</span></span>
<span id="cb5-180"><a href="#cb5-180" tabindex="-1"></a>    data.group1b<span class="sc">$</span>positionSP.mom <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">lag.xts</span>(data.group1b<span class="sc">$</span>SP_EMAfast) <span class="sc">&gt;</span></span>
<span id="cb5-181"><a href="#cb5-181" tabindex="-1"></a>                                            <span class="fu">lag.xts</span>(data.group1b<span class="sc">$</span>SP_EMAslow),</span>
<span id="cb5-182"><a href="#cb5-182" tabindex="-1"></a>                                          <span class="dv">1</span>, <span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb5-183"><a href="#cb5-183" tabindex="-1"></a>    </span>
<span id="cb5-184"><a href="#cb5-184" tabindex="-1"></a>    <span class="co"># lets apply the remaining assumptions</span></span>
<span id="cb5-185"><a href="#cb5-185" tabindex="-1"></a>    <span class="co"># - exit all positions 20 minutes before the session end, i.e. at 15:40</span></span>
<span id="cb5-186"><a href="#cb5-186" tabindex="-1"></a>    <span class="co"># - do not trade within the first 25 minutes of stocks quotations (until 9:55)</span></span>
<span id="cb5-187"><a href="#cb5-187" tabindex="-1"></a>    data.group1b<span class="sc">$</span>positionSP.mom[<span class="fu">times</span>(times_) <span class="sc">&lt;=</span> <span class="fu">times</span>(<span class="st">&quot;09:55:00&quot;</span>) <span class="sc">|</span> </span>
<span id="cb5-188"><a href="#cb5-188" tabindex="-1"></a>                                  <span class="fu">times</span>(times_) <span class="sc">&gt;</span> <span class="fu">times</span>(<span class="st">&quot;15:40:00&quot;</span>)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb5-189"><a href="#cb5-189" tabindex="-1"></a>    </span>
<span id="cb5-190"><a href="#cb5-190" tabindex="-1"></a>    </span>
<span id="cb5-191"><a href="#cb5-191" tabindex="-1"></a>    <span class="co"># lets also fill every missing position with the previous one</span></span>
<span id="cb5-192"><a href="#cb5-192" tabindex="-1"></a>    </span>
<span id="cb5-193"><a href="#cb5-193" tabindex="-1"></a>    data.group1b<span class="sc">$</span>positionSP.mom <span class="ot">&lt;-</span> <span class="fu">na.locf</span>(data.group1b<span class="sc">$</span>positionSP.mom, <span class="at">na.rm =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-194"><a href="#cb5-194" tabindex="-1"></a>    </span>
<span id="cb5-195"><a href="#cb5-195" tabindex="-1"></a>    <span class="co"># calculating gross pnl</span></span>
<span id="cb5-196"><a href="#cb5-196" tabindex="-1"></a>    </span>
<span id="cb5-197"><a href="#cb5-197" tabindex="-1"></a>    data.group1b<span class="sc">$</span>pnl_grossSP.mom <span class="ot">&lt;-</span> data.group1b<span class="sc">$</span>positionSP.mom <span class="sc">*</span> <span class="fu">diff.xts</span>(data.group1b<span class="sc">$</span>SP) <span class="sc">*</span> <span class="dv">50</span></span>
<span id="cb5-198"><a href="#cb5-198" tabindex="-1"></a>    </span>
<span id="cb5-199"><a href="#cb5-199" tabindex="-1"></a>    </span>
<span id="cb5-200"><a href="#cb5-200" tabindex="-1"></a>    <span class="co"># number of transactions</span></span>
<span id="cb5-201"><a href="#cb5-201" tabindex="-1"></a>    data.group1b<span class="sc">$</span>ntransSP.mom <span class="ot">&lt;-</span> <span class="fu">abs</span>(<span class="fu">diff.xts</span>(data.group1b<span class="sc">$</span>positionSP.mom))</span>
<span id="cb5-202"><a href="#cb5-202" tabindex="-1"></a>    </span>
<span id="cb5-203"><a href="#cb5-203" tabindex="-1"></a>    data.group1b<span class="sc">$</span>ntransSP.mom[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb5-204"><a href="#cb5-204" tabindex="-1"></a>    </span>
<span id="cb5-205"><a href="#cb5-205" tabindex="-1"></a>    <span class="co"># net pnl</span></span>
<span id="cb5-206"><a href="#cb5-206" tabindex="-1"></a>    data.group1b<span class="sc">$</span>pnl_netSP.mom <span class="ot">&lt;-</span> data.group1b<span class="sc">$</span>pnl_grossSP.mom  <span class="sc">-</span></span>
<span id="cb5-207"><a href="#cb5-207" tabindex="-1"></a>      data.group1b<span class="sc">$</span>ntransSP.mom <span class="sc">*</span> <span class="dv">10</span> <span class="co"># $10 per transaction</span></span>
<span id="cb5-208"><a href="#cb5-208" tabindex="-1"></a>    </span>
<span id="cb5-209"><a href="#cb5-209" tabindex="-1"></a>    <span class="co"># total for strategy</span></span>
<span id="cb5-210"><a href="#cb5-210" tabindex="-1"></a>    </span>
<span id="cb5-211"><a href="#cb5-211" tabindex="-1"></a>    data.group1b<span class="sc">$</span>pnl_gross.mom <span class="ot">&lt;-</span> data.group1b<span class="sc">$</span>pnl_grossSP.mom</span>
<span id="cb5-212"><a href="#cb5-212" tabindex="-1"></a>    data.group1b<span class="sc">$</span>pnl_net.mom <span class="ot">&lt;-</span> data.group1b<span class="sc">$</span>pnl_netSP.mom</span>
<span id="cb5-213"><a href="#cb5-213" tabindex="-1"></a>    </span>
<span id="cb5-214"><a href="#cb5-214" tabindex="-1"></a>    </span>
<span id="cb5-215"><a href="#cb5-215" tabindex="-1"></a>    <span class="co"># aggregate pnls and number of transactions to daily</span></span>
<span id="cb5-216"><a href="#cb5-216" tabindex="-1"></a>    my.endpoints <span class="ot">&lt;-</span> <span class="fu">endpoints</span>(data.group1b, <span class="st">&quot;days&quot;</span>)</span>
<span id="cb5-217"><a href="#cb5-217" tabindex="-1"></a>    </span>
<span id="cb5-218"><a href="#cb5-218" tabindex="-1"></a>    data.group1b.daily <span class="ot">&lt;-</span> <span class="fu">period.apply</span>(data.group1b[,<span class="fu">c</span>(<span class="fu">grep</span>(<span class="st">&quot;pnl&quot;</span>, <span class="fu">names</span>(data.group1b)),</span>
<span id="cb5-219"><a href="#cb5-219" tabindex="-1"></a>                                                       <span class="fu">grep</span>(<span class="st">&quot;ntrans&quot;</span>, <span class="fu">names</span>(data.group1b)))],</span>
<span id="cb5-220"><a href="#cb5-220" tabindex="-1"></a>                                       <span class="at">INDEX =</span> my.endpoints, </span>
<span id="cb5-221"><a href="#cb5-221" tabindex="-1"></a>                                       <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">colSums</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb5-222"><a href="#cb5-222" tabindex="-1"></a>    </span>
<span id="cb5-223"><a href="#cb5-223" tabindex="-1"></a>    <span class="co"># summarize the strategy for this quarter</span></span>
<span id="cb5-224"><a href="#cb5-224" tabindex="-1"></a>    </span>
<span id="cb5-225"><a href="#cb5-225" tabindex="-1"></a>    <span class="co"># SR</span></span>
<span id="cb5-226"><a href="#cb5-226" tabindex="-1"></a>    grossSR <span class="ot">=</span> <span class="fu">mySR</span>(<span class="at">x =</span> data.group1b.daily<span class="sc">$</span>pnl_gross.mom, <span class="at">scale =</span> <span class="dv">252</span>)</span>
<span id="cb5-227"><a href="#cb5-227" tabindex="-1"></a>    netSR <span class="ot">=</span> <span class="fu">mySR</span>(<span class="at">x =</span> data.group1b.daily<span class="sc">$</span>pnl_net.mom, <span class="at">scale =</span> <span class="dv">252</span>)</span>
<span id="cb5-228"><a href="#cb5-228" tabindex="-1"></a>    <span class="co"># CR</span></span>
<span id="cb5-229"><a href="#cb5-229" tabindex="-1"></a>    grossCR <span class="ot">=</span> <span class="fu">myCalmarRatio</span>(<span class="at">x =</span> data.group1b.daily<span class="sc">$</span>pnl_gross.mom, <span class="at">scale =</span> <span class="dv">252</span>)</span>
<span id="cb5-230"><a href="#cb5-230" tabindex="-1"></a>    netCR <span class="ot">=</span> <span class="fu">myCalmarRatio</span>(<span class="at">x =</span> data.group1b.daily<span class="sc">$</span>pnl_net.mom, <span class="at">scale =</span> <span class="dv">252</span>)</span>
<span id="cb5-231"><a href="#cb5-231" tabindex="-1"></a>    </span>
<span id="cb5-232"><a href="#cb5-232" tabindex="-1"></a>    <span class="co"># average number of transactions</span></span>
<span id="cb5-233"><a href="#cb5-233" tabindex="-1"></a>    av.daily.ntrades <span class="ot">=</span> <span class="fu">mean</span>(data.group1b.daily<span class="sc">$</span>ntransSP.mom, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-234"><a href="#cb5-234" tabindex="-1"></a>    <span class="co"># PnL</span></span>
<span id="cb5-235"><a href="#cb5-235" tabindex="-1"></a>    grossPnL <span class="ot">=</span> <span class="fu">sum</span>(data.group1b.daily<span class="sc">$</span>pnl_gross.mom)</span>
<span id="cb5-236"><a href="#cb5-236" tabindex="-1"></a>    netPnL <span class="ot">=</span> <span class="fu">sum</span>(data.group1b.daily<span class="sc">$</span>pnl_net.mom)</span>
<span id="cb5-237"><a href="#cb5-237" tabindex="-1"></a>    <span class="co"># stat</span></span>
<span id="cb5-238"><a href="#cb5-238" tabindex="-1"></a>    stat <span class="ot">=</span> netCR <span class="sc">*</span> <span class="fu">max</span>(<span class="dv">0</span>, <span class="fu">log</span>(<span class="fu">abs</span>(netPnL<span class="sc">/</span><span class="dv">1000</span>)))</span>
<span id="cb5-239"><a href="#cb5-239" tabindex="-1"></a>    </span>
<span id="cb5-240"><a href="#cb5-240" tabindex="-1"></a>    <span class="co"># collecting all statistics for a particular quarter</span></span>
<span id="cb5-241"><a href="#cb5-241" tabindex="-1"></a>    <span class="cf">if</span>(pair[<span class="dv">1</span>] <span class="sc">==</span> <span class="dv">60</span> <span class="sc">&amp;</span> pair[<span class="dv">2</span>] <span class="sc">==</span> <span class="dv">70</span>) {</span>
<span id="cb5-242"><a href="#cb5-242" tabindex="-1"></a>      quarter_stats <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">quarter =</span> selected_quarter,</span>
<span id="cb5-243"><a href="#cb5-243" tabindex="-1"></a>                                  <span class="at">assets.group =</span> <span class="dv">1</span>,</span>
<span id="cb5-244"><a href="#cb5-244" tabindex="-1"></a>                                  <span class="at">gross.SR =</span> grossSR,</span>
<span id="cb5-245"><a href="#cb5-245" tabindex="-1"></a>                                  <span class="at">net.SR =</span> netSR,</span>
<span id="cb5-246"><a href="#cb5-246" tabindex="-1"></a>                                  <span class="at">gross.CR =</span> grossCR,</span>
<span id="cb5-247"><a href="#cb5-247" tabindex="-1"></a>                                  <span class="at">net.CR =</span> netCR,</span>
<span id="cb5-248"><a href="#cb5-248" tabindex="-1"></a>                                  <span class="at">gross.PnL =</span> grossPnL,</span>
<span id="cb5-249"><a href="#cb5-249" tabindex="-1"></a>                                  <span class="at">net.PnL =</span> netPnL,</span>
<span id="cb5-250"><a href="#cb5-250" tabindex="-1"></a>                                  <span class="at">av.daily.ntrans =</span> av.daily.ntrades,</span>
<span id="cb5-251"><a href="#cb5-251" tabindex="-1"></a>                                  stat,</span>
<span id="cb5-252"><a href="#cb5-252" tabindex="-1"></a>                                  <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb5-253"><a href="#cb5-253" tabindex="-1"></a>      )</span>
<span id="cb5-254"><a href="#cb5-254" tabindex="-1"></a>      </span>
<span id="cb5-255"><a href="#cb5-255" tabindex="-1"></a>      <span class="co"># collect summaries for all quarters</span></span>
<span id="cb5-256"><a href="#cb5-256" tabindex="-1"></a>      <span class="cf">if</span>(<span class="sc">!</span><span class="fu">exists</span>(<span class="st">&quot;quarter_stats.all.group1&quot;</span>)) quarter_stats.all.group1 <span class="ot">&lt;-</span> quarter_stats <span class="cf">else</span></span>
<span id="cb5-257"><a href="#cb5-257" tabindex="-1"></a>        quarter_stats.all.group1 <span class="ot">&lt;-</span> <span class="fu">rbind</span>(quarter_stats.all.group1, quarter_stats)</span>
<span id="cb5-258"><a href="#cb5-258" tabindex="-1"></a>      </span>
<span id="cb5-259"><a href="#cb5-259" tabindex="-1"></a>      <span class="co"># create a plot of gros and net pnl and save it to png file</span></span>
<span id="cb5-260"><a href="#cb5-260" tabindex="-1"></a>      <span class="fu">print</span>( <span class="co"># when plotting in a loop you have to use print()</span></span>
<span id="cb5-261"><a href="#cb5-261" tabindex="-1"></a>        <span class="fu">plot</span>(<span class="fu">cbind</span>(<span class="fu">cumsum</span>(data.group1b.daily<span class="sc">$</span>pnl_gross.mom),</span>
<span id="cb5-262"><a href="#cb5-262" tabindex="-1"></a>                   <span class="fu">cumsum</span>(data.group1b.daily<span class="sc">$</span>pnl_net.mom)),</span>
<span id="cb5-263"><a href="#cb5-263" tabindex="-1"></a>             <span class="at">multi.panel =</span> <span class="cn">FALSE</span>,</span>
<span id="cb5-264"><a href="#cb5-264" tabindex="-1"></a>             <span class="at">main =</span> <span class="fu">paste0</span>(<span class="st">&quot;Gross and net PnL for asset group 1 </span><span class="sc">\n</span><span class="st"> quarter &quot;</span>, selected_quarter), </span>
<span id="cb5-265"><a href="#cb5-265" tabindex="-1"></a>             <span class="at">col =</span> <span class="fu">c</span>(<span class="st">&quot;#377EB8&quot;</span>, <span class="st">&quot;#E41A1C&quot;</span>),</span>
<span id="cb5-266"><a href="#cb5-266" tabindex="-1"></a>             <span class="at">major.ticks =</span> <span class="st">&quot;weeks&quot;</span>, </span>
<span id="cb5-267"><a href="#cb5-267" tabindex="-1"></a>             <span class="at">grid.ticks.on =</span> <span class="st">&quot;weeks&quot;</span>,</span>
<span id="cb5-268"><a href="#cb5-268" tabindex="-1"></a>             <span class="at">grid.ticks.lty =</span> <span class="dv">3</span>,</span>
<span id="cb5-269"><a href="#cb5-269" tabindex="-1"></a>             <span class="at">legend.loc =</span> <span class="st">&quot;topleft&quot;</span>,</span>
<span id="cb5-270"><a href="#cb5-270" tabindex="-1"></a>             <span class="at">cex =</span> <span class="fl">0.3</span>)</span>
<span id="cb5-271"><a href="#cb5-271" tabindex="-1"></a>      )</span>
<span id="cb5-272"><a href="#cb5-272" tabindex="-1"></a></span>
<span id="cb5-273"><a href="#cb5-273" tabindex="-1"></a>      <span class="co"># remove all unneeded objects for group 1</span></span>
<span id="cb5-274"><a href="#cb5-274" tabindex="-1"></a>      <span class="fu">rm</span>(pnl.gross.d, pnl.net.d, quarter_stats)</span>
<span id="cb5-275"><a href="#cb5-275" tabindex="-1"></a>      </span>
<span id="cb5-276"><a href="#cb5-276" tabindex="-1"></a>      <span class="fu">gc</span>()</span>
<span id="cb5-277"><a href="#cb5-277" tabindex="-1"></a>    }</span>
<span id="cb5-278"><a href="#cb5-278" tabindex="-1"></a>    </span>
<span id="cb5-279"><a href="#cb5-279" tabindex="-1"></a>    <span class="co"># summary of a particular strategy</span></span>
<span id="cb5-280"><a href="#cb5-280" tabindex="-1"></a>    summary_ <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">EMA.fast =</span> pair[<span class="dv">1</span>],</span>
<span id="cb5-281"><a href="#cb5-281" tabindex="-1"></a>                           <span class="at">EMA.slow =</span> pair[<span class="dv">2</span>],</span>
<span id="cb5-282"><a href="#cb5-282" tabindex="-1"></a>                           <span class="at">period =</span> selected_quarter, <span class="co"># &quot;2016-08-16 - 2016-11&quot;,</span></span>
<span id="cb5-283"><a href="#cb5-283" tabindex="-1"></a>                           <span class="at">gross.SR =</span> grossSR,</span>
<span id="cb5-284"><a href="#cb5-284" tabindex="-1"></a>                           <span class="at">net.SR =</span> netSR,</span>
<span id="cb5-285"><a href="#cb5-285" tabindex="-1"></a>                           <span class="at">gross.PnL =</span> grossPnL,</span>
<span id="cb5-286"><a href="#cb5-286" tabindex="-1"></a>                           <span class="at">net.PnL =</span> netPnL,</span>
<span id="cb5-287"><a href="#cb5-287" tabindex="-1"></a>                           <span class="at">av.daily.ntrans =</span> av.daily.ntrades,</span>
<span id="cb5-288"><a href="#cb5-288" tabindex="-1"></a>                           <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-289"><a href="#cb5-289" tabindex="-1"></a>    </span>
<span id="cb5-290"><a href="#cb5-290" tabindex="-1"></a>    <span class="co"># putting all summaries together</span></span>
<span id="cb5-291"><a href="#cb5-291" tabindex="-1"></a>    </span>
<span id="cb5-292"><a href="#cb5-292" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">exists</span>(<span class="st">&quot;summary.pair.trading&quot;</span>)) summary.pair.trading <span class="ot">&lt;-</span> summary_ <span class="cf">else</span></span>
<span id="cb5-293"><a href="#cb5-293" tabindex="-1"></a>      summary.pair.trading <span class="ot">&lt;-</span> <span class="fu">rbind</span>(summary.pair.trading, summary_)</span>
<span id="cb5-294"><a href="#cb5-294" tabindex="-1"></a>    </span>
<span id="cb5-295"><a href="#cb5-295" tabindex="-1"></a>    <span class="co"># deleting working files not needed any more</span></span>
<span id="cb5-296"><a href="#cb5-296" tabindex="-1"></a>    <span class="fu">rm</span>(grossSR, netSR, netCR,</span>
<span id="cb5-297"><a href="#cb5-297" tabindex="-1"></a>       grossPnL, netPnL,</span>
<span id="cb5-298"><a href="#cb5-298" tabindex="-1"></a>       av.daily.ntrades, stat,</span>
<span id="cb5-299"><a href="#cb5-299" tabindex="-1"></a>       summary_)</span>
<span id="cb5-300"><a href="#cb5-300" tabindex="-1"></a>  }</span>
<span id="cb5-301"><a href="#cb5-301" tabindex="-1"></a>  </span>
<span id="cb5-302"><a href="#cb5-302" tabindex="-1"></a>  <span class="co"># net.SR - spread av_ratio</span></span>
<span id="cb5-303"><a href="#cb5-303" tabindex="-1"></a>  heatmap_sr_cross <span class="ot">&lt;-</span> <span class="fu">plotHeatmap</span>(<span class="at">data_plot =</span> summary.pair.trading, <span class="co"># dataset (data.frame) with calculations</span></span>
<span id="cb5-304"><a href="#cb5-304" tabindex="-1"></a>                                  <span class="at">col_vlabels =</span> <span class="st">&quot;EMA.fast&quot;</span>, <span class="co"># column name with the labels for a vertical axis (string)</span></span>
<span id="cb5-305"><a href="#cb5-305" tabindex="-1"></a>                                  <span class="at">col_hlabels =</span> <span class="st">&quot;EMA.slow&quot;</span>, <span class="co"># column name with the labels for a horizontal axis (string)</span></span>
<span id="cb5-306"><a href="#cb5-306" tabindex="-1"></a>                                  <span class="at">col_variable =</span> <span class="st">&quot;net.SR&quot;</span>, <span class="co"># column name with the variable to show (string)</span></span>
<span id="cb5-307"><a href="#cb5-307" tabindex="-1"></a>                                  <span class="at">main =</span> <span class="fu">paste</span>(selected_quarter, <span class="st">&quot;Sensitivity analysis for momentum stategy based on EMA crossover&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;: &quot;</span>),</span>
<span id="cb5-308"><a href="#cb5-308" tabindex="-1"></a>                                  <span class="at">label_size =</span> <span class="dv">3</span>)</span>
<span id="cb5-309"><a href="#cb5-309" tabindex="-1"></a>  </span>
<span id="cb5-310"><a href="#cb5-310" tabindex="-1"></a>  sensitivities_cross[[selected_quarter]] <span class="ot">&lt;-</span> summary.pair.trading</span>
<span id="cb5-311"><a href="#cb5-311" tabindex="-1"></a>  <span class="fu">rm</span>(summary.pair.trading)</span>
<span id="cb5-312"><a href="#cb5-312" tabindex="-1"></a>  heatmap_list_cross[[selected_quarter]] <span class="ot">&lt;-</span> heatmap_sr_cross</span>
<span id="cb5-313"><a href="#cb5-313" tabindex="-1"></a>  </span>
<span id="cb5-314"><a href="#cb5-314" tabindex="-1"></a>  </span>
<span id="cb5-315"><a href="#cb5-315" tabindex="-1"></a>  <span class="co"># Mean reversion</span></span>
<span id="cb5-316"><a href="#cb5-316" tabindex="-1"></a>  </span>
<span id="cb5-317"><a href="#cb5-317" tabindex="-1"></a>  <span class="co"># Single EMA</span></span>
<span id="cb5-318"><a href="#cb5-318" tabindex="-1"></a>  </span>
<span id="cb5-319"><a href="#cb5-319" tabindex="-1"></a>  EMA_pairs <span class="ot">=</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">10</span>), <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">20</span>), <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">30</span>), <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">40</span>), <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">50</span>), <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">60</span>), <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">70</span>), <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">80</span>))</span>
<span id="cb5-320"><a href="#cb5-320" tabindex="-1"></a>  data.group1a_mr <span class="ot">&lt;-</span> data.group1</span>
<span id="cb5-321"><a href="#cb5-321" tabindex="-1"></a>  </span>
<span id="cb5-322"><a href="#cb5-322" tabindex="-1"></a>  <span class="cf">for</span> (pair <span class="cf">in</span> EMA_pairs) {</span>
<span id="cb5-323"><a href="#cb5-323" tabindex="-1"></a>    <span class="co"># lets calculate EMAfast and EMAslow for SP</span></span>
<span id="cb5-324"><a href="#cb5-324" tabindex="-1"></a>    data.group1a_mr<span class="sc">$</span>SP_EMA <span class="ot">&lt;-</span> <span class="fu">EMA</span>(<span class="fu">na.locf</span>(data.group1a_mr<span class="sc">$</span>SP), pair[<span class="dv">2</span>])</span>
<span id="cb5-325"><a href="#cb5-325" tabindex="-1"></a>    </span>
<span id="cb5-326"><a href="#cb5-326" tabindex="-1"></a>    <span class="co"># put missing value whenever the original price is missing</span></span>
<span id="cb5-327"><a href="#cb5-327" tabindex="-1"></a>    data.group1a_mr<span class="sc">$</span>SP_EMA[<span class="fu">is.na</span>(data.group1a_mr<span class="sc">$</span>SP)] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb5-328"><a href="#cb5-328" tabindex="-1"></a>    </span>
<span id="cb5-329"><a href="#cb5-329" tabindex="-1"></a>    <span class="co"># lets calculate the position for the MOMENTUM strategy</span></span>
<span id="cb5-330"><a href="#cb5-330" tabindex="-1"></a>    <span class="co"># if price(t-1) &gt; MA(t-1) =&gt; pos(t) = 1 [long]</span></span>
<span id="cb5-331"><a href="#cb5-331" tabindex="-1"></a>    <span class="co"># if price(t-1) &lt;= MA(t-1) =&gt; pos(t) = -1 [short]</span></span>
<span id="cb5-332"><a href="#cb5-332" tabindex="-1"></a>    <span class="co"># this strategy is always against the market</span></span>
<span id="cb5-333"><a href="#cb5-333" tabindex="-1"></a>    data.group1a_mr<span class="sc">$</span>positionSP.mr <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">lag.xts</span>(data.group1a_mr<span class="sc">$</span>SP) <span class="sc">&gt;</span></span>
<span id="cb5-334"><a href="#cb5-334" tabindex="-1"></a>                                              <span class="fu">lag.xts</span>(data.group1a_mr<span class="sc">$</span>SP_EMA),</span>
<span id="cb5-335"><a href="#cb5-335" tabindex="-1"></a>                                            <span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb5-336"><a href="#cb5-336" tabindex="-1"></a>    </span>
<span id="cb5-337"><a href="#cb5-337" tabindex="-1"></a>    <span class="co"># lets apply the remaining assumptions</span></span>
<span id="cb5-338"><a href="#cb5-338" tabindex="-1"></a>    <span class="co"># - exit all positions 20 minutes before the session end, i.e. at 15:40</span></span>
<span id="cb5-339"><a href="#cb5-339" tabindex="-1"></a>    <span class="co"># - do not trade within the first 25 minutes of stocks quotations (until 9:55)</span></span>
<span id="cb5-340"><a href="#cb5-340" tabindex="-1"></a>    data.group1a_mr<span class="sc">$</span>positionSP.mr[<span class="fu">times</span>(times_) <span class="sc">&lt;=</span> <span class="fu">times</span>(<span class="st">&quot;09:55:00&quot;</span>) <span class="sc">|</span> </span>
<span id="cb5-341"><a href="#cb5-341" tabindex="-1"></a>                                    <span class="fu">times</span>(times_) <span class="sc">&gt;</span> <span class="fu">times</span>(<span class="st">&quot;15:40:00&quot;</span>)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb5-342"><a href="#cb5-342" tabindex="-1"></a>    </span>
<span id="cb5-343"><a href="#cb5-343" tabindex="-1"></a>    </span>
<span id="cb5-344"><a href="#cb5-344" tabindex="-1"></a>    <span class="co"># lets also fill every missing position with the previous one</span></span>
<span id="cb5-345"><a href="#cb5-345" tabindex="-1"></a>    </span>
<span id="cb5-346"><a href="#cb5-346" tabindex="-1"></a>    data.group1a_mr<span class="sc">$</span>positionSP.mr <span class="ot">&lt;-</span> <span class="fu">na.locf</span>(data.group1a_mr<span class="sc">$</span>positionSP.mr, <span class="at">na.rm =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-347"><a href="#cb5-347" tabindex="-1"></a>    </span>
<span id="cb5-348"><a href="#cb5-348" tabindex="-1"></a>    <span class="co"># calculating gross pnl</span></span>
<span id="cb5-349"><a href="#cb5-349" tabindex="-1"></a>    </span>
<span id="cb5-350"><a href="#cb5-350" tabindex="-1"></a>    data.group1a_mr<span class="sc">$</span>pnl_grossSP.mr <span class="ot">&lt;-</span> data.group1a_mr<span class="sc">$</span>positionSP.mr <span class="sc">*</span> <span class="fu">diff.xts</span>(data.group1a_mr<span class="sc">$</span>SP) <span class="sc">*</span> <span class="dv">50</span></span>
<span id="cb5-351"><a href="#cb5-351" tabindex="-1"></a>    </span>
<span id="cb5-352"><a href="#cb5-352" tabindex="-1"></a>    </span>
<span id="cb5-353"><a href="#cb5-353" tabindex="-1"></a>    <span class="co"># number of transactions</span></span>
<span id="cb5-354"><a href="#cb5-354" tabindex="-1"></a>    data.group1a_mr<span class="sc">$</span>ntransSP.mr <span class="ot">&lt;-</span> <span class="fu">abs</span>(<span class="fu">diff.xts</span>(data.group1a_mr<span class="sc">$</span>positionSP.mr))</span>
<span id="cb5-355"><a href="#cb5-355" tabindex="-1"></a>    </span>
<span id="cb5-356"><a href="#cb5-356" tabindex="-1"></a>    data.group1a_mr<span class="sc">$</span>ntransSP.mr[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb5-357"><a href="#cb5-357" tabindex="-1"></a>    </span>
<span id="cb5-358"><a href="#cb5-358" tabindex="-1"></a>    <span class="co"># net pnl</span></span>
<span id="cb5-359"><a href="#cb5-359" tabindex="-1"></a>    data.group1a_mr<span class="sc">$</span>pnl_netSP.mr <span class="ot">&lt;-</span> data.group1a_mr<span class="sc">$</span>pnl_grossSP.mr  <span class="sc">-</span></span>
<span id="cb5-360"><a href="#cb5-360" tabindex="-1"></a>      data.group1a_mr<span class="sc">$</span>ntransSP.mr <span class="sc">*</span> <span class="dv">10</span> <span class="co"># $10 per transaction</span></span>
<span id="cb5-361"><a href="#cb5-361" tabindex="-1"></a>    </span>
<span id="cb5-362"><a href="#cb5-362" tabindex="-1"></a>    <span class="co"># total for strategy</span></span>
<span id="cb5-363"><a href="#cb5-363" tabindex="-1"></a>    </span>
<span id="cb5-364"><a href="#cb5-364" tabindex="-1"></a>    data.group1a_mr<span class="sc">$</span>pnl_gross.mr <span class="ot">&lt;-</span> data.group1a_mr<span class="sc">$</span>pnl_grossSP.mr</span>
<span id="cb5-365"><a href="#cb5-365" tabindex="-1"></a>    data.group1a_mr<span class="sc">$</span>pnl_net.mr <span class="ot">&lt;-</span> data.group1a_mr<span class="sc">$</span>pnl_netSP.mr</span>
<span id="cb5-366"><a href="#cb5-366" tabindex="-1"></a>    </span>
<span id="cb5-367"><a href="#cb5-367" tabindex="-1"></a>    </span>
<span id="cb5-368"><a href="#cb5-368" tabindex="-1"></a>    <span class="co"># aggregate pnls and number of transactions to daily</span></span>
<span id="cb5-369"><a href="#cb5-369" tabindex="-1"></a>    my.endpoints <span class="ot">&lt;-</span> <span class="fu">endpoints</span>(data.group1a_mr, <span class="st">&quot;days&quot;</span>)</span>
<span id="cb5-370"><a href="#cb5-370" tabindex="-1"></a>    </span>
<span id="cb5-371"><a href="#cb5-371" tabindex="-1"></a>    data.group1a_mr.daily <span class="ot">&lt;-</span> <span class="fu">period.apply</span>(data.group1a_mr[,<span class="fu">c</span>(<span class="fu">grep</span>(<span class="st">&quot;pnl&quot;</span>, <span class="fu">names</span>(data.group1a_mr)),</span>
<span id="cb5-372"><a href="#cb5-372" tabindex="-1"></a>                                                             <span class="fu">grep</span>(<span class="st">&quot;ntrans&quot;</span>, <span class="fu">names</span>(data.group1a_mr)))],</span>
<span id="cb5-373"><a href="#cb5-373" tabindex="-1"></a>                                          <span class="at">INDEX =</span> my.endpoints, </span>
<span id="cb5-374"><a href="#cb5-374" tabindex="-1"></a>                                          <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">colSums</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb5-375"><a href="#cb5-375" tabindex="-1"></a>    </span>
<span id="cb5-376"><a href="#cb5-376" tabindex="-1"></a>    <span class="co"># summarize the strategy for this quarter</span></span>
<span id="cb5-377"><a href="#cb5-377" tabindex="-1"></a>    </span>
<span id="cb5-378"><a href="#cb5-378" tabindex="-1"></a>    <span class="co"># SR</span></span>
<span id="cb5-379"><a href="#cb5-379" tabindex="-1"></a>    grossSR <span class="ot">=</span> <span class="fu">mySR</span>(<span class="at">x =</span> data.group1a_mr.daily<span class="sc">$</span>pnl_gross.mr, <span class="at">scale =</span> <span class="dv">252</span>)</span>
<span id="cb5-380"><a href="#cb5-380" tabindex="-1"></a>    netSR <span class="ot">=</span> <span class="fu">mySR</span>(<span class="at">x =</span> data.group1a_mr.daily<span class="sc">$</span>pnl_net.mr, <span class="at">scale =</span> <span class="dv">252</span>)</span>
<span id="cb5-381"><a href="#cb5-381" tabindex="-1"></a>    <span class="co"># CR</span></span>
<span id="cb5-382"><a href="#cb5-382" tabindex="-1"></a>    grossCR <span class="ot">=</span> <span class="fu">myCalmarRatio</span>(<span class="at">x =</span> data.group1a_mr.daily<span class="sc">$</span>pnl_gross.mr, <span class="at">scale =</span> <span class="dv">252</span>)</span>
<span id="cb5-383"><a href="#cb5-383" tabindex="-1"></a>    netCR <span class="ot">=</span> <span class="fu">myCalmarRatio</span>(<span class="at">x =</span> data.group1a_mr.daily<span class="sc">$</span>pnl_net.mr, <span class="at">scale =</span> <span class="dv">252</span>)</span>
<span id="cb5-384"><a href="#cb5-384" tabindex="-1"></a>    </span>
<span id="cb5-385"><a href="#cb5-385" tabindex="-1"></a>    <span class="co"># average number of transactions</span></span>
<span id="cb5-386"><a href="#cb5-386" tabindex="-1"></a>    av.daily.ntrades <span class="ot">=</span> <span class="fu">mean</span>(data.group1a_mr.daily<span class="sc">$</span>ntransSP.mr, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-387"><a href="#cb5-387" tabindex="-1"></a>    <span class="co"># PnL</span></span>
<span id="cb5-388"><a href="#cb5-388" tabindex="-1"></a>    grossPnL <span class="ot">=</span> <span class="fu">sum</span>(data.group1a_mr.daily<span class="sc">$</span>pnl_gross.mr)</span>
<span id="cb5-389"><a href="#cb5-389" tabindex="-1"></a>    netPnL <span class="ot">=</span> <span class="fu">sum</span>(data.group1a_mr.daily<span class="sc">$</span>pnl_net.mr)</span>
<span id="cb5-390"><a href="#cb5-390" tabindex="-1"></a>    <span class="co"># stat</span></span>
<span id="cb5-391"><a href="#cb5-391" tabindex="-1"></a>    stat <span class="ot">=</span> netCR <span class="sc">*</span> <span class="fu">max</span>(<span class="dv">0</span>, <span class="fu">log</span>(<span class="fu">abs</span>(netPnL<span class="sc">/</span><span class="dv">1000</span>)))</span>
<span id="cb5-392"><a href="#cb5-392" tabindex="-1"></a>    </span>
<span id="cb5-393"><a href="#cb5-393" tabindex="-1"></a>    <span class="co"># summary of a particular strategy</span></span>
<span id="cb5-394"><a href="#cb5-394" tabindex="-1"></a>    summary_ <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Close =</span> <span class="dv">1</span>,</span>
<span id="cb5-395"><a href="#cb5-395" tabindex="-1"></a>                           <span class="at">EMA =</span> pair[<span class="dv">2</span>],</span>
<span id="cb5-396"><a href="#cb5-396" tabindex="-1"></a>                           <span class="at">period =</span> selected_quarter, <span class="co"># &quot;2016-08-16 - 2016-11&quot;,</span></span>
<span id="cb5-397"><a href="#cb5-397" tabindex="-1"></a>                           <span class="at">gross.SR =</span> grossSR,</span>
<span id="cb5-398"><a href="#cb5-398" tabindex="-1"></a>                           <span class="at">net.SR =</span> netSR,</span>
<span id="cb5-399"><a href="#cb5-399" tabindex="-1"></a>                           <span class="at">gross.PnL =</span> grossPnL,</span>
<span id="cb5-400"><a href="#cb5-400" tabindex="-1"></a>                           <span class="at">net.PnL =</span> netPnL,</span>
<span id="cb5-401"><a href="#cb5-401" tabindex="-1"></a>                           <span class="at">av.daily.ntrans =</span> av.daily.ntrades,</span>
<span id="cb5-402"><a href="#cb5-402" tabindex="-1"></a>                           <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-403"><a href="#cb5-403" tabindex="-1"></a>    </span>
<span id="cb5-404"><a href="#cb5-404" tabindex="-1"></a>    <span class="co"># putting all summaries together</span></span>
<span id="cb5-405"><a href="#cb5-405" tabindex="-1"></a>    </span>
<span id="cb5-406"><a href="#cb5-406" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">exists</span>(<span class="st">&quot;summary.pair.trading&quot;</span>)) summary.pair.trading <span class="ot">&lt;-</span> summary_ <span class="cf">else</span></span>
<span id="cb5-407"><a href="#cb5-407" tabindex="-1"></a>      summary.pair.trading <span class="ot">&lt;-</span> <span class="fu">rbind</span>(summary.pair.trading, summary_)</span>
<span id="cb5-408"><a href="#cb5-408" tabindex="-1"></a>    </span>
<span id="cb5-409"><a href="#cb5-409" tabindex="-1"></a>    <span class="co"># deleting working files not needed any more</span></span>
<span id="cb5-410"><a href="#cb5-410" tabindex="-1"></a>    <span class="fu">rm</span>(grossSR, netSR, netCR,</span>
<span id="cb5-411"><a href="#cb5-411" tabindex="-1"></a>       grossPnL, netPnL,</span>
<span id="cb5-412"><a href="#cb5-412" tabindex="-1"></a>       av.daily.ntrades, stat,</span>
<span id="cb5-413"><a href="#cb5-413" tabindex="-1"></a>       summary_)</span>
<span id="cb5-414"><a href="#cb5-414" tabindex="-1"></a>  }</span>
<span id="cb5-415"><a href="#cb5-415" tabindex="-1"></a>  </span>
<span id="cb5-416"><a href="#cb5-416" tabindex="-1"></a>  <span class="co"># net.SR - spread av_ratio</span></span>
<span id="cb5-417"><a href="#cb5-417" tabindex="-1"></a>  heatmap_sr_single_mr <span class="ot">&lt;-</span> <span class="fu">plotHeatmap</span>(<span class="at">data_plot =</span> summary.pair.trading, <span class="co"># dataset (data.frame) with calculations</span></span>
<span id="cb5-418"><a href="#cb5-418" tabindex="-1"></a>                                      <span class="at">col_vlabels =</span> <span class="st">&quot;Close&quot;</span>, <span class="co"># column name with the labels for a vertical axis (string)</span></span>
<span id="cb5-419"><a href="#cb5-419" tabindex="-1"></a>                                      <span class="at">col_hlabels =</span> <span class="st">&quot;EMA&quot;</span>, <span class="co"># column name with the labels for a horizontal axis (string)</span></span>
<span id="cb5-420"><a href="#cb5-420" tabindex="-1"></a>                                      <span class="at">col_variable =</span> <span class="st">&quot;net.SR&quot;</span>, <span class="co"># column name with the variable to show (string)</span></span>
<span id="cb5-421"><a href="#cb5-421" tabindex="-1"></a>                                      <span class="at">main =</span> <span class="fu">paste</span>(selected_quarter, <span class="st">&quot;Sensitivity analysis for mean reversion stategy based on single EMA&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;: &quot;</span>),</span>
<span id="cb5-422"><a href="#cb5-422" tabindex="-1"></a>                                      <span class="at">label_size =</span> <span class="dv">3</span>)</span>
<span id="cb5-423"><a href="#cb5-423" tabindex="-1"></a>  </span>
<span id="cb5-424"><a href="#cb5-424" tabindex="-1"></a>  sensitivities_single_mr[[selected_quarter]] <span class="ot">&lt;-</span> summary.pair.trading</span>
<span id="cb5-425"><a href="#cb5-425" tabindex="-1"></a>  <span class="fu">rm</span>(summary.pair.trading)</span>
<span id="cb5-426"><a href="#cb5-426" tabindex="-1"></a>  heatmap_list_single_mr[[selected_quarter]] <span class="ot">&lt;-</span> heatmap_sr_single_mr</span>
<span id="cb5-427"><a href="#cb5-427" tabindex="-1"></a>  </span>
<span id="cb5-428"><a href="#cb5-428" tabindex="-1"></a>  </span>
<span id="cb5-429"><a href="#cb5-429" tabindex="-1"></a>  <span class="co"># EMA Crossover</span></span>
<span id="cb5-430"><a href="#cb5-430" tabindex="-1"></a>  </span>
<span id="cb5-431"><a href="#cb5-431" tabindex="-1"></a>  EMA_pairs <span class="ot">=</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">20</span>), <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">30</span>), <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">40</span>), <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">50</span>), <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">60</span>), <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">70</span>), <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">80</span>),</span>
<span id="cb5-432"><a href="#cb5-432" tabindex="-1"></a>                   <span class="fu">c</span>(<span class="dv">20</span>, <span class="dv">30</span>), <span class="fu">c</span>(<span class="dv">20</span>, <span class="dv">40</span>), <span class="fu">c</span>(<span class="dv">20</span>, <span class="dv">50</span>), <span class="fu">c</span>(<span class="dv">20</span>, <span class="dv">60</span>), <span class="fu">c</span>(<span class="dv">20</span>, <span class="dv">70</span>), <span class="fu">c</span>(<span class="dv">20</span>, <span class="dv">80</span>),</span>
<span id="cb5-433"><a href="#cb5-433" tabindex="-1"></a>                   <span class="fu">c</span>(<span class="dv">30</span>, <span class="dv">40</span>), <span class="fu">c</span>(<span class="dv">30</span>, <span class="dv">50</span>), <span class="fu">c</span>(<span class="dv">30</span>, <span class="dv">60</span>), <span class="fu">c</span>(<span class="dv">30</span>, <span class="dv">70</span>), <span class="fu">c</span>(<span class="dv">30</span>, <span class="dv">80</span>),</span>
<span id="cb5-434"><a href="#cb5-434" tabindex="-1"></a>                   <span class="fu">c</span>(<span class="dv">40</span>, <span class="dv">50</span>), <span class="fu">c</span>(<span class="dv">40</span>, <span class="dv">60</span>), <span class="fu">c</span>(<span class="dv">40</span>, <span class="dv">70</span>), <span class="fu">c</span>(<span class="dv">40</span>, <span class="dv">80</span>),</span>
<span id="cb5-435"><a href="#cb5-435" tabindex="-1"></a>                   <span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">60</span>), <span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">70</span>), <span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">80</span>),</span>
<span id="cb5-436"><a href="#cb5-436" tabindex="-1"></a>                   <span class="fu">c</span>(<span class="dv">60</span>, <span class="dv">70</span>), <span class="fu">c</span>(<span class="dv">60</span>, <span class="dv">80</span>),</span>
<span id="cb5-437"><a href="#cb5-437" tabindex="-1"></a>                   <span class="fu">c</span>(<span class="dv">70</span>, <span class="dv">80</span>))</span>
<span id="cb5-438"><a href="#cb5-438" tabindex="-1"></a>  </span>
<span id="cb5-439"><a href="#cb5-439" tabindex="-1"></a>  data.group1b_mr <span class="ot">&lt;-</span> data.group1</span>
<span id="cb5-440"><a href="#cb5-440" tabindex="-1"></a>  </span>
<span id="cb5-441"><a href="#cb5-441" tabindex="-1"></a>  <span class="cf">for</span> (pair <span class="cf">in</span> EMA_pairs) {</span>
<span id="cb5-442"><a href="#cb5-442" tabindex="-1"></a>    <span class="co"># lets calculate EMAfast and EMAslow for SP</span></span>
<span id="cb5-443"><a href="#cb5-443" tabindex="-1"></a>    data.group1b_mr<span class="sc">$</span>SP_EMAfast <span class="ot">&lt;-</span> <span class="fu">EMA</span>(<span class="fu">na.locf</span>(data.group1b_mr<span class="sc">$</span>SP), pair[<span class="dv">1</span>])</span>
<span id="cb5-444"><a href="#cb5-444" tabindex="-1"></a>    data.group1b_mr<span class="sc">$</span>SP_EMAslow <span class="ot">&lt;-</span> <span class="fu">EMA</span>(<span class="fu">na.locf</span>(data.group1b_mr<span class="sc">$</span>SP), pair[<span class="dv">2</span>])</span>
<span id="cb5-445"><a href="#cb5-445" tabindex="-1"></a>    </span>
<span id="cb5-446"><a href="#cb5-446" tabindex="-1"></a>    <span class="co"># put missing value whenever the original price is missing</span></span>
<span id="cb5-447"><a href="#cb5-447" tabindex="-1"></a>    data.group1b_mr<span class="sc">$</span>SP_EMAfast[<span class="fu">is.na</span>(data.group1b_mr<span class="sc">$</span>SP)] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb5-448"><a href="#cb5-448" tabindex="-1"></a>    data.group1b_mr<span class="sc">$</span>SP_EMAslow[<span class="fu">is.na</span>(data.group1b_mr<span class="sc">$</span>SP)] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb5-449"><a href="#cb5-449" tabindex="-1"></a>    </span>
<span id="cb5-450"><a href="#cb5-450" tabindex="-1"></a>    <span class="co"># lets calculate the position for the MOMENTUM strategy</span></span>
<span id="cb5-451"><a href="#cb5-451" tabindex="-1"></a>    <span class="co"># if fast MA(t-1) &gt; slow MA(t-1) =&gt; pos(t) = 1 [long]</span></span>
<span id="cb5-452"><a href="#cb5-452" tabindex="-1"></a>    <span class="co"># if fast MA(t-1) &lt;= slow MA(t-1) =&gt; pos(t) = -1 [short]</span></span>
<span id="cb5-453"><a href="#cb5-453" tabindex="-1"></a>    <span class="co"># this strategy is always against the market</span></span>
<span id="cb5-454"><a href="#cb5-454" tabindex="-1"></a>    data.group1b_mr<span class="sc">$</span>positionSP.mr <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">lag.xts</span>(data.group1b_mr<span class="sc">$</span>SP_EMAfast) <span class="sc">&gt;</span></span>
<span id="cb5-455"><a href="#cb5-455" tabindex="-1"></a>                                              <span class="fu">lag.xts</span>(data.group1b_mr<span class="sc">$</span>SP_EMAslow),</span>
<span id="cb5-456"><a href="#cb5-456" tabindex="-1"></a>                                            <span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb5-457"><a href="#cb5-457" tabindex="-1"></a>    </span>
<span id="cb5-458"><a href="#cb5-458" tabindex="-1"></a>    <span class="co"># lets apply the remaining assumptions</span></span>
<span id="cb5-459"><a href="#cb5-459" tabindex="-1"></a>    <span class="co"># - exit all positions 20 minutes before the session end, i.e. at 15:40</span></span>
<span id="cb5-460"><a href="#cb5-460" tabindex="-1"></a>    <span class="co"># - do not trade within the first 25 minutes of stocks quotations (until 9:55)</span></span>
<span id="cb5-461"><a href="#cb5-461" tabindex="-1"></a>    data.group1b_mr<span class="sc">$</span>positionSP.mr[<span class="fu">times</span>(times_) <span class="sc">&lt;=</span> <span class="fu">times</span>(<span class="st">&quot;09:55:00&quot;</span>) <span class="sc">|</span> </span>
<span id="cb5-462"><a href="#cb5-462" tabindex="-1"></a>                                    <span class="fu">times</span>(times_) <span class="sc">&gt;</span> <span class="fu">times</span>(<span class="st">&quot;15:40:00&quot;</span>)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb5-463"><a href="#cb5-463" tabindex="-1"></a>    </span>
<span id="cb5-464"><a href="#cb5-464" tabindex="-1"></a>    </span>
<span id="cb5-465"><a href="#cb5-465" tabindex="-1"></a>    <span class="co"># lets also fill every missing position with the previous one</span></span>
<span id="cb5-466"><a href="#cb5-466" tabindex="-1"></a>    </span>
<span id="cb5-467"><a href="#cb5-467" tabindex="-1"></a>    data.group1b_mr<span class="sc">$</span>positionSP.mr <span class="ot">&lt;-</span> <span class="fu">na.locf</span>(data.group1b_mr<span class="sc">$</span>positionSP.mr, <span class="at">na.rm =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-468"><a href="#cb5-468" tabindex="-1"></a>    </span>
<span id="cb5-469"><a href="#cb5-469" tabindex="-1"></a>    <span class="co"># calculating gross pnl</span></span>
<span id="cb5-470"><a href="#cb5-470" tabindex="-1"></a>    </span>
<span id="cb5-471"><a href="#cb5-471" tabindex="-1"></a>    data.group1b_mr<span class="sc">$</span>pnl_grossSP.mr <span class="ot">&lt;-</span> data.group1b_mr<span class="sc">$</span>positionSP.mr <span class="sc">*</span> <span class="fu">diff.xts</span>(data.group1b_mr<span class="sc">$</span>SP) <span class="sc">*</span> <span class="dv">50</span></span>
<span id="cb5-472"><a href="#cb5-472" tabindex="-1"></a>    </span>
<span id="cb5-473"><a href="#cb5-473" tabindex="-1"></a>    </span>
<span id="cb5-474"><a href="#cb5-474" tabindex="-1"></a>    <span class="co"># number of transactions</span></span>
<span id="cb5-475"><a href="#cb5-475" tabindex="-1"></a>    data.group1b_mr<span class="sc">$</span>ntransSP.mr <span class="ot">&lt;-</span> <span class="fu">abs</span>(<span class="fu">diff.xts</span>(data.group1b_mr<span class="sc">$</span>positionSP.mr))</span>
<span id="cb5-476"><a href="#cb5-476" tabindex="-1"></a>    </span>
<span id="cb5-477"><a href="#cb5-477" tabindex="-1"></a>    data.group1b_mr<span class="sc">$</span>ntransSP.mr[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb5-478"><a href="#cb5-478" tabindex="-1"></a>    </span>
<span id="cb5-479"><a href="#cb5-479" tabindex="-1"></a>    <span class="co"># net pnl</span></span>
<span id="cb5-480"><a href="#cb5-480" tabindex="-1"></a>    data.group1b_mr<span class="sc">$</span>pnl_netSP.mr <span class="ot">&lt;-</span> data.group1b_mr<span class="sc">$</span>pnl_grossSP.mr  <span class="sc">-</span></span>
<span id="cb5-481"><a href="#cb5-481" tabindex="-1"></a>      data.group1b_mr<span class="sc">$</span>ntransSP.mr <span class="sc">*</span> <span class="dv">10</span> <span class="co"># $10 per transaction</span></span>
<span id="cb5-482"><a href="#cb5-482" tabindex="-1"></a>    </span>
<span id="cb5-483"><a href="#cb5-483" tabindex="-1"></a>    <span class="co"># total for strategy</span></span>
<span id="cb5-484"><a href="#cb5-484" tabindex="-1"></a>    </span>
<span id="cb5-485"><a href="#cb5-485" tabindex="-1"></a>    data.group1b_mr<span class="sc">$</span>pnl_gross.mr <span class="ot">&lt;-</span> data.group1b_mr<span class="sc">$</span>pnl_grossSP.mr</span>
<span id="cb5-486"><a href="#cb5-486" tabindex="-1"></a>    data.group1b_mr<span class="sc">$</span>pnl_net.mr <span class="ot">&lt;-</span> data.group1b_mr<span class="sc">$</span>pnl_netSP.mr</span>
<span id="cb5-487"><a href="#cb5-487" tabindex="-1"></a>    </span>
<span id="cb5-488"><a href="#cb5-488" tabindex="-1"></a>    </span>
<span id="cb5-489"><a href="#cb5-489" tabindex="-1"></a>    <span class="co"># aggregate pnls and number of transactions to daily</span></span>
<span id="cb5-490"><a href="#cb5-490" tabindex="-1"></a>    my.endpoints <span class="ot">&lt;-</span> <span class="fu">endpoints</span>(data.group1b_mr, <span class="st">&quot;days&quot;</span>)</span>
<span id="cb5-491"><a href="#cb5-491" tabindex="-1"></a>    </span>
<span id="cb5-492"><a href="#cb5-492" tabindex="-1"></a>    data.group1b_mr.daily <span class="ot">&lt;-</span> <span class="fu">period.apply</span>(data.group1b_mr[,<span class="fu">c</span>(<span class="fu">grep</span>(<span class="st">&quot;pnl&quot;</span>, <span class="fu">names</span>(data.group1b_mr)),</span>
<span id="cb5-493"><a href="#cb5-493" tabindex="-1"></a>                                                             <span class="fu">grep</span>(<span class="st">&quot;ntrans&quot;</span>, <span class="fu">names</span>(data.group1b_mr)))],</span>
<span id="cb5-494"><a href="#cb5-494" tabindex="-1"></a>                                          <span class="at">INDEX =</span> my.endpoints, </span>
<span id="cb5-495"><a href="#cb5-495" tabindex="-1"></a>                                          <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">colSums</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb5-496"><a href="#cb5-496" tabindex="-1"></a>    </span>
<span id="cb5-497"><a href="#cb5-497" tabindex="-1"></a>    <span class="co"># summarize the strategy for this quarter</span></span>
<span id="cb5-498"><a href="#cb5-498" tabindex="-1"></a>    </span>
<span id="cb5-499"><a href="#cb5-499" tabindex="-1"></a>    <span class="co"># SR</span></span>
<span id="cb5-500"><a href="#cb5-500" tabindex="-1"></a>    grossSR <span class="ot">=</span> <span class="fu">mySR</span>(<span class="at">x =</span> data.group1b_mr.daily<span class="sc">$</span>pnl_gross.mr, <span class="at">scale =</span> <span class="dv">252</span>)</span>
<span id="cb5-501"><a href="#cb5-501" tabindex="-1"></a>    netSR <span class="ot">=</span> <span class="fu">mySR</span>(<span class="at">x =</span> data.group1b_mr.daily<span class="sc">$</span>pnl_net.mr, <span class="at">scale =</span> <span class="dv">252</span>)</span>
<span id="cb5-502"><a href="#cb5-502" tabindex="-1"></a>    <span class="co"># CR</span></span>
<span id="cb5-503"><a href="#cb5-503" tabindex="-1"></a>    grossCR <span class="ot">=</span> <span class="fu">myCalmarRatio</span>(<span class="at">x =</span> data.group1b_mr.daily<span class="sc">$</span>pnl_gross.mr, <span class="at">scale =</span> <span class="dv">252</span>)</span>
<span id="cb5-504"><a href="#cb5-504" tabindex="-1"></a>    netCR <span class="ot">=</span> <span class="fu">myCalmarRatio</span>(<span class="at">x =</span> data.group1b_mr.daily<span class="sc">$</span>pnl_net.mr, <span class="at">scale =</span> <span class="dv">252</span>)</span>
<span id="cb5-505"><a href="#cb5-505" tabindex="-1"></a>    </span>
<span id="cb5-506"><a href="#cb5-506" tabindex="-1"></a>    <span class="co"># average number of transactions</span></span>
<span id="cb5-507"><a href="#cb5-507" tabindex="-1"></a>    av.daily.ntrades <span class="ot">=</span> <span class="fu">mean</span>(data.group1b_mr.daily<span class="sc">$</span>ntransSP.mr, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-508"><a href="#cb5-508" tabindex="-1"></a>    <span class="co"># PnL</span></span>
<span id="cb5-509"><a href="#cb5-509" tabindex="-1"></a>    grossPnL <span class="ot">=</span> <span class="fu">sum</span>(data.group1b_mr.daily<span class="sc">$</span>pnl_gross.mr)</span>
<span id="cb5-510"><a href="#cb5-510" tabindex="-1"></a>    netPnL <span class="ot">=</span> <span class="fu">sum</span>(data.group1b_mr.daily<span class="sc">$</span>pnl_net.mr)</span>
<span id="cb5-511"><a href="#cb5-511" tabindex="-1"></a>    <span class="co"># stat</span></span>
<span id="cb5-512"><a href="#cb5-512" tabindex="-1"></a>    stat <span class="ot">=</span> netCR <span class="sc">*</span> <span class="fu">max</span>(<span class="dv">0</span>, <span class="fu">log</span>(<span class="fu">abs</span>(netPnL<span class="sc">/</span><span class="dv">1000</span>)))</span>
<span id="cb5-513"><a href="#cb5-513" tabindex="-1"></a>    </span>
<span id="cb5-514"><a href="#cb5-514" tabindex="-1"></a>    <span class="co"># summary of a particular strategy</span></span>
<span id="cb5-515"><a href="#cb5-515" tabindex="-1"></a>    summary_ <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">EMA.fast =</span> pair[<span class="dv">1</span>],</span>
<span id="cb5-516"><a href="#cb5-516" tabindex="-1"></a>                           <span class="at">EMA.slow =</span> pair[<span class="dv">2</span>],</span>
<span id="cb5-517"><a href="#cb5-517" tabindex="-1"></a>                           <span class="at">period =</span> selected_quarter, <span class="co"># &quot;2016-08-16 - 2016-11&quot;,</span></span>
<span id="cb5-518"><a href="#cb5-518" tabindex="-1"></a>                           <span class="at">gross.SR =</span> grossSR,</span>
<span id="cb5-519"><a href="#cb5-519" tabindex="-1"></a>                           <span class="at">net.SR =</span> netSR,</span>
<span id="cb5-520"><a href="#cb5-520" tabindex="-1"></a>                           <span class="at">gross.PnL =</span> grossPnL,</span>
<span id="cb5-521"><a href="#cb5-521" tabindex="-1"></a>                           <span class="at">net.PnL =</span> netPnL,</span>
<span id="cb5-522"><a href="#cb5-522" tabindex="-1"></a>                           <span class="at">av.daily.ntrans =</span> av.daily.ntrades,</span>
<span id="cb5-523"><a href="#cb5-523" tabindex="-1"></a>                           <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-524"><a href="#cb5-524" tabindex="-1"></a>    </span>
<span id="cb5-525"><a href="#cb5-525" tabindex="-1"></a>    <span class="co"># putting all summaries together</span></span>
<span id="cb5-526"><a href="#cb5-526" tabindex="-1"></a>    </span>
<span id="cb5-527"><a href="#cb5-527" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">exists</span>(<span class="st">&quot;summary.pair.trading&quot;</span>)) summary.pair.trading <span class="ot">&lt;-</span> summary_ <span class="cf">else</span></span>
<span id="cb5-528"><a href="#cb5-528" tabindex="-1"></a>      summary.pair.trading <span class="ot">&lt;-</span> <span class="fu">rbind</span>(summary.pair.trading, summary_)</span>
<span id="cb5-529"><a href="#cb5-529" tabindex="-1"></a>    </span>
<span id="cb5-530"><a href="#cb5-530" tabindex="-1"></a>    <span class="co"># deleting working files not needed any more</span></span>
<span id="cb5-531"><a href="#cb5-531" tabindex="-1"></a>    <span class="fu">rm</span>(grossSR, netSR, netCR,</span>
<span id="cb5-532"><a href="#cb5-532" tabindex="-1"></a>       grossPnL, netPnL,</span>
<span id="cb5-533"><a href="#cb5-533" tabindex="-1"></a>       av.daily.ntrades, stat,</span>
<span id="cb5-534"><a href="#cb5-534" tabindex="-1"></a>       summary_)</span>
<span id="cb5-535"><a href="#cb5-535" tabindex="-1"></a>  }</span>
<span id="cb5-536"><a href="#cb5-536" tabindex="-1"></a>  </span>
<span id="cb5-537"><a href="#cb5-537" tabindex="-1"></a>  <span class="co"># net.SR - spread av_ratio</span></span>
<span id="cb5-538"><a href="#cb5-538" tabindex="-1"></a>  heatmap_sr_cross_mr <span class="ot">&lt;-</span> <span class="fu">plotHeatmap</span>(<span class="at">data_plot =</span> summary.pair.trading, <span class="co"># dataset (data.frame) with calculations</span></span>
<span id="cb5-539"><a href="#cb5-539" tabindex="-1"></a>                                     <span class="at">col_vlabels =</span> <span class="st">&quot;EMA.fast&quot;</span>, <span class="co"># column name with the labels for a vertical axis (string)</span></span>
<span id="cb5-540"><a href="#cb5-540" tabindex="-1"></a>                                     <span class="at">col_hlabels =</span> <span class="st">&quot;EMA.slow&quot;</span>, <span class="co"># column name with the labels for a horizontal axis (string)</span></span>
<span id="cb5-541"><a href="#cb5-541" tabindex="-1"></a>                                     <span class="at">col_variable =</span> <span class="st">&quot;net.SR&quot;</span>, <span class="co"># column name with the variable to show (string)</span></span>
<span id="cb5-542"><a href="#cb5-542" tabindex="-1"></a>                                     <span class="at">main =</span> <span class="fu">paste</span>(selected_quarter, <span class="st">&quot;Sensitivity analysis for mean reversion stategy based on EMA crossover&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;: &quot;</span>),</span>
<span id="cb5-543"><a href="#cb5-543" tabindex="-1"></a>                                     <span class="at">label_size =</span> <span class="dv">3</span>)</span>
<span id="cb5-544"><a href="#cb5-544" tabindex="-1"></a>  </span>
<span id="cb5-545"><a href="#cb5-545" tabindex="-1"></a>  sensitivities_cross_mr[[selected_quarter]] <span class="ot">&lt;-</span> summary.pair.trading</span>
<span id="cb5-546"><a href="#cb5-546" tabindex="-1"></a>  <span class="fu">rm</span>(summary.pair.trading)</span>
<span id="cb5-547"><a href="#cb5-547" tabindex="-1"></a>  heatmap_list_cross_mr[[selected_quarter]] <span class="ot">&lt;-</span> heatmap_sr_cross_mr</span>
<span id="cb5-548"><a href="#cb5-548" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-4-1.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-4-2.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-4-3.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-4-4.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-4-5.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-4-6.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-4-7.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-4-8.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-4-9.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-4-10.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-4-11.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-4-12.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-4-13.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-4-14.png" width="672" /></p>
<p>The results were depicted using heatmaps containing Sharpe ratios,
considering the return per unit of volatility. The largest value
indicated which parameter combination generated the best performance on
the in-sample data.</p>
<p>The optimal strategy was crossover EMA where fast EMA was 60 days and
slow EMA was 70 days. The P&amp;L graphs above display the performance
of this particular strategy.</p>
<p>Heatmaps supporting the choice of strategy are shown below. Quarterly
outputs, as well as the mean across quarters are shown.</p>
<div id="single-ema-momentum" class="section level2">
<h2>Single EMA Momentum</h2>
<p>Single EMA momentum strategies performed poorly. All combinations
yielded negative Sharpe ratios, especially at fewer days.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="co"># Combined</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="cf">for</span> (output <span class="cf">in</span> heatmap_list_single) {</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>  <span class="fu">print</span>(output)</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-5-1.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-5-2.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-5-3.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-5-4.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-5-5.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-5-6.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-5-7.png" width="672" /></p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="co"># Mean</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>net_srs_single <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(sensitivities_single)) {</span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>  net_srs_single[[i]] <span class="ot">&lt;-</span> <span class="fu">as.list</span>(sensitivities_single[[i]][<span class="fu">c</span>(<span class="st">&quot;net.SR&quot;</span>)])[[<span class="dv">1</span>]]</span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>}</span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a>average_net_sr_single <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="fu">seq_along</span>(net_srs_single[[<span class="dv">1</span>]]), <span class="cf">function</span>(i) {</span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a>  <span class="fu">mean</span>(<span class="fu">sapply</span>(net_srs_single, <span class="cf">function</span>(x) x[[i]]))</span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a>})</span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a>average_net_sr_single <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">net.SR =</span> average_net_sr_single)</span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a></span>
<span id="cb7-13"><a href="#cb7-13" tabindex="-1"></a>sensitivities_average_single <span class="ot">&lt;-</span> sensitivities_single[[<span class="dv">1</span>]][<span class="fu">c</span>(<span class="st">&quot;Close&quot;</span>, <span class="st">&quot;EMA&quot;</span>)]</span>
<span id="cb7-14"><a href="#cb7-14" tabindex="-1"></a>sensitivities_average_single <span class="ot">&lt;-</span> <span class="fu">cbind</span>(sensitivities_average_single, <span class="st">&quot;net.SR&quot;</span> <span class="ot">=</span> average_net_sr_single)</span>
<span id="cb7-15"><a href="#cb7-15" tabindex="-1"></a></span>
<span id="cb7-16"><a href="#cb7-16" tabindex="-1"></a>heatmap_sr_mean_single <span class="ot">&lt;-</span> <span class="fu">plotHeatmap</span>(<span class="at">data_plot =</span> sensitivities_average_single, <span class="co"># dataset (data.frame) with calculations</span></span>
<span id="cb7-17"><a href="#cb7-17" tabindex="-1"></a>                                      <span class="at">col_vlabels =</span> <span class="st">&quot;Close&quot;</span>, <span class="co"># column name with the labels for a vertical axis (string)</span></span>
<span id="cb7-18"><a href="#cb7-18" tabindex="-1"></a>                                      <span class="at">col_hlabels =</span> <span class="st">&quot;EMA&quot;</span>, <span class="co"># column name with the labels for a horizontal axis (string)</span></span>
<span id="cb7-19"><a href="#cb7-19" tabindex="-1"></a>                                      <span class="at">col_variable =</span> <span class="st">&quot;net.SR&quot;</span>, <span class="co"># column name with the variable to show (string)</span></span>
<span id="cb7-20"><a href="#cb7-20" tabindex="-1"></a>                                      <span class="at">main =</span> <span class="fu">paste</span>(<span class="st">&quot;Mean&quot;</span>, <span class="st">&quot;Sensitivity analysis for momentum stategy based on single EMA&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;: &quot;</span>),</span>
<span id="cb7-21"><a href="#cb7-21" tabindex="-1"></a>                                      <span class="at">label_size =</span> <span class="dv">3</span>)</span>
<span id="cb7-22"><a href="#cb7-22" tabindex="-1"></a></span>
<span id="cb7-23"><a href="#cb7-23" tabindex="-1"></a>heatmap_sr_mean_single</span></code></pre></div>
<p><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-5-8.png" width="672" /></p>
</div>
<div id="crossover-ema-momentum" class="section level2">
<h2>Crossover EMA Momentum</h2>
<p>Crossover EMA momentum strategies performed well. Most combinations
produced positive Sharpe ratios with a clear tendency to outperform at
longer day combinations. The best strategy was 60-70 with a Sharpe ratio
of 0.95 and was selected as the strategy for group 1.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="co"># Combined</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a><span class="cf">for</span> (output <span class="cf">in</span> heatmap_list_cross) {</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>  <span class="fu">print</span>(output)</span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-6-1.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-6-2.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-6-3.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-6-4.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-6-5.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-6-6.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-6-7.png" width="672" /></p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="co"># Mean</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>net_srs_cross <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(sensitivities_cross)) {</span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a>  net_srs_cross[[i]] <span class="ot">&lt;-</span> <span class="fu">as.list</span>(sensitivities_cross[[i]][<span class="fu">c</span>(<span class="st">&quot;net.SR&quot;</span>)])[[<span class="dv">1</span>]]</span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a>}</span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a>average_net_sr_cross <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="fu">seq_along</span>(net_srs_cross[[<span class="dv">1</span>]]), <span class="cf">function</span>(i) {</span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a>  <span class="fu">mean</span>(<span class="fu">sapply</span>(net_srs_cross, <span class="cf">function</span>(x) x[[i]]))</span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a>})</span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a>average_net_sr_cross <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">net.SR =</span> average_net_sr_cross)</span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" tabindex="-1"></a>sensitivities_average_cross <span class="ot">&lt;-</span> sensitivities_cross[[<span class="dv">1</span>]][<span class="fu">c</span>(<span class="st">&quot;EMA.fast&quot;</span>, <span class="st">&quot;EMA.slow&quot;</span>)]</span>
<span id="cb9-14"><a href="#cb9-14" tabindex="-1"></a>sensitivities_average_cross <span class="ot">&lt;-</span> <span class="fu">cbind</span>(sensitivities_average_cross, <span class="st">&quot;net.SR&quot;</span> <span class="ot">=</span> average_net_sr_cross)</span>
<span id="cb9-15"><a href="#cb9-15" tabindex="-1"></a></span>
<span id="cb9-16"><a href="#cb9-16" tabindex="-1"></a>heatmap_sr_mean_cross <span class="ot">&lt;-</span> <span class="fu">plotHeatmap</span>(<span class="at">data_plot =</span> sensitivities_average_cross, <span class="co"># dataset (data.frame) with calculations</span></span>
<span id="cb9-17"><a href="#cb9-17" tabindex="-1"></a>                                     <span class="at">col_vlabels =</span> <span class="st">&quot;EMA.fast&quot;</span>, <span class="co"># column name with the labels for a vertical axis (string)</span></span>
<span id="cb9-18"><a href="#cb9-18" tabindex="-1"></a>                                     <span class="at">col_hlabels =</span> <span class="st">&quot;EMA.slow&quot;</span>, <span class="co"># column name with the labels for a horizontal axis (string)</span></span>
<span id="cb9-19"><a href="#cb9-19" tabindex="-1"></a>                                     <span class="at">col_variable =</span> <span class="st">&quot;net.SR&quot;</span>, <span class="co"># column name with the variable to show (string)</span></span>
<span id="cb9-20"><a href="#cb9-20" tabindex="-1"></a>                                     <span class="at">main =</span> <span class="fu">paste</span>(<span class="st">&quot;Mean&quot;</span>, <span class="st">&quot;Sensitivity analysis for momentum stategy based on EMA crossover&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;: &quot;</span>),</span>
<span id="cb9-21"><a href="#cb9-21" tabindex="-1"></a>                                     <span class="at">label_size =</span> <span class="dv">3</span>)</span>
<span id="cb9-22"><a href="#cb9-22" tabindex="-1"></a></span>
<span id="cb9-23"><a href="#cb9-23" tabindex="-1"></a>heatmap_sr_mean_cross</span></code></pre></div>
<p><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-6-8.png" width="672" /></p>
</div>
<div id="single-ema-mean-reversion" class="section level2">
<h2>Single EMA Mean Reversion</h2>
<p>Single EMA mean reversion strategies performed even worse than their
momentum equivalent.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="co"># Combined</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="cf">for</span> (output <span class="cf">in</span> heatmap_list_single_mr) {</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>  <span class="fu">print</span>(output)</span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-7-1.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-7-2.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-7-3.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-7-4.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-7-5.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-7-6.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-7-7.png" width="672" /></p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="co"># Mean</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>net_srs_single_mr <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(sensitivities_single_mr)) {</span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>  net_srs_single_mr[[i]] <span class="ot">&lt;-</span> <span class="fu">as.list</span>(sensitivities_single_mr[[i]][<span class="fu">c</span>(<span class="st">&quot;net.SR&quot;</span>)])[[<span class="dv">1</span>]]</span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a>}</span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a>average_net_sr_single_mr <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="fu">seq_along</span>(net_srs_single_mr[[<span class="dv">1</span>]]), <span class="cf">function</span>(i) {</span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a>  <span class="fu">mean</span>(<span class="fu">sapply</span>(net_srs_single_mr, <span class="cf">function</span>(x) x[[i]]))</span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a>})</span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a>average_net_sr_single_mr <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">net.SR =</span> average_net_sr_single_mr)</span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a></span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a>sensitivities_average_single_mr <span class="ot">&lt;-</span> sensitivities_single_mr[[<span class="dv">1</span>]][<span class="fu">c</span>(<span class="st">&quot;Close&quot;</span>, <span class="st">&quot;EMA&quot;</span>)]</span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a>sensitivities_average_single_mr <span class="ot">&lt;-</span> <span class="fu">cbind</span>(sensitivities_average_single_mr, <span class="st">&quot;net.SR&quot;</span> <span class="ot">=</span> average_net_sr_single_mr)</span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a></span>
<span id="cb11-16"><a href="#cb11-16" tabindex="-1"></a>heatmap_sr_mean_single_mr <span class="ot">&lt;-</span> <span class="fu">plotHeatmap</span>(<span class="at">data_plot =</span> sensitivities_average_single_mr, <span class="co"># dataset (data.frame) with calculations</span></span>
<span id="cb11-17"><a href="#cb11-17" tabindex="-1"></a>                                         <span class="at">col_vlabels =</span> <span class="st">&quot;Close&quot;</span>, <span class="co"># column name with the labels for a vertical axis (string)</span></span>
<span id="cb11-18"><a href="#cb11-18" tabindex="-1"></a>                                         <span class="at">col_hlabels =</span> <span class="st">&quot;EMA&quot;</span>, <span class="co"># column name with the labels for a horizontal axis (string)</span></span>
<span id="cb11-19"><a href="#cb11-19" tabindex="-1"></a>                                         <span class="at">col_variable =</span> <span class="st">&quot;net.SR&quot;</span>, <span class="co"># column name with the variable to show (string)</span></span>
<span id="cb11-20"><a href="#cb11-20" tabindex="-1"></a>                                         <span class="at">main =</span> <span class="fu">paste</span>(<span class="st">&quot;Mean&quot;</span>, <span class="st">&quot;Sensitivity analysis for mean reversion stategy based on single EMA&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;: &quot;</span>),</span>
<span id="cb11-21"><a href="#cb11-21" tabindex="-1"></a>                                         <span class="at">label_size =</span> <span class="dv">3</span>)</span>
<span id="cb11-22"><a href="#cb11-22" tabindex="-1"></a></span>
<span id="cb11-23"><a href="#cb11-23" tabindex="-1"></a>heatmap_sr_mean_single_mr</span></code></pre></div>
<p><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-7-8.png" width="672" /></p>
</div>
<div id="crossover-ema-mean-reversion" class="section level2">
<h2>Crossover EMA Mean Reversion</h2>
<p>Similarly, crossover EMA mean reversion strategies produced negative
Sharpe ratios for all combinations.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="co"># Combined</span></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a><span class="cf">for</span> (output <span class="cf">in</span> heatmap_list_cross_mr) {</span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a>  <span class="fu">print</span>(output)</span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-8-1.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-8-2.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-8-3.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-8-4.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-8-5.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-8-6.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-8-7.png" width="672" /></p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="co"># Mean</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>net_srs_cross_mr <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(sensitivities_cross_mr)) {</span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a>  net_srs_cross_mr[[i]] <span class="ot">&lt;-</span> <span class="fu">as.list</span>(sensitivities_cross_mr[[i]][<span class="fu">c</span>(<span class="st">&quot;net.SR&quot;</span>)])[[<span class="dv">1</span>]]</span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a>}</span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a>average_net_sr_cross_mr <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="fu">seq_along</span>(net_srs_cross_mr[[<span class="dv">1</span>]]), <span class="cf">function</span>(i) {</span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a>  <span class="fu">mean</span>(<span class="fu">sapply</span>(net_srs_cross_mr, <span class="cf">function</span>(x) x[[i]]))</span>
<span id="cb13-10"><a href="#cb13-10" tabindex="-1"></a>})</span>
<span id="cb13-11"><a href="#cb13-11" tabindex="-1"></a>average_net_sr_cross_mr <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">net.SR =</span> average_net_sr_cross_mr)</span>
<span id="cb13-12"><a href="#cb13-12" tabindex="-1"></a></span>
<span id="cb13-13"><a href="#cb13-13" tabindex="-1"></a>sensitivities_average_cross_mr <span class="ot">&lt;-</span> sensitivities_cross_mr[[<span class="dv">1</span>]][<span class="fu">c</span>(<span class="st">&quot;EMA.fast&quot;</span>, <span class="st">&quot;EMA.slow&quot;</span>)]</span>
<span id="cb13-14"><a href="#cb13-14" tabindex="-1"></a>sensitivities_average_cross_mr <span class="ot">&lt;-</span> <span class="fu">cbind</span>(sensitivities_average_cross_mr, <span class="st">&quot;net.SR&quot;</span> <span class="ot">=</span> average_net_sr_cross_mr)</span>
<span id="cb13-15"><a href="#cb13-15" tabindex="-1"></a></span>
<span id="cb13-16"><a href="#cb13-16" tabindex="-1"></a>heatmap_sr_mean_cross_mr <span class="ot">&lt;-</span> <span class="fu">plotHeatmap</span>(<span class="at">data_plot =</span> sensitivities_average_cross_mr, <span class="co"># dataset (data.frame) with calculations</span></span>
<span id="cb13-17"><a href="#cb13-17" tabindex="-1"></a>                                        <span class="at">col_vlabels =</span> <span class="st">&quot;EMA.fast&quot;</span>, <span class="co"># column name with the labels for a vertical axis (string)</span></span>
<span id="cb13-18"><a href="#cb13-18" tabindex="-1"></a>                                        <span class="at">col_hlabels =</span> <span class="st">&quot;EMA.slow&quot;</span>, <span class="co"># column name with the labels for a horizontal axis (string)</span></span>
<span id="cb13-19"><a href="#cb13-19" tabindex="-1"></a>                                        <span class="at">col_variable =</span> <span class="st">&quot;net.SR&quot;</span>, <span class="co"># column name with the variable to show (string)</span></span>
<span id="cb13-20"><a href="#cb13-20" tabindex="-1"></a>                                        <span class="at">main =</span> <span class="fu">paste</span>(<span class="st">&quot;Mean&quot;</span>, <span class="st">&quot;Sensitivity analysis for mean reversion stategy based on EMA crossover&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;: &quot;</span>),</span>
<span id="cb13-21"><a href="#cb13-21" tabindex="-1"></a>                                        <span class="at">label_size =</span> <span class="dv">3</span>)</span>
<span id="cb13-22"><a href="#cb13-22" tabindex="-1"></a></span>
<span id="cb13-23"><a href="#cb13-23" tabindex="-1"></a>heatmap_sr_mean_cross_mr</span></code></pre></div>
<p><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-8-8.png" width="672" /></p>
</div>
</div>
<div id="group-2" class="section level1">
<h1>Group 2</h1>
<p>Group 2 data was limited to gold and silver. NA values were inserted
in the first and last 10 minutes of the trading session to avoid trading
on volatile and reactive parts of the day and to focus on intraday
trading.</p>
<p>The two assets were grouped for pair trading and volatility breakout
was the approach of choice in the algorithm. Being part of the same
precious metals category of commodities, it was plausible to assume some
level of common price movement. A spread was calculated, which formed
the basis of signals for trading (volatility bands were set around the
spread). Both levels and returns were tested for the spread. A short
position was initially triggered whenever the signal exceeded the upper
bound and then continued whilst the signal remained above the lower
bound and a long position otherwise. This strategy was always a mean
reversion strategy being against the market.</p>
<p>In order to determine the optimal parameters for the models, multiple
combinations of volatility memories and multipliers were tested: every
combination of 60-180 day volatility memories and 0.5-3.5
multipliers.</p>
<p>All positions were exited in the first 10 and last 10 minutes of the
trading session and in between sessions. Any remaining missing ratio
value was populated with the previous value for completeness.</p>
<p>Gross P&amp;L (accounting for point values), net P&amp;L (reflecting
transaction costs) and number of trades were calculated. The data was
then aggregated to daily level and the following metrics were
calculated: Sharpe ratio, Calmar ratio, average number of trades,
cumulative sum of gross P&amp;L, cumulative sum of net P&amp;L and a
final test statistic.</p>
<p>The entire process was repeated for all in-sample quarters.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a>heatmap_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>heatmap_list2 <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a>sensitivities <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a>sensitivities2 <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a><span class="cf">for</span> (selected_quarter <span class="cf">in</span> selected_quarters) {</span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a>  </span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a>  <span class="fu">message</span>(selected_quarter)</span>
<span id="cb14-9"><a href="#cb14-9" tabindex="-1"></a>  </span>
<span id="cb14-10"><a href="#cb14-10" tabindex="-1"></a>  filename_ <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;data/data2_&quot;</span>, selected_quarter, <span class="st">&quot;.RData&quot;</span>)</span>
<span id="cb14-11"><a href="#cb14-11" tabindex="-1"></a>  <span class="fu">load</span>(filename_)</span>
<span id="cb14-12"><a href="#cb14-12" tabindex="-1"></a>  </span>
<span id="cb14-13"><a href="#cb14-13" tabindex="-1"></a>  data.group2 <span class="ot">&lt;-</span> <span class="fu">get</span>(<span class="fu">paste0</span>(<span class="st">&quot;data2_&quot;</span>, selected_quarter))</span>
<span id="cb14-14"><a href="#cb14-14" tabindex="-1"></a>  times_ <span class="ot">&lt;-</span> <span class="fu">substr</span>(<span class="fu">index</span>(data.group2), <span class="dv">12</span>, <span class="dv">19</span>)</span>
<span id="cb14-15"><a href="#cb14-15" tabindex="-1"></a>  </span>
<span id="cb14-16"><a href="#cb14-16" tabindex="-1"></a>  <span class="co"># Keep gold and silver</span></span>
<span id="cb14-17"><a href="#cb14-17" tabindex="-1"></a>  data.group2 <span class="ot">&lt;-</span> data.group2[, <span class="sc">!</span><span class="fu">colnames</span>(data.group2) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;AUD&quot;</span>,<span class="st">&quot;CAD&quot;</span>)]</span>
<span id="cb14-18"><a href="#cb14-18" tabindex="-1"></a>  <span class="fu">names</span>(data.group2)[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;XAG.close&quot;</span>,<span class="st">&quot;XAU.close&quot;</span>)</span>
<span id="cb14-19"><a href="#cb14-19" tabindex="-1"></a>  </span>
<span id="cb14-20"><a href="#cb14-20" tabindex="-1"></a>  data.group2.return <span class="ot">&lt;-</span> <span class="dv">10000</span><span class="sc">*</span><span class="fu">diff.xts</span>(<span class="fu">log</span>(data.group2))</span>
<span id="cb14-21"><a href="#cb14-21" tabindex="-1"></a>  <span class="fu">names</span>(data.group2.return)[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;XAG.return&quot;</span>,<span class="st">&quot;XAU.return&quot;</span>)</span>
<span id="cb14-22"><a href="#cb14-22" tabindex="-1"></a>  </span>
<span id="cb14-23"><a href="#cb14-23" tabindex="-1"></a>  data.group2 <span class="ot">&lt;-</span> <span class="fu">merge</span>(data.group2[, <span class="fu">c</span>(<span class="st">&quot;XAG.close&quot;</span>, <span class="st">&quot;XAU.close&quot;</span>)],</span>
<span id="cb14-24"><a href="#cb14-24" tabindex="-1"></a>                       data.group2.return[, <span class="fu">c</span>(<span class="st">&quot;XAG.return&quot;</span>, <span class="st">&quot;XAU.return&quot;</span>)])</span>
<span id="cb14-25"><a href="#cb14-25" tabindex="-1"></a>  </span>
<span id="cb14-26"><a href="#cb14-26" tabindex="-1"></a>  myTheme <span class="ot">&lt;-</span> <span class="fu">chart_theme</span>()</span>
<span id="cb14-27"><a href="#cb14-27" tabindex="-1"></a>  myTheme<span class="sc">$</span>col<span class="sc">$</span>line.col <span class="ot">&lt;-</span> <span class="st">&quot;darkblue&quot;</span></span>
<span id="cb14-28"><a href="#cb14-28" tabindex="-1"></a></span>
<span id="cb14-29"><a href="#cb14-29" tabindex="-1"></a>  <span class="co"># the following common assumptions were defined:</span></span>
<span id="cb14-30"><a href="#cb14-30" tabindex="-1"></a>  <span class="co"># 1.  do not use in calculations the data from the first and last 10 minutes of the session (18:01--18:10 and 16:51--17:00) – put missing values there,</span></span>
<span id="cb14-31"><a href="#cb14-31" tabindex="-1"></a>  </span>
<span id="cb14-32"><a href="#cb14-32" tabindex="-1"></a>  <span class="co"># lets put missing values for these periods</span></span>
<span id="cb14-33"><a href="#cb14-33" tabindex="-1"></a>  data.group2[<span class="st">&quot;T18:01/T18:10&quot;</span>,] <span class="ot">&lt;-</span> <span class="cn">NA</span> </span>
<span id="cb14-34"><a href="#cb14-34" tabindex="-1"></a>  data.group2[<span class="st">&quot;T16:51/T17:00&quot;</span>,] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb14-35"><a href="#cb14-35" tabindex="-1"></a>  </span>
<span id="cb14-36"><a href="#cb14-36" tabindex="-1"></a>  <span class="fu">layout</span>(<span class="fu">matrix</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="dv">2</span>, <span class="dv">2</span>))</span>
<span id="cb14-37"><a href="#cb14-37" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">chart_Series</span>(data.group2<span class="sc">$</span>XAG.close, <span class="at">theme =</span> myTheme))</span>
<span id="cb14-38"><a href="#cb14-38" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">chart_Series</span>(data.group2<span class="sc">$</span>XAU.close, <span class="at">theme =</span> myTheme))</span>
<span id="cb14-39"><a href="#cb14-39" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">chart_Series</span>(data.group2<span class="sc">$</span>XAG.return, <span class="at">theme =</span> myTheme))</span>
<span id="cb14-40"><a href="#cb14-40" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">chart_Series</span>(data.group2<span class="sc">$</span>XAU.return, <span class="at">theme =</span> myTheme))</span>
<span id="cb14-41"><a href="#cb14-41" tabindex="-1"></a>  <span class="fu">layout</span>(<span class="fu">matrix</span>(<span class="dv">1</span>))</span>
<span id="cb14-42"><a href="#cb14-42" tabindex="-1"></a>  </span>
<span id="cb14-43"><a href="#cb14-43" tabindex="-1"></a>  <span class="do">###################################################################</span></span>
<span id="cb14-44"><a href="#cb14-44" tabindex="-1"></a>  <span class="co"># formulate a spread: P1 - m * P2 (P_XAU - m * P_XAG) </span></span>
<span id="cb14-45"><a href="#cb14-45" tabindex="-1"></a>  <span class="co"># where m = m1/m2 is based on average ratio between the prices</span></span>
<span id="cb14-46"><a href="#cb14-46" tabindex="-1"></a>  <span class="co"># on the PREVIOUS day</span></span>
<span id="cb14-47"><a href="#cb14-47" tabindex="-1"></a>  </span>
<span id="cb14-48"><a href="#cb14-48" tabindex="-1"></a>  <span class="co"># spread is a signal to our model, which shows whether to take </span></span>
<span id="cb14-49"><a href="#cb14-49" tabindex="-1"></a>  <span class="co"># position or not (volatility bands around the spread)</span></span>
<span id="cb14-50"><a href="#cb14-50" tabindex="-1"></a>  </span>
<span id="cb14-51"><a href="#cb14-51" tabindex="-1"></a>  <span class="co"># we assume the mean reverting behavior of the spread</span></span>
<span id="cb14-52"><a href="#cb14-52" tabindex="-1"></a>  </span>
<span id="cb14-53"><a href="#cb14-53" tabindex="-1"></a>  <span class="do">####################################################################</span></span>
<span id="cb14-54"><a href="#cb14-54" tabindex="-1"></a>  <span class="co"># lets calculate average ratio of prices on the daily basis</span></span>
<span id="cb14-55"><a href="#cb14-55" tabindex="-1"></a>  </span>
<span id="cb14-56"><a href="#cb14-56" tabindex="-1"></a>  index_posix <span class="ot">&lt;-</span> <span class="fu">index</span>(data.group2)</span>
<span id="cb14-57"><a href="#cb14-57" tabindex="-1"></a>  time_component <span class="ot">&lt;-</span> <span class="fu">format</span>(index_posix, <span class="at">format =</span> <span class="st">&quot;%H:%M:%S&quot;</span>)</span>
<span id="cb14-58"><a href="#cb14-58" tabindex="-1"></a>  target_time <span class="ot">&lt;-</span> <span class="st">&quot;17:00:00&quot;</span></span>
<span id="cb14-59"><a href="#cb14-59" tabindex="-1"></a>  indices <span class="ot">&lt;-</span> <span class="fu">which</span>(time_component <span class="sc">==</span> target_time)</span>
<span id="cb14-60"><a href="#cb14-60" tabindex="-1"></a></span>
<span id="cb14-61"><a href="#cb14-61" tabindex="-1"></a>  cmd.av.ratio <span class="ot">&lt;-</span> <span class="fu">period.apply</span>(data.group2,</span>
<span id="cb14-62"><a href="#cb14-62" tabindex="-1"></a>                              <span class="at">INDEX =</span> indices,</span>
<span id="cb14-63"><a href="#cb14-63" tabindex="-1"></a>                              <span class="cf">function</span>(x) <span class="fu">mean</span>(x<span class="sc">$</span>XAU.close<span class="sc">/</span>x<span class="sc">$</span>XAG.close, </span>
<span id="cb14-64"><a href="#cb14-64" tabindex="-1"></a>                                               <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb14-65"><a href="#cb14-65" tabindex="-1"></a>  )</span>
<span id="cb14-66"><a href="#cb14-66" tabindex="-1"></a>  </span>
<span id="cb14-67"><a href="#cb14-67" tabindex="-1"></a>  <span class="fu">names</span>(cmd.av.ratio) <span class="ot">&lt;-</span> <span class="st">&quot;av.ratio&quot;</span></span>
<span id="cb14-68"><a href="#cb14-68" tabindex="-1"></a>  </span>
<span id="cb14-69"><a href="#cb14-69" tabindex="-1"></a>  <span class="co"># about 64-74 XAG units per each unit of XAU (future)</span></span>
<span id="cb14-70"><a href="#cb14-70" tabindex="-1"></a>  </span>
<span id="cb14-71"><a href="#cb14-71" tabindex="-1"></a>  <span class="co"># calculations based on the first day</span></span>
<span id="cb14-72"><a href="#cb14-72" tabindex="-1"></a>  <span class="co"># will be used on the second day, etc.</span></span>
<span id="cb14-73"><a href="#cb14-73" tabindex="-1"></a>  <span class="co"># move the time index to 18:00 of the next trading day (same day)</span></span>
<span id="cb14-74"><a href="#cb14-74" tabindex="-1"></a></span>
<span id="cb14-75"><a href="#cb14-75" tabindex="-1"></a>  <span class="co"># some of the dates might be Fridays and in this case</span></span>
<span id="cb14-76"><a href="#cb14-76" tabindex="-1"></a>  <span class="co"># we would move the index to 18:00 on Sunday</span></span>
<span id="cb14-77"><a href="#cb14-77" tabindex="-1"></a>  <span class="co"># 6 = Friday</span></span>
<span id="cb14-78"><a href="#cb14-78" tabindex="-1"></a>  <span class="co"># use if_else() from dplyr instead</span></span>
<span id="cb14-79"><a href="#cb14-79" tabindex="-1"></a></span>
<span id="cb14-80"><a href="#cb14-80" tabindex="-1"></a>  <span class="fu">index</span>(cmd.av.ratio) <span class="ot">&lt;-</span> </span>
<span id="cb14-81"><a href="#cb14-81" tabindex="-1"></a>    <span class="fu">ceiling_date</span>(<span class="fu">index</span>(cmd.av.ratio), <span class="st">&quot;day&quot;</span>) <span class="sc">-</span> </span>
<span id="cb14-82"><a href="#cb14-82" tabindex="-1"></a>    <span class="fu">hours</span>(<span class="dv">6</span>) <span class="sc">+</span> </span>
<span id="cb14-83"><a href="#cb14-83" tabindex="-1"></a>    <span class="fu">minutes</span>(<span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb14-84"><a href="#cb14-84" tabindex="-1"></a>    <span class="fu">if_else</span>(<span class="fu">wday</span>(<span class="fu">index</span>(cmd.av.ratio)) <span class="sc">==</span> <span class="dv">6</span>, </span>
<span id="cb14-85"><a href="#cb14-85" tabindex="-1"></a>            <span class="fu">days</span>(<span class="dv">2</span>),</span>
<span id="cb14-86"><a href="#cb14-86" tabindex="-1"></a>            <span class="fu">days</span>(<span class="dv">0</span>))  </span>
<span id="cb14-87"><a href="#cb14-87" tabindex="-1"></a>  </span>
<span id="cb14-88"><a href="#cb14-88" tabindex="-1"></a>  <span class="do">###################################################################</span></span>
<span id="cb14-89"><a href="#cb14-89" tabindex="-1"></a>  <span class="co"># alternative spread based on RETURNS:</span></span>
<span id="cb14-90"><a href="#cb14-90" tabindex="-1"></a>  <span class="co"># r1 - ms * r2 (r_XAU - ms * r_XAG) </span></span>
<span id="cb14-91"><a href="#cb14-91" tabindex="-1"></a>  <span class="co"># where ms = s1/s2 is based on the ratio of standard</span></span>
<span id="cb14-92"><a href="#cb14-92" tabindex="-1"></a>  <span class="co"># deviations of returns on the PREVIOUS day</span></span>
<span id="cb14-93"><a href="#cb14-93" tabindex="-1"></a>  </span>
<span id="cb14-94"><a href="#cb14-94" tabindex="-1"></a>  cmd.sds.ratio <span class="ot">&lt;-</span> <span class="fu">period.apply</span>(data.group2,</span>
<span id="cb14-95"><a href="#cb14-95" tabindex="-1"></a>                               <span class="at">INDEX =</span> indices,</span>
<span id="cb14-96"><a href="#cb14-96" tabindex="-1"></a>                               <span class="cf">function</span>(x) <span class="fu">sd</span>(x<span class="sc">$</span>XAU.return, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span></span>
<span id="cb14-97"><a href="#cb14-97" tabindex="-1"></a>                                 <span class="fu">sd</span>(x<span class="sc">$</span>XAG.return, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb14-98"><a href="#cb14-98" tabindex="-1"></a>  )</span>
<span id="cb14-99"><a href="#cb14-99" tabindex="-1"></a>  </span>
<span id="cb14-100"><a href="#cb14-100" tabindex="-1"></a>  <span class="fu">names</span>(cmd.sds.ratio) <span class="ot">&lt;-</span> <span class="st">&quot;sds.ratio&quot;</span></span>
<span id="cb14-101"><a href="#cb14-101" tabindex="-1"></a>  </span>
<span id="cb14-102"><a href="#cb14-102" tabindex="-1"></a>  <span class="co"># between 0.2 and 0.65 XAG units </span></span>
<span id="cb14-103"><a href="#cb14-103" tabindex="-1"></a>  <span class="co"># per each unit of XAU (future)</span></span>
<span id="cb14-104"><a href="#cb14-104" tabindex="-1"></a>  </span>
<span id="cb14-105"><a href="#cb14-105" tabindex="-1"></a>  <span class="co"># move the index to 18:00 of the next trading day (same day)</span></span>
<span id="cb14-106"><a href="#cb14-106" tabindex="-1"></a>  </span>
<span id="cb14-107"><a href="#cb14-107" tabindex="-1"></a>  <span class="fu">index</span>(cmd.sds.ratio) <span class="ot">&lt;-</span> </span>
<span id="cb14-108"><a href="#cb14-108" tabindex="-1"></a>    <span class="fu">ceiling_date</span>(<span class="fu">index</span>(cmd.sds.ratio), <span class="st">&quot;day&quot;</span>) <span class="sc">-</span></span>
<span id="cb14-109"><a href="#cb14-109" tabindex="-1"></a>    <span class="fu">hours</span>(<span class="dv">6</span>) <span class="sc">+</span> </span>
<span id="cb14-110"><a href="#cb14-110" tabindex="-1"></a>    <span class="fu">minutes</span>(<span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb14-111"><a href="#cb14-111" tabindex="-1"></a>    <span class="fu">if_else</span>(<span class="fu">wday</span>(<span class="fu">index</span>(cmd.sds.ratio)) <span class="sc">==</span> <span class="dv">6</span>, </span>
<span id="cb14-112"><a href="#cb14-112" tabindex="-1"></a>            <span class="fu">days</span>(<span class="dv">2</span>), </span>
<span id="cb14-113"><a href="#cb14-113" tabindex="-1"></a>            <span class="fu">days</span>(<span class="dv">0</span>))</span>
<span id="cb14-114"><a href="#cb14-114" tabindex="-1"></a>  </span>
<span id="cb14-115"><a href="#cb14-115" tabindex="-1"></a>  <span class="co"># merge our basic 5 min data with daily calculations</span></span>
<span id="cb14-116"><a href="#cb14-116" tabindex="-1"></a>  </span>
<span id="cb14-117"><a href="#cb14-117" tabindex="-1"></a>  data.group2b <span class="ot">&lt;-</span> <span class="fu">merge</span>(data.group2,</span>
<span id="cb14-118"><a href="#cb14-118" tabindex="-1"></a>                    cmd.av.ratio, </span>
<span id="cb14-119"><a href="#cb14-119" tabindex="-1"></a>                    cmd.sds.ratio)</span>
<span id="cb14-120"><a href="#cb14-120" tabindex="-1"></a>  </span>
<span id="cb14-121"><a href="#cb14-121" tabindex="-1"></a>  <span class="co"># missings in a the last 2 columns</span></span>
<span id="cb14-122"><a href="#cb14-122" tabindex="-1"></a>  <span class="co"># which should be filled with the last non-missing value</span></span>
<span id="cb14-123"><a href="#cb14-123" tabindex="-1"></a>  <span class="co"># (last multiplier is used until there is a new one)</span></span>
<span id="cb14-124"><a href="#cb14-124" tabindex="-1"></a>  </span>
<span id="cb14-125"><a href="#cb14-125" tabindex="-1"></a>  data.group2b<span class="sc">$</span>av.ratio <span class="ot">&lt;-</span> <span class="fu">na.locf</span>(data.group2b<span class="sc">$</span>av.ratio,</span>
<span id="cb14-126"><a href="#cb14-126" tabindex="-1"></a>                               <span class="at">na.rm =</span> <span class="cn">FALSE</span>)</span>
<span id="cb14-127"><a href="#cb14-127" tabindex="-1"></a>  data.group2b<span class="sc">$</span>sds.ratio <span class="ot">&lt;-</span> <span class="fu">na.locf</span>(data.group2b<span class="sc">$</span>sds.ratio,</span>
<span id="cb14-128"><a href="#cb14-128" tabindex="-1"></a>                                <span class="at">na.rm =</span> <span class="cn">FALSE</span>)</span>
<span id="cb14-129"><a href="#cb14-129" tabindex="-1"></a>  </span>
<span id="cb14-130"><a href="#cb14-130" tabindex="-1"></a>  <span class="co"># exclude weekends from data</span></span>
<span id="cb14-131"><a href="#cb14-131" tabindex="-1"></a>  </span>
<span id="cb14-132"><a href="#cb14-132" tabindex="-1"></a>  <span class="fu">table</span>(<span class="fu">wday</span>(data.group2b))</span>
<span id="cb14-133"><a href="#cb14-133" tabindex="-1"></a>  </span>
<span id="cb14-134"><a href="#cb14-134" tabindex="-1"></a>  <span class="co"># there are no rows with 7 (Saturday)</span></span>
<span id="cb14-135"><a href="#cb14-135" tabindex="-1"></a>  </span>
<span id="cb14-136"><a href="#cb14-136" tabindex="-1"></a>  <span class="co"># calculate the spread (in 2 variants)</span></span>
<span id="cb14-137"><a href="#cb14-137" tabindex="-1"></a>  data.group2b<span class="sc">$</span>spread_avratio <span class="ot">&lt;-</span> </span>
<span id="cb14-138"><a href="#cb14-138" tabindex="-1"></a>    data.group2b<span class="sc">$</span>XAU.close <span class="sc">-</span></span>
<span id="cb14-139"><a href="#cb14-139" tabindex="-1"></a>    data.group2b<span class="sc">$</span>av.ratio <span class="sc">*</span> data.group2b<span class="sc">$</span>XAG.close</span>
<span id="cb14-140"><a href="#cb14-140" tabindex="-1"></a>  </span>
<span id="cb14-141"><a href="#cb14-141" tabindex="-1"></a>  data.group2b<span class="sc">$</span>spread_sdsratio <span class="ot">&lt;-</span> </span>
<span id="cb14-142"><a href="#cb14-142" tabindex="-1"></a>    data.group2b<span class="sc">$</span>XAU.return <span class="sc">-</span> </span>
<span id="cb14-143"><a href="#cb14-143" tabindex="-1"></a>    data.group2b<span class="sc">$</span>sds.ratio <span class="sc">*</span> data.group2b<span class="sc">$</span>XAG.return</span>
<span id="cb14-144"><a href="#cb14-144" tabindex="-1"></a>  </span>
<span id="cb14-145"><a href="#cb14-145" tabindex="-1"></a>  <span class="co"># assume we do not trade within the first 10-mins of the day</span></span>
<span id="cb14-146"><a href="#cb14-146" tabindex="-1"></a>  <span class="co"># and exit all positions 10 minutes before the end of quotations</span></span>
<span id="cb14-147"><a href="#cb14-147" tabindex="-1"></a>  </span>
<span id="cb14-148"><a href="#cb14-148" tabindex="-1"></a>  <span class="co"># create a pos_flat vector and fill it with 0s</span></span>
<span id="cb14-149"><a href="#cb14-149" tabindex="-1"></a>  pos_flat <span class="ot">&lt;-</span> <span class="fu">xts</span>(<span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">nrow</span>(data.group2b)), <span class="fu">index</span>(data.group2b))</span>
<span id="cb14-150"><a href="#cb14-150" tabindex="-1"></a>  </span>
<span id="cb14-151"><a href="#cb14-151" tabindex="-1"></a>  <span class="co"># we do not trade within the first 10 mins (18:00-18:10) </span></span>
<span id="cb14-152"><a href="#cb14-152" tabindex="-1"></a>  <span class="co"># but also before that time when session was inactive</span></span>
<span id="cb14-153"><a href="#cb14-153" tabindex="-1"></a>  <span class="co"># and last 10 mins of the session (16:51-17:00)</span></span>
<span id="cb14-154"><a href="#cb14-154" tabindex="-1"></a>  <span class="co"># but also after this time when session was inactive</span></span>
<span id="cb14-155"><a href="#cb14-155" tabindex="-1"></a>  </span>
<span id="cb14-156"><a href="#cb14-156" tabindex="-1"></a>  pos_flat[<span class="st">&quot;T16:51/T18:10&quot;</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb14-157"><a href="#cb14-157" tabindex="-1"></a>  </span>
<span id="cb14-158"><a href="#cb14-158" tabindex="-1"></a>  <span class="co"># note this covers Fridays and Sundays as the series goes from 17:00 Friday to 17:05 Sunday</span></span>
<span id="cb14-159"><a href="#cb14-159" tabindex="-1"></a>  </span>
<span id="cb14-160"><a href="#cb14-160" tabindex="-1"></a>  <span class="co"># apply volatility breakout model in a loop for spread and spread2</span></span>
<span id="cb14-161"><a href="#cb14-161" tabindex="-1"></a></span>
<span id="cb14-162"><a href="#cb14-162" tabindex="-1"></a>  <span class="cf">for</span>(volat.sd <span class="cf">in</span> <span class="fu">c</span>(<span class="dv">60</span>, <span class="dv">90</span>, <span class="dv">120</span>, <span class="dv">150</span>, <span class="dv">180</span>)) { <span class="co"># different volatility memories</span></span>
<span id="cb14-163"><a href="#cb14-163" tabindex="-1"></a>    <span class="cf">for</span>(m_ <span class="cf">in</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="dv">1</span>, <span class="fl">1.5</span>, <span class="dv">2</span>, <span class="fl">2.5</span>, <span class="dv">3</span>, <span class="fl">3.5</span>)) { <span class="co"># different multipliers</span></span>
<span id="cb14-164"><a href="#cb14-164" tabindex="-1"></a>      </span>
<span id="cb14-165"><a href="#cb14-165" tabindex="-1"></a>      <span class="fu">message</span>(<span class="fu">paste0</span>(<span class="st">&quot;volat.sd = &quot;</span>, volat.sd,</span>
<span id="cb14-166"><a href="#cb14-166" tabindex="-1"></a>                     <span class="st">&quot;, m_ = &quot;</span>, m_)) </span>
<span id="cb14-167"><a href="#cb14-167" tabindex="-1"></a>      </span>
<span id="cb14-168"><a href="#cb14-168" tabindex="-1"></a>      <span class="co"># calculating elements of the strategy</span></span>
<span id="cb14-169"><a href="#cb14-169" tabindex="-1"></a>      XAU_price <span class="ot">&lt;-</span> <span class="fu">coredata</span>(data.group2b<span class="sc">$</span>XAU.close)</span>
<span id="cb14-170"><a href="#cb14-170" tabindex="-1"></a>      XAG_price <span class="ot">&lt;-</span> <span class="fu">coredata</span>(data.group2b<span class="sc">$</span>XAG.close)</span>
<span id="cb14-171"><a href="#cb14-171" tabindex="-1"></a>      </span>
<span id="cb14-172"><a href="#cb14-172" tabindex="-1"></a>      signal <span class="ot">&lt;-</span> <span class="fu">coredata</span>(data.group2b<span class="sc">$</span>spread_avratio)</span>
<span id="cb14-173"><a href="#cb14-173" tabindex="-1"></a>      signal2 <span class="ot">&lt;-</span> <span class="fu">coredata</span>(data.group2b<span class="sc">$</span>spread_sdsratio)</span>
<span id="cb14-174"><a href="#cb14-174" tabindex="-1"></a>      </span>
<span id="cb14-175"><a href="#cb14-175" tabindex="-1"></a>      upper <span class="ot">&lt;-</span> m_ <span class="sc">*</span> <span class="fu">runsd</span>(signal, volat.sd, </span>
<span id="cb14-176"><a href="#cb14-176" tabindex="-1"></a>                          <span class="at">endrule =</span> <span class="st">&quot;NA&quot;</span>, </span>
<span id="cb14-177"><a href="#cb14-177" tabindex="-1"></a>                          <span class="at">align =</span> <span class="st">&quot;right&quot;</span>)</span>
<span id="cb14-178"><a href="#cb14-178" tabindex="-1"></a>      lower <span class="ot">&lt;-</span> <span class="sc">-</span>m_ <span class="sc">*</span> <span class="fu">runsd</span>(signal, volat.sd, </span>
<span id="cb14-179"><a href="#cb14-179" tabindex="-1"></a>                           <span class="at">endrule =</span> <span class="st">&quot;NA&quot;</span>, </span>
<span id="cb14-180"><a href="#cb14-180" tabindex="-1"></a>                           <span class="at">align =</span> <span class="st">&quot;right&quot;</span>)</span>
<span id="cb14-181"><a href="#cb14-181" tabindex="-1"></a>      </span>
<span id="cb14-182"><a href="#cb14-182" tabindex="-1"></a>      upper2 <span class="ot">&lt;-</span> m_ <span class="sc">*</span> <span class="fu">runsd</span>(signal2, volat.sd, </span>
<span id="cb14-183"><a href="#cb14-183" tabindex="-1"></a>                           <span class="at">endrule =</span> <span class="st">&quot;NA&quot;</span>, </span>
<span id="cb14-184"><a href="#cb14-184" tabindex="-1"></a>                           <span class="at">align =</span> <span class="st">&quot;right&quot;</span>)</span>
<span id="cb14-185"><a href="#cb14-185" tabindex="-1"></a>      lower2 <span class="ot">&lt;-</span> <span class="sc">-</span>m_ <span class="sc">*</span> <span class="fu">runsd</span>(signal2, volat.sd, </span>
<span id="cb14-186"><a href="#cb14-186" tabindex="-1"></a>                            <span class="at">endrule =</span> <span class="st">&quot;NA&quot;</span>, </span>
<span id="cb14-187"><a href="#cb14-187" tabindex="-1"></a>                            <span class="at">align =</span> <span class="st">&quot;right&quot;</span>)</span>
<span id="cb14-188"><a href="#cb14-188" tabindex="-1"></a>      </span>
<span id="cb14-189"><a href="#cb14-189" tabindex="-1"></a>      <span class="co"># position for mean-reverting strategy</span></span>
<span id="cb14-190"><a href="#cb14-190" tabindex="-1"></a>      pos.mr <span class="ot">&lt;-</span> <span class="fu">positionVB_new</span>(signal, lower, upper,</span>
<span id="cb14-191"><a href="#cb14-191" tabindex="-1"></a>                               <span class="at">pos_flat =</span> pos_flat,</span>
<span id="cb14-192"><a href="#cb14-192" tabindex="-1"></a>                               <span class="at">strategy =</span> <span class="st">&quot;mr&quot;</span></span>
<span id="cb14-193"><a href="#cb14-193" tabindex="-1"></a>      )</span>
<span id="cb14-194"><a href="#cb14-194" tabindex="-1"></a>      pos.mr2 <span class="ot">&lt;-</span> <span class="fu">positionVB_new</span>(signal2, lower2, upper2,</span>
<span id="cb14-195"><a href="#cb14-195" tabindex="-1"></a>                                <span class="at">pos_flat =</span> pos_flat,</span>
<span id="cb14-196"><a href="#cb14-196" tabindex="-1"></a>                                <span class="at">strategy =</span> <span class="st">&quot;mr&quot;</span></span>
<span id="cb14-197"><a href="#cb14-197" tabindex="-1"></a>      )</span>
<span id="cb14-198"><a href="#cb14-198" tabindex="-1"></a>      <span class="co"># number of transactions</span></span>
<span id="cb14-199"><a href="#cb14-199" tabindex="-1"></a>      ntrans <span class="ot">&lt;-</span> <span class="fu">abs</span>(<span class="fu">diff.xts</span>(pos.mr))</span>
<span id="cb14-200"><a href="#cb14-200" tabindex="-1"></a>      ntrans2 <span class="ot">&lt;-</span> <span class="fu">abs</span>(<span class="fu">diff.xts</span>(pos.mr2))</span>
<span id="cb14-201"><a href="#cb14-201" tabindex="-1"></a>      </span>
<span id="cb14-202"><a href="#cb14-202" tabindex="-1"></a>      <span class="co"># gross pnl</span></span>
<span id="cb14-203"><a href="#cb14-203" tabindex="-1"></a>      gross.pnl <span class="ot">&lt;-</span> (pos.mr) <span class="sc">*</span></span>
<span id="cb14-204"><a href="#cb14-204" tabindex="-1"></a>        (<span class="fu">diff.xts</span>(XAU_price) <span class="sc">*</span> <span class="dv">100</span> <span class="co"># point value for XAU</span></span>
<span id="cb14-205"><a href="#cb14-205" tabindex="-1"></a>         <span class="sc">-</span> <span class="fu">coredata</span>(data.group2b<span class="sc">$</span>av.ratio) <span class="sc">*</span> <span class="fu">diff.xts</span>(XAG_price) <span class="sc">*</span> <span class="dv">5000</span>) <span class="co"># point value for XAG</span></span>
<span id="cb14-206"><a href="#cb14-206" tabindex="-1"></a>      </span>
<span id="cb14-207"><a href="#cb14-207" tabindex="-1"></a>      gross.pnl2 <span class="ot">&lt;-</span> (pos.mr2) <span class="sc">*</span></span>
<span id="cb14-208"><a href="#cb14-208" tabindex="-1"></a>        (<span class="fu">diff.xts</span>(XAU_price) <span class="sc">*</span> <span class="dv">100</span>  <span class="co"># point value for XAU</span></span>
<span id="cb14-209"><a href="#cb14-209" tabindex="-1"></a>         <span class="sc">-</span> <span class="fu">coredata</span>(data.group2b<span class="sc">$</span>sds.ratio) <span class="sc">*</span> <span class="fu">diff.xts</span>(XAG_price) <span class="sc">*</span> <span class="dv">5000</span>) <span class="co"># point value for XAG</span></span>
<span id="cb14-210"><a href="#cb14-210" tabindex="-1"></a>      </span>
<span id="cb14-211"><a href="#cb14-211" tabindex="-1"></a>      <span class="co"># pnl after  costs</span></span>
<span id="cb14-212"><a href="#cb14-212" tabindex="-1"></a>      <span class="co"># costs = $7 for XAG and $12 for XAU = (12+m*7) in total</span></span>
<span id="cb14-213"><a href="#cb14-213" tabindex="-1"></a>      <span class="co"># costs are always positive</span></span>
<span id="cb14-214"><a href="#cb14-214" tabindex="-1"></a>      </span>
<span id="cb14-215"><a href="#cb14-215" tabindex="-1"></a>      net.pnl <span class="ot">&lt;-</span> gross.pnl <span class="sc">-</span> ntrans <span class="sc">*</span> (<span class="dv">12</span> <span class="sc">+</span> <span class="fu">coredata</span>(data.group2b<span class="sc">$</span>av.ratio) <span class="sc">*</span> <span class="dv">7</span>)</span>
<span id="cb14-216"><a href="#cb14-216" tabindex="-1"></a>      net.pnl2 <span class="ot">&lt;-</span> gross.pnl2 <span class="sc">-</span> ntrans2 <span class="sc">*</span> (<span class="dv">12</span> <span class="sc">+</span> <span class="fu">coredata</span>(data.group2b<span class="sc">$</span>sds.ratio) <span class="sc">*</span> <span class="dv">7</span>)</span>
<span id="cb14-217"><a href="#cb14-217" tabindex="-1"></a>      </span>
<span id="cb14-218"><a href="#cb14-218" tabindex="-1"></a>      <span class="co"># aggregate to daily</span></span>
<span id="cb14-219"><a href="#cb14-219" tabindex="-1"></a></span>
<span id="cb14-220"><a href="#cb14-220" tabindex="-1"></a>      pnl.gross.d <span class="ot">&lt;-</span> <span class="fu">period.apply</span>(gross.pnl, <span class="at">INDEX =</span> indices, </span>
<span id="cb14-221"><a href="#cb14-221" tabindex="-1"></a>                                  <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">sum</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb14-222"><a href="#cb14-222" tabindex="-1"></a>      pnl.gross2.d <span class="ot">&lt;-</span> <span class="fu">period.apply</span>(gross.pnl2, <span class="at">INDEX =</span> indices, </span>
<span id="cb14-223"><a href="#cb14-223" tabindex="-1"></a>                                   <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">sum</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb14-224"><a href="#cb14-224" tabindex="-1"></a>      pnl.net.d <span class="ot">&lt;-</span> <span class="fu">period.apply</span>(net.pnl, <span class="at">INDEX =</span> indices,</span>
<span id="cb14-225"><a href="#cb14-225" tabindex="-1"></a>                                <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">sum</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb14-226"><a href="#cb14-226" tabindex="-1"></a>      pnl.net2.d <span class="ot">&lt;-</span> <span class="fu">period.apply</span>(net.pnl2, <span class="at">INDEX =</span> indices,</span>
<span id="cb14-227"><a href="#cb14-227" tabindex="-1"></a>                                 <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">sum</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb14-228"><a href="#cb14-228" tabindex="-1"></a>      ntrans.d <span class="ot">&lt;-</span> <span class="fu">period.apply</span>(ntrans, <span class="at">INDEX =</span> indices, </span>
<span id="cb14-229"><a href="#cb14-229" tabindex="-1"></a>                               <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">sum</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb14-230"><a href="#cb14-230" tabindex="-1"></a>      ntrans2.d <span class="ot">&lt;-</span> <span class="fu">period.apply</span>(ntrans2, <span class="at">INDEX =</span> indices, </span>
<span id="cb14-231"><a href="#cb14-231" tabindex="-1"></a>                                <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">sum</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb14-232"><a href="#cb14-232" tabindex="-1"></a>      </span>
<span id="cb14-233"><a href="#cb14-233" tabindex="-1"></a>      <span class="co"># calculate summary measures</span></span>
<span id="cb14-234"><a href="#cb14-234" tabindex="-1"></a>      gross.SR <span class="ot">&lt;-</span> <span class="fu">mySR</span>(pnl.gross.d, <span class="at">scale =</span> <span class="dv">252</span>)</span>
<span id="cb14-235"><a href="#cb14-235" tabindex="-1"></a>      gross.SR2 <span class="ot">&lt;-</span> <span class="fu">mySR</span>(pnl.gross2.d, <span class="at">scale =</span> <span class="dv">252</span>)</span>
<span id="cb14-236"><a href="#cb14-236" tabindex="-1"></a>      net.SR <span class="ot">&lt;-</span> <span class="fu">mySR</span>(pnl.net.d, <span class="at">scale =</span> <span class="dv">252</span>)</span>
<span id="cb14-237"><a href="#cb14-237" tabindex="-1"></a>      net.SR2 <span class="ot">&lt;-</span> <span class="fu">mySR</span>(pnl.net2.d, <span class="at">scale =</span> <span class="dv">252</span>)</span>
<span id="cb14-238"><a href="#cb14-238" tabindex="-1"></a>      </span>
<span id="cb14-239"><a href="#cb14-239" tabindex="-1"></a>      gross.CR <span class="ot">&lt;-</span> <span class="fu">myCalmarRatio</span>(pnl.gross.d, <span class="at">scale =</span> <span class="dv">252</span>)</span>
<span id="cb14-240"><a href="#cb14-240" tabindex="-1"></a>      gross.CR2 <span class="ot">&lt;-</span> <span class="fu">myCalmarRatio</span>(pnl.gross2.d, <span class="at">scale =</span> <span class="dv">252</span>)</span>
<span id="cb14-241"><a href="#cb14-241" tabindex="-1"></a>      net.CR <span class="ot">&lt;-</span> <span class="fu">myCalmarRatio</span>(pnl.net.d, <span class="at">scale =</span> <span class="dv">252</span>)</span>
<span id="cb14-242"><a href="#cb14-242" tabindex="-1"></a>      net.CR2 <span class="ot">&lt;-</span> <span class="fu">myCalmarRatio</span>(pnl.net2.d, <span class="at">scale =</span> <span class="dv">252</span>)</span>
<span id="cb14-243"><a href="#cb14-243" tabindex="-1"></a>      </span>
<span id="cb14-244"><a href="#cb14-244" tabindex="-1"></a>      gross.PnL <span class="ot">&lt;-</span> <span class="fu">sum</span>(pnl.gross.d, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb14-245"><a href="#cb14-245" tabindex="-1"></a>      gross.PnL2 <span class="ot">&lt;-</span> <span class="fu">sum</span>(pnl.gross2.d, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb14-246"><a href="#cb14-246" tabindex="-1"></a>      net.PnL <span class="ot">&lt;-</span> <span class="fu">sum</span>(pnl.net.d, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb14-247"><a href="#cb14-247" tabindex="-1"></a>      net.PnL2 <span class="ot">&lt;-</span> <span class="fu">sum</span>(pnl.net2.d, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb14-248"><a href="#cb14-248" tabindex="-1"></a>      </span>
<span id="cb14-249"><a href="#cb14-249" tabindex="-1"></a>      av.daily.ntrans <span class="ot">&lt;-</span> <span class="fu">mean</span>(ntrans.d, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb14-250"><a href="#cb14-250" tabindex="-1"></a>      av.daily.ntrans2 <span class="ot">&lt;-</span> <span class="fu">mean</span>(ntrans2.d, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) </span>
<span id="cb14-251"><a href="#cb14-251" tabindex="-1"></a>      </span>
<span id="cb14-252"><a href="#cb14-252" tabindex="-1"></a>      stat <span class="ot">=</span> net.CR <span class="sc">*</span> <span class="fu">max</span>(<span class="dv">0</span>, <span class="fu">log</span>(<span class="fu">abs</span>(net.PnL<span class="sc">/</span><span class="dv">1000</span>)))</span>
<span id="cb14-253"><a href="#cb14-253" tabindex="-1"></a>      stat2 <span class="ot">=</span> net.CR2 <span class="sc">*</span> <span class="fu">max</span>(<span class="dv">0</span>, <span class="fu">log</span>(<span class="fu">abs</span>(net.PnL2<span class="sc">/</span><span class="dv">1000</span>)))</span>
<span id="cb14-254"><a href="#cb14-254" tabindex="-1"></a>      </span>
<span id="cb14-255"><a href="#cb14-255" tabindex="-1"></a>      <span class="co"># collecting all statistics for a particular quarter</span></span>
<span id="cb14-256"><a href="#cb14-256" tabindex="-1"></a>      <span class="cf">if</span>(volat.sd <span class="sc">==</span> <span class="dv">180</span> <span class="sc">&amp;</span> m_ <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb14-257"><a href="#cb14-257" tabindex="-1"></a>        quarter_stats <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">quarter =</span> selected_quarter,</span>
<span id="cb14-258"><a href="#cb14-258" tabindex="-1"></a>                                    <span class="at">assets.group =</span> <span class="dv">2</span>,</span>
<span id="cb14-259"><a href="#cb14-259" tabindex="-1"></a>                                    gross.SR,</span>
<span id="cb14-260"><a href="#cb14-260" tabindex="-1"></a>                                    net.SR,</span>
<span id="cb14-261"><a href="#cb14-261" tabindex="-1"></a>                                    gross.CR,</span>
<span id="cb14-262"><a href="#cb14-262" tabindex="-1"></a>                                    net.CR,</span>
<span id="cb14-263"><a href="#cb14-263" tabindex="-1"></a>                                    gross.PnL,</span>
<span id="cb14-264"><a href="#cb14-264" tabindex="-1"></a>                                    net.PnL,</span>
<span id="cb14-265"><a href="#cb14-265" tabindex="-1"></a>                                    av.daily.ntrans,</span>
<span id="cb14-266"><a href="#cb14-266" tabindex="-1"></a>                                    stat,</span>
<span id="cb14-267"><a href="#cb14-267" tabindex="-1"></a>                                    <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb14-268"><a href="#cb14-268" tabindex="-1"></a>        )</span>
<span id="cb14-269"><a href="#cb14-269" tabindex="-1"></a>        </span>
<span id="cb14-270"><a href="#cb14-270" tabindex="-1"></a>        quarter_stats2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">quarter =</span> selected_quarter,</span>
<span id="cb14-271"><a href="#cb14-271" tabindex="-1"></a>                                    <span class="at">assets.group =</span> <span class="dv">2</span>,</span>
<span id="cb14-272"><a href="#cb14-272" tabindex="-1"></a>                                    gross.SR2,</span>
<span id="cb14-273"><a href="#cb14-273" tabindex="-1"></a>                                    net.SR2,</span>
<span id="cb14-274"><a href="#cb14-274" tabindex="-1"></a>                                    gross.CR2,</span>
<span id="cb14-275"><a href="#cb14-275" tabindex="-1"></a>                                    net.CR2,</span>
<span id="cb14-276"><a href="#cb14-276" tabindex="-1"></a>                                    gross.PnL2,</span>
<span id="cb14-277"><a href="#cb14-277" tabindex="-1"></a>                                    net.PnL2,</span>
<span id="cb14-278"><a href="#cb14-278" tabindex="-1"></a>                                    av.daily.ntrans2,</span>
<span id="cb14-279"><a href="#cb14-279" tabindex="-1"></a>                                    stat2,</span>
<span id="cb14-280"><a href="#cb14-280" tabindex="-1"></a>                                    <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb14-281"><a href="#cb14-281" tabindex="-1"></a>        )</span>
<span id="cb14-282"><a href="#cb14-282" tabindex="-1"></a>        </span>
<span id="cb14-283"><a href="#cb14-283" tabindex="-1"></a>        <span class="co"># collect summaries for all quarters</span></span>
<span id="cb14-284"><a href="#cb14-284" tabindex="-1"></a>        <span class="cf">if</span>(<span class="sc">!</span><span class="fu">exists</span>(<span class="st">&quot;quarter_stats.all.group2&quot;</span>)) quarter_stats.all.group2 <span class="ot">&lt;-</span> quarter_stats <span class="cf">else</span></span>
<span id="cb14-285"><a href="#cb14-285" tabindex="-1"></a>          quarter_stats.all.group2 <span class="ot">&lt;-</span> <span class="fu">rbind</span>(quarter_stats.all.group2, quarter_stats)</span>
<span id="cb14-286"><a href="#cb14-286" tabindex="-1"></a>        </span>
<span id="cb14-287"><a href="#cb14-287" tabindex="-1"></a>        <span class="cf">if</span>(<span class="sc">!</span><span class="fu">exists</span>(<span class="st">&quot;quarter_stats2.all.group2&quot;</span>)) quarter_stats2.all.group2 <span class="ot">&lt;-</span> quarter_stats2 <span class="cf">else</span></span>
<span id="cb14-288"><a href="#cb14-288" tabindex="-1"></a>          quarter_stats2.all.group2 <span class="ot">&lt;-</span> <span class="fu">rbind</span>(quarter_stats2.all.group2, quarter_stats2)</span>
<span id="cb14-289"><a href="#cb14-289" tabindex="-1"></a>        </span>
<span id="cb14-290"><a href="#cb14-290" tabindex="-1"></a>        <span class="co"># create a plot of gross and net pnl and save it to png file</span></span>
<span id="cb14-291"><a href="#cb14-291" tabindex="-1"></a>        y_range <span class="ot">&lt;-</span> <span class="fu">range</span>(<span class="fu">c</span>(<span class="fu">cumsum</span>(pnl.gross.d), <span class="fu">cumsum</span>(pnl.net.d)))</span>
<span id="cb14-292"><a href="#cb14-292" tabindex="-1"></a></span>
<span id="cb14-293"><a href="#cb14-293" tabindex="-1"></a>        <span class="fu">print</span>( <span class="co"># when plotting in a loop you have to use print()</span></span>
<span id="cb14-294"><a href="#cb14-294" tabindex="-1"></a>          <span class="fu">plot</span>(<span class="fu">cumsum</span>(pnl.gross.d),</span>
<span id="cb14-295"><a href="#cb14-295" tabindex="-1"></a>               <span class="at">type =</span> <span class="st">&quot;l&quot;</span>,</span>
<span id="cb14-296"><a href="#cb14-296" tabindex="-1"></a>               <span class="at">main =</span> <span class="fu">paste0</span>(<span class="st">&quot;Gross and net PnL for asset group 2 </span><span class="sc">\n</span><span class="st"> quarter &quot;</span>, selected_quarter),</span>
<span id="cb14-297"><a href="#cb14-297" tabindex="-1"></a>               <span class="at">col =</span> <span class="st">&quot;#377EB8&quot;</span>,</span>
<span id="cb14-298"><a href="#cb14-298" tabindex="-1"></a>               <span class="at">xlab =</span> <span class="st">&quot;Time&quot;</span>,</span>
<span id="cb14-299"><a href="#cb14-299" tabindex="-1"></a>               <span class="at">ylab =</span> <span class="st">&quot;Cumulative PnL&quot;</span>,</span>
<span id="cb14-300"><a href="#cb14-300" tabindex="-1"></a>               <span class="at">ylim =</span> y_range</span>
<span id="cb14-301"><a href="#cb14-301" tabindex="-1"></a>          )</span>
<span id="cb14-302"><a href="#cb14-302" tabindex="-1"></a>        )</span>
<span id="cb14-303"><a href="#cb14-303" tabindex="-1"></a>        <span class="fu">lines</span>(<span class="fu">cumsum</span>(pnl.net.d), <span class="at">col =</span> <span class="st">&quot;#E41A1C&quot;</span>)</span>
<span id="cb14-304"><a href="#cb14-304" tabindex="-1"></a>        <span class="fu">legend</span>(<span class="st">&quot;topleft&quot;</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">&quot;Gross PnL&quot;</span>, <span class="st">&quot;Net PnL&quot;</span>), <span class="at">col =</span> <span class="fu">c</span>(<span class="st">&quot;#377EB8&quot;</span>, <span class="st">&quot;#E41A1C&quot;</span>), <span class="at">lty =</span> <span class="dv">1</span>, <span class="at">cex =</span> <span class="dv">1</span>)</span>
<span id="cb14-305"><a href="#cb14-305" tabindex="-1"></a>      }</span>
<span id="cb14-306"><a href="#cb14-306" tabindex="-1"></a>      </span>
<span id="cb14-307"><a href="#cb14-307" tabindex="-1"></a>      <span class="co"># summary of a particular strategy</span></span>
<span id="cb14-308"><a href="#cb14-308" tabindex="-1"></a>      summary_ <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">spread =</span> <span class="st">&quot;av.ratio&quot;</span>,</span>
<span id="cb14-309"><a href="#cb14-309" tabindex="-1"></a>                             <span class="at">volat.sd =</span> volat.sd,</span>
<span id="cb14-310"><a href="#cb14-310" tabindex="-1"></a>                             <span class="at">m =</span> m_,</span>
<span id="cb14-311"><a href="#cb14-311" tabindex="-1"></a>                             <span class="at">period =</span> selected_quarter, <span class="co"># &quot;2016-08-16 - 2016-11&quot;,</span></span>
<span id="cb14-312"><a href="#cb14-312" tabindex="-1"></a>                             gross.SR,</span>
<span id="cb14-313"><a href="#cb14-313" tabindex="-1"></a>                             net.SR,</span>
<span id="cb14-314"><a href="#cb14-314" tabindex="-1"></a>                             gross.PnL,</span>
<span id="cb14-315"><a href="#cb14-315" tabindex="-1"></a>                             net.PnL,</span>
<span id="cb14-316"><a href="#cb14-316" tabindex="-1"></a>                             av.daily.ntrans,</span>
<span id="cb14-317"><a href="#cb14-317" tabindex="-1"></a>                             <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb14-318"><a href="#cb14-318" tabindex="-1"></a></span>
<span id="cb14-319"><a href="#cb14-319" tabindex="-1"></a>      summary2_ <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">spread =</span> <span class="st">&quot;sds.ratio&quot;</span>,</span>
<span id="cb14-320"><a href="#cb14-320" tabindex="-1"></a>                              <span class="at">volat.sd =</span> volat.sd,</span>
<span id="cb14-321"><a href="#cb14-321" tabindex="-1"></a>                              <span class="at">m =</span> m_,</span>
<span id="cb14-322"><a href="#cb14-322" tabindex="-1"></a>                              <span class="at">period =</span> selected_quarter, <span class="co"># &quot;2016-08-16 - 2016-11&quot;,</span></span>
<span id="cb14-323"><a href="#cb14-323" tabindex="-1"></a>                              <span class="at">gross.SR =</span> gross.SR2,</span>
<span id="cb14-324"><a href="#cb14-324" tabindex="-1"></a>                              <span class="at">net.SR =</span> net.SR2,</span>
<span id="cb14-325"><a href="#cb14-325" tabindex="-1"></a>                              <span class="at">gross.PnL =</span> gross.PnL2,</span>
<span id="cb14-326"><a href="#cb14-326" tabindex="-1"></a>                              <span class="at">net.PnL =</span> net.PnL2,</span>
<span id="cb14-327"><a href="#cb14-327" tabindex="-1"></a>                              <span class="at">av.daily.ntrans =</span> av.daily.ntrans2,</span>
<span id="cb14-328"><a href="#cb14-328" tabindex="-1"></a>                              <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb14-329"><a href="#cb14-329" tabindex="-1"></a></span>
<span id="cb14-330"><a href="#cb14-330" tabindex="-1"></a>      <span class="co"># putting all summaries together</span></span>
<span id="cb14-331"><a href="#cb14-331" tabindex="-1"></a></span>
<span id="cb14-332"><a href="#cb14-332" tabindex="-1"></a>      <span class="cf">if</span>(<span class="sc">!</span><span class="fu">exists</span>(<span class="st">&quot;summary.pair.trading&quot;</span>)) summary.pair.trading <span class="ot">&lt;-</span> <span class="fu">rbind</span>(summary_, summary2_) <span class="cf">else</span></span>
<span id="cb14-333"><a href="#cb14-333" tabindex="-1"></a>        summary.pair.trading <span class="ot">&lt;-</span> <span class="fu">rbind</span>(summary.pair.trading, summary_, summary2_)</span>
<span id="cb14-334"><a href="#cb14-334" tabindex="-1"></a>      </span>
<span id="cb14-335"><a href="#cb14-335" tabindex="-1"></a>      <span class="co"># deleting working files not needed any more</span></span>
<span id="cb14-336"><a href="#cb14-336" tabindex="-1"></a>      <span class="fu">rm</span>(gross.SR, gross.SR2, net.SR, net.SR2, net.CR, net.CR2,</span>
<span id="cb14-337"><a href="#cb14-337" tabindex="-1"></a>         gross.PnL, gross.PnL2, net.PnL, net.PnL2,</span>
<span id="cb14-338"><a href="#cb14-338" tabindex="-1"></a>         av.daily.ntrans, av.daily.ntrans2, stat, stat2,</span>
<span id="cb14-339"><a href="#cb14-339" tabindex="-1"></a>         pnl.gross.d, pnl.gross2.d, pnl.net.d, pnl.net2.d, </span>
<span id="cb14-340"><a href="#cb14-340" tabindex="-1"></a>         ntrans.d, ntrans2.d,</span>
<span id="cb14-341"><a href="#cb14-341" tabindex="-1"></a>         pnl.gross, pnl.gross2, pnl.net, pnl.net2, </span>
<span id="cb14-342"><a href="#cb14-342" tabindex="-1"></a>         ntrans, ntrans2,</span>
<span id="cb14-343"><a href="#cb14-343" tabindex="-1"></a>         pos.mr, pos.mr2, summary_, summary2_,</span>
<span id="cb14-344"><a href="#cb14-344" tabindex="-1"></a>         XAU_price, XAG_price,</span>
<span id="cb14-345"><a href="#cb14-345" tabindex="-1"></a>         signal, signal2, lower, lower2, upper, upper2)</span>
<span id="cb14-346"><a href="#cb14-346" tabindex="-1"></a>      </span>
<span id="cb14-347"><a href="#cb14-347" tabindex="-1"></a>    } <span class="co"># end of loop for m_</span></span>
<span id="cb14-348"><a href="#cb14-348" tabindex="-1"></a>  } <span class="co"># end of loop for volatility  </span></span>
<span id="cb14-349"><a href="#cb14-349" tabindex="-1"></a>  </span>
<span id="cb14-350"><a href="#cb14-350" tabindex="-1"></a>  </span>
<span id="cb14-351"><a href="#cb14-351" tabindex="-1"></a>  <span class="co"># results on the heatmap graph</span></span>
<span id="cb14-352"><a href="#cb14-352" tabindex="-1"></a>  </span>
<span id="cb14-353"><a href="#cb14-353" tabindex="-1"></a>  <span class="co"># net.SR - spread av_ratio</span></span>
<span id="cb14-354"><a href="#cb14-354" tabindex="-1"></a>  heatmap_sr <span class="ot">&lt;-</span> <span class="fu">plotHeatmap</span>(<span class="at">data_plot =</span> summary.pair.trading[summary.pair.trading<span class="sc">$</span>spread <span class="sc">==</span> <span class="st">&quot;av.ratio&quot;</span>,], <span class="co"># dataset (data.frame) with calculations</span></span>
<span id="cb14-355"><a href="#cb14-355" tabindex="-1"></a>              <span class="at">col_vlabels =</span> <span class="st">&quot;volat.sd&quot;</span>, <span class="co"># column name with the labels for a vertical axis (string)</span></span>
<span id="cb14-356"><a href="#cb14-356" tabindex="-1"></a>              <span class="at">col_hlabels =</span> <span class="st">&quot;m&quot;</span>, <span class="co"># column name with the labels for a horizontal axis (string)</span></span>
<span id="cb14-357"><a href="#cb14-357" tabindex="-1"></a>              <span class="at">col_variable =</span> <span class="st">&quot;net.SR&quot;</span>, <span class="co"># column name with the variable to show (string)</span></span>
<span id="cb14-358"><a href="#cb14-358" tabindex="-1"></a>              <span class="at">main =</span> <span class="fu">paste</span>(selected_quarter, <span class="st">&quot;Sensitivity analysis for pair trading - spread based on prices ratio&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;: &quot;</span>),</span>
<span id="cb14-359"><a href="#cb14-359" tabindex="-1"></a>              <span class="at">label_size =</span> <span class="dv">3</span>)</span>
<span id="cb14-360"><a href="#cb14-360" tabindex="-1"></a>  </span>
<span id="cb14-361"><a href="#cb14-361" tabindex="-1"></a>  heatmap_sr2 <span class="ot">&lt;-</span> <span class="fu">plotHeatmap</span>(<span class="at">data_plot =</span> summary.pair.trading[summary.pair.trading<span class="sc">$</span>spread <span class="sc">==</span> <span class="st">&quot;sds.ratio&quot;</span>,], <span class="co"># dataset (data.frame) with calculations</span></span>
<span id="cb14-362"><a href="#cb14-362" tabindex="-1"></a>                            <span class="at">col_vlabels =</span> <span class="st">&quot;volat.sd&quot;</span>, <span class="co"># column name with the labels for a vertical axis (string)</span></span>
<span id="cb14-363"><a href="#cb14-363" tabindex="-1"></a>                            <span class="at">col_hlabels =</span> <span class="st">&quot;m&quot;</span>, <span class="co"># column name with the labels for a horizontal axis (string)</span></span>
<span id="cb14-364"><a href="#cb14-364" tabindex="-1"></a>                            <span class="at">col_variable =</span> <span class="st">&quot;net.SR&quot;</span>, <span class="co"># column name with the variable to show (string)</span></span>
<span id="cb14-365"><a href="#cb14-365" tabindex="-1"></a>                            <span class="at">main =</span> <span class="fu">paste</span>(selected_quarter, <span class="st">&quot;Sensitivity analysis for pair trading - spread based on returns ratio&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;: &quot;</span>),</span>
<span id="cb14-366"><a href="#cb14-366" tabindex="-1"></a>                            <span class="at">label_size =</span> <span class="dv">3</span>)</span>
<span id="cb14-367"><a href="#cb14-367" tabindex="-1"></a>  </span>
<span id="cb14-368"><a href="#cb14-368" tabindex="-1"></a>  sensitivities[[selected_quarter]] <span class="ot">&lt;-</span> summary.pair.trading[summary.pair.trading<span class="sc">$</span>spread <span class="sc">==</span> <span class="st">&quot;av.ratio&quot;</span>,]</span>
<span id="cb14-369"><a href="#cb14-369" tabindex="-1"></a>  sensitivities2[[selected_quarter]] <span class="ot">&lt;-</span> summary.pair.trading[summary.pair.trading<span class="sc">$</span>spread <span class="sc">==</span> <span class="st">&quot;sds.ratio&quot;</span>,]</span>
<span id="cb14-370"><a href="#cb14-370" tabindex="-1"></a>  <span class="fu">rm</span>(summary.pair.trading)</span>
<span id="cb14-371"><a href="#cb14-371" tabindex="-1"></a>  </span>
<span id="cb14-372"><a href="#cb14-372" tabindex="-1"></a>  heatmap_list[[selected_quarter]] <span class="ot">&lt;-</span> heatmap_sr</span>
<span id="cb14-373"><a href="#cb14-373" tabindex="-1"></a>  heatmap_list2[[selected_quarter]] <span class="ot">&lt;-</span> heatmap_sr2</span>
<span id="cb14-374"><a href="#cb14-374" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-9-1.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-9-2.png" width="672" /></p>
<pre><code>## NULL</code></pre>
<p><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-9-3.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-9-4.png" width="672" /></p>
<pre><code>## NULL</code></pre>
<p><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-9-5.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-9-6.png" width="672" /></p>
<pre><code>## NULL</code></pre>
<p><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-9-7.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-9-8.png" width="672" /></p>
<pre><code>## NULL</code></pre>
<p><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-9-9.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-9-10.png" width="672" /></p>
<pre><code>## NULL</code></pre>
<p><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-9-11.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-9-12.png" width="672" /></p>
<pre><code>## NULL</code></pre>
<p><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-9-13.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-9-14.png" width="672" /></p>
<pre><code>## NULL</code></pre>
<p>The results were depicted using heatmaps containing Sharpe ratios,
considering the return per unit of volatility. The largest value
indicated which parameter combination generated the best performance on
the in-sample data.</p>
<p>The optimal strategy was volatility breakout using levels where
volatility memory was 180 days and the multiplier was 1. The P&amp;L
graphs above display the performance of this particular strategy.</p>
<p>Heatmaps supporting the choice of strategy are shown below. Quarterly
outputs, as well as the mean across quarters are shown.</p>
<div id="volatility-breakout---levels" class="section level2">
<h2>Volatility Breakout - Levels</h2>
<p>Volatility breakout using price levels generated positive Sharpe
ratios across all combinations. The best strategy was chosen in this
approach: 180 days volatility memory and a multiplier of 1 produced a
Sharpe ratio of 1.14.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a><span class="co"># Combined</span></span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a><span class="cf">for</span> (output <span class="cf">in</span> heatmap_list) {</span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a>  <span class="fu">print</span>(output)</span>
<span id="cb22-4"><a href="#cb22-4" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-10-1.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-10-2.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-10-3.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-10-4.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-10-5.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-10-6.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-10-7.png" width="672" /></p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="co"># Mean</span></span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a>net_srs <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(sensitivities)) {</span>
<span id="cb23-5"><a href="#cb23-5" tabindex="-1"></a>  net_srs[[i]] <span class="ot">&lt;-</span> <span class="fu">as.list</span>(sensitivities[[i]][<span class="fu">c</span>(<span class="st">&quot;net.SR&quot;</span>)])[[<span class="dv">1</span>]]</span>
<span id="cb23-6"><a href="#cb23-6" tabindex="-1"></a>}</span>
<span id="cb23-7"><a href="#cb23-7" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" tabindex="-1"></a>average_net_sr <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="fu">seq_along</span>(net_srs[[<span class="dv">1</span>]]), <span class="cf">function</span>(i) {</span>
<span id="cb23-9"><a href="#cb23-9" tabindex="-1"></a>  <span class="fu">mean</span>(<span class="fu">sapply</span>(net_srs, <span class="cf">function</span>(x) x[[i]]))</span>
<span id="cb23-10"><a href="#cb23-10" tabindex="-1"></a>})</span>
<span id="cb23-11"><a href="#cb23-11" tabindex="-1"></a>average_net_sr <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">net.SR =</span> average_net_sr)</span>
<span id="cb23-12"><a href="#cb23-12" tabindex="-1"></a></span>
<span id="cb23-13"><a href="#cb23-13" tabindex="-1"></a>sensitivities_average <span class="ot">&lt;-</span> sensitivities[[<span class="dv">1</span>]][<span class="fu">c</span>(<span class="st">&quot;spread&quot;</span>, <span class="st">&quot;volat.sd&quot;</span>, <span class="st">&quot;m&quot;</span>)]</span>
<span id="cb23-14"><a href="#cb23-14" tabindex="-1"></a>sensitivities_average <span class="ot">&lt;-</span> <span class="fu">cbind</span>(sensitivities_average, <span class="st">&quot;net.SR&quot;</span> <span class="ot">=</span> average_net_sr)</span>
<span id="cb23-15"><a href="#cb23-15" tabindex="-1"></a></span>
<span id="cb23-16"><a href="#cb23-16" tabindex="-1"></a>heatmap_sr_mean <span class="ot">&lt;-</span> <span class="fu">plotHeatmap</span>(<span class="at">data_plot =</span> sensitivities_average, <span class="co"># dataset (data.frame) with calculations</span></span>
<span id="cb23-17"><a href="#cb23-17" tabindex="-1"></a>                          <span class="at">col_vlabels =</span> <span class="st">&quot;volat.sd&quot;</span>, <span class="co"># column name with the labels for a vertical axis (string)</span></span>
<span id="cb23-18"><a href="#cb23-18" tabindex="-1"></a>                          <span class="at">col_hlabels =</span> <span class="st">&quot;m&quot;</span>, <span class="co"># column name with the labels for a horizontal axis (string)</span></span>
<span id="cb23-19"><a href="#cb23-19" tabindex="-1"></a>                          <span class="at">col_variable =</span> <span class="st">&quot;net.SR&quot;</span>, <span class="co"># column name with the variable to show (string)</span></span>
<span id="cb23-20"><a href="#cb23-20" tabindex="-1"></a>                          <span class="at">main =</span> <span class="fu">paste</span>(<span class="st">&quot;Mean&quot;</span>, <span class="st">&quot;Sensitivity analysis for pair trading - spread based on prices ratio&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;: &quot;</span>),</span>
<span id="cb23-21"><a href="#cb23-21" tabindex="-1"></a>                          <span class="at">label_size =</span> <span class="dv">3</span>)</span>
<span id="cb23-22"><a href="#cb23-22" tabindex="-1"></a></span>
<span id="cb23-23"><a href="#cb23-23" tabindex="-1"></a>heatmap_sr_mean</span></code></pre></div>
<p><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-10-8.png" width="672" /></p>
</div>
<div id="volatility-breakout---returns" class="section level2">
<h2>Volatility Breakout - Returns</h2>
<p>Volatility breakout using returns yielded worse Sharpe ratios,
particularly at low levels of the multiplier.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a><span class="co"># Combined</span></span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a><span class="cf">for</span> (output <span class="cf">in</span> heatmap_list2) {</span>
<span id="cb24-3"><a href="#cb24-3" tabindex="-1"></a>  <span class="fu">print</span>(output)</span>
<span id="cb24-4"><a href="#cb24-4" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-11-1.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-11-2.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-11-3.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-11-4.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-11-5.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-11-6.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-11-7.png" width="672" /></p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="co"># Mean</span></span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a>net_srs2 <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(sensitivities2)) {</span>
<span id="cb25-5"><a href="#cb25-5" tabindex="-1"></a>  net_srs2[[i]] <span class="ot">&lt;-</span> <span class="fu">as.list</span>(sensitivities2[[i]][<span class="fu">c</span>(<span class="st">&quot;net.SR&quot;</span>)])[[<span class="dv">1</span>]]</span>
<span id="cb25-6"><a href="#cb25-6" tabindex="-1"></a>}</span>
<span id="cb25-7"><a href="#cb25-7" tabindex="-1"></a></span>
<span id="cb25-8"><a href="#cb25-8" tabindex="-1"></a>average_net_sr2 <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="fu">seq_along</span>(net_srs2[[<span class="dv">1</span>]]), <span class="cf">function</span>(i) {</span>
<span id="cb25-9"><a href="#cb25-9" tabindex="-1"></a>  <span class="fu">mean</span>(<span class="fu">sapply</span>(net_srs2, <span class="cf">function</span>(x) x[[i]]))</span>
<span id="cb25-10"><a href="#cb25-10" tabindex="-1"></a>})</span>
<span id="cb25-11"><a href="#cb25-11" tabindex="-1"></a>average_net_sr2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">net.SR =</span> average_net_sr2)</span>
<span id="cb25-12"><a href="#cb25-12" tabindex="-1"></a></span>
<span id="cb25-13"><a href="#cb25-13" tabindex="-1"></a>sensitivities_average2 <span class="ot">&lt;-</span> sensitivities2[[<span class="dv">1</span>]][<span class="fu">c</span>(<span class="st">&quot;spread&quot;</span>, <span class="st">&quot;volat.sd&quot;</span>, <span class="st">&quot;m&quot;</span>)]</span>
<span id="cb25-14"><a href="#cb25-14" tabindex="-1"></a>sensitivities_average2 <span class="ot">&lt;-</span> <span class="fu">cbind</span>(sensitivities_average2, <span class="st">&quot;net.SR&quot;</span> <span class="ot">=</span> average_net_sr2)</span>
<span id="cb25-15"><a href="#cb25-15" tabindex="-1"></a></span>
<span id="cb25-16"><a href="#cb25-16" tabindex="-1"></a>heatmap_sr_mean2 <span class="ot">&lt;-</span> <span class="fu">plotHeatmap</span>(<span class="at">data_plot =</span> sensitivities_average2, <span class="co"># dataset (data.frame) with calculations</span></span>
<span id="cb25-17"><a href="#cb25-17" tabindex="-1"></a>                               <span class="at">col_vlabels =</span> <span class="st">&quot;volat.sd&quot;</span>, <span class="co"># column name with the labels for a vertical axis (string)</span></span>
<span id="cb25-18"><a href="#cb25-18" tabindex="-1"></a>                               <span class="at">col_hlabels =</span> <span class="st">&quot;m&quot;</span>, <span class="co"># column name with the labels for a horizontal axis (string)</span></span>
<span id="cb25-19"><a href="#cb25-19" tabindex="-1"></a>                               <span class="at">col_variable =</span> <span class="st">&quot;net.SR&quot;</span>, <span class="co"># column name with the variable to show (string)</span></span>
<span id="cb25-20"><a href="#cb25-20" tabindex="-1"></a>                               <span class="at">main =</span> <span class="fu">paste</span>(<span class="st">&quot;Mean&quot;</span>, <span class="st">&quot;Sensitivity analysis for pair trading - spread based on returns ratio&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;: &quot;</span>),</span>
<span id="cb25-21"><a href="#cb25-21" tabindex="-1"></a>                               <span class="at">label_size =</span> <span class="dv">3</span>)</span>
<span id="cb25-22"><a href="#cb25-22" tabindex="-1"></a></span>
<span id="cb25-23"><a href="#cb25-23" tabindex="-1"></a>heatmap_sr_mean2</span></code></pre></div>
<p><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-11-8.png" width="672" /></p>
</div>
</div>
<div id="conclusion" class="section level1">
<h1>Conclusion</h1>
<div id="group-1-1" class="section level2">
<h2>Group 1</h2>
<p>The best strategy for group 1 was crossover EMA momentum with a fast
EMA of 60 days and slow EMA of 70 days. There were quarters in which
most combinations (even those containing fewer days) generated positive
Sharpe ratios. This was in line with continuing bull markets throughout
such periods. In general, shorter EMA periods (particularly 10 days)
often yielded negative Sharpe ratios, as the market tended to revert
after such short bullish signals. A longer-term view is beneficial with
the S&amp;P500, as supported by the strategy of choice: a long-term
signal relative to an even longer time horizon indicated there was a
sustained trading opportunity - about <strong>0.95</strong> Sharpe ratio
on average across all quarters. The single EMA entry and exit approach
performed worse, as it was falsely identifying bull/bear markets based
on price changes relative to one EMA. Mean reversion also performed
worse for all variants.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a>quarter_stats.all.group1</span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":["quarter"],"name":[1],"type":["chr"],"align":["left"]},{"label":["assets.group"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["gross.SR"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["net.SR"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["gross.CR"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["net.CR"],"name":[6],"type":["dbl"],"align":["right"]},{"label":["gross.PnL"],"name":[7],"type":["dbl"],"align":["right"]},{"label":["net.PnL"],"name":[8],"type":["dbl"],"align":["right"]},{"label":["av.daily.ntrans"],"name":[9],"type":["dbl"],"align":["right"]},{"label":["stat"],"name":[10],"type":["dbl"],"align":["right"]}],"data":[{"1":"2021_Q1","2":"1","3":"2.7643615","4":"1.7515603","5":"14.3639656","6":"8.2525053","7":"14079.20","8":"9079.20","9":"7.936508","10":"18.2049118"},{"1":"2021_Q3","2":"1","3":"4.3221804","4":"2.9608779","5":"15.6427494","6":"10.1261152","7":"13957.15","8":"9777.15","9":"6.333333","10":"23.0880291"},{"1":"2021_Q4","2":"1","3":"4.0216583","4":"3.0336018","5":"16.7524145","6":"9.8777086","7":"21485.55","8":"16445.55","9":"7.636364","10":"27.6581267"},{"1":"2022_Q2","2":"1","3":"-0.3837697","4":"-0.8968936","5":"-0.5654044","6":"-1.2004592","7":"-3659.05","8":"-8639.05","9":"7.661538","10":"-2.5885414"},{"1":"2022_Q4","2":"1","3":"0.3310653","4":"-0.2104375","5":"0.8403617","6":"-0.4334056","7":"2832.50","8":"-1827.50","9":"7.169231","10":"-0.2613215"},{"1":"2023_Q1","2":"1","3":"0.9874473","4":"0.3738055","5":"2.3871303","6":"0.8047851","7":"6936.70","8":"2666.70","9":"6.584615","10":"0.7893668"},{"1":"2023_Q2","2":"1","3":"0.3614862","4":"-0.3350885","5":"0.8106422","6":"-0.7066736","7":"2072.30","8":"-1947.70","9":"6.312500","10":"-0.4711034"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<p>Cumulative net P&amp;L amounted to <strong>$25,554</strong> and
cumulative summary statistic was <strong>66.4</strong> using in-sample
data.</p>
</div>
<div id="group-2-1" class="section level2">
<h2>Group 2</h2>
<p>The optimal strategy for group 2 was volatility breakout using levels
with 180 days of volatility memory and a multiplier of 1. All
combinations were generally profitable, indicating going against an
increasing spread between gold and silver is a good strategy. There
were, however, some quarters where this was not true and the divergence
continued. The combination that consistently delivered the best results
generated a Sharpe ratio of <strong>1.14</strong>. It indicated it was
worth taking a longer view of volatility and a lower multiplier, meaning
whenever the signal moved relatively little outside the long-term
bounds, a trading opportunity was worthwhile. There were also fewer
trades per day (hence lower trading costs) with the selected strategy in
group 2. The return-based volatility breakout entry and exit approach
performed worse, as it was unable to identify genuine moves away from
gold and silver’s mean to trade against, particularly at low multiplier
values when the bounds were more restrictive.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a><span class="fu">options</span>(<span class="at">digits=</span><span class="dv">2</span>)</span>
<span id="cb27-2"><a href="#cb27-2" tabindex="-1"></a>quarter_stats.all.group2</span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":["quarter"],"name":[1],"type":["chr"],"align":["left"]},{"label":["assets.group"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["gross.SR"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["net.SR"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["gross.CR"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["net.CR"],"name":[6],"type":["dbl"],"align":["right"]},{"label":["gross.PnL"],"name":[7],"type":["dbl"],"align":["right"]},{"label":["net.PnL"],"name":[8],"type":["dbl"],"align":["right"]},{"label":["av.daily.ntrans"],"name":[9],"type":["dbl"],"align":["right"]},{"label":["stat"],"name":[10],"type":["dbl"],"align":["right"]}],"data":[{"1":"2021_Q1","2":"2","3":"2.60","4":"2.49","5":"6.58","6":"6.20","7":"1727629","8":"1647371","9":"3.5","10":"46.0"},{"1":"2021_Q3","2":"2","3":"1.32","4":"1.17","5":"2.58","6":"2.24","7":"688515","8":"608509","9":"3.2","10":"14.3"},{"1":"2021_Q4","2":"2","3":"2.22","4":"2.05","5":"6.59","6":"6.00","7":"1136272","8":"1043029","9":"3.5","10":"41.7"},{"1":"2022_Q2","2":"2","3":"-1.14","4":"-1.28","5":"-1.89","6":"-2.08","7":"-709471","8":"-795455","9":"3.2","10":"-13.9"},{"1":"2022_Q4","2":"2","3":"0.29","4":"0.17","5":"0.89","6":"0.51","7":"210894","8":"121714","9":"3.4","10":"2.5"},{"1":"2023_Q1","2":"2","3":"0.30","4":"0.14","5":"0.51","6":"0.23","7":"176808","8":"80963","9":"3.7","10":"1.0"},{"1":"2023_Q2","2":"2","3":"3.41","4":"3.25","5":"10.34","6":"9.76","7":"2108033","8":"1999241","9":"4.0","10":"74.2"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<p>Cumulative net P&amp;L amounted to <strong>$4,705,373</strong> and
cumulative summary statistic was <strong>165.8</strong> using in-sample
data.</p>
<p>The results for the best models for groups 1 and 2 can be saved as
csv - the following lines need to be uncommented.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a><span class="co"># write.csv(quarter_stats.all.group1, </span></span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a><span class="co">#           &quot;quarter_stats.all.group1.csv&quot;,</span></span>
<span id="cb28-3"><a href="#cb28-3" tabindex="-1"></a><span class="co">#           row.names = FALSE)1</span></span>
<span id="cb28-4"><a href="#cb28-4" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" tabindex="-1"></a><span class="co"># write.csv(quarter_stats.all.group2, </span></span>
<span id="cb28-6"><a href="#cb28-6" tabindex="-1"></a><span class="co">#           &quot;quarter_stats.all.group2.csv&quot;,</span></span>
<span id="cb28-7"><a href="#cb28-7" tabindex="-1"></a><span class="co">#           row.names = FALSE)</span></span></code></pre></div>
</div>
</div>
<div id="out-of-sample" class="section level1">
<h1>Out-of-Sample</h1>
<p>The aforementioned optimal strategies were run on out-of-sample
data.</p>
<div id="group-1-2" class="section level2">
<h2>Group 1</h2>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a><span class="cf">for</span> (selected_quarter <span class="cf">in</span> OOS_quarters) {</span>
<span id="cb29-2"><a href="#cb29-2" tabindex="-1"></a>  </span>
<span id="cb29-3"><a href="#cb29-3" tabindex="-1"></a>  <span class="fu">message</span>(selected_quarter)</span>
<span id="cb29-4"><a href="#cb29-4" tabindex="-1"></a>  </span>
<span id="cb29-5"><a href="#cb29-5" tabindex="-1"></a>  filename_ <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;data/data1_&quot;</span>, selected_quarter, <span class="st">&quot;.RData&quot;</span>)</span>
<span id="cb29-6"><a href="#cb29-6" tabindex="-1"></a>  <span class="fu">load</span>(filename_)</span>
<span id="cb29-7"><a href="#cb29-7" tabindex="-1"></a>  </span>
<span id="cb29-8"><a href="#cb29-8" tabindex="-1"></a>  <span class="co"># create index of times for this quarter</span></span>
<span id="cb29-9"><a href="#cb29-9" tabindex="-1"></a>  data.group1.oos <span class="ot">&lt;-</span> <span class="fu">get</span>(<span class="fu">paste0</span>(<span class="st">&quot;data1_&quot;</span>, selected_quarter))</span>
<span id="cb29-10"><a href="#cb29-10" tabindex="-1"></a>  times_ <span class="ot">&lt;-</span> <span class="fu">substr</span>(<span class="fu">index</span>(data.group1.oos), <span class="dv">12</span>, <span class="dv">19</span>)</span>
<span id="cb29-11"><a href="#cb29-11" tabindex="-1"></a>  </span>
<span id="cb29-12"><a href="#cb29-12" tabindex="-1"></a>  <span class="co"># Keep S&amp;P500</span></span>
<span id="cb29-13"><a href="#cb29-13" tabindex="-1"></a>  data.group1.oos <span class="ot">&lt;-</span> data.group1.oos[, <span class="sc">!</span><span class="fu">colnames</span>(data.group1.oos) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;NQ&quot;</span>)]</span>
<span id="cb29-14"><a href="#cb29-14" tabindex="-1"></a>  </span>
<span id="cb29-15"><a href="#cb29-15" tabindex="-1"></a>  <span class="co"># the following common assumptions were defined:</span></span>
<span id="cb29-16"><a href="#cb29-16" tabindex="-1"></a>  <span class="co"># 1.  do not use in calculations the data from the first </span></span>
<span id="cb29-17"><a href="#cb29-17" tabindex="-1"></a>  <span class="co"># and last 10 minutes of the session (9:31--9:40 and 15:51--16:00)</span></span>
<span id="cb29-18"><a href="#cb29-18" tabindex="-1"></a>  <span class="co"># – put missing values there,</span></span>
<span id="cb29-19"><a href="#cb29-19" tabindex="-1"></a>  </span>
<span id="cb29-20"><a href="#cb29-20" tabindex="-1"></a>  <span class="co"># lets put missing values for these periods</span></span>
<span id="cb29-21"><a href="#cb29-21" tabindex="-1"></a>  data.group1.oos[<span class="st">&quot;T09:31/T09:40&quot;</span>,] <span class="ot">&lt;-</span> <span class="cn">NA</span> </span>
<span id="cb29-22"><a href="#cb29-22" tabindex="-1"></a>  data.group1.oos[<span class="st">&quot;T15:51/T16:00&quot;</span>,] <span class="ot">&lt;-</span><span class="cn">NA</span></span>
<span id="cb29-23"><a href="#cb29-23" tabindex="-1"></a>  </span>
<span id="cb29-24"><a href="#cb29-24" tabindex="-1"></a>  myTheme <span class="ot">&lt;-</span> <span class="fu">chart_theme</span>()</span>
<span id="cb29-25"><a href="#cb29-25" tabindex="-1"></a>  myTheme<span class="sc">$</span>col<span class="sc">$</span>line.col <span class="ot">&lt;-</span> <span class="st">&quot;darkblue&quot;</span></span>
<span id="cb29-26"><a href="#cb29-26" tabindex="-1"></a>  <span class="fu">layout</span>(<span class="fu">matrix</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb29-27"><a href="#cb29-27" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">chart_Series</span>(data.group1.oos<span class="sc">$</span>SP, <span class="at">theme =</span> myTheme))</span>
<span id="cb29-28"><a href="#cb29-28" tabindex="-1"></a>  <span class="fu">layout</span>(<span class="fu">matrix</span>(<span class="dv">1</span>))</span>
<span id="cb29-29"><a href="#cb29-29" tabindex="-1"></a></span>
<span id="cb29-30"><a href="#cb29-30" tabindex="-1"></a></span>
<span id="cb29-31"><a href="#cb29-31" tabindex="-1"></a>  <span class="co"># Momentum</span></span>
<span id="cb29-32"><a href="#cb29-32" tabindex="-1"></a>  </span>
<span id="cb29-33"><a href="#cb29-33" tabindex="-1"></a>  <span class="co"># EMA Crossover</span></span>
<span id="cb29-34"><a href="#cb29-34" tabindex="-1"></a>  </span>
<span id="cb29-35"><a href="#cb29-35" tabindex="-1"></a>  EMA_pairs <span class="ot">=</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="dv">60</span>, <span class="dv">70</span>))</span>
<span id="cb29-36"><a href="#cb29-36" tabindex="-1"></a>  </span>
<span id="cb29-37"><a href="#cb29-37" tabindex="-1"></a>  data.group1b.oos <span class="ot">&lt;-</span> data.group1.oos</span>
<span id="cb29-38"><a href="#cb29-38" tabindex="-1"></a>  </span>
<span id="cb29-39"><a href="#cb29-39" tabindex="-1"></a>  <span class="co"># pair &lt;- c(60, 70)</span></span>
<span id="cb29-40"><a href="#cb29-40" tabindex="-1"></a>  <span class="cf">for</span> (pair <span class="cf">in</span> EMA_pairs) {</span>
<span id="cb29-41"><a href="#cb29-41" tabindex="-1"></a>    <span class="co"># lets calculate EMAfast and EMAslow for SP</span></span>
<span id="cb29-42"><a href="#cb29-42" tabindex="-1"></a>    data.group1b.oos<span class="sc">$</span>SP_EMAfast <span class="ot">&lt;-</span> <span class="fu">EMA</span>(<span class="fu">na.locf</span>(data.group1b.oos<span class="sc">$</span>SP), pair[<span class="dv">1</span>])</span>
<span id="cb29-43"><a href="#cb29-43" tabindex="-1"></a>    data.group1b.oos<span class="sc">$</span>SP_EMAslow <span class="ot">&lt;-</span> <span class="fu">EMA</span>(<span class="fu">na.locf</span>(data.group1b.oos<span class="sc">$</span>SP), pair[<span class="dv">2</span>])</span>
<span id="cb29-44"><a href="#cb29-44" tabindex="-1"></a>    </span>
<span id="cb29-45"><a href="#cb29-45" tabindex="-1"></a>    <span class="co"># put missing value whenever the original price is missing</span></span>
<span id="cb29-46"><a href="#cb29-46" tabindex="-1"></a>    data.group1b.oos<span class="sc">$</span>SP_EMAfast[<span class="fu">is.na</span>(data.group1b.oos<span class="sc">$</span>SP)] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb29-47"><a href="#cb29-47" tabindex="-1"></a>    data.group1b.oos<span class="sc">$</span>SP_EMAslow[<span class="fu">is.na</span>(data.group1b.oos<span class="sc">$</span>SP)] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb29-48"><a href="#cb29-48" tabindex="-1"></a>    </span>
<span id="cb29-49"><a href="#cb29-49" tabindex="-1"></a>    <span class="co"># lets calculate the position for the MOMENTUM strategy</span></span>
<span id="cb29-50"><a href="#cb29-50" tabindex="-1"></a>    <span class="co"># if fast MA(t-1) &gt; slow MA(t-1) =&gt; pos(t) = 1 [long]</span></span>
<span id="cb29-51"><a href="#cb29-51" tabindex="-1"></a>    <span class="co"># if fast MA(t-1) &lt;= slow MA(t-1) =&gt; pos(t) = -1 [short]</span></span>
<span id="cb29-52"><a href="#cb29-52" tabindex="-1"></a>    <span class="co"># this strategy is always in the market</span></span>
<span id="cb29-53"><a href="#cb29-53" tabindex="-1"></a>    data.group1b.oos<span class="sc">$</span>positionSP.mom <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">lag.xts</span>(data.group1b.oos<span class="sc">$</span>SP_EMAfast) <span class="sc">&gt;</span></span>
<span id="cb29-54"><a href="#cb29-54" tabindex="-1"></a>                                            <span class="fu">lag.xts</span>(data.group1b.oos<span class="sc">$</span>SP_EMAslow),</span>
<span id="cb29-55"><a href="#cb29-55" tabindex="-1"></a>                                          <span class="dv">1</span>, <span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb29-56"><a href="#cb29-56" tabindex="-1"></a>    </span>
<span id="cb29-57"><a href="#cb29-57" tabindex="-1"></a>    <span class="co"># lets apply the remaining assumptions</span></span>
<span id="cb29-58"><a href="#cb29-58" tabindex="-1"></a>    <span class="co"># - exit all positions 20 minutes before the session end, i.e. at 15:40</span></span>
<span id="cb29-59"><a href="#cb29-59" tabindex="-1"></a>    <span class="co"># - do not trade within the first 25 minutes of stocks quotations (until 9:55)</span></span>
<span id="cb29-60"><a href="#cb29-60" tabindex="-1"></a>    data.group1b.oos<span class="sc">$</span>positionSP.mom[<span class="fu">times</span>(times_) <span class="sc">&lt;=</span> <span class="fu">times</span>(<span class="st">&quot;09:55:00&quot;</span>) <span class="sc">|</span> </span>
<span id="cb29-61"><a href="#cb29-61" tabindex="-1"></a>                                  <span class="fu">times</span>(times_) <span class="sc">&gt;</span> <span class="fu">times</span>(<span class="st">&quot;15:40:00&quot;</span>)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb29-62"><a href="#cb29-62" tabindex="-1"></a>    </span>
<span id="cb29-63"><a href="#cb29-63" tabindex="-1"></a>    </span>
<span id="cb29-64"><a href="#cb29-64" tabindex="-1"></a>    <span class="co"># lets also fill every missing position with the previous one</span></span>
<span id="cb29-65"><a href="#cb29-65" tabindex="-1"></a>    </span>
<span id="cb29-66"><a href="#cb29-66" tabindex="-1"></a>    data.group1b.oos<span class="sc">$</span>positionSP.mom <span class="ot">&lt;-</span> <span class="fu">na.locf</span>(data.group1b.oos<span class="sc">$</span>positionSP.mom, <span class="at">na.rm =</span> <span class="cn">FALSE</span>)</span>
<span id="cb29-67"><a href="#cb29-67" tabindex="-1"></a>    </span>
<span id="cb29-68"><a href="#cb29-68" tabindex="-1"></a>    <span class="co"># calculating gross pnl</span></span>
<span id="cb29-69"><a href="#cb29-69" tabindex="-1"></a>    </span>
<span id="cb29-70"><a href="#cb29-70" tabindex="-1"></a>    data.group1b.oos<span class="sc">$</span>pnl_grossSP.mom <span class="ot">&lt;-</span> data.group1b.oos<span class="sc">$</span>positionSP.mom <span class="sc">*</span> <span class="fu">diff.xts</span>(data.group1b.oos<span class="sc">$</span>SP) <span class="sc">*</span> <span class="dv">50</span></span>
<span id="cb29-71"><a href="#cb29-71" tabindex="-1"></a>    </span>
<span id="cb29-72"><a href="#cb29-72" tabindex="-1"></a>    </span>
<span id="cb29-73"><a href="#cb29-73" tabindex="-1"></a>    <span class="co"># number of transactions</span></span>
<span id="cb29-74"><a href="#cb29-74" tabindex="-1"></a>    data.group1b.oos<span class="sc">$</span>ntransSP.mom <span class="ot">&lt;-</span> <span class="fu">abs</span>(<span class="fu">diff.xts</span>(data.group1b.oos<span class="sc">$</span>positionSP.mom))</span>
<span id="cb29-75"><a href="#cb29-75" tabindex="-1"></a>    </span>
<span id="cb29-76"><a href="#cb29-76" tabindex="-1"></a>    data.group1b.oos<span class="sc">$</span>ntransSP.mom[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb29-77"><a href="#cb29-77" tabindex="-1"></a>    </span>
<span id="cb29-78"><a href="#cb29-78" tabindex="-1"></a>    <span class="co"># net pnl</span></span>
<span id="cb29-79"><a href="#cb29-79" tabindex="-1"></a>    data.group1b.oos<span class="sc">$</span>pnl_netSP.mom <span class="ot">&lt;-</span> data.group1b.oos<span class="sc">$</span>pnl_grossSP.mom  <span class="sc">-</span></span>
<span id="cb29-80"><a href="#cb29-80" tabindex="-1"></a>      data.group1b.oos<span class="sc">$</span>ntransSP.mom <span class="sc">*</span> <span class="dv">10</span> <span class="co"># $10 per transaction</span></span>
<span id="cb29-81"><a href="#cb29-81" tabindex="-1"></a>    </span>
<span id="cb29-82"><a href="#cb29-82" tabindex="-1"></a>    <span class="co"># total for strategy</span></span>
<span id="cb29-83"><a href="#cb29-83" tabindex="-1"></a>    </span>
<span id="cb29-84"><a href="#cb29-84" tabindex="-1"></a>    data.group1b.oos<span class="sc">$</span>pnl_gross.mom <span class="ot">&lt;-</span> data.group1b.oos<span class="sc">$</span>pnl_grossSP.mom</span>
<span id="cb29-85"><a href="#cb29-85" tabindex="-1"></a>    data.group1b.oos<span class="sc">$</span>pnl_net.mom <span class="ot">&lt;-</span> data.group1b.oos<span class="sc">$</span>pnl_netSP.mom</span>
<span id="cb29-86"><a href="#cb29-86" tabindex="-1"></a>    </span>
<span id="cb29-87"><a href="#cb29-87" tabindex="-1"></a>    </span>
<span id="cb29-88"><a href="#cb29-88" tabindex="-1"></a>    <span class="co"># aggregate pnls and number of transactions to daily</span></span>
<span id="cb29-89"><a href="#cb29-89" tabindex="-1"></a>    my.endpoints <span class="ot">&lt;-</span> <span class="fu">endpoints</span>(data.group1b.oos, <span class="st">&quot;days&quot;</span>)</span>
<span id="cb29-90"><a href="#cb29-90" tabindex="-1"></a>    </span>
<span id="cb29-91"><a href="#cb29-91" tabindex="-1"></a>    data.group1b.oos.daily <span class="ot">&lt;-</span> <span class="fu">period.apply</span>(data.group1b.oos[,<span class="fu">c</span>(<span class="fu">grep</span>(<span class="st">&quot;pnl&quot;</span>, <span class="fu">names</span>(data.group1b.oos)),</span>
<span id="cb29-92"><a href="#cb29-92" tabindex="-1"></a>                                                       <span class="fu">grep</span>(<span class="st">&quot;ntrans&quot;</span>, <span class="fu">names</span>(data.group1b.oos)))],</span>
<span id="cb29-93"><a href="#cb29-93" tabindex="-1"></a>                                       <span class="at">INDEX =</span> my.endpoints, </span>
<span id="cb29-94"><a href="#cb29-94" tabindex="-1"></a>                                       <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">colSums</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb29-95"><a href="#cb29-95" tabindex="-1"></a>    </span>
<span id="cb29-96"><a href="#cb29-96" tabindex="-1"></a>    <span class="co"># summarize the strategy for this quarter</span></span>
<span id="cb29-97"><a href="#cb29-97" tabindex="-1"></a>    </span>
<span id="cb29-98"><a href="#cb29-98" tabindex="-1"></a>    <span class="co"># SR</span></span>
<span id="cb29-99"><a href="#cb29-99" tabindex="-1"></a>    grossSR <span class="ot">=</span> <span class="fu">mySR</span>(<span class="at">x =</span> data.group1b.oos.daily<span class="sc">$</span>pnl_gross.mom, <span class="at">scale =</span> <span class="dv">252</span>)</span>
<span id="cb29-100"><a href="#cb29-100" tabindex="-1"></a>    netSR <span class="ot">=</span> <span class="fu">mySR</span>(<span class="at">x =</span> data.group1b.oos.daily<span class="sc">$</span>pnl_net.mom, <span class="at">scale =</span> <span class="dv">252</span>)</span>
<span id="cb29-101"><a href="#cb29-101" tabindex="-1"></a>    <span class="co"># CR</span></span>
<span id="cb29-102"><a href="#cb29-102" tabindex="-1"></a>    grossCR <span class="ot">=</span> <span class="fu">myCalmarRatio</span>(<span class="at">x =</span> data.group1b.oos.daily<span class="sc">$</span>pnl_gross.mom, <span class="at">scale =</span> <span class="dv">252</span>)</span>
<span id="cb29-103"><a href="#cb29-103" tabindex="-1"></a>    netCR <span class="ot">=</span> <span class="fu">myCalmarRatio</span>(<span class="at">x =</span> data.group1b.oos.daily<span class="sc">$</span>pnl_net.mom, <span class="at">scale =</span> <span class="dv">252</span>)</span>
<span id="cb29-104"><a href="#cb29-104" tabindex="-1"></a>    </span>
<span id="cb29-105"><a href="#cb29-105" tabindex="-1"></a>    <span class="co"># average number of transactions</span></span>
<span id="cb29-106"><a href="#cb29-106" tabindex="-1"></a>    av.daily.ntrades <span class="ot">=</span> <span class="fu">mean</span>(data.group1b.oos.daily<span class="sc">$</span>ntransSP.mom, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb29-107"><a href="#cb29-107" tabindex="-1"></a>    <span class="co"># PnL</span></span>
<span id="cb29-108"><a href="#cb29-108" tabindex="-1"></a>    grossPnL <span class="ot">=</span> <span class="fu">sum</span>(data.group1b.oos.daily<span class="sc">$</span>pnl_gross.mom)</span>
<span id="cb29-109"><a href="#cb29-109" tabindex="-1"></a>    netPnL <span class="ot">=</span> <span class="fu">sum</span>(data.group1b.oos.daily<span class="sc">$</span>pnl_net.mom)</span>
<span id="cb29-110"><a href="#cb29-110" tabindex="-1"></a>    <span class="co"># stat</span></span>
<span id="cb29-111"><a href="#cb29-111" tabindex="-1"></a>    stat <span class="ot">=</span> netCR <span class="sc">*</span> <span class="fu">max</span>(<span class="dv">0</span>, <span class="fu">log</span>(<span class="fu">abs</span>(netPnL<span class="sc">/</span><span class="dv">1000</span>)))</span>
<span id="cb29-112"><a href="#cb29-112" tabindex="-1"></a>    </span>
<span id="cb29-113"><a href="#cb29-113" tabindex="-1"></a>    <span class="co"># collecting all statistics for a particular quarter</span></span>
<span id="cb29-114"><a href="#cb29-114" tabindex="-1"></a>    <span class="cf">if</span>(pair[<span class="dv">1</span>] <span class="sc">==</span> <span class="dv">60</span> <span class="sc">&amp;</span> pair[<span class="dv">2</span>] <span class="sc">==</span> <span class="dv">70</span>) {</span>
<span id="cb29-115"><a href="#cb29-115" tabindex="-1"></a>      quarter_stats <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">quarter =</span> selected_quarter,</span>
<span id="cb29-116"><a href="#cb29-116" tabindex="-1"></a>                                  <span class="at">assets.group =</span> <span class="dv">1</span>,</span>
<span id="cb29-117"><a href="#cb29-117" tabindex="-1"></a>                                  <span class="at">gross.SR =</span> grossSR,</span>
<span id="cb29-118"><a href="#cb29-118" tabindex="-1"></a>                                  <span class="at">net.SR =</span> netSR,</span>
<span id="cb29-119"><a href="#cb29-119" tabindex="-1"></a>                                  <span class="at">gross.CR =</span> grossCR,</span>
<span id="cb29-120"><a href="#cb29-120" tabindex="-1"></a>                                  <span class="at">net.CR =</span> netCR,</span>
<span id="cb29-121"><a href="#cb29-121" tabindex="-1"></a>                                  <span class="at">gross.PnL =</span> grossPnL,</span>
<span id="cb29-122"><a href="#cb29-122" tabindex="-1"></a>                                  <span class="at">net.PnL =</span> netPnL,</span>
<span id="cb29-123"><a href="#cb29-123" tabindex="-1"></a>                                  <span class="at">av.daily.ntrans =</span> av.daily.ntrades,</span>
<span id="cb29-124"><a href="#cb29-124" tabindex="-1"></a>                                  stat,</span>
<span id="cb29-125"><a href="#cb29-125" tabindex="-1"></a>                                  <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb29-126"><a href="#cb29-126" tabindex="-1"></a>      )</span>
<span id="cb29-127"><a href="#cb29-127" tabindex="-1"></a>      </span>
<span id="cb29-128"><a href="#cb29-128" tabindex="-1"></a>      <span class="co"># collect summaries for all quarters</span></span>
<span id="cb29-129"><a href="#cb29-129" tabindex="-1"></a>      <span class="cf">if</span>(<span class="sc">!</span><span class="fu">exists</span>(<span class="st">&quot;quarter_stats.all.group1.oos&quot;</span>)) quarter_stats.all.group1.oos <span class="ot">&lt;-</span> quarter_stats <span class="cf">else</span></span>
<span id="cb29-130"><a href="#cb29-130" tabindex="-1"></a>        quarter_stats.all.group1.oos <span class="ot">&lt;-</span> <span class="fu">rbind</span>(quarter_stats.all.group1.oos, quarter_stats)</span>
<span id="cb29-131"><a href="#cb29-131" tabindex="-1"></a>      </span>
<span id="cb29-132"><a href="#cb29-132" tabindex="-1"></a>      <span class="co"># create a plot of gros and net pnl and save it to png file</span></span>
<span id="cb29-133"><a href="#cb29-133" tabindex="-1"></a>      <span class="fu">print</span>( <span class="co"># when plotting in a loop you have to use print()</span></span>
<span id="cb29-134"><a href="#cb29-134" tabindex="-1"></a>        <span class="fu">plot</span>(<span class="fu">cbind</span>(<span class="fu">cumsum</span>(data.group1b.oos.daily<span class="sc">$</span>pnl_gross.mom),</span>
<span id="cb29-135"><a href="#cb29-135" tabindex="-1"></a>                   <span class="fu">cumsum</span>(data.group1b.oos.daily<span class="sc">$</span>pnl_net.mom)),</span>
<span id="cb29-136"><a href="#cb29-136" tabindex="-1"></a>             <span class="at">multi.panel =</span> <span class="cn">FALSE</span>,</span>
<span id="cb29-137"><a href="#cb29-137" tabindex="-1"></a>             <span class="at">main =</span> <span class="fu">paste0</span>(<span class="st">&quot;Gross and net PnL for asset group 1 </span><span class="sc">\n</span><span class="st"> quarter &quot;</span>, selected_quarter), </span>
<span id="cb29-138"><a href="#cb29-138" tabindex="-1"></a>             <span class="at">col =</span> <span class="fu">c</span>(<span class="st">&quot;#377EB8&quot;</span>, <span class="st">&quot;#E41A1C&quot;</span>),</span>
<span id="cb29-139"><a href="#cb29-139" tabindex="-1"></a>             <span class="at">major.ticks =</span> <span class="st">&quot;weeks&quot;</span>, </span>
<span id="cb29-140"><a href="#cb29-140" tabindex="-1"></a>             <span class="at">grid.ticks.on =</span> <span class="st">&quot;weeks&quot;</span>,</span>
<span id="cb29-141"><a href="#cb29-141" tabindex="-1"></a>             <span class="at">grid.ticks.lty =</span> <span class="dv">3</span>,</span>
<span id="cb29-142"><a href="#cb29-142" tabindex="-1"></a>             <span class="at">legend.loc =</span> <span class="st">&quot;topleft&quot;</span>,</span>
<span id="cb29-143"><a href="#cb29-143" tabindex="-1"></a>             <span class="at">cex =</span> <span class="fl">0.3</span>)</span>
<span id="cb29-144"><a href="#cb29-144" tabindex="-1"></a>      )</span>
<span id="cb29-145"><a href="#cb29-145" tabindex="-1"></a></span>
<span id="cb29-146"><a href="#cb29-146" tabindex="-1"></a>      <span class="co"># remove all unneeded objects for group 1</span></span>
<span id="cb29-147"><a href="#cb29-147" tabindex="-1"></a>      <span class="fu">rm</span>(pnl.gross.d, pnl.net.d, quarter_stats)</span>
<span id="cb29-148"><a href="#cb29-148" tabindex="-1"></a>      </span>
<span id="cb29-149"><a href="#cb29-149" tabindex="-1"></a>      <span class="fu">gc</span>()</span>
<span id="cb29-150"><a href="#cb29-150" tabindex="-1"></a>    }</span>
<span id="cb29-151"><a href="#cb29-151" tabindex="-1"></a>    </span>
<span id="cb29-152"><a href="#cb29-152" tabindex="-1"></a>    <span class="co"># summary of a particular strategy</span></span>
<span id="cb29-153"><a href="#cb29-153" tabindex="-1"></a>    summary_ <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">EMA.fast =</span> pair[<span class="dv">1</span>],</span>
<span id="cb29-154"><a href="#cb29-154" tabindex="-1"></a>                           <span class="at">EMA.slow =</span> pair[<span class="dv">2</span>],</span>
<span id="cb29-155"><a href="#cb29-155" tabindex="-1"></a>                           <span class="at">period =</span> selected_quarter, <span class="co"># &quot;2016-08-16 - 2016-11&quot;,</span></span>
<span id="cb29-156"><a href="#cb29-156" tabindex="-1"></a>                           <span class="at">gross.SR =</span> grossSR,</span>
<span id="cb29-157"><a href="#cb29-157" tabindex="-1"></a>                           <span class="at">net.SR =</span> netSR,</span>
<span id="cb29-158"><a href="#cb29-158" tabindex="-1"></a>                           <span class="at">gross.PnL =</span> grossPnL,</span>
<span id="cb29-159"><a href="#cb29-159" tabindex="-1"></a>                           <span class="at">net.PnL =</span> netPnL,</span>
<span id="cb29-160"><a href="#cb29-160" tabindex="-1"></a>                           <span class="at">av.daily.ntrans =</span> av.daily.ntrades,</span>
<span id="cb29-161"><a href="#cb29-161" tabindex="-1"></a>                           <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb29-162"><a href="#cb29-162" tabindex="-1"></a>    </span>
<span id="cb29-163"><a href="#cb29-163" tabindex="-1"></a>    <span class="co"># putting all summaries together</span></span>
<span id="cb29-164"><a href="#cb29-164" tabindex="-1"></a>    </span>
<span id="cb29-165"><a href="#cb29-165" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">exists</span>(<span class="st">&quot;summary.pair.trading&quot;</span>)) summary.pair.trading <span class="ot">&lt;-</span> summary_ <span class="cf">else</span></span>
<span id="cb29-166"><a href="#cb29-166" tabindex="-1"></a>      summary.pair.trading <span class="ot">&lt;-</span> <span class="fu">rbind</span>(summary.pair.trading, summary_)</span>
<span id="cb29-167"><a href="#cb29-167" tabindex="-1"></a>    </span>
<span id="cb29-168"><a href="#cb29-168" tabindex="-1"></a>    <span class="co"># deleting working files not needed any more</span></span>
<span id="cb29-169"><a href="#cb29-169" tabindex="-1"></a>    <span class="fu">rm</span>(grossSR, netSR, netCR,</span>
<span id="cb29-170"><a href="#cb29-170" tabindex="-1"></a>       grossPnL, netPnL,</span>
<span id="cb29-171"><a href="#cb29-171" tabindex="-1"></a>       av.daily.ntrades, stat,</span>
<span id="cb29-172"><a href="#cb29-172" tabindex="-1"></a>       summary_)</span>
<span id="cb29-173"><a href="#cb29-173" tabindex="-1"></a>  }</span>
<span id="cb29-174"><a href="#cb29-174" tabindex="-1"></a>  </span>
<span id="cb29-175"><a href="#cb29-175" tabindex="-1"></a>  <span class="fu">rm</span>(summary.pair.trading)</span>
<span id="cb29-176"><a href="#cb29-176" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-15-1.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-15-2.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-15-3.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-15-4.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-15-5.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-15-6.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-15-7.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-15-8.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-15-9.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-15-10.png" width="672" /></p>
</div>
<div id="group-2-2" class="section level2">
<h2>Group 2</h2>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" tabindex="-1"></a><span class="cf">for</span> (selected_quarter <span class="cf">in</span> OOS_quarters) {</span>
<span id="cb30-2"><a href="#cb30-2" tabindex="-1"></a>  </span>
<span id="cb30-3"><a href="#cb30-3" tabindex="-1"></a>  <span class="fu">message</span>(selected_quarter)</span>
<span id="cb30-4"><a href="#cb30-4" tabindex="-1"></a>  </span>
<span id="cb30-5"><a href="#cb30-5" tabindex="-1"></a>  filename_ <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;data/data2_&quot;</span>, selected_quarter, <span class="st">&quot;.RData&quot;</span>)</span>
<span id="cb30-6"><a href="#cb30-6" tabindex="-1"></a>  <span class="fu">load</span>(filename_)</span>
<span id="cb30-7"><a href="#cb30-7" tabindex="-1"></a>  </span>
<span id="cb30-8"><a href="#cb30-8" tabindex="-1"></a>  data.group2.oos <span class="ot">&lt;-</span> <span class="fu">get</span>(<span class="fu">paste0</span>(<span class="st">&quot;data2_&quot;</span>, selected_quarter))</span>
<span id="cb30-9"><a href="#cb30-9" tabindex="-1"></a>  times_ <span class="ot">&lt;-</span> <span class="fu">substr</span>(<span class="fu">index</span>(data.group2.oos), <span class="dv">12</span>, <span class="dv">19</span>)</span>
<span id="cb30-10"><a href="#cb30-10" tabindex="-1"></a>  </span>
<span id="cb30-11"><a href="#cb30-11" tabindex="-1"></a>  <span class="co"># Keep gold and silver</span></span>
<span id="cb30-12"><a href="#cb30-12" tabindex="-1"></a>  data.group2.oos <span class="ot">&lt;-</span> data.group2.oos[, <span class="sc">!</span><span class="fu">colnames</span>(data.group2.oos) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;AUD&quot;</span>,<span class="st">&quot;CAD&quot;</span>)]</span>
<span id="cb30-13"><a href="#cb30-13" tabindex="-1"></a>  <span class="fu">names</span>(data.group2.oos)[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;XAG.close&quot;</span>,<span class="st">&quot;XAU.close&quot;</span>)</span>
<span id="cb30-14"><a href="#cb30-14" tabindex="-1"></a>  </span>
<span id="cb30-15"><a href="#cb30-15" tabindex="-1"></a>  data.group2.oos <span class="ot">&lt;-</span> data.group2.oos[, <span class="fu">c</span>(<span class="st">&quot;XAG.close&quot;</span>, <span class="st">&quot;XAU.close&quot;</span>)]</span>
<span id="cb30-16"><a href="#cb30-16" tabindex="-1"></a>  </span>
<span id="cb30-17"><a href="#cb30-17" tabindex="-1"></a>  myTheme <span class="ot">&lt;-</span> <span class="fu">chart_theme</span>()</span>
<span id="cb30-18"><a href="#cb30-18" tabindex="-1"></a>  myTheme<span class="sc">$</span>col<span class="sc">$</span>line.col <span class="ot">&lt;-</span> <span class="st">&quot;darkblue&quot;</span></span>
<span id="cb30-19"><a href="#cb30-19" tabindex="-1"></a></span>
<span id="cb30-20"><a href="#cb30-20" tabindex="-1"></a>  <span class="co"># the following common assumptions were defined:</span></span>
<span id="cb30-21"><a href="#cb30-21" tabindex="-1"></a>  <span class="co"># 1.  do not use in calculations the data from the first and last 10 minutes of the session (18:01--18:10 and 16:51--17:00) – put missing values there,</span></span>
<span id="cb30-22"><a href="#cb30-22" tabindex="-1"></a>  </span>
<span id="cb30-23"><a href="#cb30-23" tabindex="-1"></a>  <span class="co"># lets put missing values for these periods</span></span>
<span id="cb30-24"><a href="#cb30-24" tabindex="-1"></a>  data.group2.oos[<span class="st">&quot;T18:01/T18:10&quot;</span>,] <span class="ot">&lt;-</span> <span class="cn">NA</span> </span>
<span id="cb30-25"><a href="#cb30-25" tabindex="-1"></a>  data.group2.oos[<span class="st">&quot;T16:51/T17:00&quot;</span>,] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb30-26"><a href="#cb30-26" tabindex="-1"></a>  </span>
<span id="cb30-27"><a href="#cb30-27" tabindex="-1"></a>  <span class="fu">layout</span>(<span class="fu">matrix</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">1</span>))</span>
<span id="cb30-28"><a href="#cb30-28" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">chart_Series</span>(data.group2.oos<span class="sc">$</span>XAG.close, <span class="at">theme =</span> myTheme))</span>
<span id="cb30-29"><a href="#cb30-29" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">chart_Series</span>(data.group2.oos<span class="sc">$</span>XAU.close, <span class="at">theme =</span> myTheme))</span>
<span id="cb30-30"><a href="#cb30-30" tabindex="-1"></a>  <span class="fu">layout</span>(<span class="fu">matrix</span>(<span class="dv">1</span>))</span>
<span id="cb30-31"><a href="#cb30-31" tabindex="-1"></a>  </span>
<span id="cb30-32"><a href="#cb30-32" tabindex="-1"></a>  <span class="do">###################################################################</span></span>
<span id="cb30-33"><a href="#cb30-33" tabindex="-1"></a>  <span class="co"># formulate a spread: P1 - m * P2 (P_XAU - m * P_XAG) </span></span>
<span id="cb30-34"><a href="#cb30-34" tabindex="-1"></a>  <span class="co"># where m = m1/m2 is based on average ratio between the prices</span></span>
<span id="cb30-35"><a href="#cb30-35" tabindex="-1"></a>  <span class="co"># on the PREVIOUS day</span></span>
<span id="cb30-36"><a href="#cb30-36" tabindex="-1"></a>  </span>
<span id="cb30-37"><a href="#cb30-37" tabindex="-1"></a>  <span class="co"># spread is a signal to our model, which shows whether to take </span></span>
<span id="cb30-38"><a href="#cb30-38" tabindex="-1"></a>  <span class="co"># position or not (volatility bands around the spread)</span></span>
<span id="cb30-39"><a href="#cb30-39" tabindex="-1"></a>  </span>
<span id="cb30-40"><a href="#cb30-40" tabindex="-1"></a>  <span class="co"># we assume the mean reverting behavior of the spread</span></span>
<span id="cb30-41"><a href="#cb30-41" tabindex="-1"></a>  </span>
<span id="cb30-42"><a href="#cb30-42" tabindex="-1"></a>  <span class="do">####################################################################</span></span>
<span id="cb30-43"><a href="#cb30-43" tabindex="-1"></a>  <span class="co"># lets calculate average ratio of prices on the daily basis</span></span>
<span id="cb30-44"><a href="#cb30-44" tabindex="-1"></a>  </span>
<span id="cb30-45"><a href="#cb30-45" tabindex="-1"></a>  index_posix <span class="ot">&lt;-</span> <span class="fu">index</span>(data.group2.oos)</span>
<span id="cb30-46"><a href="#cb30-46" tabindex="-1"></a>  time_component <span class="ot">&lt;-</span> <span class="fu">format</span>(index_posix, <span class="at">format =</span> <span class="st">&quot;%H:%M:%S&quot;</span>)</span>
<span id="cb30-47"><a href="#cb30-47" tabindex="-1"></a>  target_time <span class="ot">&lt;-</span> <span class="st">&quot;17:00:00&quot;</span></span>
<span id="cb30-48"><a href="#cb30-48" tabindex="-1"></a>  indices <span class="ot">&lt;-</span> <span class="fu">which</span>(time_component <span class="sc">==</span> target_time)</span>
<span id="cb30-49"><a href="#cb30-49" tabindex="-1"></a></span>
<span id="cb30-50"><a href="#cb30-50" tabindex="-1"></a>  cmd.av.ratio <span class="ot">&lt;-</span> <span class="fu">period.apply</span>(data.group2.oos,</span>
<span id="cb30-51"><a href="#cb30-51" tabindex="-1"></a>                              <span class="at">INDEX =</span> indices,</span>
<span id="cb30-52"><a href="#cb30-52" tabindex="-1"></a>                              <span class="cf">function</span>(x) <span class="fu">mean</span>(x<span class="sc">$</span>XAU.close<span class="sc">/</span>x<span class="sc">$</span>XAG.close, </span>
<span id="cb30-53"><a href="#cb30-53" tabindex="-1"></a>                                               <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb30-54"><a href="#cb30-54" tabindex="-1"></a>  )</span>
<span id="cb30-55"><a href="#cb30-55" tabindex="-1"></a>  </span>
<span id="cb30-56"><a href="#cb30-56" tabindex="-1"></a>  <span class="fu">names</span>(cmd.av.ratio) <span class="ot">&lt;-</span> <span class="st">&quot;av.ratio&quot;</span></span>
<span id="cb30-57"><a href="#cb30-57" tabindex="-1"></a>  </span>
<span id="cb30-58"><a href="#cb30-58" tabindex="-1"></a>  <span class="co"># about 64-74 XAG units per each unit of XAU (future)</span></span>
<span id="cb30-59"><a href="#cb30-59" tabindex="-1"></a>  </span>
<span id="cb30-60"><a href="#cb30-60" tabindex="-1"></a>  <span class="co"># calculations based on the first day</span></span>
<span id="cb30-61"><a href="#cb30-61" tabindex="-1"></a>  <span class="co"># will be used on the second day, etc.</span></span>
<span id="cb30-62"><a href="#cb30-62" tabindex="-1"></a>  <span class="co"># move the time index to 18:00 of the next trading day (same day)</span></span>
<span id="cb30-63"><a href="#cb30-63" tabindex="-1"></a></span>
<span id="cb30-64"><a href="#cb30-64" tabindex="-1"></a>  <span class="co"># some of the dates might be Fridays and in this case</span></span>
<span id="cb30-65"><a href="#cb30-65" tabindex="-1"></a>  <span class="co"># we would move the index to 18:00 on Sunday</span></span>
<span id="cb30-66"><a href="#cb30-66" tabindex="-1"></a>  <span class="co"># 6 = Friday</span></span>
<span id="cb30-67"><a href="#cb30-67" tabindex="-1"></a>  <span class="co"># use if_else() from dplyr instead</span></span>
<span id="cb30-68"><a href="#cb30-68" tabindex="-1"></a></span>
<span id="cb30-69"><a href="#cb30-69" tabindex="-1"></a>  <span class="fu">index</span>(cmd.av.ratio) <span class="ot">&lt;-</span> </span>
<span id="cb30-70"><a href="#cb30-70" tabindex="-1"></a>    <span class="fu">ceiling_date</span>(<span class="fu">index</span>(cmd.av.ratio), <span class="st">&quot;day&quot;</span>) <span class="sc">-</span> </span>
<span id="cb30-71"><a href="#cb30-71" tabindex="-1"></a>    <span class="fu">hours</span>(<span class="dv">6</span>) <span class="sc">+</span> </span>
<span id="cb30-72"><a href="#cb30-72" tabindex="-1"></a>    <span class="fu">minutes</span>(<span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb30-73"><a href="#cb30-73" tabindex="-1"></a>    <span class="fu">if_else</span>(<span class="fu">wday</span>(<span class="fu">index</span>(cmd.av.ratio)) <span class="sc">==</span> <span class="dv">6</span>, </span>
<span id="cb30-74"><a href="#cb30-74" tabindex="-1"></a>            <span class="fu">days</span>(<span class="dv">2</span>),</span>
<span id="cb30-75"><a href="#cb30-75" tabindex="-1"></a>            <span class="fu">days</span>(<span class="dv">0</span>))  </span>
<span id="cb30-76"><a href="#cb30-76" tabindex="-1"></a>  </span>
<span id="cb30-77"><a href="#cb30-77" tabindex="-1"></a>  <span class="co"># merge our basic 5 min data with daily calculations</span></span>
<span id="cb30-78"><a href="#cb30-78" tabindex="-1"></a>  </span>
<span id="cb30-79"><a href="#cb30-79" tabindex="-1"></a>  data.group2b.oos <span class="ot">&lt;-</span> <span class="fu">merge</span>(data.group2.oos,</span>
<span id="cb30-80"><a href="#cb30-80" tabindex="-1"></a>                    cmd.av.ratio)</span>
<span id="cb30-81"><a href="#cb30-81" tabindex="-1"></a>  </span>
<span id="cb30-82"><a href="#cb30-82" tabindex="-1"></a>  <span class="co"># missings in a the last 2 columns</span></span>
<span id="cb30-83"><a href="#cb30-83" tabindex="-1"></a>  <span class="co"># which should be filled with the last non-missing value</span></span>
<span id="cb30-84"><a href="#cb30-84" tabindex="-1"></a>  <span class="co"># (last multiplier is used until there is a new one)</span></span>
<span id="cb30-85"><a href="#cb30-85" tabindex="-1"></a>  </span>
<span id="cb30-86"><a href="#cb30-86" tabindex="-1"></a>  data.group2b.oos<span class="sc">$</span>av.ratio <span class="ot">&lt;-</span> <span class="fu">na.locf</span>(data.group2b.oos<span class="sc">$</span>av.ratio,</span>
<span id="cb30-87"><a href="#cb30-87" tabindex="-1"></a>                               <span class="at">na.rm =</span> <span class="cn">FALSE</span>)</span>
<span id="cb30-88"><a href="#cb30-88" tabindex="-1"></a></span>
<span id="cb30-89"><a href="#cb30-89" tabindex="-1"></a>  <span class="co"># exclude weekends from data</span></span>
<span id="cb30-90"><a href="#cb30-90" tabindex="-1"></a>  </span>
<span id="cb30-91"><a href="#cb30-91" tabindex="-1"></a>  <span class="fu">table</span>(<span class="fu">wday</span>(data.group2b.oos))</span>
<span id="cb30-92"><a href="#cb30-92" tabindex="-1"></a>  </span>
<span id="cb30-93"><a href="#cb30-93" tabindex="-1"></a>  <span class="co"># there are no rows with 7 (Saturday)</span></span>
<span id="cb30-94"><a href="#cb30-94" tabindex="-1"></a>  </span>
<span id="cb30-95"><a href="#cb30-95" tabindex="-1"></a>  <span class="co"># calculate the spread (in 2 variants)</span></span>
<span id="cb30-96"><a href="#cb30-96" tabindex="-1"></a>  data.group2b.oos<span class="sc">$</span>spread_avratio <span class="ot">&lt;-</span> </span>
<span id="cb30-97"><a href="#cb30-97" tabindex="-1"></a>    data.group2b.oos<span class="sc">$</span>XAU.close <span class="sc">-</span></span>
<span id="cb30-98"><a href="#cb30-98" tabindex="-1"></a>    data.group2b.oos<span class="sc">$</span>av.ratio <span class="sc">*</span> data.group2b.oos<span class="sc">$</span>XAG.close</span>
<span id="cb30-99"><a href="#cb30-99" tabindex="-1"></a>  </span>
<span id="cb30-100"><a href="#cb30-100" tabindex="-1"></a>  <span class="co"># assume we do not trade within the first 10-mins of the day</span></span>
<span id="cb30-101"><a href="#cb30-101" tabindex="-1"></a>  <span class="co"># and exit all positions 10 minutes before the end of quotations</span></span>
<span id="cb30-102"><a href="#cb30-102" tabindex="-1"></a>  </span>
<span id="cb30-103"><a href="#cb30-103" tabindex="-1"></a>  <span class="co"># create a pos_flat vector and fill it with 0s</span></span>
<span id="cb30-104"><a href="#cb30-104" tabindex="-1"></a>  pos_flat <span class="ot">&lt;-</span> <span class="fu">xts</span>(<span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">nrow</span>(data.group2b.oos)), <span class="fu">index</span>(data.group2b.oos))</span>
<span id="cb30-105"><a href="#cb30-105" tabindex="-1"></a>  </span>
<span id="cb30-106"><a href="#cb30-106" tabindex="-1"></a>  <span class="co"># we do not trade within the first 10 mins (18:00-18:10) </span></span>
<span id="cb30-107"><a href="#cb30-107" tabindex="-1"></a>  <span class="co"># but also before that time when session was inactive</span></span>
<span id="cb30-108"><a href="#cb30-108" tabindex="-1"></a>  <span class="co"># and last 10 mins of the session (16:51-17:00)</span></span>
<span id="cb30-109"><a href="#cb30-109" tabindex="-1"></a>  <span class="co"># but also after this time when session was inactive</span></span>
<span id="cb30-110"><a href="#cb30-110" tabindex="-1"></a>  </span>
<span id="cb30-111"><a href="#cb30-111" tabindex="-1"></a>  pos_flat[<span class="st">&quot;T16:51/T18:10&quot;</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb30-112"><a href="#cb30-112" tabindex="-1"></a>  </span>
<span id="cb30-113"><a href="#cb30-113" tabindex="-1"></a>  <span class="co"># note this covers Fridays and Sundays as the series goes from 17:00 Friday to 17:05 Sunday</span></span>
<span id="cb30-114"><a href="#cb30-114" tabindex="-1"></a>  </span>
<span id="cb30-115"><a href="#cb30-115" tabindex="-1"></a>  <span class="co"># apply volatility breakout model in a loop for spread and spread2</span></span>
<span id="cb30-116"><a href="#cb30-116" tabindex="-1"></a></span>
<span id="cb30-117"><a href="#cb30-117" tabindex="-1"></a>  <span class="cf">for</span>(volat.sd <span class="cf">in</span> <span class="fu">c</span>(<span class="dv">180</span>)) { <span class="co"># different volatility memories</span></span>
<span id="cb30-118"><a href="#cb30-118" tabindex="-1"></a>    <span class="cf">for</span>(m_ <span class="cf">in</span> <span class="fu">c</span>(<span class="dv">1</span>)) { <span class="co"># different multipliers</span></span>
<span id="cb30-119"><a href="#cb30-119" tabindex="-1"></a>      </span>
<span id="cb30-120"><a href="#cb30-120" tabindex="-1"></a>      <span class="fu">message</span>(<span class="fu">paste0</span>(<span class="st">&quot;volat.sd = &quot;</span>, volat.sd,</span>
<span id="cb30-121"><a href="#cb30-121" tabindex="-1"></a>                     <span class="st">&quot;, m_ = &quot;</span>, m_)) </span>
<span id="cb30-122"><a href="#cb30-122" tabindex="-1"></a>      </span>
<span id="cb30-123"><a href="#cb30-123" tabindex="-1"></a>      <span class="co"># calculating elements of the strategy</span></span>
<span id="cb30-124"><a href="#cb30-124" tabindex="-1"></a>      XAU_price <span class="ot">&lt;-</span> <span class="fu">coredata</span>(data.group2b.oos<span class="sc">$</span>XAU.close)</span>
<span id="cb30-125"><a href="#cb30-125" tabindex="-1"></a>      XAG_price <span class="ot">&lt;-</span> <span class="fu">coredata</span>(data.group2b.oos<span class="sc">$</span>XAG.close)</span>
<span id="cb30-126"><a href="#cb30-126" tabindex="-1"></a>      </span>
<span id="cb30-127"><a href="#cb30-127" tabindex="-1"></a>      signal <span class="ot">&lt;-</span> <span class="fu">coredata</span>(data.group2b.oos<span class="sc">$</span>spread_avratio)</span>
<span id="cb30-128"><a href="#cb30-128" tabindex="-1"></a></span>
<span id="cb30-129"><a href="#cb30-129" tabindex="-1"></a>      upper <span class="ot">&lt;-</span> m_ <span class="sc">*</span> <span class="fu">runsd</span>(signal, volat.sd, </span>
<span id="cb30-130"><a href="#cb30-130" tabindex="-1"></a>                          <span class="at">endrule =</span> <span class="st">&quot;NA&quot;</span>, </span>
<span id="cb30-131"><a href="#cb30-131" tabindex="-1"></a>                          <span class="at">align =</span> <span class="st">&quot;right&quot;</span>)</span>
<span id="cb30-132"><a href="#cb30-132" tabindex="-1"></a>      lower <span class="ot">&lt;-</span> <span class="sc">-</span>m_ <span class="sc">*</span> <span class="fu">runsd</span>(signal, volat.sd, </span>
<span id="cb30-133"><a href="#cb30-133" tabindex="-1"></a>                           <span class="at">endrule =</span> <span class="st">&quot;NA&quot;</span>, </span>
<span id="cb30-134"><a href="#cb30-134" tabindex="-1"></a>                           <span class="at">align =</span> <span class="st">&quot;right&quot;</span>)</span>
<span id="cb30-135"><a href="#cb30-135" tabindex="-1"></a>      </span>
<span id="cb30-136"><a href="#cb30-136" tabindex="-1"></a>      <span class="co"># position for mean-reverting strategy</span></span>
<span id="cb30-137"><a href="#cb30-137" tabindex="-1"></a>      pos.mr <span class="ot">&lt;-</span> <span class="fu">positionVB_new</span>(signal, lower, upper,</span>
<span id="cb30-138"><a href="#cb30-138" tabindex="-1"></a>                               <span class="at">pos_flat =</span> pos_flat,</span>
<span id="cb30-139"><a href="#cb30-139" tabindex="-1"></a>                               <span class="at">strategy =</span> <span class="st">&quot;mr&quot;</span></span>
<span id="cb30-140"><a href="#cb30-140" tabindex="-1"></a>      )</span>
<span id="cb30-141"><a href="#cb30-141" tabindex="-1"></a>      <span class="co"># number of transactions</span></span>
<span id="cb30-142"><a href="#cb30-142" tabindex="-1"></a>      ntrans <span class="ot">&lt;-</span> <span class="fu">abs</span>(<span class="fu">diff.xts</span>(pos.mr))</span>
<span id="cb30-143"><a href="#cb30-143" tabindex="-1"></a></span>
<span id="cb30-144"><a href="#cb30-144" tabindex="-1"></a>      <span class="co"># gross pnl</span></span>
<span id="cb30-145"><a href="#cb30-145" tabindex="-1"></a>      gross.pnl <span class="ot">&lt;-</span> (pos.mr) <span class="sc">*</span></span>
<span id="cb30-146"><a href="#cb30-146" tabindex="-1"></a>        (<span class="fu">diff.xts</span>(XAU_price) <span class="sc">*</span> <span class="dv">100</span> <span class="co"># point value for XAU</span></span>
<span id="cb30-147"><a href="#cb30-147" tabindex="-1"></a>         <span class="sc">-</span> <span class="fu">coredata</span>(data.group2b.oos<span class="sc">$</span>av.ratio) <span class="sc">*</span> <span class="fu">diff.xts</span>(XAG_price) <span class="sc">*</span> <span class="dv">5000</span>) <span class="co"># point value for XAG</span></span>
<span id="cb30-148"><a href="#cb30-148" tabindex="-1"></a></span>
<span id="cb30-149"><a href="#cb30-149" tabindex="-1"></a>      <span class="co"># pnl after  costs</span></span>
<span id="cb30-150"><a href="#cb30-150" tabindex="-1"></a>      <span class="co"># costs = $7 for XAG and $12 for XAU = (12+m*7) in total</span></span>
<span id="cb30-151"><a href="#cb30-151" tabindex="-1"></a>      <span class="co"># costs are always positive</span></span>
<span id="cb30-152"><a href="#cb30-152" tabindex="-1"></a>      </span>
<span id="cb30-153"><a href="#cb30-153" tabindex="-1"></a>      net.pnl <span class="ot">&lt;-</span> gross.pnl <span class="sc">-</span> ntrans <span class="sc">*</span> (<span class="dv">12</span> <span class="sc">+</span> <span class="fu">coredata</span>(data.group2b.oos<span class="sc">$</span>av.ratio) <span class="sc">*</span> <span class="dv">7</span>)</span>
<span id="cb30-154"><a href="#cb30-154" tabindex="-1"></a></span>
<span id="cb30-155"><a href="#cb30-155" tabindex="-1"></a>      <span class="co"># aggregate to daily</span></span>
<span id="cb30-156"><a href="#cb30-156" tabindex="-1"></a></span>
<span id="cb30-157"><a href="#cb30-157" tabindex="-1"></a>      pnl.gross.d <span class="ot">&lt;-</span> <span class="fu">period.apply</span>(gross.pnl, <span class="at">INDEX =</span> indices, </span>
<span id="cb30-158"><a href="#cb30-158" tabindex="-1"></a>                                  <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">sum</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb30-159"><a href="#cb30-159" tabindex="-1"></a>      pnl.net.d <span class="ot">&lt;-</span> <span class="fu">period.apply</span>(net.pnl, <span class="at">INDEX =</span> indices,</span>
<span id="cb30-160"><a href="#cb30-160" tabindex="-1"></a>                                <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">sum</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb30-161"><a href="#cb30-161" tabindex="-1"></a>      ntrans.d <span class="ot">&lt;-</span> <span class="fu">period.apply</span>(ntrans, <span class="at">INDEX =</span> indices, </span>
<span id="cb30-162"><a href="#cb30-162" tabindex="-1"></a>                               <span class="at">FUN =</span> <span class="cf">function</span>(x) <span class="fu">sum</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb30-163"><a href="#cb30-163" tabindex="-1"></a></span>
<span id="cb30-164"><a href="#cb30-164" tabindex="-1"></a>      <span class="co"># calculate summary measures</span></span>
<span id="cb30-165"><a href="#cb30-165" tabindex="-1"></a>      gross.SR <span class="ot">&lt;-</span> <span class="fu">mySR</span>(pnl.gross.d, <span class="at">scale =</span> <span class="dv">252</span>)</span>
<span id="cb30-166"><a href="#cb30-166" tabindex="-1"></a>      net.SR <span class="ot">&lt;-</span> <span class="fu">mySR</span>(pnl.net.d, <span class="at">scale =</span> <span class="dv">252</span>)</span>
<span id="cb30-167"><a href="#cb30-167" tabindex="-1"></a></span>
<span id="cb30-168"><a href="#cb30-168" tabindex="-1"></a>      gross.CR <span class="ot">&lt;-</span> <span class="fu">myCalmarRatio</span>(pnl.gross.d, <span class="at">scale =</span> <span class="dv">252</span>)</span>
<span id="cb30-169"><a href="#cb30-169" tabindex="-1"></a>      net.CR <span class="ot">&lt;-</span> <span class="fu">myCalmarRatio</span>(pnl.net.d, <span class="at">scale =</span> <span class="dv">252</span>)</span>
<span id="cb30-170"><a href="#cb30-170" tabindex="-1"></a></span>
<span id="cb30-171"><a href="#cb30-171" tabindex="-1"></a>      gross.PnL <span class="ot">&lt;-</span> <span class="fu">sum</span>(pnl.gross.d, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb30-172"><a href="#cb30-172" tabindex="-1"></a>      net.PnL <span class="ot">&lt;-</span> <span class="fu">sum</span>(pnl.net.d, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb30-173"><a href="#cb30-173" tabindex="-1"></a></span>
<span id="cb30-174"><a href="#cb30-174" tabindex="-1"></a>      av.daily.ntrans <span class="ot">&lt;-</span> <span class="fu">mean</span>(ntrans.d, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb30-175"><a href="#cb30-175" tabindex="-1"></a></span>
<span id="cb30-176"><a href="#cb30-176" tabindex="-1"></a>      stat <span class="ot">=</span> net.CR <span class="sc">*</span> <span class="fu">max</span>(<span class="dv">0</span>, <span class="fu">log</span>(<span class="fu">abs</span>(net.PnL<span class="sc">/</span><span class="dv">1000</span>)))</span>
<span id="cb30-177"><a href="#cb30-177" tabindex="-1"></a></span>
<span id="cb30-178"><a href="#cb30-178" tabindex="-1"></a>      <span class="co"># collecting all statistics for a particular quarter</span></span>
<span id="cb30-179"><a href="#cb30-179" tabindex="-1"></a>      <span class="cf">if</span>(volat.sd <span class="sc">==</span> <span class="dv">180</span> <span class="sc">&amp;</span> m_ <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb30-180"><a href="#cb30-180" tabindex="-1"></a>        quarter_stats <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">quarter =</span> selected_quarter,</span>
<span id="cb30-181"><a href="#cb30-181" tabindex="-1"></a>                                    <span class="at">assets.group =</span> <span class="dv">2</span>,</span>
<span id="cb30-182"><a href="#cb30-182" tabindex="-1"></a>                                    gross.SR,</span>
<span id="cb30-183"><a href="#cb30-183" tabindex="-1"></a>                                    net.SR,</span>
<span id="cb30-184"><a href="#cb30-184" tabindex="-1"></a>                                    gross.CR,</span>
<span id="cb30-185"><a href="#cb30-185" tabindex="-1"></a>                                    net.CR,</span>
<span id="cb30-186"><a href="#cb30-186" tabindex="-1"></a>                                    gross.PnL,</span>
<span id="cb30-187"><a href="#cb30-187" tabindex="-1"></a>                                    net.PnL,</span>
<span id="cb30-188"><a href="#cb30-188" tabindex="-1"></a>                                    av.daily.ntrans,</span>
<span id="cb30-189"><a href="#cb30-189" tabindex="-1"></a>                                    stat,</span>
<span id="cb30-190"><a href="#cb30-190" tabindex="-1"></a>                                    <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb30-191"><a href="#cb30-191" tabindex="-1"></a>        )</span>
<span id="cb30-192"><a href="#cb30-192" tabindex="-1"></a>  </span>
<span id="cb30-193"><a href="#cb30-193" tabindex="-1"></a>        <span class="co"># collect summaries for all quarters</span></span>
<span id="cb30-194"><a href="#cb30-194" tabindex="-1"></a>        <span class="cf">if</span>(<span class="sc">!</span><span class="fu">exists</span>(<span class="st">&quot;quarter_stats.all.group2.oos&quot;</span>)) quarter_stats.all.group2.oos <span class="ot">&lt;-</span> quarter_stats <span class="cf">else</span></span>
<span id="cb30-195"><a href="#cb30-195" tabindex="-1"></a>          quarter_stats.all.group2.oos <span class="ot">&lt;-</span> <span class="fu">rbind</span>(quarter_stats.all.group2.oos, quarter_stats)</span>
<span id="cb30-196"><a href="#cb30-196" tabindex="-1"></a>        </span>
<span id="cb30-197"><a href="#cb30-197" tabindex="-1"></a>        <span class="co"># create a plot of gross and net pnl and save it to png file</span></span>
<span id="cb30-198"><a href="#cb30-198" tabindex="-1"></a>        y_range <span class="ot">&lt;-</span> <span class="fu">range</span>(<span class="fu">c</span>(<span class="fu">cumsum</span>(pnl.gross.d), <span class="fu">cumsum</span>(pnl.net.d)))</span>
<span id="cb30-199"><a href="#cb30-199" tabindex="-1"></a></span>
<span id="cb30-200"><a href="#cb30-200" tabindex="-1"></a>        <span class="fu">print</span>( <span class="co"># when plotting in a loop you have to use print()</span></span>
<span id="cb30-201"><a href="#cb30-201" tabindex="-1"></a>          <span class="fu">plot</span>(<span class="fu">cumsum</span>(pnl.gross.d),</span>
<span id="cb30-202"><a href="#cb30-202" tabindex="-1"></a>               <span class="at">type =</span> <span class="st">&quot;l&quot;</span>,</span>
<span id="cb30-203"><a href="#cb30-203" tabindex="-1"></a>               <span class="at">main =</span> <span class="fu">paste0</span>(<span class="st">&quot;Gross and net PnL for asset group 2 </span><span class="sc">\n</span><span class="st"> quarter &quot;</span>, selected_quarter),</span>
<span id="cb30-204"><a href="#cb30-204" tabindex="-1"></a>               <span class="at">col =</span> <span class="st">&quot;#377EB8&quot;</span>,</span>
<span id="cb30-205"><a href="#cb30-205" tabindex="-1"></a>               <span class="at">xlab =</span> <span class="st">&quot;Time&quot;</span>,</span>
<span id="cb30-206"><a href="#cb30-206" tabindex="-1"></a>               <span class="at">ylab =</span> <span class="st">&quot;Cumulative PnL&quot;</span>,</span>
<span id="cb30-207"><a href="#cb30-207" tabindex="-1"></a>               <span class="at">ylim =</span> y_range</span>
<span id="cb30-208"><a href="#cb30-208" tabindex="-1"></a>          )</span>
<span id="cb30-209"><a href="#cb30-209" tabindex="-1"></a>        )</span>
<span id="cb30-210"><a href="#cb30-210" tabindex="-1"></a>        <span class="fu">lines</span>(<span class="fu">cumsum</span>(pnl.net.d), <span class="at">col =</span> <span class="st">&quot;#E41A1C&quot;</span>)</span>
<span id="cb30-211"><a href="#cb30-211" tabindex="-1"></a>        <span class="fu">legend</span>(<span class="st">&quot;topleft&quot;</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">&quot;Gross PnL&quot;</span>, <span class="st">&quot;Net PnL&quot;</span>), <span class="at">col =</span> <span class="fu">c</span>(<span class="st">&quot;#377EB8&quot;</span>, <span class="st">&quot;#E41A1C&quot;</span>), <span class="at">lty =</span> <span class="dv">1</span>, <span class="at">cex =</span> <span class="dv">1</span>)</span>
<span id="cb30-212"><a href="#cb30-212" tabindex="-1"></a>      }</span>
<span id="cb30-213"><a href="#cb30-213" tabindex="-1"></a>      </span>
<span id="cb30-214"><a href="#cb30-214" tabindex="-1"></a>      <span class="co"># summary of a particular strategy</span></span>
<span id="cb30-215"><a href="#cb30-215" tabindex="-1"></a>      summary_ <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">spread =</span> <span class="st">&quot;av.ratio&quot;</span>,</span>
<span id="cb30-216"><a href="#cb30-216" tabindex="-1"></a>                             <span class="at">volat.sd =</span> volat.sd,</span>
<span id="cb30-217"><a href="#cb30-217" tabindex="-1"></a>                             <span class="at">m =</span> m_,</span>
<span id="cb30-218"><a href="#cb30-218" tabindex="-1"></a>                             <span class="at">period =</span> selected_quarter, <span class="co"># &quot;2016-08-16 - 2016-11&quot;,</span></span>
<span id="cb30-219"><a href="#cb30-219" tabindex="-1"></a>                             gross.SR,</span>
<span id="cb30-220"><a href="#cb30-220" tabindex="-1"></a>                             net.SR,</span>
<span id="cb30-221"><a href="#cb30-221" tabindex="-1"></a>                             gross.PnL,</span>
<span id="cb30-222"><a href="#cb30-222" tabindex="-1"></a>                             net.PnL,</span>
<span id="cb30-223"><a href="#cb30-223" tabindex="-1"></a>                             av.daily.ntrans,</span>
<span id="cb30-224"><a href="#cb30-224" tabindex="-1"></a>                             <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb30-225"><a href="#cb30-225" tabindex="-1"></a></span>
<span id="cb30-226"><a href="#cb30-226" tabindex="-1"></a>      <span class="co"># putting all summaries together</span></span>
<span id="cb30-227"><a href="#cb30-227" tabindex="-1"></a></span>
<span id="cb30-228"><a href="#cb30-228" tabindex="-1"></a>      <span class="cf">if</span>(<span class="sc">!</span><span class="fu">exists</span>(<span class="st">&quot;summary.pair.trading&quot;</span>)) summary.pair.trading <span class="ot">&lt;-</span> summary_ <span class="cf">else</span></span>
<span id="cb30-229"><a href="#cb30-229" tabindex="-1"></a>        summary.pair.trading <span class="ot">&lt;-</span> <span class="fu">rbind</span>(summary.pair.trading, summary_)</span>
<span id="cb30-230"><a href="#cb30-230" tabindex="-1"></a>      </span>
<span id="cb30-231"><a href="#cb30-231" tabindex="-1"></a>      <span class="co"># deleting working files not needed any more</span></span>
<span id="cb30-232"><a href="#cb30-232" tabindex="-1"></a>      <span class="fu">rm</span>(gross.SR, net.SR, net.CR,</span>
<span id="cb30-233"><a href="#cb30-233" tabindex="-1"></a>         gross.PnL, net.PnL,</span>
<span id="cb30-234"><a href="#cb30-234" tabindex="-1"></a>         av.daily.ntrans, stat,</span>
<span id="cb30-235"><a href="#cb30-235" tabindex="-1"></a>         pnl.gross.d, pnl.net.d, </span>
<span id="cb30-236"><a href="#cb30-236" tabindex="-1"></a>         ntrans.d,</span>
<span id="cb30-237"><a href="#cb30-237" tabindex="-1"></a>         pnl.gross, pnl.net, </span>
<span id="cb30-238"><a href="#cb30-238" tabindex="-1"></a>         ntrans,</span>
<span id="cb30-239"><a href="#cb30-239" tabindex="-1"></a>         pos.mr, summary_,</span>
<span id="cb30-240"><a href="#cb30-240" tabindex="-1"></a>         XAU_price, XAG_price,</span>
<span id="cb30-241"><a href="#cb30-241" tabindex="-1"></a>         signal, lower, upper)</span>
<span id="cb30-242"><a href="#cb30-242" tabindex="-1"></a>      </span>
<span id="cb30-243"><a href="#cb30-243" tabindex="-1"></a>    } <span class="co"># end of loop for m_</span></span>
<span id="cb30-244"><a href="#cb30-244" tabindex="-1"></a>  } <span class="co"># end of loop for volatility  </span></span>
<span id="cb30-245"><a href="#cb30-245" tabindex="-1"></a>  </span>
<span id="cb30-246"><a href="#cb30-246" tabindex="-1"></a>  <span class="fu">rm</span>(summary.pair.trading)</span>
<span id="cb30-247"><a href="#cb30-247" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-16-1.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-16-2.png" width="672" /></p>
<pre><code>## NULL</code></pre>
<p><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-16-3.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-16-4.png" width="672" /></p>
<pre><code>## NULL</code></pre>
<p><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-16-5.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-16-6.png" width="672" /></p>
<pre><code>## NULL</code></pre>
<p><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-16-7.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-16-8.png" width="672" /></p>
<pre><code>## NULL</code></pre>
<p><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-16-9.png" width="672" /><img src="QSHFD_Foster_Staniszewski_Final_files/figure-html/unnamed-chunk-16-10.png" width="672" /></p>
<pre><code>## NULL</code></pre>
</div>
<div id="performance" class="section level2">
<h2>Performance</h2>
<p>Group 1 performed worse on out-of-sample data, producing an average
Sharpe ratio of <strong>-0.37</strong>, cumulative net P&amp;L of
<strong>-$4,375</strong> and cumulative summary statistic of
<strong>10.3</strong>. The result was reflective of changing market
environment and therefore asset price shortly after the relatively long
EMA days used in the signal, as well meaningful trading costs.</p>
<p>Group 2 repeated its strong performance on out-of-sample data,
producing an average Sharpe ratio of <strong>1.13</strong>, cumulative
net P&amp;L of <strong>$2,928,157</strong> and cumulative summary
statistic of <strong>133.0</strong>. This indicated successful reversion
of the gold-silver spread towards its long-term trend, even at low
divergence levels. Trading frequency was also low, thus incurring
relatively lower costs.</p>
<p>Overall, the performance of Group 2 rendered overall results
satisfactory, generating a substantial P&amp;L and good reward to risk
trade-off.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" tabindex="-1"></a><span class="fu">options</span>(<span class="at">digits=</span><span class="dv">2</span>)</span>
<span id="cb36-2"><a href="#cb36-2" tabindex="-1"></a>quarter_stats.all.group1.oos</span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":["quarter"],"name":[1],"type":["chr"],"align":["left"]},{"label":["assets.group"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["gross.SR"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["net.SR"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["gross.CR"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["net.CR"],"name":[6],"type":["dbl"],"align":["right"]},{"label":["gross.PnL"],"name":[7],"type":["dbl"],"align":["right"]},{"label":["net.PnL"],"name":[8],"type":["dbl"],"align":["right"]},{"label":["av.daily.ntrans"],"name":[9],"type":["dbl"],"align":["right"]},{"label":["stat"],"name":[10],"type":["dbl"],"align":["right"]}],"data":[{"1":"2021_Q2","2":"1","3":"-0.98","4":"-2.32","5":"-1.43","6":"-2.7","7":"-3679","8":"-8959","9":"8.2","10":"-5.90"},{"1":"2022_Q1","2":"1","3":"2.70","4":"2.05","5":"11.09","6":"8.1","7":"20650","8":"15870","9":"7.5","10":"22.29"},{"1":"2022_Q3","2":"1","3":"-0.30","4":"-0.90","5":"-0.54","6":"-1.4","7":"-2509","8":"-7549","9":"7.6","10":"-2.78"},{"1":"2023_Q3","2":"1","3":"-0.11","4":"-1.04","5":"-0.31","6":"-2.3","7":"-571","8":"-5341","9":"7.4","10":"-3.84"},{"1":"2023_Q4","2":"1","3":"1.54","4":"0.37","5":"5.43","6":"1.2","7":"6584","8":"1604","9":"7.8","10":"0.56"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" tabindex="-1"></a><span class="fu">options</span>(<span class="at">digits=</span><span class="dv">2</span>)</span>
<span id="cb37-2"><a href="#cb37-2" tabindex="-1"></a>quarter_stats.all.group2.oos</span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":["quarter"],"name":[1],"type":["chr"],"align":["left"]},{"label":["assets.group"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["gross.SR"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["net.SR"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["gross.CR"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["net.CR"],"name":[6],"type":["dbl"],"align":["right"]},{"label":["gross.PnL"],"name":[7],"type":["dbl"],"align":["right"]},{"label":["net.PnL"],"name":[8],"type":["dbl"],"align":["right"]},{"label":["av.daily.ntrans"],"name":[9],"type":["dbl"],"align":["right"]},{"label":["stat"],"name":[10],"type":["dbl"],"align":["right"]}],"data":[{"1":"2021_Q2","2":"2","3":"4.09","4":"3.95","5":"14.96","6":"14.31","7":"2058232","8":"1979478","9":"3.4","10":"108.6"},{"1":"2022_Q1","2":"2","3":"0.88","4":"0.75","5":"2.17","6":"1.82","7":"543234","8":"461532","9":"3.2","10":"11.1"},{"1":"2022_Q3","2":"2","3":"-0.20","4":"-0.33","5":"-0.35","6":"-0.55","7":"-124499","8":"-204524","9":"2.8","10":"-2.9"},{"1":"2023_Q3","2":"2","3":"0.83","4":"0.64","5":"2.29","6":"1.69","7":"441477","8":"336432","9":"3.8","10":"9.8"},{"1":"2023_Q4","2":"2","3":"0.82","4":"0.64","5":"1.42","6":"1.08","7":"454891","8":"355239","9":"3.6","10":"6.4"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<p>The out-of-sample results for the best models for groups 1 and 2 can
be saved as csv - the following lines need to be uncommented.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" tabindex="-1"></a><span class="co"># write.csv(quarter_stats.all.group1.oos, </span></span>
<span id="cb38-2"><a href="#cb38-2" tabindex="-1"></a><span class="co">#           &quot;quarter_stats.all.group1.oos.csv&quot;,</span></span>
<span id="cb38-3"><a href="#cb38-3" tabindex="-1"></a><span class="co">#           row.names = FALSE)1</span></span>
<span id="cb38-4"><a href="#cb38-4" tabindex="-1"></a></span>
<span id="cb38-5"><a href="#cb38-5" tabindex="-1"></a><span class="co"># write.csv(quarter_stats.all.group2.oos, </span></span>
<span id="cb38-6"><a href="#cb38-6" tabindex="-1"></a><span class="co">#           &quot;quarter_stats.all.group2.oos.csv&quot;,</span></span>
<span id="cb38-7"><a href="#cb38-7" tabindex="-1"></a><span class="co">#           row.names = FALSE)</span></span></code></pre></div>
</div>
</div>

<div id="rmd-source-code">LS0tDQp0aXRsZTogIlF1YW50aXRhdGl2ZSBTdHJhdGVnaWVzIG9uIEhpZ2ggRnJlcXVlbmN5IERhdGEgLSBQcm9qZWN0Ig0KYXV0aG9yOiAiQWRhbSBGb3N0ZXIsIE1hY2llaiBTdGFuaXN6ZXdza2kiDQpkYXRlOiAiMjAyNC0wMS0yMCINCm91dHB1dDoNCiAgaHRtbF9kb2N1bWVudDoNCiAgICB0aGVtZTogY29zbW8NCiAgICBoaWdobGlnaHQ6IGhhZGRvY2sNCiAgICB0b2M6IHRydWUNCiAgICB0b2NfZGVwdGg6IDMNCiAgICB0b2NfZmxvYXQ6IHRydWUNCiAgICBjb2RlX2ZvbGRpbmc6IHNob3cNCiAgICBjb2RlX2Rvd25sb2FkOiB0cnVlDQogICAgY29kZV9leHRlcm5hbDogZmFsc2UNCiAgICBudW1iZXJfc2VjdGlvbnM6IGZhbHNlDQogICAgZmlnX2NhcHRpb246IHRydWUNCiAgICBkZl9wcmludDogcGFnZWQNCiAgICBzZWxmX2NvbnRhaW5lZDogZmFsc2UNCi0tLQ0KDQpgYGB7Y3NzLCBlY2hvPUZBTFNFfQ0KYm9keSB7DQogIGZvbnQtZmFtaWx5OiAnQXJpYWwnLCBzYW5zLXNlcmlmOw0KICBjb2xvcjogIzMzMzMzMzsgLyogRGFyayBncmV5IGZvciB0ZXh0ICovDQp9DQoNCmgxLCBoMiB7DQogIGZvbnQtd2VpZ2h0OiBib2xkOw0KfQ0KDQpoMSwgaDIsIGgzLCBoNCwgaDUsIGg2IHsNCiAgY29sb3I6ICMwMDcwM0M7IC8qIE1pbnQgZ3JlZW4gZm9yIGhlYWRlcnMgKi8NCn0NCg0KYSB7DQogIGNvbG9yOiAjMDA3MDNDOyAvKiBNaW50IGdyZWVuIGZvciBsaW5rcyAqLw0KfQ0KDQpwcmUgY29kZS5yIHsNCiAgYmFja2dyb3VuZC1jb2xvcjogI2Y3ZjdmNyAvKiBMaWdodCBncmV5IGZvciBjb2RlIGJsb2NrIGJhY2tncm91bmQgKi8NCiAgcGFkZGluZzogNXB4OyAvKiBBZGQgc29tZSBwYWRkaW5nIGZvciBiZXR0ZXIgcmVhZGFiaWxpdHkgKi8NCiAgYm9yZGVyLXJhZGl1czogNXB4OyAvKiBBZGQgcm91bmRlZCBjb3JuZXJzICovDQp9DQoNCmJsb2NrcXVvdGUgew0KICBiYWNrZ3JvdW5kOiAjZjlmOWY5Ow0KICBib3JkZXItbGVmdDogMTBweCBzb2xpZCAjY2NjOw0KICBtYXJnaW46IDEuNWVtIDEwcHg7DQogIHBhZGRpbmc6IDAuNWVtIDEwcHg7DQogIHF1b3RlczogIlwyMDFDIiJcMjAxRCIiXDIwMTgiIlwyMDE5IjsNCn0NCg0KYmxvY2txdW90ZTpiZWZvcmUgew0KICBjb2xvcjogI2NjYzsNCiAgY29udGVudDogb3Blbi1xdW90ZTsNCiAgZm9udC1zaXplOiA0ZW07DQogIGxpbmUtaGVpZ2h0OiAwLjFlbTsNCiAgbWFyZ2luLXJpZ2h0OiAwLjI1ZW07DQogIHZlcnRpY2FsLWFsaWduOiAtMC40ZW07DQp9DQoNCmJsb2NrcXVvdGUgcCB7DQogIGRpc3BsYXk6IGlubGluZTsNCiAgZm9udC1zdHlsZTogaXRhbGljOyAvKiBNYWtlIHRoZSBxdW90ZWQgdGV4dCBpdGFsaWMgKi8NCn0NCg0KLnNvdXJjZSB7DQogIGZsb2F0OiByaWdodDsNCiAgZm9udC1zaXplOiA4MCU7DQogIGZvbnQtc3R5bGU6IGl0YWxpYzsNCiAgY29sb3I6ICM4ODg4ODg7DQp9DQpgYGANCg0KDQpgYGB7ciBzZXR1cCwgaW5jbHVkZT1GQUxTRX0NCmtuaXRyOjpvcHRzX2NodW5rJHNldChlY2hvID0gVFJVRSkNCmBgYA0KDQojIEFwcHJvYWNoDQpGb3IgdGhlIGBRdWFudGl0YXRpdmUgU3RyYXRlZ2llcyBvbiBIaWdoIEZyZXF1ZW5jeSBEYXRhYCBwcm9qZWN0LCB0d28gc2V0cyBvZiBzdHJhdGVnaWVzIHdlcmUgZGV2ZWxvcGVkIGZvciB0d28gZ3JvdXBzIG9mIGFzc2V0cy4NCg0KRm9yIGdyb3VwIDEsIHRoZSBhc3NldCBjb25zaWRlcmVkIHdhcyB0aGUgZnV0dXJlcyBjb250cmFjdCBvbiB0aGUgUyZQNTAwIGluZGV4LiBNdWx0aXBsZSBjb21iaW5hdGlvbnMgd2l0aGluIHNpbmdsZSBFTUEgYW5kIGNyb3Nzb3ZlciBFTUEgc3RyYXRlZ2llcyB3ZXJlIHRlc3RlZCBiZWZvcmUgYXJyaXZpbmcgYXQgdGhlIGJlc3QgdmFyaWFudCBiYXNlZCBvbiBpbi1zYW1wbGUgZGF0YSBhY3Jvc3MgYWxsIGF2YWlsYWJsZSBxdWFydGVycy4NCg0KRm9yIGdyb3VwIDIsIGZ1dHVyZXMgY29udHJhY3RzIG9uIGdvbGQgYW5kIHNpbHZlciB3ZXJlIGNvbnNpZGVyZWQuIE11bHRpcGxlIGNvbWJpbmF0aW9ucyB3aXRoaW4gbGV2ZWwtYmFzZWQgYW5kIHJldHVybi1iYXNlZCB2b2xhdGlsaXR5IGJyZWFrb3V0IHBhaXIgdHJhZGluZyBzdHJhdGVnaWVzIHdlcmUgdGVzdGVkLiBTaW1pbGFybHksIHRoZSBiZXN0IHZhcmlhbnQgd2FzIGNob3NlbiBiYXNlZCBvbiBpbi1zYW1wbGUgZGF0YSBhY3Jvc3MgYWxsIGF2YWlsYWJsZSBxdWFydGVycy4NCg0KTW9yZSBkZXRhaWxzIGFyZSBwcm92aWRlZCBpbiBzdWJzZXF1ZW50IHNlY3Rpb25zLg0KDQpUaGlzIHJlcG9ydCBjb250YWlucyBzdWZmaWNpZW50IFIgY29kZSB0byBlZmZlY3RpdmVseSBydW4gYWxsIHRoZSBtb2RlbHMgYW5kIGFuYWx5c2lzLCBlbnN1cmluZyBmdWxsIHJlcHJvZHVjaWJpbGl0eSBvZiByZXN1bHRzLg0KDQojIElucHV0DQpUaGUgd29ya2luZyBkaXJlY3RvcnkgYW5kIHF1YXJ0ZXJzIHdlcmUgZGVmaW5lZC4gQWxsIHF1YXJ0ZXJseSBkYXRhIGhhZCB0byBiZSBzdG9yZWQgaW4gYSBzdWJmb2xkZXIgY2FsbGVkICdkYXRhJyB3aXRoaW4gdGhlIHdvcmtpbmcgZGlyZWN0b3J5Lg0KDQpgYGB7ciwgd2FybmluZyA9IEYsIG1lc3NhZ2UgPSBGfQ0KI3NldHdkKCJDOlxcVXNlcnNcXGFmb3N0XFxEb2N1bWVudHNcXFVXXFxZMlxcUzFcXFF1YW50aXRhdGl2ZSBTdHJhdGVnaWVzIEhpZ2ggRnJlcXVlbmN5IERhdGFcXGhmZF9zdHJhdCIpDQoNCnNlbGVjdGVkX3F1YXJ0ZXJzIDwtIGMoIjIwMjFfUTEiLCAiMjAyMV9RMyIsICIyMDIxX1E0IiwgDQogICIyMDIyX1EyIiwgIjIwMjJfUTQiLCANCiAgIjIwMjNfUTEiLCAiMjAyM19RMiIpDQoNCk9PU19xdWFydGVycyA8LSBjKCIyMDIxX1EyIiwiMjAyMl9RMSIsIjIwMjJfUTMiLCIyMDIzX1EzIiwiMjAyM19RNCIpDQpgYGANCg0KIyBTZXR1cA0KTGlicmFyaWVzLCBmdW5jdGlvbnMgd2VyZSBsb2FkZWQgYW5kIHN5c3RlbSBzZXR0aW5ncyB3ZXJlIHNldC4NCg0KYGBge3IsIHdhcm5pbmcgPSBGLCBtZXNzYWdlID0gRn0NCmxpYnJhcnkoeHRzKQ0KbGlicmFyeShjaHJvbikNCmxpYnJhcnkoVFRSKQ0KbGlicmFyeSh0c2VyaWVzKQ0KbGlicmFyeShrbml0cikNCmxpYnJhcnkoa2FibGVFeHRyYSkNCmxpYnJhcnkocXVhbnRtb2QpDQpsaWJyYXJ5KGNhVG9vbHMpDQpsaWJyYXJ5KGx1YnJpZGF0ZSkNCmxpYnJhcnkoZHBseXIpDQpsaWJyYXJ5KGxhdHRpY2UpDQpsaWJyYXJ5KGdyRGV2aWNlcykNCmxpYnJhcnkoZ2dwbG90MikNCmxpYnJhcnkoY293cGxvdCkNCg0Kb3B0aW9ucyhzY2lwZW49OTk5KQ0KU3lzLnNldGxvY2FsZSgiTENfVElNRSIsICJFbmdsaXNoIikNClN5cy5zZXRlbnYoVFogPSAnQW1lcmljYS9OZXdfWW9yaycpDQoNCnBhcihvbWE9YygwLDAsMiwwKSkgIyBhbGxvY2F0ZSBzcGFjZSBmb3IgcGxvdCBtYXJnaW5zDQoNCm15U1IgPC0gZnVuY3Rpb24oeCwgc2NhbGUpIHsNCiAgc3FydChzY2FsZSkgKiBtZWFuKGNvcmVkYXRhKHgpLCBuYS5ybSA9IFRSVUUpIC8gDQogICAgc2QoY29yZWRhdGEoeCksIG5hLnJtID0gVFJVRSkNCn0gDQoNCm15Q2FsbWFyUmF0aW8gPC0gZnVuY3Rpb24oeCwgIyB4ID0gc2VyaWVzIG9mIHJldHVybnMNCiAgICAgICAgICAgICAgICAgICAgICAgICAgIyBzY2FsZSBwYXJhbWV0ZXIgPSBOdA0KICAgICAgICAgICAgICAgICAgICAgICAgICBzY2FsZSkgew0KICBzY2FsZSAqIG1lYW4oY29yZWRhdGEoeCksIG5hLnJtID0gVFJVRSkgLyANCiAgICBtYXhkcmF3ZG93bihjdW1zdW0oeCkpJG1heGRyYXdkb3duDQogIA0KfQ0KDQpwb3NpdGlvblZCX25ldyA8LSBmdW5jdGlvbihzaWduYWwsIA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgbG93ZXIsIA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgdXBwZXIsIA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zX2ZsYXQsIA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyYXRlZ3kpDQp7DQogIHJlcXVpcmUoeHRzKQ0KICANCiAgIyBsZXRzIGNoZWNrIHRoZXZhbHVlIG9mIHRoZSBzdHJhdGVneSBwYXJhbWV0ZXINCiAgaWYgKCEgc3RyYXRlZ3kgJWluJSBjKCJtb20iLCAibXIiKSkNCiAgeyAgcHJpbnQoIlN0cmF0ZWd5IHBhcmFtZXRlciBpbmNvcnJlY3QuIFBsZWFzZSB1c2UgJ21vbScgb3IgJ21yJyEiKQ0KICAgIHN0b3ANCiAgfQ0KICANCiAgIyBjb252ZXJ0IGlucHV0cyB0byBzaW1wbGVyIG9iamVjdHMgIA0KICBzaWduYWwgPSBjb3JlZGF0YShzaWduYWwpDQogIGxvd2VyID0gY29yZWRhdGEobG93ZXIpDQogIHVwcGVyID0gY29yZWRhdGEodXBwZXIpDQogIHBvc19mbGF0ID0gY29yZWRhdGEocG9zX2ZsYXQpDQogIA0KICANCiAgIyBsZXRzIGZpcnN0IGNyZWF0ZSBhIHZlY3RvciBvZiAwcw0KICBwb3NpdGlvbiA8LSByZXAoMCwgbGVuZ3RoKHNpZ25hbCkpDQogIA0KICBmb3IgKGkgaW4gMjpsZW5ndGgoc2lnbmFsKSkNCiAgew0KICAgIGlmICggcG9zX2ZsYXRbaV0gPT0gMSApIHBvc2l0aW9uW2ldIDwtIDAgDQogICAgZWxzZQ0KICAgIHsgIyBjaGVjayBpZiB2YWx1ZXMgYXJlIG5vbm1pc3NpbmcgKG90aGVyd2lzZSBjYWxjdWxhdGlvbnMgbm90IHBvc3NpYmxlKQ0KICAgICAgaWYgKCFpcy5uYShzaWduYWxbaS0xXSkgJiANCiAgICAgICAgICAhaXMubmEodXBwZXJbaS0xXSkgJiANCiAgICAgICAgICAhaXMubmEobG93ZXJbaS0xXSkpDQogICAgICB7IA0KICAgICAgICAjIHdoYXQgaWYgcHJldmlvdXMgcG9zaXRpb24gd2FzIDANCiAgICAgICAgaWYgKHBvc2l0aW9uW2ktMV0gPT0gMCl7DQogICAgICAgICAgaWYgKHNpZ25hbFtpLTFdID4gdXBwZXJbaS0xXSl7cG9zaXRpb25baV0gPC0gLTF9DQogICAgICAgICAgaWYgKHNpZ25hbFtpLTFdIDwgbG93ZXJbaS0xXSl7cG9zaXRpb25baV0gPC0gMX0NCiAgICAgICAgfSBlbHNlIGlmIChwb3NpdGlvbltpLTFdPT0tMSl7DQogICAgICAgICAgIyB3aGF0IGlmIHByZXZpb3VzIHBvc2l0aW9uIHdhcyAtMQ0KICAgICAgICAgIGlmIChzaWduYWxbaS0xXSA+IGxvd2VyW2ktMV0pe3Bvc2l0aW9uW2ldIDwtIC0xfQ0KICAgICAgICAgIGlmIChzaWduYWxbaS0xXSA8IGxvd2VyW2ktMV0pe3Bvc2l0aW9uW2ldIDwtIDF9DQogICAgICAgIH0gZWxzZSBpZiAocG9zaXRpb25baS0xXT09MSl7DQogICAgICAgICAgIyB3aGF0IGlmIHByZXZpb3VzIHBvc2l0aW9uIHdhcyAxDQogICAgICAgICAgaWYgKHNpZ25hbFtpLTFdIDwgdXBwZXJbaS0xXSl7cG9zaXRpb25baV0gPC0gMX0NCiAgICAgICAgICBpZiAoc2lnbmFsW2ktMV0gPiB1cHBlcltpLTFdKXtwb3NpdGlvbltpXSA8LSAtMX0NCiAgICAgICAgfQ0KICAgICAgfSBlbHNlIHBvc2l0aW9uW2ldIDwtIHBvc2l0aW9uW2ktMV0NCiAgICAgICMgaWYgYW55dGhpbmcgaXMgbWlzc2luZywga2VlcCBwcmV2aW91cyBwb3NpdGlvbg0KICAgIH0NCiAgfQ0KICAjIHJldmVyc2UgdGhlIHBvc2l0aW9uIGlmIHdlIHVzZSBhIG1vbWVudHVtICgibW9tIikgc3RyYXRlZ3kNCiAgaWYoc3RyYXRlZ3kgPT0gIm1vbSIpIHBvc2l0aW9uIDwtICgtcG9zaXRpb24pDQogIA0KICAjIHJldHVybigpIGZ1bmN0aW9uIGNsZWFybHkgaW5kaWNhdGVzIA0KICAjIHdoYXQgdGhlIGZ1bmN0aW9uIHNob3VsZCByZXR1cm4NCiAgcmV0dXJuKHBvc2l0aW9uKQ0KfQ0KDQpwbG90SGVhdG1hcCA8LSBmdW5jdGlvbihkYXRhX3Bsb3QsICMgZGF0YXNldCAoZGF0YS5mcmFtZSkgd2l0aCBjYWxjdWxhdGlvbnMNCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbF92bGFiZWxzLCAjIGNvbHVtbiBuYW1lIHdpdGggdGhlIGxhYmVscyBmb3IgYSB2ZXJ0aWNhbCBheGlzIChzdHJpbmcpDQogICAgICAgICAgICAgICAgICAgICAgICBjb2xfaGxhYmVscywgIyBjb2x1bW4gbmFtZSB3aXRoIHRoZSBsYWJlbHMgZm9yIGEgaG9yaXpvbnRhbCBheGlzIChzdHJpbmcpDQogICAgICAgICAgICAgICAgICAgICAgICBjb2xfdmFyaWFibGUsICMgY29sdW1uIG5hbWUgd2l0aCB0aGUgdmFyaWFibGUgdG8gc2hvdyAoc3RyaW5nKQ0KICAgICAgICAgICAgICAgICAgICAgICAgbWFpbiwgICAgICAjIHRpdGxlDQogICAgICAgICAgICAgICAgICAgICAgICBsYWJlbF9zaXplID0gNiwgIyBzaXplIG9mIGxhYmVscw0KICAgICAgICAgICAgICAgICAgICAgICAgc2F2ZV9ncmFwaCA9IEZBTFNFLCAjIHdoZXRoZXIgdG8gc2F2ZSB0aGUgZ3JhcGgNCiAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoID0gMTIsDQogICAgICAgICAgICAgICAgICAgICAgICBoZWlnaHQgPSA4LA0KICAgICAgICAgICAgICAgICAgICAgICAgZmlsZV9uYW1lID0gTlVMTCkgeyAjIGZpbGVuYW1lIGZvciBzYXZpbmcNCiAgDQogIHJlcXVpcmUoZ2dwbG90MikNCiAgcmVxdWlyZShkcGx5cikNCiAgDQogIA0KICBkYXRhX3Bsb3QkbGFiZWxzXyA8LSByb3VuZChkYXRhX3Bsb3RbLCBjb2xfdmFyaWFibGVdLCAyKQ0KICBkYXRhX3Bsb3RbLCBjb2xfaGxhYmVsc10gPC0gYXMuZmFjdG9yKGRhdGFfcGxvdFssIGNvbF9obGFiZWxzXSkNCiAgZGF0YV9wbG90WywgY29sX3ZsYWJlbHNdIDwtIGFzLmZhY3RvcihkYXRhX3Bsb3RbLCBjb2xfdmxhYmVsc10pDQogIA0KICANCiAgcDEgPC0gZ2dwbG90KGRhdGFfcGxvdCwgDQogICAgICAgICAgICAgICBhZXNfc3RyaW5nKHggPSBjb2xfaGxhYmVscywgDQogICAgICAgICAgICAgICAgICAgICAgICAgIHkgPSBjb2xfdmxhYmVscykpICsNCiAgICBnZW9tX3Jhc3RlcihhZXNfc3RyaW5nKGZpbGwgPSBjb2xfdmFyaWFibGUpKSArDQogICAgdGhlbWVfYncoKSArDQogICAgeGxhYihjb2xfaGxhYmVscykgKw0KICAgIHlsYWIoY29sX3ZsYWJlbHMpICsNCiAgICBnZ3RpdGxlKG1haW4pICsNCiAgICBzY2FsZV9maWxsX2dyYWRpZW50Mihsb3cgPSAicmVkIiwNCiAgICAgICAgICAgICAgICAgICAgICAgICBoaWdoID0gImRhcmtncmVlbiIsDQogICAgICAgICAgICAgICAgICAgICAgICAgbWlkID0gIndoaXRlIiwNCiAgICAgICAgICAgICAgICAgICAgICAgICBtaWRwb2ludCA9IDApICsNCiAgICBnZW9tX2xhYmVsKGFlc19zdHJpbmcobGFiZWwgPSAibGFiZWxzXyIpLA0KICAgICAgICAgICAgICAgc2l6ZSA9IGxhYmVsX3NpemUpICsNCiAgICB0aGVtZShsZWdlbmQucG9zaXRpb24gPSAiYm90dG9tIiwgDQogICAgICAgICAgbGVnZW5kLmtleS53aWR0aCA9IHVuaXQoMiwgImNtIikpDQogIA0KICBpZihzYXZlX2dyYXBoKSB7IA0KICAgIGlmKGlzLm51bGwoZmlsZV9uYW1lKSkgc3RvcCgiUGxlYXNlIHByb3ZpZGUgdGhlIGZpbGVfbmFtZT0gYXJndW1lbnQiKSBlbHNlDQogICAgICBnZ3NhdmUoZmlsZW5hbWUgPSBmaWxlX25hbWUsIA0KICAgICAgICAgICAgIHBsb3QgPSBwMSwgDQogICAgICAgICAgICAgdW5pdHMgPSAiaW4iLA0KICAgICAgICAgICAgIHdpZHRoID0gd2lkdGgsIA0KICAgICAgICAgICAgIGhlaWdodCA9IGhlaWdodCkNCiAgfQ0KICANCiAgcmV0dXJuKHAxKQ0KfQ0KYGBgDQoNCiMgR3JvdXAgMQ0KR3JvdXAgMSBkYXRhIHdhcyBsaW1pdGVkIHRvIHRoZSBTJlA1MDAgaW5kZXguIE5BIHZhbHVlcyB3ZXJlIGluc2VydGVkIGluIHRoZSBmaXJzdCBhbmQgbGFzdCAxMCBtaW51dGVzIG9mIHRoZSB0cmFkaW5nIHNlc3Npb24gdG8gYXZvaWQgdHJhZGluZyBvbiB2b2xhdGlsZSBhbmQgcmVhY3RpdmUgcGFydHMgb2YgdGhlIGRheSBhbmQgdG8gZm9jdXMgb24gaW50cmFkYXkgdHJhZGluZy4NCg0KRXhwb25lbnRpYWwgTW92aW5nIEF2ZXJhZ2UgKEVNQSkgd2FzIHRoZSBtZXRyaWMgb2YgY2hvaWNlIGluIHRoZSBhbGdvcml0aG0uIFRoZSB0aW1lIHNlcmllcyBpcyB1bml2YXJpYXRlIGFuZCBFTUEgcGxhY2VzIGdyZWF0ZXIgZW1waGFzaXMgb24gcmVjZW50IHByaWNlcyB0aGFuIFNNQS4gQm90aCBzaW5nbGUgRU1BIGFuZCBjcm9zc292ZXIgRU1BIHdlcmUgdGVzdGVkIGZvciBlbnRyeSBhbmQgZXhpdC4gU2luZ2xlIEVNQSB0cmlnZ2VyZWQgYSBsb25nIHBvc2l0aW9uIHdoZW5ldmVyIHByaWNlIGV4Y2VlZGVkIHRoZSBFTUEgYW5kIHNob3J0IHBvc2l0aW9uIG90aGVyd2lzZTsgY3Jvc3NvdmVyIEVNQSB0cmlnZ2VyZWQgYSBsb25nIHBvc2l0aW9uIHdoZW5ldmVyIGZhc3QgRU1BIGV4Y2VlZGVkIHNsb3cgRU1BIGFuZCBzaG9ydCBwb3NpdGlvbiBvdGhlcndpc2UuIFRoaXMgc3RyYXRlZ3kgd2FzIHRlcm1lZCB0aGUgbW9tZW50dW0gc3RyYXRlZ3kgYmVpbmcgaW4gdGhlIG1hcmtldC4gQSBjb3JyZXNwb25kaW5nIHNldCBvZiByZXN1bHRzIHdhcyBnZW5lcmF0ZWQgZm9yIHRoZSBtZWFuIHJldmVyc2lvbiBzdHJhdGVneS4NCg0KSW4gb3JkZXIgdG8gZGV0ZXJtaW5lIHRoZSBvcHRpbWFsIHBhcmFtZXRlcnMgZm9yIHRoZSBtb2RlbHMsIG11bHRpcGxlIGNvbWJpbmF0aW9ucyBvZiBFTUEgdGltZSBob3Jpem9ucyB3ZXJlIHRlc3RlZDogMTAtODAgZGF5cyBmb3Igc2luZ2xlIEVNQSBhbmQgZXZlcnkgY29tYmluYXRpb24gb2YgMTAtODAgZGF5cyBjb25zdHJhaW5lZCBieSBmYXN0IGFsd2F5cyBoYXZpbmcgdG8gYmUgZmV3ZXIgZGF5cyB0aGFuIHNsb3cgZm9yIGNyb3Nzb3ZlciBFTUEuDQoNCkFsbCBwb3NpdGlvbnMgd2VyZSBleGl0ZWQgaW4gdGhlIGZpcnN0IDI1IGFuZCBsYXN0IDIwIG1pbnV0ZXMgb2YgdGhlIHRyYWRpbmcgc2Vzc2lvbiBhbmQgaW4gYmV0d2VlbiBzZXNzaW9ucy4gQW55IHJlbWFpbmluZyBtaXNzaW5nIHZhbHVlIHdhcyBwb3B1bGF0ZWQgd2l0aCB0aGUgcHJldmlvdXMgdmFsdWUgZm9yIGNvbXBsZXRlbmVzcy4NCg0KR3Jvc3MgUCZMIChhY2NvdW50aW5nIGZvciBwb2ludCB2YWx1ZXMpLCBuZXQgUCZMIChyZWZsZWN0aW5nIHRyYW5zYWN0aW9uIGNvc3RzKSBhbmQgbnVtYmVyIG9mIHRyYWRlcyB3ZXJlIGNhbGN1bGF0ZWQuIFRoZSBkYXRhIHdhcyB0aGVuIGFnZ3JlZ2F0ZWQgdG8gZGFpbHkgbGV2ZWwgYW5kIHRoZSBmb2xsb3dpbmcgbWV0cmljcyB3ZXJlIGNhbGN1bGF0ZWQ6IFNoYXJwZSByYXRpbywgQ2FsbWFyIHJhdGlvLCBhdmVyYWdlIG51bWJlciBvZiB0cmFkZXMsIGN1bXVsYXRpdmUgc3VtIG9mIGdyb3NzIFAmTCwgY3VtdWxhdGl2ZSBzdW0gb2YgbmV0IFAmTCBhbmQgYSBmaW5hbCB0ZXN0IHN0YXRpc3RpYy4NCg0KVGhlIGVudGlyZSBwcm9jZXNzIHdhcyByZXBlYXRlZCBmb3IgYWxsIGluLXNhbXBsZSBxdWFydGVycy4NCg0KYGBge3IsIHdhcm5pbmcgPSBGLCBtZXNzYWdlID0gRn0NCmhlYXRtYXBfbGlzdF9zaW5nbGUgPC0gbGlzdCgpDQpoZWF0bWFwX2xpc3RfY3Jvc3MgPC0gbGlzdCgpDQpoZWF0bWFwX2xpc3Rfc2luZ2xlX21yIDwtIGxpc3QoKQ0KaGVhdG1hcF9saXN0X2Nyb3NzX21yIDwtIGxpc3QoKQ0Kc2Vuc2l0aXZpdGllc19zaW5nbGUgPC0gbGlzdCgpDQpzZW5zaXRpdml0aWVzX2Nyb3NzIDwtIGxpc3QoKQ0Kc2Vuc2l0aXZpdGllc19zaW5nbGVfbXIgPC0gbGlzdCgpDQpzZW5zaXRpdml0aWVzX2Nyb3NzX21yIDwtIGxpc3QoKQ0KDQpmb3IgKHNlbGVjdGVkX3F1YXJ0ZXIgaW4gc2VsZWN0ZWRfcXVhcnRlcnMpIHsNCiAgDQogIG1lc3NhZ2Uoc2VsZWN0ZWRfcXVhcnRlcikNCiAgDQogIGZpbGVuYW1lXyA8LSBwYXN0ZTAoImRhdGEvZGF0YTFfIiwgc2VsZWN0ZWRfcXVhcnRlciwgIi5SRGF0YSIpDQogIGxvYWQoZmlsZW5hbWVfKQ0KICANCiAgIyBjcmVhdGUgaW5kZXggb2YgdGltZXMgZm9yIHRoaXMgcXVhcnRlcg0KICBkYXRhLmdyb3VwMSA8LSBnZXQocGFzdGUwKCJkYXRhMV8iLCBzZWxlY3RlZF9xdWFydGVyKSkNCiAgdGltZXNfIDwtIHN1YnN0cihpbmRleChkYXRhLmdyb3VwMSksIDEyLCAxOSkNCiAgDQogICMgS2VlcCBTJlA1MDANCiAgZGF0YS5ncm91cDEgPC0gZGF0YS5ncm91cDFbLCAhY29sbmFtZXMoZGF0YS5ncm91cDEpICVpbiUgYygiTlEiKV0NCiAgDQogICMgdGhlIGZvbGxvd2luZyBjb21tb24gYXNzdW1wdGlvbnMgd2VyZSBkZWZpbmVkOg0KICAjIDEuCWRvIG5vdCB1c2UgaW4gY2FsY3VsYXRpb25zIHRoZSBkYXRhIGZyb20gdGhlIGZpcnN0IA0KICAjIGFuZCBsYXN0IDEwIG1pbnV0ZXMgb2YgdGhlIHNlc3Npb24gKDk6MzEtLTk6NDAgYW5kIDE1OjUxLS0xNjowMCkNCiAgIyDigJMgcHV0IG1pc3NpbmcgdmFsdWVzIHRoZXJlLA0KICANCiAgIyBsZXRzIHB1dCBtaXNzaW5nIHZhbHVlcyBmb3IgdGhlc2UgcGVyaW9kcw0KICBkYXRhLmdyb3VwMVsiVDA5OjMxL1QwOTo0MCIsXSA8LSBOQSANCiAgZGF0YS5ncm91cDFbIlQxNTo1MS9UMTY6MDAiLF0gPC1OQQ0KICANCiAgbXlUaGVtZSA8LSBjaGFydF90aGVtZSgpDQogIG15VGhlbWUkY29sJGxpbmUuY29sIDwtICJkYXJrYmx1ZSINCiAgbGF5b3V0KG1hdHJpeCgxOjEsIDEsIDEpKQ0KICBwcmludChjaGFydF9TZXJpZXMoZGF0YS5ncm91cDEkU1AsIHRoZW1lID0gbXlUaGVtZSkpDQogIGxheW91dChtYXRyaXgoMSkpDQoNCg0KICAjIE1vbWVudHVtDQogIA0KICAjIFNpbmdsZSBFTUENCiAgDQogIEVNQV9wYWlycyA9IGxpc3QoYygxLCAxMCksIGMoMSwgMjApLCBjKDEsIDMwKSwgYygxLCA0MCksIGMoMSwgNTApLCBjKDEsIDYwKSwgYygxLCA3MCksIGMoMSwgODApKQ0KICBkYXRhLmdyb3VwMWEgPC0gZGF0YS5ncm91cDENCiAgDQogIGZvciAocGFpciBpbiBFTUFfcGFpcnMpIHsNCiAgICAjIGxldHMgY2FsY3VsYXRlIEVNQWZhc3QgYW5kIEVNQXNsb3cgZm9yIFNQDQogICAgZGF0YS5ncm91cDFhJFNQX0VNQSA8LSBFTUEobmEubG9jZihkYXRhLmdyb3VwMWEkU1ApLCBwYWlyWzJdKQ0KICAgIA0KICAgICMgcHV0IG1pc3NpbmcgdmFsdWUgd2hlbmV2ZXIgdGhlIG9yaWdpbmFsIHByaWNlIGlzIG1pc3NpbmcNCiAgICBkYXRhLmdyb3VwMWEkU1BfRU1BW2lzLm5hKGRhdGEuZ3JvdXAxYSRTUCldIDwtIE5BDQogICAgDQogICAgIyBsZXRzIGNhbGN1bGF0ZSB0aGUgcG9zaXRpb24gZm9yIHRoZSBNT01FTlRVTSBzdHJhdGVneQ0KICAgICMgaWYgcHJpY2UodC0xKSA+IE1BKHQtMSkgPT4gcG9zKHQpID0gMSBbbG9uZ10NCiAgICAjIGlmIHByaWNlKHQtMSkgPD0gTUEodC0xKSA9PiBwb3ModCkgPSAtMSBbc2hvcnRdDQogICAgIyB0aGlzIHN0cmF0ZWd5IGlzIGFsd2F5cyBpbiB0aGUgbWFya2V0DQogICAgZGF0YS5ncm91cDFhJHBvc2l0aW9uU1AubW9tIDwtIGlmZWxzZShsYWcueHRzKGRhdGEuZ3JvdXAxYSRTUCkgPg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWcueHRzKGRhdGEuZ3JvdXAxYSRTUF9FTUEpLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMSwgLTEpDQogICAgDQogICAgIyBsZXRzIGFwcGx5IHRoZSByZW1haW5pbmcgYXNzdW1wdGlvbnMNCiAgICAjIC0gZXhpdCBhbGwgcG9zaXRpb25zIDIwIG1pbnV0ZXMgYmVmb3JlIHRoZSBzZXNzaW9uIGVuZCwgaS5lLiBhdCAxNTo0MA0KICAgICMgLSBkbyBub3QgdHJhZGUgd2l0aGluIHRoZSBmaXJzdCAyNSBtaW51dGVzIG9mIHN0b2NrcyBxdW90YXRpb25zICh1bnRpbCA5OjU1KQ0KICAgIGRhdGEuZ3JvdXAxYSRwb3NpdGlvblNQLm1vbVt0aW1lcyh0aW1lc18pIDw9IHRpbWVzKCIwOTo1NTowMCIpIHwgDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGltZXModGltZXNfKSA+IHRpbWVzKCIxNTo0MDowMCIpXSA8LSAwDQogICAgDQogICAgDQogICAgIyBsZXRzIGFsc28gZmlsbCBldmVyeSBtaXNzaW5nIHBvc2l0aW9uIHdpdGggdGhlIHByZXZpb3VzIG9uZQ0KICAgIA0KICAgIGRhdGEuZ3JvdXAxYSRwb3NpdGlvblNQLm1vbSA8LSBuYS5sb2NmKGRhdGEuZ3JvdXAxYSRwb3NpdGlvblNQLm1vbSwgbmEucm0gPSBGQUxTRSkNCiAgICANCiAgICAjIGNhbGN1bGF0aW5nIGdyb3NzIHBubA0KICAgIA0KICAgIGRhdGEuZ3JvdXAxYSRwbmxfZ3Jvc3NTUC5tb20gPC0gZGF0YS5ncm91cDFhJHBvc2l0aW9uU1AubW9tICogZGlmZi54dHMoZGF0YS5ncm91cDFhJFNQKSAqIDUwDQogICAgDQogICAgDQogICAgIyBudW1iZXIgb2YgdHJhbnNhY3Rpb25zDQogICAgZGF0YS5ncm91cDFhJG50cmFuc1NQLm1vbSA8LSBhYnMoZGlmZi54dHMoZGF0YS5ncm91cDFhJHBvc2l0aW9uU1AubW9tKSkNCiAgICANCiAgICBkYXRhLmdyb3VwMWEkbnRyYW5zU1AubW9tWzFdIDwtIDANCiAgICANCiAgICAjIG5ldCBwbmwNCiAgICBkYXRhLmdyb3VwMWEkcG5sX25ldFNQLm1vbSA8LSBkYXRhLmdyb3VwMWEkcG5sX2dyb3NzU1AubW9tICAtDQogICAgICBkYXRhLmdyb3VwMWEkbnRyYW5zU1AubW9tICogMTAgIyAkMTAgcGVyIHRyYW5zYWN0aW9uDQogICAgDQogICAgIyB0b3RhbCBmb3Igc3RyYXRlZ3kNCiAgICANCiAgICBkYXRhLmdyb3VwMWEkcG5sX2dyb3NzLm1vbSA8LSBkYXRhLmdyb3VwMWEkcG5sX2dyb3NzU1AubW9tDQogICAgZGF0YS5ncm91cDFhJHBubF9uZXQubW9tIDwtIGRhdGEuZ3JvdXAxYSRwbmxfbmV0U1AubW9tDQogICAgDQogICAgDQogICAgIyBhZ2dyZWdhdGUgcG5scyBhbmQgbnVtYmVyIG9mIHRyYW5zYWN0aW9ucyB0byBkYWlseQ0KICAgIG15LmVuZHBvaW50cyA8LSBlbmRwb2ludHMoZGF0YS5ncm91cDFhLCAiZGF5cyIpDQogICAgDQogICAgZGF0YS5ncm91cDFhLmRhaWx5IDwtIHBlcmlvZC5hcHBseShkYXRhLmdyb3VwMWFbLGMoZ3JlcCgicG5sIiwgbmFtZXMoZGF0YS5ncm91cDFhKSksDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JlcCgibnRyYW5zIiwgbmFtZXMoZGF0YS5ncm91cDFhKSkpXSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIElOREVYID0gbXkuZW5kcG9pbnRzLCANCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEZVTiA9IGZ1bmN0aW9uKHgpIGNvbFN1bXMoeCwgbmEucm0gPSBUUlVFKSkNCiAgICANCiAgICAjIHN1bW1hcml6ZSB0aGUgc3RyYXRlZ3kgZm9yIHRoaXMgcXVhcnRlcg0KICAgIA0KICAgICMgU1INCiAgICBncm9zc1NSID0gbXlTUih4ID0gZGF0YS5ncm91cDFhLmRhaWx5JHBubF9ncm9zcy5tb20sIHNjYWxlID0gMjUyKQ0KICAgIG5ldFNSID0gbXlTUih4ID0gZGF0YS5ncm91cDFhLmRhaWx5JHBubF9uZXQubW9tLCBzY2FsZSA9IDI1MikNCiAgICAjIENSDQogICAgZ3Jvc3NDUiA9IG15Q2FsbWFyUmF0aW8oeCA9IGRhdGEuZ3JvdXAxYS5kYWlseSRwbmxfZ3Jvc3MubW9tLCBzY2FsZSA9IDI1MikNCiAgICBuZXRDUiA9IG15Q2FsbWFyUmF0aW8oeCA9IGRhdGEuZ3JvdXAxYS5kYWlseSRwbmxfbmV0Lm1vbSwgc2NhbGUgPSAyNTIpDQogICAgDQogICAgIyBhdmVyYWdlIG51bWJlciBvZiB0cmFuc2FjdGlvbnMNCiAgICBhdi5kYWlseS5udHJhZGVzID0gbWVhbihkYXRhLmdyb3VwMWEuZGFpbHkkbnRyYW5zU1AubW9tLCBuYS5ybSA9IFRSVUUpDQogICAgIyBQbkwNCiAgICBncm9zc1BuTCA9IHN1bShkYXRhLmdyb3VwMWEuZGFpbHkkcG5sX2dyb3NzLm1vbSkNCiAgICBuZXRQbkwgPSBzdW0oZGF0YS5ncm91cDFhLmRhaWx5JHBubF9uZXQubW9tKQ0KICAgICMgc3RhdA0KICAgIHN0YXQgPSBuZXRDUiAqIG1heCgwLCBsb2coYWJzKG5ldFBuTC8xMDAwKSkpDQogICAgDQogICAgIyBzdW1tYXJ5IG9mIGEgcGFydGljdWxhciBzdHJhdGVneQ0KICAgIHN1bW1hcnlfIDwtIGRhdGEuZnJhbWUoQ2xvc2UgPSAxLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgRU1BID0gcGFpclsyXSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgIHBlcmlvZCA9IHNlbGVjdGVkX3F1YXJ0ZXIsICMgIjIwMTYtMDgtMTYgLSAyMDE2LTExIiwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyb3NzLlNSID0gZ3Jvc3NTUiwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ldC5TUiA9IG5ldFNSLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3Jvc3MuUG5MID0gZ3Jvc3NQbkwsDQogICAgICAgICAgICAgICAgICAgICAgICAgICBuZXQuUG5MID0gbmV0UG5MLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgYXYuZGFpbHkubnRyYW5zID0gYXYuZGFpbHkubnRyYWRlcywNCiAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cmluZ3NBc0ZhY3RvcnMgPSBGQUxTRSkNCiAgICANCiAgICAjIHB1dHRpbmcgYWxsIHN1bW1hcmllcyB0b2dldGhlcg0KICAgIA0KICAgIGlmKCFleGlzdHMoInN1bW1hcnkucGFpci50cmFkaW5nIikpIHN1bW1hcnkucGFpci50cmFkaW5nIDwtIHN1bW1hcnlfIGVsc2UNCiAgICAgIHN1bW1hcnkucGFpci50cmFkaW5nIDwtIHJiaW5kKHN1bW1hcnkucGFpci50cmFkaW5nLCBzdW1tYXJ5XykNCiAgICANCiAgICAjIGRlbGV0aW5nIHdvcmtpbmcgZmlsZXMgbm90IG5lZWRlZCBhbnkgbW9yZQ0KICAgIHJtKGdyb3NzU1IsIG5ldFNSLCBuZXRDUiwNCiAgICAgICBncm9zc1BuTCwgbmV0UG5MLA0KICAgICAgIGF2LmRhaWx5Lm50cmFkZXMsIHN0YXQsDQogICAgICAgc3VtbWFyeV8pDQogIH0NCiAgDQogICMgbmV0LlNSIC0gc3ByZWFkIGF2X3JhdGlvDQogIGhlYXRtYXBfc3Jfc2luZ2xlIDwtIHBsb3RIZWF0bWFwKGRhdGFfcGxvdCA9IHN1bW1hcnkucGFpci50cmFkaW5nLCAjIGRhdGFzZXQgKGRhdGEuZnJhbWUpIHdpdGggY2FsY3VsYXRpb25zDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbF92bGFiZWxzID0gIkNsb3NlIiwgIyBjb2x1bW4gbmFtZSB3aXRoIHRoZSBsYWJlbHMgZm9yIGEgdmVydGljYWwgYXhpcyAoc3RyaW5nKQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xfaGxhYmVscyA9ICJFTUEiLCAjIGNvbHVtbiBuYW1lIHdpdGggdGhlIGxhYmVscyBmb3IgYSBob3Jpem9udGFsIGF4aXMgKHN0cmluZykNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sX3ZhcmlhYmxlID0gIm5ldC5TUiIsICMgY29sdW1uIG5hbWUgd2l0aCB0aGUgdmFyaWFibGUgdG8gc2hvdyAoc3RyaW5nKQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYWluID0gcGFzdGUoc2VsZWN0ZWRfcXVhcnRlciwgIlNlbnNpdGl2aXR5IGFuYWx5c2lzIGZvciBtb21lbnR1bSBzdGF0ZWd5IGJhc2VkIG9uIHNpbmdsZSBFTUEiLCBzZXAgPSAiOiAiKSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWxfc2l6ZSA9IDMpDQogIA0KICBzZW5zaXRpdml0aWVzX3NpbmdsZVtbc2VsZWN0ZWRfcXVhcnRlcl1dIDwtIHN1bW1hcnkucGFpci50cmFkaW5nDQogIHJtKHN1bW1hcnkucGFpci50cmFkaW5nKQ0KICBoZWF0bWFwX2xpc3Rfc2luZ2xlW1tzZWxlY3RlZF9xdWFydGVyXV0gPC0gaGVhdG1hcF9zcl9zaW5nbGUNCiAgDQogIA0KICAjIEVNQSBDcm9zc292ZXINCiAgDQogIEVNQV9wYWlycyA9IGxpc3QoYygxMCwgMjApLCBjKDEwLCAzMCksIGMoMTAsIDQwKSwgYygxMCwgNTApLCBjKDEwLCA2MCksIGMoMTAsIDcwKSwgYygxMCwgODApLA0KICAgICAgICAgICAgICAgICAgIGMoMjAsIDMwKSwgYygyMCwgNDApLCBjKDIwLCA1MCksIGMoMjAsIDYwKSwgYygyMCwgNzApLCBjKDIwLCA4MCksDQogICAgICAgICAgICAgICAgICAgYygzMCwgNDApLCBjKDMwLCA1MCksIGMoMzAsIDYwKSwgYygzMCwgNzApLCBjKDMwLCA4MCksDQogICAgICAgICAgICAgICAgICAgYyg0MCwgNTApLCBjKDQwLCA2MCksIGMoNDAsIDcwKSwgYyg0MCwgODApLA0KICAgICAgICAgICAgICAgICAgIGMoNTAsIDYwKSwgYyg1MCwgNzApLCBjKDUwLCA4MCksDQogICAgICAgICAgICAgICAgICAgYyg2MCwgNzApLCBjKDYwLCA4MCksDQogICAgICAgICAgICAgICAgICAgYyg3MCwgODApKQ0KICANCiAgZGF0YS5ncm91cDFiIDwtIGRhdGEuZ3JvdXAxDQogIA0KICAjIHBhaXIgPC0gYyg2MCwgNzApDQogIGZvciAocGFpciBpbiBFTUFfcGFpcnMpIHsNCiAgICAjIGxldHMgY2FsY3VsYXRlIEVNQWZhc3QgYW5kIEVNQXNsb3cgZm9yIFNQDQogICAgZGF0YS5ncm91cDFiJFNQX0VNQWZhc3QgPC0gRU1BKG5hLmxvY2YoZGF0YS5ncm91cDFiJFNQKSwgcGFpclsxXSkNCiAgICBkYXRhLmdyb3VwMWIkU1BfRU1Bc2xvdyA8LSBFTUEobmEubG9jZihkYXRhLmdyb3VwMWIkU1ApLCBwYWlyWzJdKQ0KICAgIA0KICAgICMgcHV0IG1pc3NpbmcgdmFsdWUgd2hlbmV2ZXIgdGhlIG9yaWdpbmFsIHByaWNlIGlzIG1pc3NpbmcNCiAgICBkYXRhLmdyb3VwMWIkU1BfRU1BZmFzdFtpcy5uYShkYXRhLmdyb3VwMWIkU1ApXSA8LSBOQQ0KICAgIGRhdGEuZ3JvdXAxYiRTUF9FTUFzbG93W2lzLm5hKGRhdGEuZ3JvdXAxYiRTUCldIDwtIE5BDQogICAgDQogICAgIyBsZXRzIGNhbGN1bGF0ZSB0aGUgcG9zaXRpb24gZm9yIHRoZSBNT01FTlRVTSBzdHJhdGVneQ0KICAgICMgaWYgZmFzdCBNQSh0LTEpID4gc2xvdyBNQSh0LTEpID0+IHBvcyh0KSA9IDEgW2xvbmddDQogICAgIyBpZiBmYXN0IE1BKHQtMSkgPD0gc2xvdyBNQSh0LTEpID0+IHBvcyh0KSA9IC0xIFtzaG9ydF0NCiAgICAjIHRoaXMgc3RyYXRlZ3kgaXMgYWx3YXlzIGluIHRoZSBtYXJrZXQNCiAgICBkYXRhLmdyb3VwMWIkcG9zaXRpb25TUC5tb20gPC0gaWZlbHNlKGxhZy54dHMoZGF0YS5ncm91cDFiJFNQX0VNQWZhc3QpID4NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFnLnh0cyhkYXRhLmdyb3VwMWIkU1BfRU1Bc2xvdyksDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAxLCAtMSkNCiAgICANCiAgICAjIGxldHMgYXBwbHkgdGhlIHJlbWFpbmluZyBhc3N1bXB0aW9ucw0KICAgICMgLSBleGl0IGFsbCBwb3NpdGlvbnMgMjAgbWludXRlcyBiZWZvcmUgdGhlIHNlc3Npb24gZW5kLCBpLmUuIGF0IDE1OjQwDQogICAgIyAtIGRvIG5vdCB0cmFkZSB3aXRoaW4gdGhlIGZpcnN0IDI1IG1pbnV0ZXMgb2Ygc3RvY2tzIHF1b3RhdGlvbnMgKHVudGlsIDk6NTUpDQogICAgZGF0YS5ncm91cDFiJHBvc2l0aW9uU1AubW9tW3RpbWVzKHRpbWVzXykgPD0gdGltZXMoIjA5OjU1OjAwIikgfCANCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aW1lcyh0aW1lc18pID4gdGltZXMoIjE1OjQwOjAwIildIDwtIDANCiAgICANCiAgICANCiAgICAjIGxldHMgYWxzbyBmaWxsIGV2ZXJ5IG1pc3NpbmcgcG9zaXRpb24gd2l0aCB0aGUgcHJldmlvdXMgb25lDQogICAgDQogICAgZGF0YS5ncm91cDFiJHBvc2l0aW9uU1AubW9tIDwtIG5hLmxvY2YoZGF0YS5ncm91cDFiJHBvc2l0aW9uU1AubW9tLCBuYS5ybSA9IEZBTFNFKQ0KICAgIA0KICAgICMgY2FsY3VsYXRpbmcgZ3Jvc3MgcG5sDQogICAgDQogICAgZGF0YS5ncm91cDFiJHBubF9ncm9zc1NQLm1vbSA8LSBkYXRhLmdyb3VwMWIkcG9zaXRpb25TUC5tb20gKiBkaWZmLnh0cyhkYXRhLmdyb3VwMWIkU1ApICogNTANCiAgICANCiAgICANCiAgICAjIG51bWJlciBvZiB0cmFuc2FjdGlvbnMNCiAgICBkYXRhLmdyb3VwMWIkbnRyYW5zU1AubW9tIDwtIGFicyhkaWZmLnh0cyhkYXRhLmdyb3VwMWIkcG9zaXRpb25TUC5tb20pKQ0KICAgIA0KICAgIGRhdGEuZ3JvdXAxYiRudHJhbnNTUC5tb21bMV0gPC0gMA0KICAgIA0KICAgICMgbmV0IHBubA0KICAgIGRhdGEuZ3JvdXAxYiRwbmxfbmV0U1AubW9tIDwtIGRhdGEuZ3JvdXAxYiRwbmxfZ3Jvc3NTUC5tb20gIC0NCiAgICAgIGRhdGEuZ3JvdXAxYiRudHJhbnNTUC5tb20gKiAxMCAjICQxMCBwZXIgdHJhbnNhY3Rpb24NCiAgICANCiAgICAjIHRvdGFsIGZvciBzdHJhdGVneQ0KICAgIA0KICAgIGRhdGEuZ3JvdXAxYiRwbmxfZ3Jvc3MubW9tIDwtIGRhdGEuZ3JvdXAxYiRwbmxfZ3Jvc3NTUC5tb20NCiAgICBkYXRhLmdyb3VwMWIkcG5sX25ldC5tb20gPC0gZGF0YS5ncm91cDFiJHBubF9uZXRTUC5tb20NCiAgICANCiAgICANCiAgICAjIGFnZ3JlZ2F0ZSBwbmxzIGFuZCBudW1iZXIgb2YgdHJhbnNhY3Rpb25zIHRvIGRhaWx5DQogICAgbXkuZW5kcG9pbnRzIDwtIGVuZHBvaW50cyhkYXRhLmdyb3VwMWIsICJkYXlzIikNCiAgICANCiAgICBkYXRhLmdyb3VwMWIuZGFpbHkgPC0gcGVyaW9kLmFwcGx5KGRhdGEuZ3JvdXAxYlssYyhncmVwKCJwbmwiLCBuYW1lcyhkYXRhLmdyb3VwMWIpKSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncmVwKCJudHJhbnMiLCBuYW1lcyhkYXRhLmdyb3VwMWIpKSldLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgSU5ERVggPSBteS5lbmRwb2ludHMsIA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgRlVOID0gZnVuY3Rpb24oeCkgY29sU3Vtcyh4LCBuYS5ybSA9IFRSVUUpKQ0KICAgIA0KICAgICMgc3VtbWFyaXplIHRoZSBzdHJhdGVneSBmb3IgdGhpcyBxdWFydGVyDQogICAgDQogICAgIyBTUg0KICAgIGdyb3NzU1IgPSBteVNSKHggPSBkYXRhLmdyb3VwMWIuZGFpbHkkcG5sX2dyb3NzLm1vbSwgc2NhbGUgPSAyNTIpDQogICAgbmV0U1IgPSBteVNSKHggPSBkYXRhLmdyb3VwMWIuZGFpbHkkcG5sX25ldC5tb20sIHNjYWxlID0gMjUyKQ0KICAgICMgQ1INCiAgICBncm9zc0NSID0gbXlDYWxtYXJSYXRpbyh4ID0gZGF0YS5ncm91cDFiLmRhaWx5JHBubF9ncm9zcy5tb20sIHNjYWxlID0gMjUyKQ0KICAgIG5ldENSID0gbXlDYWxtYXJSYXRpbyh4ID0gZGF0YS5ncm91cDFiLmRhaWx5JHBubF9uZXQubW9tLCBzY2FsZSA9IDI1MikNCiAgICANCiAgICAjIGF2ZXJhZ2UgbnVtYmVyIG9mIHRyYW5zYWN0aW9ucw0KICAgIGF2LmRhaWx5Lm50cmFkZXMgPSBtZWFuKGRhdGEuZ3JvdXAxYi5kYWlseSRudHJhbnNTUC5tb20sIG5hLnJtID0gVFJVRSkNCiAgICAjIFBuTA0KICAgIGdyb3NzUG5MID0gc3VtKGRhdGEuZ3JvdXAxYi5kYWlseSRwbmxfZ3Jvc3MubW9tKQ0KICAgIG5ldFBuTCA9IHN1bShkYXRhLmdyb3VwMWIuZGFpbHkkcG5sX25ldC5tb20pDQogICAgIyBzdGF0DQogICAgc3RhdCA9IG5ldENSICogbWF4KDAsIGxvZyhhYnMobmV0UG5MLzEwMDApKSkNCiAgICANCiAgICAjIGNvbGxlY3RpbmcgYWxsIHN0YXRpc3RpY3MgZm9yIGEgcGFydGljdWxhciBxdWFydGVyDQogICAgaWYocGFpclsxXSA9PSA2MCAmIHBhaXJbMl0gPT0gNzApIHsNCiAgICAgIHF1YXJ0ZXJfc3RhdHMgPC0gZGF0YS5mcmFtZShxdWFydGVyID0gc2VsZWN0ZWRfcXVhcnRlciwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhc3NldHMuZ3JvdXAgPSAxLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyb3NzLlNSID0gZ3Jvc3NTUiwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXQuU1IgPSBuZXRTUiwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm9zcy5DUiA9IGdyb3NzQ1IsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV0LkNSID0gbmV0Q1IsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3Jvc3MuUG5MID0gZ3Jvc3NQbkwsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV0LlBuTCA9IG5ldFBuTCwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdi5kYWlseS5udHJhbnMgPSBhdi5kYWlseS5udHJhZGVzLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXQsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyaW5nc0FzRmFjdG9ycyA9IEZBTFNFDQogICAgICApDQogICAgICANCiAgICAgICMgY29sbGVjdCBzdW1tYXJpZXMgZm9yIGFsbCBxdWFydGVycw0KICAgICAgaWYoIWV4aXN0cygicXVhcnRlcl9zdGF0cy5hbGwuZ3JvdXAxIikpIHF1YXJ0ZXJfc3RhdHMuYWxsLmdyb3VwMSA8LSBxdWFydGVyX3N0YXRzIGVsc2UNCiAgICAgICAgcXVhcnRlcl9zdGF0cy5hbGwuZ3JvdXAxIDwtIHJiaW5kKHF1YXJ0ZXJfc3RhdHMuYWxsLmdyb3VwMSwgcXVhcnRlcl9zdGF0cykNCiAgICAgIA0KICAgICAgIyBjcmVhdGUgYSBwbG90IG9mIGdyb3MgYW5kIG5ldCBwbmwgYW5kIHNhdmUgaXQgdG8gcG5nIGZpbGUNCiAgICAgIHByaW50KCAjIHdoZW4gcGxvdHRpbmcgaW4gYSBsb29wIHlvdSBoYXZlIHRvIHVzZSBwcmludCgpDQogICAgICAgIHBsb3QoY2JpbmQoY3Vtc3VtKGRhdGEuZ3JvdXAxYi5kYWlseSRwbmxfZ3Jvc3MubW9tKSwNCiAgICAgICAgICAgICAgICAgICBjdW1zdW0oZGF0YS5ncm91cDFiLmRhaWx5JHBubF9uZXQubW9tKSksDQogICAgICAgICAgICAgbXVsdGkucGFuZWwgPSBGQUxTRSwNCiAgICAgICAgICAgICBtYWluID0gcGFzdGUwKCJHcm9zcyBhbmQgbmV0IFBuTCBmb3IgYXNzZXQgZ3JvdXAgMSBcbiBxdWFydGVyICIsIHNlbGVjdGVkX3F1YXJ0ZXIpLCANCiAgICAgICAgICAgICBjb2wgPSBjKCIjMzc3RUI4IiwgIiNFNDFBMUMiKSwNCiAgICAgICAgICAgICBtYWpvci50aWNrcyA9ICJ3ZWVrcyIsIA0KICAgICAgICAgICAgIGdyaWQudGlja3Mub24gPSAid2Vla3MiLA0KICAgICAgICAgICAgIGdyaWQudGlja3MubHR5ID0gMywNCiAgICAgICAgICAgICBsZWdlbmQubG9jID0gInRvcGxlZnQiLA0KICAgICAgICAgICAgIGNleCA9IDAuMykNCiAgICAgICkNCg0KICAgICAgIyByZW1vdmUgYWxsIHVubmVlZGVkIG9iamVjdHMgZm9yIGdyb3VwIDENCiAgICAgIHJtKHBubC5ncm9zcy5kLCBwbmwubmV0LmQsIHF1YXJ0ZXJfc3RhdHMpDQogICAgICANCiAgICAgIGdjKCkNCiAgICB9DQogICAgDQogICAgIyBzdW1tYXJ5IG9mIGEgcGFydGljdWxhciBzdHJhdGVneQ0KICAgIHN1bW1hcnlfIDwtIGRhdGEuZnJhbWUoRU1BLmZhc3QgPSBwYWlyWzFdLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgRU1BLnNsb3cgPSBwYWlyWzJdLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgcGVyaW9kID0gc2VsZWN0ZWRfcXVhcnRlciwgIyAiMjAxNi0wOC0xNiAtIDIwMTYtMTEiLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3Jvc3MuU1IgPSBncm9zc1NSLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV0LlNSID0gbmV0U1IsDQogICAgICAgICAgICAgICAgICAgICAgICAgICBncm9zcy5QbkwgPSBncm9zc1BuTCwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ldC5QbkwgPSBuZXRQbkwsDQogICAgICAgICAgICAgICAgICAgICAgICAgICBhdi5kYWlseS5udHJhbnMgPSBhdi5kYWlseS5udHJhZGVzLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyaW5nc0FzRmFjdG9ycyA9IEZBTFNFKQ0KICAgIA0KICAgICMgcHV0dGluZyBhbGwgc3VtbWFyaWVzIHRvZ2V0aGVyDQogICAgDQogICAgaWYoIWV4aXN0cygic3VtbWFyeS5wYWlyLnRyYWRpbmciKSkgc3VtbWFyeS5wYWlyLnRyYWRpbmcgPC0gc3VtbWFyeV8gZWxzZQ0KICAgICAgc3VtbWFyeS5wYWlyLnRyYWRpbmcgPC0gcmJpbmQoc3VtbWFyeS5wYWlyLnRyYWRpbmcsIHN1bW1hcnlfKQ0KICAgIA0KICAgICMgZGVsZXRpbmcgd29ya2luZyBmaWxlcyBub3QgbmVlZGVkIGFueSBtb3JlDQogICAgcm0oZ3Jvc3NTUiwgbmV0U1IsIG5ldENSLA0KICAgICAgIGdyb3NzUG5MLCBuZXRQbkwsDQogICAgICAgYXYuZGFpbHkubnRyYWRlcywgc3RhdCwNCiAgICAgICBzdW1tYXJ5XykNCiAgfQ0KICANCiAgIyBuZXQuU1IgLSBzcHJlYWQgYXZfcmF0aW8NCiAgaGVhdG1hcF9zcl9jcm9zcyA8LSBwbG90SGVhdG1hcChkYXRhX3Bsb3QgPSBzdW1tYXJ5LnBhaXIudHJhZGluZywgIyBkYXRhc2V0IChkYXRhLmZyYW1lKSB3aXRoIGNhbGN1bGF0aW9ucw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbF92bGFiZWxzID0gIkVNQS5mYXN0IiwgIyBjb2x1bW4gbmFtZSB3aXRoIHRoZSBsYWJlbHMgZm9yIGEgdmVydGljYWwgYXhpcyAoc3RyaW5nKQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbF9obGFiZWxzID0gIkVNQS5zbG93IiwgIyBjb2x1bW4gbmFtZSB3aXRoIHRoZSBsYWJlbHMgZm9yIGEgaG9yaXpvbnRhbCBheGlzIChzdHJpbmcpDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sX3ZhcmlhYmxlID0gIm5ldC5TUiIsICMgY29sdW1uIG5hbWUgd2l0aCB0aGUgdmFyaWFibGUgdG8gc2hvdyAoc3RyaW5nKQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1haW4gPSBwYXN0ZShzZWxlY3RlZF9xdWFydGVyLCAiU2Vuc2l0aXZpdHkgYW5hbHlzaXMgZm9yIG1vbWVudHVtIHN0YXRlZ3kgYmFzZWQgb24gRU1BIGNyb3Nzb3ZlciIsIHNlcCA9ICI6ICIpLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsX3NpemUgPSAzKQ0KICANCiAgc2Vuc2l0aXZpdGllc19jcm9zc1tbc2VsZWN0ZWRfcXVhcnRlcl1dIDwtIHN1bW1hcnkucGFpci50cmFkaW5nDQogIHJtKHN1bW1hcnkucGFpci50cmFkaW5nKQ0KICBoZWF0bWFwX2xpc3RfY3Jvc3NbW3NlbGVjdGVkX3F1YXJ0ZXJdXSA8LSBoZWF0bWFwX3NyX2Nyb3NzDQogIA0KICANCiAgIyBNZWFuIHJldmVyc2lvbg0KICANCiAgIyBTaW5nbGUgRU1BDQogIA0KICBFTUFfcGFpcnMgPSBsaXN0KGMoMSwgMTApLCBjKDEsIDIwKSwgYygxLCAzMCksIGMoMSwgNDApLCBjKDEsIDUwKSwgYygxLCA2MCksIGMoMSwgNzApLCBjKDEsIDgwKSkNCiAgZGF0YS5ncm91cDFhX21yIDwtIGRhdGEuZ3JvdXAxDQogIA0KICBmb3IgKHBhaXIgaW4gRU1BX3BhaXJzKSB7DQogICAgIyBsZXRzIGNhbGN1bGF0ZSBFTUFmYXN0IGFuZCBFTUFzbG93IGZvciBTUA0KICAgIGRhdGEuZ3JvdXAxYV9tciRTUF9FTUEgPC0gRU1BKG5hLmxvY2YoZGF0YS5ncm91cDFhX21yJFNQKSwgcGFpclsyXSkNCiAgICANCiAgICAjIHB1dCBtaXNzaW5nIHZhbHVlIHdoZW5ldmVyIHRoZSBvcmlnaW5hbCBwcmljZSBpcyBtaXNzaW5nDQogICAgZGF0YS5ncm91cDFhX21yJFNQX0VNQVtpcy5uYShkYXRhLmdyb3VwMWFfbXIkU1ApXSA8LSBOQQ0KICAgIA0KICAgICMgbGV0cyBjYWxjdWxhdGUgdGhlIHBvc2l0aW9uIGZvciB0aGUgTU9NRU5UVU0gc3RyYXRlZ3kNCiAgICAjIGlmIHByaWNlKHQtMSkgPiBNQSh0LTEpID0+IHBvcyh0KSA9IDEgW2xvbmddDQogICAgIyBpZiBwcmljZSh0LTEpIDw9IE1BKHQtMSkgPT4gcG9zKHQpID0gLTEgW3Nob3J0XQ0KICAgICMgdGhpcyBzdHJhdGVneSBpcyBhbHdheXMgYWdhaW5zdCB0aGUgbWFya2V0DQogICAgZGF0YS5ncm91cDFhX21yJHBvc2l0aW9uU1AubXIgPC0gaWZlbHNlKGxhZy54dHMoZGF0YS5ncm91cDFhX21yJFNQKSA+DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFnLnh0cyhkYXRhLmdyb3VwMWFfbXIkU1BfRU1BKSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLTEsIDEpDQogICAgDQogICAgIyBsZXRzIGFwcGx5IHRoZSByZW1haW5pbmcgYXNzdW1wdGlvbnMNCiAgICAjIC0gZXhpdCBhbGwgcG9zaXRpb25zIDIwIG1pbnV0ZXMgYmVmb3JlIHRoZSBzZXNzaW9uIGVuZCwgaS5lLiBhdCAxNTo0MA0KICAgICMgLSBkbyBub3QgdHJhZGUgd2l0aGluIHRoZSBmaXJzdCAyNSBtaW51dGVzIG9mIHN0b2NrcyBxdW90YXRpb25zICh1bnRpbCA5OjU1KQ0KICAgIGRhdGEuZ3JvdXAxYV9tciRwb3NpdGlvblNQLm1yW3RpbWVzKHRpbWVzXykgPD0gdGltZXMoIjA5OjU1OjAwIikgfCANCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVzKHRpbWVzXykgPiB0aW1lcygiMTU6NDA6MDAiKV0gPC0gMA0KICAgIA0KICAgIA0KICAgICMgbGV0cyBhbHNvIGZpbGwgZXZlcnkgbWlzc2luZyBwb3NpdGlvbiB3aXRoIHRoZSBwcmV2aW91cyBvbmUNCiAgICANCiAgICBkYXRhLmdyb3VwMWFfbXIkcG9zaXRpb25TUC5tciA8LSBuYS5sb2NmKGRhdGEuZ3JvdXAxYV9tciRwb3NpdGlvblNQLm1yLCBuYS5ybSA9IEZBTFNFKQ0KICAgIA0KICAgICMgY2FsY3VsYXRpbmcgZ3Jvc3MgcG5sDQogICAgDQogICAgZGF0YS5ncm91cDFhX21yJHBubF9ncm9zc1NQLm1yIDwtIGRhdGEuZ3JvdXAxYV9tciRwb3NpdGlvblNQLm1yICogZGlmZi54dHMoZGF0YS5ncm91cDFhX21yJFNQKSAqIDUwDQogICAgDQogICAgDQogICAgIyBudW1iZXIgb2YgdHJhbnNhY3Rpb25zDQogICAgZGF0YS5ncm91cDFhX21yJG50cmFuc1NQLm1yIDwtIGFicyhkaWZmLnh0cyhkYXRhLmdyb3VwMWFfbXIkcG9zaXRpb25TUC5tcikpDQogICAgDQogICAgZGF0YS5ncm91cDFhX21yJG50cmFuc1NQLm1yWzFdIDwtIDANCiAgICANCiAgICAjIG5ldCBwbmwNCiAgICBkYXRhLmdyb3VwMWFfbXIkcG5sX25ldFNQLm1yIDwtIGRhdGEuZ3JvdXAxYV9tciRwbmxfZ3Jvc3NTUC5tciAgLQ0KICAgICAgZGF0YS5ncm91cDFhX21yJG50cmFuc1NQLm1yICogMTAgIyAkMTAgcGVyIHRyYW5zYWN0aW9uDQogICAgDQogICAgIyB0b3RhbCBmb3Igc3RyYXRlZ3kNCiAgICANCiAgICBkYXRhLmdyb3VwMWFfbXIkcG5sX2dyb3NzLm1yIDwtIGRhdGEuZ3JvdXAxYV9tciRwbmxfZ3Jvc3NTUC5tcg0KICAgIGRhdGEuZ3JvdXAxYV9tciRwbmxfbmV0Lm1yIDwtIGRhdGEuZ3JvdXAxYV9tciRwbmxfbmV0U1AubXINCiAgICANCiAgICANCiAgICAjIGFnZ3JlZ2F0ZSBwbmxzIGFuZCBudW1iZXIgb2YgdHJhbnNhY3Rpb25zIHRvIGRhaWx5DQogICAgbXkuZW5kcG9pbnRzIDwtIGVuZHBvaW50cyhkYXRhLmdyb3VwMWFfbXIsICJkYXlzIikNCiAgICANCiAgICBkYXRhLmdyb3VwMWFfbXIuZGFpbHkgPC0gcGVyaW9kLmFwcGx5KGRhdGEuZ3JvdXAxYV9tclssYyhncmVwKCJwbmwiLCBuYW1lcyhkYXRhLmdyb3VwMWFfbXIpKSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncmVwKCJudHJhbnMiLCBuYW1lcyhkYXRhLmdyb3VwMWFfbXIpKSldLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgSU5ERVggPSBteS5lbmRwb2ludHMsIA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgRlVOID0gZnVuY3Rpb24oeCkgY29sU3Vtcyh4LCBuYS5ybSA9IFRSVUUpKQ0KICAgIA0KICAgICMgc3VtbWFyaXplIHRoZSBzdHJhdGVneSBmb3IgdGhpcyBxdWFydGVyDQogICAgDQogICAgIyBTUg0KICAgIGdyb3NzU1IgPSBteVNSKHggPSBkYXRhLmdyb3VwMWFfbXIuZGFpbHkkcG5sX2dyb3NzLm1yLCBzY2FsZSA9IDI1MikNCiAgICBuZXRTUiA9IG15U1IoeCA9IGRhdGEuZ3JvdXAxYV9tci5kYWlseSRwbmxfbmV0Lm1yLCBzY2FsZSA9IDI1MikNCiAgICAjIENSDQogICAgZ3Jvc3NDUiA9IG15Q2FsbWFyUmF0aW8oeCA9IGRhdGEuZ3JvdXAxYV9tci5kYWlseSRwbmxfZ3Jvc3MubXIsIHNjYWxlID0gMjUyKQ0KICAgIG5ldENSID0gbXlDYWxtYXJSYXRpbyh4ID0gZGF0YS5ncm91cDFhX21yLmRhaWx5JHBubF9uZXQubXIsIHNjYWxlID0gMjUyKQ0KICAgIA0KICAgICMgYXZlcmFnZSBudW1iZXIgb2YgdHJhbnNhY3Rpb25zDQogICAgYXYuZGFpbHkubnRyYWRlcyA9IG1lYW4oZGF0YS5ncm91cDFhX21yLmRhaWx5JG50cmFuc1NQLm1yLCBuYS5ybSA9IFRSVUUpDQogICAgIyBQbkwNCiAgICBncm9zc1BuTCA9IHN1bShkYXRhLmdyb3VwMWFfbXIuZGFpbHkkcG5sX2dyb3NzLm1yKQ0KICAgIG5ldFBuTCA9IHN1bShkYXRhLmdyb3VwMWFfbXIuZGFpbHkkcG5sX25ldC5tcikNCiAgICAjIHN0YXQNCiAgICBzdGF0ID0gbmV0Q1IgKiBtYXgoMCwgbG9nKGFicyhuZXRQbkwvMTAwMCkpKQ0KICAgIA0KICAgICMgc3VtbWFyeSBvZiBhIHBhcnRpY3VsYXIgc3RyYXRlZ3kNCiAgICBzdW1tYXJ5XyA8LSBkYXRhLmZyYW1lKENsb3NlID0gMSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgIEVNQSA9IHBhaXJbMl0sDQogICAgICAgICAgICAgICAgICAgICAgICAgICBwZXJpb2QgPSBzZWxlY3RlZF9xdWFydGVyLCAjICIyMDE2LTA4LTE2IC0gMjAxNi0xMSIsDQogICAgICAgICAgICAgICAgICAgICAgICAgICBncm9zcy5TUiA9IGdyb3NzU1IsDQogICAgICAgICAgICAgICAgICAgICAgICAgICBuZXQuU1IgPSBuZXRTUiwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyb3NzLlBuTCA9IGdyb3NzUG5MLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV0LlBuTCA9IG5ldFBuTCwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgIGF2LmRhaWx5Lm50cmFucyA9IGF2LmRhaWx5Lm50cmFkZXMsDQogICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJpbmdzQXNGYWN0b3JzID0gRkFMU0UpDQogICAgDQogICAgIyBwdXR0aW5nIGFsbCBzdW1tYXJpZXMgdG9nZXRoZXINCiAgICANCiAgICBpZighZXhpc3RzKCJzdW1tYXJ5LnBhaXIudHJhZGluZyIpKSBzdW1tYXJ5LnBhaXIudHJhZGluZyA8LSBzdW1tYXJ5XyBlbHNlDQogICAgICBzdW1tYXJ5LnBhaXIudHJhZGluZyA8LSByYmluZChzdW1tYXJ5LnBhaXIudHJhZGluZywgc3VtbWFyeV8pDQogICAgDQogICAgIyBkZWxldGluZyB3b3JraW5nIGZpbGVzIG5vdCBuZWVkZWQgYW55IG1vcmUNCiAgICBybShncm9zc1NSLCBuZXRTUiwgbmV0Q1IsDQogICAgICAgZ3Jvc3NQbkwsIG5ldFBuTCwNCiAgICAgICBhdi5kYWlseS5udHJhZGVzLCBzdGF0LA0KICAgICAgIHN1bW1hcnlfKQ0KICB9DQogIA0KICAjIG5ldC5TUiAtIHNwcmVhZCBhdl9yYXRpbw0KICBoZWF0bWFwX3NyX3NpbmdsZV9tciA8LSBwbG90SGVhdG1hcChkYXRhX3Bsb3QgPSBzdW1tYXJ5LnBhaXIudHJhZGluZywgIyBkYXRhc2V0IChkYXRhLmZyYW1lKSB3aXRoIGNhbGN1bGF0aW9ucw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xfdmxhYmVscyA9ICJDbG9zZSIsICMgY29sdW1uIG5hbWUgd2l0aCB0aGUgbGFiZWxzIGZvciBhIHZlcnRpY2FsIGF4aXMgKHN0cmluZykNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sX2hsYWJlbHMgPSAiRU1BIiwgIyBjb2x1bW4gbmFtZSB3aXRoIHRoZSBsYWJlbHMgZm9yIGEgaG9yaXpvbnRhbCBheGlzIChzdHJpbmcpDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbF92YXJpYWJsZSA9ICJuZXQuU1IiLCAjIGNvbHVtbiBuYW1lIHdpdGggdGhlIHZhcmlhYmxlIHRvIHNob3cgKHN0cmluZykNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFpbiA9IHBhc3RlKHNlbGVjdGVkX3F1YXJ0ZXIsICJTZW5zaXRpdml0eSBhbmFseXNpcyBmb3IgbWVhbiByZXZlcnNpb24gc3RhdGVneSBiYXNlZCBvbiBzaW5nbGUgRU1BIiwgc2VwID0gIjogIiksDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsX3NpemUgPSAzKQ0KICANCiAgc2Vuc2l0aXZpdGllc19zaW5nbGVfbXJbW3NlbGVjdGVkX3F1YXJ0ZXJdXSA8LSBzdW1tYXJ5LnBhaXIudHJhZGluZw0KICBybShzdW1tYXJ5LnBhaXIudHJhZGluZykNCiAgaGVhdG1hcF9saXN0X3NpbmdsZV9tcltbc2VsZWN0ZWRfcXVhcnRlcl1dIDwtIGhlYXRtYXBfc3Jfc2luZ2xlX21yDQogIA0KICANCiAgIyBFTUEgQ3Jvc3NvdmVyDQogIA0KICBFTUFfcGFpcnMgPSBsaXN0KGMoMTAsIDIwKSwgYygxMCwgMzApLCBjKDEwLCA0MCksIGMoMTAsIDUwKSwgYygxMCwgNjApLCBjKDEwLCA3MCksIGMoMTAsIDgwKSwNCiAgICAgICAgICAgICAgICAgICBjKDIwLCAzMCksIGMoMjAsIDQwKSwgYygyMCwgNTApLCBjKDIwLCA2MCksIGMoMjAsIDcwKSwgYygyMCwgODApLA0KICAgICAgICAgICAgICAgICAgIGMoMzAsIDQwKSwgYygzMCwgNTApLCBjKDMwLCA2MCksIGMoMzAsIDcwKSwgYygzMCwgODApLA0KICAgICAgICAgICAgICAgICAgIGMoNDAsIDUwKSwgYyg0MCwgNjApLCBjKDQwLCA3MCksIGMoNDAsIDgwKSwNCiAgICAgICAgICAgICAgICAgICBjKDUwLCA2MCksIGMoNTAsIDcwKSwgYyg1MCwgODApLA0KICAgICAgICAgICAgICAgICAgIGMoNjAsIDcwKSwgYyg2MCwgODApLA0KICAgICAgICAgICAgICAgICAgIGMoNzAsIDgwKSkNCiAgDQogIGRhdGEuZ3JvdXAxYl9tciA8LSBkYXRhLmdyb3VwMQ0KICANCiAgZm9yIChwYWlyIGluIEVNQV9wYWlycykgew0KICAgICMgbGV0cyBjYWxjdWxhdGUgRU1BZmFzdCBhbmQgRU1Bc2xvdyBmb3IgU1ANCiAgICBkYXRhLmdyb3VwMWJfbXIkU1BfRU1BZmFzdCA8LSBFTUEobmEubG9jZihkYXRhLmdyb3VwMWJfbXIkU1ApLCBwYWlyWzFdKQ0KICAgIGRhdGEuZ3JvdXAxYl9tciRTUF9FTUFzbG93IDwtIEVNQShuYS5sb2NmKGRhdGEuZ3JvdXAxYl9tciRTUCksIHBhaXJbMl0pDQogICAgDQogICAgIyBwdXQgbWlzc2luZyB2YWx1ZSB3aGVuZXZlciB0aGUgb3JpZ2luYWwgcHJpY2UgaXMgbWlzc2luZw0KICAgIGRhdGEuZ3JvdXAxYl9tciRTUF9FTUFmYXN0W2lzLm5hKGRhdGEuZ3JvdXAxYl9tciRTUCldIDwtIE5BDQogICAgZGF0YS5ncm91cDFiX21yJFNQX0VNQXNsb3dbaXMubmEoZGF0YS5ncm91cDFiX21yJFNQKV0gPC0gTkENCiAgICANCiAgICAjIGxldHMgY2FsY3VsYXRlIHRoZSBwb3NpdGlvbiBmb3IgdGhlIE1PTUVOVFVNIHN0cmF0ZWd5DQogICAgIyBpZiBmYXN0IE1BKHQtMSkgPiBzbG93IE1BKHQtMSkgPT4gcG9zKHQpID0gMSBbbG9uZ10NCiAgICAjIGlmIGZhc3QgTUEodC0xKSA8PSBzbG93IE1BKHQtMSkgPT4gcG9zKHQpID0gLTEgW3Nob3J0XQ0KICAgICMgdGhpcyBzdHJhdGVneSBpcyBhbHdheXMgYWdhaW5zdCB0aGUgbWFya2V0DQogICAgZGF0YS5ncm91cDFiX21yJHBvc2l0aW9uU1AubXIgPC0gaWZlbHNlKGxhZy54dHMoZGF0YS5ncm91cDFiX21yJFNQX0VNQWZhc3QpID4NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWcueHRzKGRhdGEuZ3JvdXAxYl9tciRTUF9FTUFzbG93KSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLTEsIDEpDQogICAgDQogICAgIyBsZXRzIGFwcGx5IHRoZSByZW1haW5pbmcgYXNzdW1wdGlvbnMNCiAgICAjIC0gZXhpdCBhbGwgcG9zaXRpb25zIDIwIG1pbnV0ZXMgYmVmb3JlIHRoZSBzZXNzaW9uIGVuZCwgaS5lLiBhdCAxNTo0MA0KICAgICMgLSBkbyBub3QgdHJhZGUgd2l0aGluIHRoZSBmaXJzdCAyNSBtaW51dGVzIG9mIHN0b2NrcyBxdW90YXRpb25zICh1bnRpbCA5OjU1KQ0KICAgIGRhdGEuZ3JvdXAxYl9tciRwb3NpdGlvblNQLm1yW3RpbWVzKHRpbWVzXykgPD0gdGltZXMoIjA5OjU1OjAwIikgfCANCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVzKHRpbWVzXykgPiB0aW1lcygiMTU6NDA6MDAiKV0gPC0gMA0KICAgIA0KICAgIA0KICAgICMgbGV0cyBhbHNvIGZpbGwgZXZlcnkgbWlzc2luZyBwb3NpdGlvbiB3aXRoIHRoZSBwcmV2aW91cyBvbmUNCiAgICANCiAgICBkYXRhLmdyb3VwMWJfbXIkcG9zaXRpb25TUC5tciA8LSBuYS5sb2NmKGRhdGEuZ3JvdXAxYl9tciRwb3NpdGlvblNQLm1yLCBuYS5ybSA9IEZBTFNFKQ0KICAgIA0KICAgICMgY2FsY3VsYXRpbmcgZ3Jvc3MgcG5sDQogICAgDQogICAgZGF0YS5ncm91cDFiX21yJHBubF9ncm9zc1NQLm1yIDwtIGRhdGEuZ3JvdXAxYl9tciRwb3NpdGlvblNQLm1yICogZGlmZi54dHMoZGF0YS5ncm91cDFiX21yJFNQKSAqIDUwDQogICAgDQogICAgDQogICAgIyBudW1iZXIgb2YgdHJhbnNhY3Rpb25zDQogICAgZGF0YS5ncm91cDFiX21yJG50cmFuc1NQLm1yIDwtIGFicyhkaWZmLnh0cyhkYXRhLmdyb3VwMWJfbXIkcG9zaXRpb25TUC5tcikpDQogICAgDQogICAgZGF0YS5ncm91cDFiX21yJG50cmFuc1NQLm1yWzFdIDwtIDANCiAgICANCiAgICAjIG5ldCBwbmwNCiAgICBkYXRhLmdyb3VwMWJfbXIkcG5sX25ldFNQLm1yIDwtIGRhdGEuZ3JvdXAxYl9tciRwbmxfZ3Jvc3NTUC5tciAgLQ0KICAgICAgZGF0YS5ncm91cDFiX21yJG50cmFuc1NQLm1yICogMTAgIyAkMTAgcGVyIHRyYW5zYWN0aW9uDQogICAgDQogICAgIyB0b3RhbCBmb3Igc3RyYXRlZ3kNCiAgICANCiAgICBkYXRhLmdyb3VwMWJfbXIkcG5sX2dyb3NzLm1yIDwtIGRhdGEuZ3JvdXAxYl9tciRwbmxfZ3Jvc3NTUC5tcg0KICAgIGRhdGEuZ3JvdXAxYl9tciRwbmxfbmV0Lm1yIDwtIGRhdGEuZ3JvdXAxYl9tciRwbmxfbmV0U1AubXINCiAgICANCiAgICANCiAgICAjIGFnZ3JlZ2F0ZSBwbmxzIGFuZCBudW1iZXIgb2YgdHJhbnNhY3Rpb25zIHRvIGRhaWx5DQogICAgbXkuZW5kcG9pbnRzIDwtIGVuZHBvaW50cyhkYXRhLmdyb3VwMWJfbXIsICJkYXlzIikNCiAgICANCiAgICBkYXRhLmdyb3VwMWJfbXIuZGFpbHkgPC0gcGVyaW9kLmFwcGx5KGRhdGEuZ3JvdXAxYl9tclssYyhncmVwKCJwbmwiLCBuYW1lcyhkYXRhLmdyb3VwMWJfbXIpKSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncmVwKCJudHJhbnMiLCBuYW1lcyhkYXRhLmdyb3VwMWJfbXIpKSldLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgSU5ERVggPSBteS5lbmRwb2ludHMsIA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgRlVOID0gZnVuY3Rpb24oeCkgY29sU3Vtcyh4LCBuYS5ybSA9IFRSVUUpKQ0KICAgIA0KICAgICMgc3VtbWFyaXplIHRoZSBzdHJhdGVneSBmb3IgdGhpcyBxdWFydGVyDQogICAgDQogICAgIyBTUg0KICAgIGdyb3NzU1IgPSBteVNSKHggPSBkYXRhLmdyb3VwMWJfbXIuZGFpbHkkcG5sX2dyb3NzLm1yLCBzY2FsZSA9IDI1MikNCiAgICBuZXRTUiA9IG15U1IoeCA9IGRhdGEuZ3JvdXAxYl9tci5kYWlseSRwbmxfbmV0Lm1yLCBzY2FsZSA9IDI1MikNCiAgICAjIENSDQogICAgZ3Jvc3NDUiA9IG15Q2FsbWFyUmF0aW8oeCA9IGRhdGEuZ3JvdXAxYl9tci5kYWlseSRwbmxfZ3Jvc3MubXIsIHNjYWxlID0gMjUyKQ0KICAgIG5ldENSID0gbXlDYWxtYXJSYXRpbyh4ID0gZGF0YS5ncm91cDFiX21yLmRhaWx5JHBubF9uZXQubXIsIHNjYWxlID0gMjUyKQ0KICAgIA0KICAgICMgYXZlcmFnZSBudW1iZXIgb2YgdHJhbnNhY3Rpb25zDQogICAgYXYuZGFpbHkubnRyYWRlcyA9IG1lYW4oZGF0YS5ncm91cDFiX21yLmRhaWx5JG50cmFuc1NQLm1yLCBuYS5ybSA9IFRSVUUpDQogICAgIyBQbkwNCiAgICBncm9zc1BuTCA9IHN1bShkYXRhLmdyb3VwMWJfbXIuZGFpbHkkcG5sX2dyb3NzLm1yKQ0KICAgIG5ldFBuTCA9IHN1bShkYXRhLmdyb3VwMWJfbXIuZGFpbHkkcG5sX25ldC5tcikNCiAgICAjIHN0YXQNCiAgICBzdGF0ID0gbmV0Q1IgKiBtYXgoMCwgbG9nKGFicyhuZXRQbkwvMTAwMCkpKQ0KICAgIA0KICAgICMgc3VtbWFyeSBvZiBhIHBhcnRpY3VsYXIgc3RyYXRlZ3kNCiAgICBzdW1tYXJ5XyA8LSBkYXRhLmZyYW1lKEVNQS5mYXN0ID0gcGFpclsxXSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgIEVNQS5zbG93ID0gcGFpclsyXSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgIHBlcmlvZCA9IHNlbGVjdGVkX3F1YXJ0ZXIsICMgIjIwMTYtMDgtMTYgLSAyMDE2LTExIiwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyb3NzLlNSID0gZ3Jvc3NTUiwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ldC5TUiA9IG5ldFNSLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3Jvc3MuUG5MID0gZ3Jvc3NQbkwsDQogICAgICAgICAgICAgICAgICAgICAgICAgICBuZXQuUG5MID0gbmV0UG5MLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgYXYuZGFpbHkubnRyYW5zID0gYXYuZGFpbHkubnRyYWRlcywNCiAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cmluZ3NBc0ZhY3RvcnMgPSBGQUxTRSkNCiAgICANCiAgICAjIHB1dHRpbmcgYWxsIHN1bW1hcmllcyB0b2dldGhlcg0KICAgIA0KICAgIGlmKCFleGlzdHMoInN1bW1hcnkucGFpci50cmFkaW5nIikpIHN1bW1hcnkucGFpci50cmFkaW5nIDwtIHN1bW1hcnlfIGVsc2UNCiAgICAgIHN1bW1hcnkucGFpci50cmFkaW5nIDwtIHJiaW5kKHN1bW1hcnkucGFpci50cmFkaW5nLCBzdW1tYXJ5XykNCiAgICANCiAgICAjIGRlbGV0aW5nIHdvcmtpbmcgZmlsZXMgbm90IG5lZWRlZCBhbnkgbW9yZQ0KICAgIHJtKGdyb3NzU1IsIG5ldFNSLCBuZXRDUiwNCiAgICAgICBncm9zc1BuTCwgbmV0UG5MLA0KICAgICAgIGF2LmRhaWx5Lm50cmFkZXMsIHN0YXQsDQogICAgICAgc3VtbWFyeV8pDQogIH0NCiAgDQogICMgbmV0LlNSIC0gc3ByZWFkIGF2X3JhdGlvDQogIGhlYXRtYXBfc3JfY3Jvc3NfbXIgPC0gcGxvdEhlYXRtYXAoZGF0YV9wbG90ID0gc3VtbWFyeS5wYWlyLnRyYWRpbmcsICMgZGF0YXNldCAoZGF0YS5mcmFtZSkgd2l0aCBjYWxjdWxhdGlvbnMNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xfdmxhYmVscyA9ICJFTUEuZmFzdCIsICMgY29sdW1uIG5hbWUgd2l0aCB0aGUgbGFiZWxzIGZvciBhIHZlcnRpY2FsIGF4aXMgKHN0cmluZykNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xfaGxhYmVscyA9ICJFTUEuc2xvdyIsICMgY29sdW1uIG5hbWUgd2l0aCB0aGUgbGFiZWxzIGZvciBhIGhvcml6b250YWwgYXhpcyAoc3RyaW5nKQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbF92YXJpYWJsZSA9ICJuZXQuU1IiLCAjIGNvbHVtbiBuYW1lIHdpdGggdGhlIHZhcmlhYmxlIHRvIHNob3cgKHN0cmluZykNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYWluID0gcGFzdGUoc2VsZWN0ZWRfcXVhcnRlciwgIlNlbnNpdGl2aXR5IGFuYWx5c2lzIGZvciBtZWFuIHJldmVyc2lvbiBzdGF0ZWd5IGJhc2VkIG9uIEVNQSBjcm9zc292ZXIiLCBzZXAgPSAiOiAiKSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbF9zaXplID0gMykNCiAgDQogIHNlbnNpdGl2aXRpZXNfY3Jvc3NfbXJbW3NlbGVjdGVkX3F1YXJ0ZXJdXSA8LSBzdW1tYXJ5LnBhaXIudHJhZGluZw0KICBybShzdW1tYXJ5LnBhaXIudHJhZGluZykNCiAgaGVhdG1hcF9saXN0X2Nyb3NzX21yW1tzZWxlY3RlZF9xdWFydGVyXV0gPC0gaGVhdG1hcF9zcl9jcm9zc19tcg0KfQ0KYGBgDQoNClRoZSByZXN1bHRzIHdlcmUgZGVwaWN0ZWQgdXNpbmcgaGVhdG1hcHMgY29udGFpbmluZyBTaGFycGUgcmF0aW9zLCBjb25zaWRlcmluZyB0aGUgcmV0dXJuIHBlciB1bml0IG9mIHZvbGF0aWxpdHkuIFRoZSBsYXJnZXN0IHZhbHVlIGluZGljYXRlZCB3aGljaCBwYXJhbWV0ZXIgY29tYmluYXRpb24gZ2VuZXJhdGVkIHRoZSBiZXN0IHBlcmZvcm1hbmNlIG9uIHRoZSBpbi1zYW1wbGUgZGF0YS4NCg0KVGhlIG9wdGltYWwgc3RyYXRlZ3kgd2FzIGNyb3Nzb3ZlciBFTUEgd2hlcmUgZmFzdCBFTUEgd2FzIDYwIGRheXMgYW5kIHNsb3cgRU1BIHdhcyA3MCBkYXlzLiBUaGUgUCZMIGdyYXBocyBhYm92ZSBkaXNwbGF5IHRoZSBwZXJmb3JtYW5jZSBvZiB0aGlzIHBhcnRpY3VsYXIgc3RyYXRlZ3kuDQoNCkhlYXRtYXBzIHN1cHBvcnRpbmcgdGhlIGNob2ljZSBvZiBzdHJhdGVneSBhcmUgc2hvd24gYmVsb3cuIFF1YXJ0ZXJseSBvdXRwdXRzLCBhcyB3ZWxsIGFzIHRoZSBtZWFuIGFjcm9zcyBxdWFydGVycyBhcmUgc2hvd24uDQoNCiMjIFNpbmdsZSBFTUEgTW9tZW50dW0NClNpbmdsZSBFTUEgbW9tZW50dW0gc3RyYXRlZ2llcyBwZXJmb3JtZWQgcG9vcmx5LiBBbGwgY29tYmluYXRpb25zIHlpZWxkZWQgbmVnYXRpdmUgU2hhcnBlIHJhdGlvcywgZXNwZWNpYWxseSBhdCBmZXdlciBkYXlzLg0KDQpgYGB7ciwgd2FybmluZyA9IEYsIG1lc3NhZ2UgPSBGfQ0KIyBDb21iaW5lZA0KZm9yIChvdXRwdXQgaW4gaGVhdG1hcF9saXN0X3NpbmdsZSkgew0KICBwcmludChvdXRwdXQpDQp9DQoNCiMgTWVhbg0KbmV0X3Nyc19zaW5nbGUgPC0gbGlzdCgpDQoNCmZvcihpIGluIDE6bGVuZ3RoKHNlbnNpdGl2aXRpZXNfc2luZ2xlKSkgew0KICBuZXRfc3JzX3NpbmdsZVtbaV1dIDwtIGFzLmxpc3Qoc2Vuc2l0aXZpdGllc19zaW5nbGVbW2ldXVtjKCJuZXQuU1IiKV0pW1sxXV0NCn0NCg0KYXZlcmFnZV9uZXRfc3Jfc2luZ2xlIDwtIHNhcHBseShzZXFfYWxvbmcobmV0X3Nyc19zaW5nbGVbWzFdXSksIGZ1bmN0aW9uKGkpIHsNCiAgbWVhbihzYXBwbHkobmV0X3Nyc19zaW5nbGUsIGZ1bmN0aW9uKHgpIHhbW2ldXSkpDQp9KQ0KYXZlcmFnZV9uZXRfc3Jfc2luZ2xlIDwtIGRhdGEuZnJhbWUobmV0LlNSID0gYXZlcmFnZV9uZXRfc3Jfc2luZ2xlKQ0KDQpzZW5zaXRpdml0aWVzX2F2ZXJhZ2Vfc2luZ2xlIDwtIHNlbnNpdGl2aXRpZXNfc2luZ2xlW1sxXV1bYygiQ2xvc2UiLCAiRU1BIildDQpzZW5zaXRpdml0aWVzX2F2ZXJhZ2Vfc2luZ2xlIDwtIGNiaW5kKHNlbnNpdGl2aXRpZXNfYXZlcmFnZV9zaW5nbGUsICJuZXQuU1IiID0gYXZlcmFnZV9uZXRfc3Jfc2luZ2xlKQ0KDQpoZWF0bWFwX3NyX21lYW5fc2luZ2xlIDwtIHBsb3RIZWF0bWFwKGRhdGFfcGxvdCA9IHNlbnNpdGl2aXRpZXNfYXZlcmFnZV9zaW5nbGUsICMgZGF0YXNldCAoZGF0YS5mcmFtZSkgd2l0aCBjYWxjdWxhdGlvbnMNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sX3ZsYWJlbHMgPSAiQ2xvc2UiLCAjIGNvbHVtbiBuYW1lIHdpdGggdGhlIGxhYmVscyBmb3IgYSB2ZXJ0aWNhbCBheGlzIChzdHJpbmcpDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbF9obGFiZWxzID0gIkVNQSIsICMgY29sdW1uIG5hbWUgd2l0aCB0aGUgbGFiZWxzIGZvciBhIGhvcml6b250YWwgYXhpcyAoc3RyaW5nKQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xfdmFyaWFibGUgPSAibmV0LlNSIiwgIyBjb2x1bW4gbmFtZSB3aXRoIHRoZSB2YXJpYWJsZSB0byBzaG93IChzdHJpbmcpDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1haW4gPSBwYXN0ZSgiTWVhbiIsICJTZW5zaXRpdml0eSBhbmFseXNpcyBmb3IgbW9tZW50dW0gc3RhdGVneSBiYXNlZCBvbiBzaW5nbGUgRU1BIiwgc2VwID0gIjogIiksDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsX3NpemUgPSAzKQ0KDQpoZWF0bWFwX3NyX21lYW5fc2luZ2xlDQpgYGANCg0KIyMgQ3Jvc3NvdmVyIEVNQSBNb21lbnR1bQ0KQ3Jvc3NvdmVyIEVNQSBtb21lbnR1bSBzdHJhdGVnaWVzIHBlcmZvcm1lZCB3ZWxsLiBNb3N0IGNvbWJpbmF0aW9ucyBwcm9kdWNlZCBwb3NpdGl2ZSBTaGFycGUgcmF0aW9zIHdpdGggYSBjbGVhciB0ZW5kZW5jeSB0byBvdXRwZXJmb3JtIGF0IGxvbmdlciBkYXkgY29tYmluYXRpb25zLiBUaGUgYmVzdCBzdHJhdGVneSB3YXMgNjAtNzAgd2l0aCBhIFNoYXJwZSByYXRpbyBvZiAwLjk1IGFuZCB3YXMgc2VsZWN0ZWQgYXMgdGhlIHN0cmF0ZWd5IGZvciBncm91cCAxLg0KDQpgYGB7ciwgd2FybmluZyA9IEYsIG1lc3NhZ2UgPSBGfQ0KIyBDb21iaW5lZA0KZm9yIChvdXRwdXQgaW4gaGVhdG1hcF9saXN0X2Nyb3NzKSB7DQogIHByaW50KG91dHB1dCkNCn0NCg0KIyBNZWFuDQpuZXRfc3JzX2Nyb3NzIDwtIGxpc3QoKQ0KDQpmb3IoaSBpbiAxOmxlbmd0aChzZW5zaXRpdml0aWVzX2Nyb3NzKSkgew0KICBuZXRfc3JzX2Nyb3NzW1tpXV0gPC0gYXMubGlzdChzZW5zaXRpdml0aWVzX2Nyb3NzW1tpXV1bYygibmV0LlNSIildKVtbMV1dDQp9DQoNCmF2ZXJhZ2VfbmV0X3NyX2Nyb3NzIDwtIHNhcHBseShzZXFfYWxvbmcobmV0X3Nyc19jcm9zc1tbMV1dKSwgZnVuY3Rpb24oaSkgew0KICBtZWFuKHNhcHBseShuZXRfc3JzX2Nyb3NzLCBmdW5jdGlvbih4KSB4W1tpXV0pKQ0KfSkNCmF2ZXJhZ2VfbmV0X3NyX2Nyb3NzIDwtIGRhdGEuZnJhbWUobmV0LlNSID0gYXZlcmFnZV9uZXRfc3JfY3Jvc3MpDQoNCnNlbnNpdGl2aXRpZXNfYXZlcmFnZV9jcm9zcyA8LSBzZW5zaXRpdml0aWVzX2Nyb3NzW1sxXV1bYygiRU1BLmZhc3QiLCAiRU1BLnNsb3ciKV0NCnNlbnNpdGl2aXRpZXNfYXZlcmFnZV9jcm9zcyA8LSBjYmluZChzZW5zaXRpdml0aWVzX2F2ZXJhZ2VfY3Jvc3MsICJuZXQuU1IiID0gYXZlcmFnZV9uZXRfc3JfY3Jvc3MpDQoNCmhlYXRtYXBfc3JfbWVhbl9jcm9zcyA8LSBwbG90SGVhdG1hcChkYXRhX3Bsb3QgPSBzZW5zaXRpdml0aWVzX2F2ZXJhZ2VfY3Jvc3MsICMgZGF0YXNldCAoZGF0YS5mcmFtZSkgd2l0aCBjYWxjdWxhdGlvbnMNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xfdmxhYmVscyA9ICJFTUEuZmFzdCIsICMgY29sdW1uIG5hbWUgd2l0aCB0aGUgbGFiZWxzIGZvciBhIHZlcnRpY2FsIGF4aXMgKHN0cmluZykNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xfaGxhYmVscyA9ICJFTUEuc2xvdyIsICMgY29sdW1uIG5hbWUgd2l0aCB0aGUgbGFiZWxzIGZvciBhIGhvcml6b250YWwgYXhpcyAoc3RyaW5nKQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbF92YXJpYWJsZSA9ICJuZXQuU1IiLCAjIGNvbHVtbiBuYW1lIHdpdGggdGhlIHZhcmlhYmxlIHRvIHNob3cgKHN0cmluZykNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYWluID0gcGFzdGUoIk1lYW4iLCAiU2Vuc2l0aXZpdHkgYW5hbHlzaXMgZm9yIG1vbWVudHVtIHN0YXRlZ3kgYmFzZWQgb24gRU1BIGNyb3Nzb3ZlciIsIHNlcCA9ICI6ICIpLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsX3NpemUgPSAzKQ0KDQpoZWF0bWFwX3NyX21lYW5fY3Jvc3MNCmBgYA0KDQojIyBTaW5nbGUgRU1BIE1lYW4gUmV2ZXJzaW9uDQpTaW5nbGUgRU1BIG1lYW4gcmV2ZXJzaW9uIHN0cmF0ZWdpZXMgcGVyZm9ybWVkIGV2ZW4gd29yc2UgdGhhbiB0aGVpciBtb21lbnR1bSBlcXVpdmFsZW50Lg0KDQpgYGB7ciwgd2FybmluZyA9IEYsIG1lc3NhZ2UgPSBGfQ0KIyBDb21iaW5lZA0KZm9yIChvdXRwdXQgaW4gaGVhdG1hcF9saXN0X3NpbmdsZV9tcikgew0KICBwcmludChvdXRwdXQpDQp9DQoNCiMgTWVhbg0KbmV0X3Nyc19zaW5nbGVfbXIgPC0gbGlzdCgpDQoNCmZvcihpIGluIDE6bGVuZ3RoKHNlbnNpdGl2aXRpZXNfc2luZ2xlX21yKSkgew0KICBuZXRfc3JzX3NpbmdsZV9tcltbaV1dIDwtIGFzLmxpc3Qoc2Vuc2l0aXZpdGllc19zaW5nbGVfbXJbW2ldXVtjKCJuZXQuU1IiKV0pW1sxXV0NCn0NCg0KYXZlcmFnZV9uZXRfc3Jfc2luZ2xlX21yIDwtIHNhcHBseShzZXFfYWxvbmcobmV0X3Nyc19zaW5nbGVfbXJbWzFdXSksIGZ1bmN0aW9uKGkpIHsNCiAgbWVhbihzYXBwbHkobmV0X3Nyc19zaW5nbGVfbXIsIGZ1bmN0aW9uKHgpIHhbW2ldXSkpDQp9KQ0KYXZlcmFnZV9uZXRfc3Jfc2luZ2xlX21yIDwtIGRhdGEuZnJhbWUobmV0LlNSID0gYXZlcmFnZV9uZXRfc3Jfc2luZ2xlX21yKQ0KDQpzZW5zaXRpdml0aWVzX2F2ZXJhZ2Vfc2luZ2xlX21yIDwtIHNlbnNpdGl2aXRpZXNfc2luZ2xlX21yW1sxXV1bYygiQ2xvc2UiLCAiRU1BIildDQpzZW5zaXRpdml0aWVzX2F2ZXJhZ2Vfc2luZ2xlX21yIDwtIGNiaW5kKHNlbnNpdGl2aXRpZXNfYXZlcmFnZV9zaW5nbGVfbXIsICJuZXQuU1IiID0gYXZlcmFnZV9uZXRfc3Jfc2luZ2xlX21yKQ0KDQpoZWF0bWFwX3NyX21lYW5fc2luZ2xlX21yIDwtIHBsb3RIZWF0bWFwKGRhdGFfcGxvdCA9IHNlbnNpdGl2aXRpZXNfYXZlcmFnZV9zaW5nbGVfbXIsICMgZGF0YXNldCAoZGF0YS5mcmFtZSkgd2l0aCBjYWxjdWxhdGlvbnMNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sX3ZsYWJlbHMgPSAiQ2xvc2UiLCAjIGNvbHVtbiBuYW1lIHdpdGggdGhlIGxhYmVscyBmb3IgYSB2ZXJ0aWNhbCBheGlzIChzdHJpbmcpDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbF9obGFiZWxzID0gIkVNQSIsICMgY29sdW1uIG5hbWUgd2l0aCB0aGUgbGFiZWxzIGZvciBhIGhvcml6b250YWwgYXhpcyAoc3RyaW5nKQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xfdmFyaWFibGUgPSAibmV0LlNSIiwgIyBjb2x1bW4gbmFtZSB3aXRoIHRoZSB2YXJpYWJsZSB0byBzaG93IChzdHJpbmcpDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1haW4gPSBwYXN0ZSgiTWVhbiIsICJTZW5zaXRpdml0eSBhbmFseXNpcyBmb3IgbWVhbiByZXZlcnNpb24gc3RhdGVneSBiYXNlZCBvbiBzaW5nbGUgRU1BIiwgc2VwID0gIjogIiksDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsX3NpemUgPSAzKQ0KDQpoZWF0bWFwX3NyX21lYW5fc2luZ2xlX21yDQpgYGANCg0KIyMgQ3Jvc3NvdmVyIEVNQSBNZWFuIFJldmVyc2lvbg0KU2ltaWxhcmx5LCBjcm9zc292ZXIgRU1BIG1lYW4gcmV2ZXJzaW9uIHN0cmF0ZWdpZXMgcHJvZHVjZWQgbmVnYXRpdmUgU2hhcnBlIHJhdGlvcyBmb3IgYWxsIGNvbWJpbmF0aW9ucy4NCg0KYGBge3IsIHdhcm5pbmcgPSBGLCBtZXNzYWdlID0gRn0NCiMgQ29tYmluZWQNCmZvciAob3V0cHV0IGluIGhlYXRtYXBfbGlzdF9jcm9zc19tcikgew0KICBwcmludChvdXRwdXQpDQp9DQoNCiMgTWVhbg0KbmV0X3Nyc19jcm9zc19tciA8LSBsaXN0KCkNCg0KZm9yKGkgaW4gMTpsZW5ndGgoc2Vuc2l0aXZpdGllc19jcm9zc19tcikpIHsNCiAgbmV0X3Nyc19jcm9zc19tcltbaV1dIDwtIGFzLmxpc3Qoc2Vuc2l0aXZpdGllc19jcm9zc19tcltbaV1dW2MoIm5ldC5TUiIpXSlbWzFdXQ0KfQ0KDQphdmVyYWdlX25ldF9zcl9jcm9zc19tciA8LSBzYXBwbHkoc2VxX2Fsb25nKG5ldF9zcnNfY3Jvc3NfbXJbWzFdXSksIGZ1bmN0aW9uKGkpIHsNCiAgbWVhbihzYXBwbHkobmV0X3Nyc19jcm9zc19tciwgZnVuY3Rpb24oeCkgeFtbaV1dKSkNCn0pDQphdmVyYWdlX25ldF9zcl9jcm9zc19tciA8LSBkYXRhLmZyYW1lKG5ldC5TUiA9IGF2ZXJhZ2VfbmV0X3NyX2Nyb3NzX21yKQ0KDQpzZW5zaXRpdml0aWVzX2F2ZXJhZ2VfY3Jvc3NfbXIgPC0gc2Vuc2l0aXZpdGllc19jcm9zc19tcltbMV1dW2MoIkVNQS5mYXN0IiwgIkVNQS5zbG93IildDQpzZW5zaXRpdml0aWVzX2F2ZXJhZ2VfY3Jvc3NfbXIgPC0gY2JpbmQoc2Vuc2l0aXZpdGllc19hdmVyYWdlX2Nyb3NzX21yLCAibmV0LlNSIiA9IGF2ZXJhZ2VfbmV0X3NyX2Nyb3NzX21yKQ0KDQpoZWF0bWFwX3NyX21lYW5fY3Jvc3NfbXIgPC0gcGxvdEhlYXRtYXAoZGF0YV9wbG90ID0gc2Vuc2l0aXZpdGllc19hdmVyYWdlX2Nyb3NzX21yLCAjIGRhdGFzZXQgKGRhdGEuZnJhbWUpIHdpdGggY2FsY3VsYXRpb25zDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sX3ZsYWJlbHMgPSAiRU1BLmZhc3QiLCAjIGNvbHVtbiBuYW1lIHdpdGggdGhlIGxhYmVscyBmb3IgYSB2ZXJ0aWNhbCBheGlzIChzdHJpbmcpDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sX2hsYWJlbHMgPSAiRU1BLnNsb3ciLCAjIGNvbHVtbiBuYW1lIHdpdGggdGhlIGxhYmVscyBmb3IgYSBob3Jpem9udGFsIGF4aXMgKHN0cmluZykNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xfdmFyaWFibGUgPSAibmV0LlNSIiwgIyBjb2x1bW4gbmFtZSB3aXRoIHRoZSB2YXJpYWJsZSB0byBzaG93IChzdHJpbmcpDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFpbiA9IHBhc3RlKCJNZWFuIiwgIlNlbnNpdGl2aXR5IGFuYWx5c2lzIGZvciBtZWFuIHJldmVyc2lvbiBzdGF0ZWd5IGJhc2VkIG9uIEVNQSBjcm9zc292ZXIiLCBzZXAgPSAiOiAiKSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbF9zaXplID0gMykNCg0KaGVhdG1hcF9zcl9tZWFuX2Nyb3NzX21yDQpgYGANCg0KIyBHcm91cCAyDQpHcm91cCAyIGRhdGEgd2FzIGxpbWl0ZWQgdG8gZ29sZCBhbmQgc2lsdmVyLiBOQSB2YWx1ZXMgd2VyZSBpbnNlcnRlZCBpbiB0aGUgZmlyc3QgYW5kIGxhc3QgMTAgbWludXRlcyBvZiB0aGUgdHJhZGluZyBzZXNzaW9uIHRvIGF2b2lkIHRyYWRpbmcgb24gdm9sYXRpbGUgYW5kIHJlYWN0aXZlIHBhcnRzIG9mIHRoZSBkYXkgYW5kIHRvIGZvY3VzIG9uIGludHJhZGF5IHRyYWRpbmcuDQoNClRoZSB0d28gYXNzZXRzIHdlcmUgZ3JvdXBlZCBmb3IgcGFpciB0cmFkaW5nIGFuZCB2b2xhdGlsaXR5IGJyZWFrb3V0IHdhcyB0aGUgYXBwcm9hY2ggb2YgY2hvaWNlIGluIHRoZSBhbGdvcml0aG0uIEJlaW5nIHBhcnQgb2YgdGhlIHNhbWUgcHJlY2lvdXMgbWV0YWxzIGNhdGVnb3J5IG9mIGNvbW1vZGl0aWVzLCBpdCB3YXMgcGxhdXNpYmxlIHRvIGFzc3VtZSBzb21lIGxldmVsIG9mIGNvbW1vbiBwcmljZSBtb3ZlbWVudC4gQSBzcHJlYWQgd2FzIGNhbGN1bGF0ZWQsIHdoaWNoIGZvcm1lZCB0aGUgYmFzaXMgb2Ygc2lnbmFscyBmb3IgdHJhZGluZyAodm9sYXRpbGl0eSBiYW5kcyB3ZXJlIHNldCBhcm91bmQgdGhlIHNwcmVhZCkuIEJvdGggbGV2ZWxzIGFuZCByZXR1cm5zIHdlcmUgdGVzdGVkIGZvciB0aGUgc3ByZWFkLiBBIHNob3J0IHBvc2l0aW9uIHdhcyBpbml0aWFsbHkgdHJpZ2dlcmVkIHdoZW5ldmVyIHRoZSBzaWduYWwgZXhjZWVkZWQgdGhlIHVwcGVyIGJvdW5kIGFuZCB0aGVuIGNvbnRpbnVlZCB3aGlsc3QgdGhlIHNpZ25hbCByZW1haW5lZCBhYm92ZSB0aGUgbG93ZXIgYm91bmQgYW5kIGEgbG9uZyBwb3NpdGlvbiBvdGhlcndpc2UuIFRoaXMgc3RyYXRlZ3kgd2FzIGFsd2F5cyBhIG1lYW4gcmV2ZXJzaW9uIHN0cmF0ZWd5IGJlaW5nIGFnYWluc3QgdGhlIG1hcmtldC4NCg0KSW4gb3JkZXIgdG8gZGV0ZXJtaW5lIHRoZSBvcHRpbWFsIHBhcmFtZXRlcnMgZm9yIHRoZSBtb2RlbHMsIG11bHRpcGxlIGNvbWJpbmF0aW9ucyBvZiB2b2xhdGlsaXR5IG1lbW9yaWVzIGFuZCBtdWx0aXBsaWVycyB3ZXJlIHRlc3RlZDogZXZlcnkgY29tYmluYXRpb24gb2YgNjAtMTgwIGRheSB2b2xhdGlsaXR5IG1lbW9yaWVzIGFuZCAwLjUtMy41IG11bHRpcGxpZXJzLg0KDQpBbGwgcG9zaXRpb25zIHdlcmUgZXhpdGVkIGluIHRoZSBmaXJzdCAxMCBhbmQgbGFzdCAxMCBtaW51dGVzIG9mIHRoZSB0cmFkaW5nIHNlc3Npb24gYW5kIGluIGJldHdlZW4gc2Vzc2lvbnMuIEFueSByZW1haW5pbmcgbWlzc2luZyByYXRpbyB2YWx1ZSB3YXMgcG9wdWxhdGVkIHdpdGggdGhlIHByZXZpb3VzIHZhbHVlIGZvciBjb21wbGV0ZW5lc3MuDQoNCkdyb3NzIFAmTCAoYWNjb3VudGluZyBmb3IgcG9pbnQgdmFsdWVzKSwgbmV0IFAmTCAocmVmbGVjdGluZyB0cmFuc2FjdGlvbiBjb3N0cykgYW5kIG51bWJlciBvZiB0cmFkZXMgd2VyZSBjYWxjdWxhdGVkLiBUaGUgZGF0YSB3YXMgdGhlbiBhZ2dyZWdhdGVkIHRvIGRhaWx5IGxldmVsIGFuZCB0aGUgZm9sbG93aW5nIG1ldHJpY3Mgd2VyZSBjYWxjdWxhdGVkOiBTaGFycGUgcmF0aW8sIENhbG1hciByYXRpbywgYXZlcmFnZSBudW1iZXIgb2YgdHJhZGVzLCBjdW11bGF0aXZlIHN1bSBvZiBncm9zcyBQJkwsIGN1bXVsYXRpdmUgc3VtIG9mIG5ldCBQJkwgYW5kIGEgZmluYWwgdGVzdCBzdGF0aXN0aWMuDQoNClRoZSBlbnRpcmUgcHJvY2VzcyB3YXMgcmVwZWF0ZWQgZm9yIGFsbCBpbi1zYW1wbGUgcXVhcnRlcnMuDQoNCmBgYHtyLCB3YXJuaW5nID0gRiwgbWVzc2FnZSA9IEZ9DQpoZWF0bWFwX2xpc3QgPC0gbGlzdCgpDQpoZWF0bWFwX2xpc3QyIDwtIGxpc3QoKQ0Kc2Vuc2l0aXZpdGllcyA8LSBsaXN0KCkNCnNlbnNpdGl2aXRpZXMyIDwtIGxpc3QoKQ0KDQpmb3IgKHNlbGVjdGVkX3F1YXJ0ZXIgaW4gc2VsZWN0ZWRfcXVhcnRlcnMpIHsNCiAgDQogIG1lc3NhZ2Uoc2VsZWN0ZWRfcXVhcnRlcikNCiAgDQogIGZpbGVuYW1lXyA8LSBwYXN0ZTAoImRhdGEvZGF0YTJfIiwgc2VsZWN0ZWRfcXVhcnRlciwgIi5SRGF0YSIpDQogIGxvYWQoZmlsZW5hbWVfKQ0KICANCiAgZGF0YS5ncm91cDIgPC0gZ2V0KHBhc3RlMCgiZGF0YTJfIiwgc2VsZWN0ZWRfcXVhcnRlcikpDQogIHRpbWVzXyA8LSBzdWJzdHIoaW5kZXgoZGF0YS5ncm91cDIpLCAxMiwgMTkpDQogIA0KICAjIEtlZXAgZ29sZCBhbmQgc2lsdmVyDQogIGRhdGEuZ3JvdXAyIDwtIGRhdGEuZ3JvdXAyWywgIWNvbG5hbWVzKGRhdGEuZ3JvdXAyKSAlaW4lIGMoIkFVRCIsIkNBRCIpXQ0KICBuYW1lcyhkYXRhLmdyb3VwMilbMToyXSA8LSBjKCJYQUcuY2xvc2UiLCJYQVUuY2xvc2UiKQ0KICANCiAgZGF0YS5ncm91cDIucmV0dXJuIDwtIDEwMDAwKmRpZmYueHRzKGxvZyhkYXRhLmdyb3VwMikpDQogIG5hbWVzKGRhdGEuZ3JvdXAyLnJldHVybilbMToyXSA8LSBjKCJYQUcucmV0dXJuIiwiWEFVLnJldHVybiIpDQogIA0KICBkYXRhLmdyb3VwMiA8LSBtZXJnZShkYXRhLmdyb3VwMlssIGMoIlhBRy5jbG9zZSIsICJYQVUuY2xvc2UiKV0sDQogICAgICAgICAgICAgICAgICAgICAgIGRhdGEuZ3JvdXAyLnJldHVyblssIGMoIlhBRy5yZXR1cm4iLCAiWEFVLnJldHVybiIpXSkNCiAgDQogIG15VGhlbWUgPC0gY2hhcnRfdGhlbWUoKQ0KICBteVRoZW1lJGNvbCRsaW5lLmNvbCA8LSAiZGFya2JsdWUiDQoNCiAgIyB0aGUgZm9sbG93aW5nIGNvbW1vbiBhc3N1bXB0aW9ucyB3ZXJlIGRlZmluZWQ6DQogICMgMS4JZG8gbm90IHVzZSBpbiBjYWxjdWxhdGlvbnMgdGhlIGRhdGEgZnJvbSB0aGUgZmlyc3QgYW5kIGxhc3QgMTAgbWludXRlcyBvZiB0aGUgc2Vzc2lvbiAoMTg6MDEtLTE4OjEwIGFuZCAxNjo1MS0tMTc6MDApIOKAkyBwdXQgbWlzc2luZyB2YWx1ZXMgdGhlcmUsDQogIA0KICAjIGxldHMgcHV0IG1pc3NpbmcgdmFsdWVzIGZvciB0aGVzZSBwZXJpb2RzDQogIGRhdGEuZ3JvdXAyWyJUMTg6MDEvVDE4OjEwIixdIDwtIE5BIA0KICBkYXRhLmdyb3VwMlsiVDE2OjUxL1QxNzowMCIsXSA8LSBOQQ0KICANCiAgbGF5b3V0KG1hdHJpeCgxOjQsIDIsIDIpKQ0KICBwcmludChjaGFydF9TZXJpZXMoZGF0YS5ncm91cDIkWEFHLmNsb3NlLCB0aGVtZSA9IG15VGhlbWUpKQ0KICBwcmludChjaGFydF9TZXJpZXMoZGF0YS5ncm91cDIkWEFVLmNsb3NlLCB0aGVtZSA9IG15VGhlbWUpKQ0KICBwcmludChjaGFydF9TZXJpZXMoZGF0YS5ncm91cDIkWEFHLnJldHVybiwgdGhlbWUgPSBteVRoZW1lKSkNCiAgcHJpbnQoY2hhcnRfU2VyaWVzKGRhdGEuZ3JvdXAyJFhBVS5yZXR1cm4sIHRoZW1lID0gbXlUaGVtZSkpDQogIGxheW91dChtYXRyaXgoMSkpDQogIA0KICAjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjDQogICMgZm9ybXVsYXRlIGEgc3ByZWFkOiBQMSAtIG0gKiBQMiAoUF9YQVUgLSBtICogUF9YQUcpIA0KICAjIHdoZXJlIG0gPSBtMS9tMiBpcyBiYXNlZCBvbiBhdmVyYWdlIHJhdGlvIGJldHdlZW4gdGhlIHByaWNlcw0KICAjIG9uIHRoZSBQUkVWSU9VUyBkYXkNCiAgDQogICMgc3ByZWFkIGlzIGEgc2lnbmFsIHRvIG91ciBtb2RlbCwgd2hpY2ggc2hvd3Mgd2hldGhlciB0byB0YWtlIA0KICAjIHBvc2l0aW9uIG9yIG5vdCAodm9sYXRpbGl0eSBiYW5kcyBhcm91bmQgdGhlIHNwcmVhZCkNCiAgDQogICMgd2UgYXNzdW1lIHRoZSBtZWFuIHJldmVydGluZyBiZWhhdmlvciBvZiB0aGUgc3ByZWFkDQogIA0KICAjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIw0KICAjIGxldHMgY2FsY3VsYXRlIGF2ZXJhZ2UgcmF0aW8gb2YgcHJpY2VzIG9uIHRoZSBkYWlseSBiYXNpcw0KICANCiAgaW5kZXhfcG9zaXggPC0gaW5kZXgoZGF0YS5ncm91cDIpDQogIHRpbWVfY29tcG9uZW50IDwtIGZvcm1hdChpbmRleF9wb3NpeCwgZm9ybWF0ID0gIiVIOiVNOiVTIikNCiAgdGFyZ2V0X3RpbWUgPC0gIjE3OjAwOjAwIg0KICBpbmRpY2VzIDwtIHdoaWNoKHRpbWVfY29tcG9uZW50ID09IHRhcmdldF90aW1lKQ0KDQogIGNtZC5hdi5yYXRpbyA8LSBwZXJpb2QuYXBwbHkoZGF0YS5ncm91cDIsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBJTkRFWCA9IGluZGljZXMsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbih4KSBtZWFuKHgkWEFVLmNsb3NlL3gkWEFHLmNsb3NlLCANCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmEucm0gPSBUUlVFKQ0KICApDQogIA0KICBuYW1lcyhjbWQuYXYucmF0aW8pIDwtICJhdi5yYXRpbyINCiAgDQogICMgYWJvdXQgNjQtNzQgWEFHIHVuaXRzIHBlciBlYWNoIHVuaXQgb2YgWEFVIChmdXR1cmUpDQogIA0KICAjIGNhbGN1bGF0aW9ucyBiYXNlZCBvbiB0aGUgZmlyc3QgZGF5DQogICMgd2lsbCBiZSB1c2VkIG9uIHRoZSBzZWNvbmQgZGF5LCBldGMuDQogICMgbW92ZSB0aGUgdGltZSBpbmRleCB0byAxODowMCBvZiB0aGUgbmV4dCB0cmFkaW5nIGRheSAoc2FtZSBkYXkpDQoNCiAgIyBzb21lIG9mIHRoZSBkYXRlcyBtaWdodCBiZSBGcmlkYXlzIGFuZCBpbiB0aGlzIGNhc2UNCiAgIyB3ZSB3b3VsZCBtb3ZlIHRoZSBpbmRleCB0byAxODowMCBvbiBTdW5kYXkNCiAgIyA2ID0gRnJpZGF5DQogICMgdXNlIGlmX2Vsc2UoKSBmcm9tIGRwbHlyIGluc3RlYWQNCg0KICBpbmRleChjbWQuYXYucmF0aW8pIDwtIA0KICAgIGNlaWxpbmdfZGF0ZShpbmRleChjbWQuYXYucmF0aW8pLCAiZGF5IikgLSANCiAgICBob3Vycyg2KSArIA0KICAgIG1pbnV0ZXMoMCkgKw0KICAgIGlmX2Vsc2Uod2RheShpbmRleChjbWQuYXYucmF0aW8pKSA9PSA2LCANCiAgICAgICAgICAgIGRheXMoMiksDQogICAgICAgICAgICBkYXlzKDApKSAgDQogIA0KICAjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjDQogICMgYWx0ZXJuYXRpdmUgc3ByZWFkIGJhc2VkIG9uIFJFVFVSTlM6DQogICMgcjEgLSBtcyAqIHIyIChyX1hBVSAtIG1zICogcl9YQUcpIA0KICAjIHdoZXJlIG1zID0gczEvczIgaXMgYmFzZWQgb24gdGhlIHJhdGlvIG9mIHN0YW5kYXJkDQogICMgZGV2aWF0aW9ucyBvZiByZXR1cm5zIG9uIHRoZSBQUkVWSU9VUyBkYXkNCiAgDQogIGNtZC5zZHMucmF0aW8gPC0gcGVyaW9kLmFwcGx5KGRhdGEuZ3JvdXAyLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIElOREVYID0gaW5kaWNlcywNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbih4KSBzZCh4JFhBVS5yZXR1cm4sIG5hLnJtID0gVFJVRSkgLw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2QoeCRYQUcucmV0dXJuLCBuYS5ybSA9IFRSVUUpDQogICkNCiAgDQogIG5hbWVzKGNtZC5zZHMucmF0aW8pIDwtICJzZHMucmF0aW8iDQogIA0KICAjIGJldHdlZW4gMC4yIGFuZCAwLjY1IFhBRyB1bml0cyANCiAgIyBwZXIgZWFjaCB1bml0IG9mIFhBVSAoZnV0dXJlKQ0KICANCiAgIyBtb3ZlIHRoZSBpbmRleCB0byAxODowMCBvZiB0aGUgbmV4dCB0cmFkaW5nIGRheSAoc2FtZSBkYXkpDQogIA0KICBpbmRleChjbWQuc2RzLnJhdGlvKSA8LSANCiAgICBjZWlsaW5nX2RhdGUoaW5kZXgoY21kLnNkcy5yYXRpbyksICJkYXkiKSAtDQogICAgaG91cnMoNikgKyANCiAgICBtaW51dGVzKDApICsNCiAgICBpZl9lbHNlKHdkYXkoaW5kZXgoY21kLnNkcy5yYXRpbykpID09IDYsIA0KICAgICAgICAgICAgZGF5cygyKSwgDQogICAgICAgICAgICBkYXlzKDApKQ0KICANCiAgIyBtZXJnZSBvdXIgYmFzaWMgNSBtaW4gZGF0YSB3aXRoIGRhaWx5IGNhbGN1bGF0aW9ucw0KICANCiAgZGF0YS5ncm91cDJiIDwtIG1lcmdlKGRhdGEuZ3JvdXAyLA0KICAgICAgICAgICAgICAgICAgICBjbWQuYXYucmF0aW8sIA0KICAgICAgICAgICAgICAgICAgICBjbWQuc2RzLnJhdGlvKQ0KICANCiAgIyBtaXNzaW5ncyBpbiBhIHRoZSBsYXN0IDIgY29sdW1ucw0KICAjIHdoaWNoIHNob3VsZCBiZSBmaWxsZWQgd2l0aCB0aGUgbGFzdCBub24tbWlzc2luZyB2YWx1ZQ0KICAjIChsYXN0IG11bHRpcGxpZXIgaXMgdXNlZCB1bnRpbCB0aGVyZSBpcyBhIG5ldyBvbmUpDQogIA0KICBkYXRhLmdyb3VwMmIkYXYucmF0aW8gPC0gbmEubG9jZihkYXRhLmdyb3VwMmIkYXYucmF0aW8sDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmEucm0gPSBGQUxTRSkNCiAgZGF0YS5ncm91cDJiJHNkcy5yYXRpbyA8LSBuYS5sb2NmKGRhdGEuZ3JvdXAyYiRzZHMucmF0aW8sDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hLnJtID0gRkFMU0UpDQogIA0KICAjIGV4Y2x1ZGUgd2Vla2VuZHMgZnJvbSBkYXRhDQogIA0KICB0YWJsZSh3ZGF5KGRhdGEuZ3JvdXAyYikpDQogIA0KICAjIHRoZXJlIGFyZSBubyByb3dzIHdpdGggNyAoU2F0dXJkYXkpDQogIA0KICAjIGNhbGN1bGF0ZSB0aGUgc3ByZWFkIChpbiAyIHZhcmlhbnRzKQ0KICBkYXRhLmdyb3VwMmIkc3ByZWFkX2F2cmF0aW8gPC0gDQogICAgZGF0YS5ncm91cDJiJFhBVS5jbG9zZSAtDQogICAgZGF0YS5ncm91cDJiJGF2LnJhdGlvICogZGF0YS5ncm91cDJiJFhBRy5jbG9zZQ0KICANCiAgZGF0YS5ncm91cDJiJHNwcmVhZF9zZHNyYXRpbyA8LSANCiAgICBkYXRhLmdyb3VwMmIkWEFVLnJldHVybiAtIA0KICAgIGRhdGEuZ3JvdXAyYiRzZHMucmF0aW8gKiBkYXRhLmdyb3VwMmIkWEFHLnJldHVybg0KICANCiAgIyBhc3N1bWUgd2UgZG8gbm90IHRyYWRlIHdpdGhpbiB0aGUgZmlyc3QgMTAtbWlucyBvZiB0aGUgZGF5DQogICMgYW5kIGV4aXQgYWxsIHBvc2l0aW9ucyAxMCBtaW51dGVzIGJlZm9yZSB0aGUgZW5kIG9mIHF1b3RhdGlvbnMNCiAgDQogICMgY3JlYXRlIGEgcG9zX2ZsYXQgdmVjdG9yIGFuZCBmaWxsIGl0IHdpdGggMHMNCiAgcG9zX2ZsYXQgPC0geHRzKHJlcCgwLCBucm93KGRhdGEuZ3JvdXAyYikpLCBpbmRleChkYXRhLmdyb3VwMmIpKQ0KICANCiAgIyB3ZSBkbyBub3QgdHJhZGUgd2l0aGluIHRoZSBmaXJzdCAxMCBtaW5zICgxODowMC0xODoxMCkgDQogICMgYnV0IGFsc28gYmVmb3JlIHRoYXQgdGltZSB3aGVuIHNlc3Npb24gd2FzIGluYWN0aXZlDQogICMgYW5kIGxhc3QgMTAgbWlucyBvZiB0aGUgc2Vzc2lvbiAoMTY6NTEtMTc6MDApDQogICMgYnV0IGFsc28gYWZ0ZXIgdGhpcyB0aW1lIHdoZW4gc2Vzc2lvbiB3YXMgaW5hY3RpdmUNCiAgDQogIHBvc19mbGF0WyJUMTY6NTEvVDE4OjEwIl0gPC0gMQ0KICANCiAgIyBub3RlIHRoaXMgY292ZXJzIEZyaWRheXMgYW5kIFN1bmRheXMgYXMgdGhlIHNlcmllcyBnb2VzIGZyb20gMTc6MDAgRnJpZGF5IHRvIDE3OjA1IFN1bmRheQ0KICANCiAgIyBhcHBseSB2b2xhdGlsaXR5IGJyZWFrb3V0IG1vZGVsIGluIGEgbG9vcCBmb3Igc3ByZWFkIGFuZCBzcHJlYWQyDQoNCiAgZm9yKHZvbGF0LnNkIGluIGMoNjAsIDkwLCAxMjAsIDE1MCwgMTgwKSkgeyAjIGRpZmZlcmVudCB2b2xhdGlsaXR5IG1lbW9yaWVzDQogICAgZm9yKG1fIGluIGMoMC41LCAxLCAxLjUsIDIsIDIuNSwgMywgMy41KSkgeyAjIGRpZmZlcmVudCBtdWx0aXBsaWVycw0KICAgICAgDQogICAgICBtZXNzYWdlKHBhc3RlMCgidm9sYXQuc2QgPSAiLCB2b2xhdC5zZCwNCiAgICAgICAgICAgICAgICAgICAgICIsIG1fID0gIiwgbV8pKSANCiAgICAgIA0KICAgICAgIyBjYWxjdWxhdGluZyBlbGVtZW50cyBvZiB0aGUgc3RyYXRlZ3kNCiAgICAgIFhBVV9wcmljZSA8LSBjb3JlZGF0YShkYXRhLmdyb3VwMmIkWEFVLmNsb3NlKQ0KICAgICAgWEFHX3ByaWNlIDwtIGNvcmVkYXRhKGRhdGEuZ3JvdXAyYiRYQUcuY2xvc2UpDQogICAgICANCiAgICAgIHNpZ25hbCA8LSBjb3JlZGF0YShkYXRhLmdyb3VwMmIkc3ByZWFkX2F2cmF0aW8pDQogICAgICBzaWduYWwyIDwtIGNvcmVkYXRhKGRhdGEuZ3JvdXAyYiRzcHJlYWRfc2RzcmF0aW8pDQogICAgICANCiAgICAgIHVwcGVyIDwtIG1fICogcnVuc2Qoc2lnbmFsLCB2b2xhdC5zZCwgDQogICAgICAgICAgICAgICAgICAgICAgICAgIGVuZHJ1bGUgPSAiTkEiLCANCiAgICAgICAgICAgICAgICAgICAgICAgICAgYWxpZ24gPSAicmlnaHQiKQ0KICAgICAgbG93ZXIgPC0gLW1fICogcnVuc2Qoc2lnbmFsLCB2b2xhdC5zZCwgDQogICAgICAgICAgICAgICAgICAgICAgICAgICBlbmRydWxlID0gIk5BIiwgDQogICAgICAgICAgICAgICAgICAgICAgICAgICBhbGlnbiA9ICJyaWdodCIpDQogICAgICANCiAgICAgIHVwcGVyMiA8LSBtXyAqIHJ1bnNkKHNpZ25hbDIsIHZvbGF0LnNkLCANCiAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuZHJ1bGUgPSAiTkEiLCANCiAgICAgICAgICAgICAgICAgICAgICAgICAgIGFsaWduID0gInJpZ2h0IikNCiAgICAgIGxvd2VyMiA8LSAtbV8gKiBydW5zZChzaWduYWwyLCB2b2xhdC5zZCwgDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5kcnVsZSA9ICJOQSIsIA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFsaWduID0gInJpZ2h0IikNCiAgICAgIA0KICAgICAgIyBwb3NpdGlvbiBmb3IgbWVhbi1yZXZlcnRpbmcgc3RyYXRlZ3kNCiAgICAgIHBvcy5tciA8LSBwb3NpdGlvblZCX25ldyhzaWduYWwsIGxvd2VyLCB1cHBlciwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3NfZmxhdCA9IHBvc19mbGF0LA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cmF0ZWd5ID0gIm1yIg0KICAgICAgKQ0KICAgICAgcG9zLm1yMiA8LSBwb3NpdGlvblZCX25ldyhzaWduYWwyLCBsb3dlcjIsIHVwcGVyMiwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zX2ZsYXQgPSBwb3NfZmxhdCwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyYXRlZ3kgPSAibXIiDQogICAgICApDQogICAgICAjIG51bWJlciBvZiB0cmFuc2FjdGlvbnMNCiAgICAgIG50cmFucyA8LSBhYnMoZGlmZi54dHMocG9zLm1yKSkNCiAgICAgIG50cmFuczIgPC0gYWJzKGRpZmYueHRzKHBvcy5tcjIpKQ0KICAgICAgDQogICAgICAjIGdyb3NzIHBubA0KICAgICAgZ3Jvc3MucG5sIDwtIChwb3MubXIpICoNCiAgICAgICAgKGRpZmYueHRzKFhBVV9wcmljZSkgKiAxMDAgIyBwb2ludCB2YWx1ZSBmb3IgWEFVDQogICAgICAgICAtIGNvcmVkYXRhKGRhdGEuZ3JvdXAyYiRhdi5yYXRpbykgKiBkaWZmLnh0cyhYQUdfcHJpY2UpICogNTAwMCkgIyBwb2ludCB2YWx1ZSBmb3IgWEFHDQogICAgICANCiAgICAgIGdyb3NzLnBubDIgPC0gKHBvcy5tcjIpICoNCiAgICAgICAgKGRpZmYueHRzKFhBVV9wcmljZSkgKiAxMDAgICMgcG9pbnQgdmFsdWUgZm9yIFhBVQ0KICAgICAgICAgLSBjb3JlZGF0YShkYXRhLmdyb3VwMmIkc2RzLnJhdGlvKSAqIGRpZmYueHRzKFhBR19wcmljZSkgKiA1MDAwKSAjIHBvaW50IHZhbHVlIGZvciBYQUcNCiAgICAgIA0KICAgICAgIyBwbmwgYWZ0ZXIgIGNvc3RzDQogICAgICAjIGNvc3RzID0gJDcgZm9yIFhBRyBhbmQgJDEyIGZvciBYQVUgPSAoMTIrbSo3KSBpbiB0b3RhbA0KICAgICAgIyBjb3N0cyBhcmUgYWx3YXlzIHBvc2l0aXZlDQogICAgICANCiAgICAgIG5ldC5wbmwgPC0gZ3Jvc3MucG5sIC0gbnRyYW5zICogKDEyICsgY29yZWRhdGEoZGF0YS5ncm91cDJiJGF2LnJhdGlvKSAqIDcpDQogICAgICBuZXQucG5sMiA8LSBncm9zcy5wbmwyIC0gbnRyYW5zMiAqICgxMiArIGNvcmVkYXRhKGRhdGEuZ3JvdXAyYiRzZHMucmF0aW8pICogNykNCiAgICAgIA0KICAgICAgIyBhZ2dyZWdhdGUgdG8gZGFpbHkNCg0KICAgICAgcG5sLmdyb3NzLmQgPC0gcGVyaW9kLmFwcGx5KGdyb3NzLnBubCwgSU5ERVggPSBpbmRpY2VzLCANCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBGVU4gPSBmdW5jdGlvbih4KSBzdW0oeCwgbmEucm0gPSBUUlVFKSkNCiAgICAgIHBubC5ncm9zczIuZCA8LSBwZXJpb2QuYXBwbHkoZ3Jvc3MucG5sMiwgSU5ERVggPSBpbmRpY2VzLCANCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgRlVOID0gZnVuY3Rpb24oeCkgc3VtKHgsIG5hLnJtID0gVFJVRSkpDQogICAgICBwbmwubmV0LmQgPC0gcGVyaW9kLmFwcGx5KG5ldC5wbmwsIElOREVYID0gaW5kaWNlcywNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgRlVOID0gZnVuY3Rpb24oeCkgc3VtKHgsIG5hLnJtID0gVFJVRSkpDQogICAgICBwbmwubmV0Mi5kIDwtIHBlcmlvZC5hcHBseShuZXQucG5sMiwgSU5ERVggPSBpbmRpY2VzLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgRlVOID0gZnVuY3Rpb24oeCkgc3VtKHgsIG5hLnJtID0gVFJVRSkpDQogICAgICBudHJhbnMuZCA8LSBwZXJpb2QuYXBwbHkobnRyYW5zLCBJTkRFWCA9IGluZGljZXMsIA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEZVTiA9IGZ1bmN0aW9uKHgpIHN1bSh4LCBuYS5ybSA9IFRSVUUpKQ0KICAgICAgbnRyYW5zMi5kIDwtIHBlcmlvZC5hcHBseShudHJhbnMyLCBJTkRFWCA9IGluZGljZXMsIA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBGVU4gPSBmdW5jdGlvbih4KSBzdW0oeCwgbmEucm0gPSBUUlVFKSkNCiAgICAgIA0KICAgICAgIyBjYWxjdWxhdGUgc3VtbWFyeSBtZWFzdXJlcw0KICAgICAgZ3Jvc3MuU1IgPC0gbXlTUihwbmwuZ3Jvc3MuZCwgc2NhbGUgPSAyNTIpDQogICAgICBncm9zcy5TUjIgPC0gbXlTUihwbmwuZ3Jvc3MyLmQsIHNjYWxlID0gMjUyKQ0KICAgICAgbmV0LlNSIDwtIG15U1IocG5sLm5ldC5kLCBzY2FsZSA9IDI1MikNCiAgICAgIG5ldC5TUjIgPC0gbXlTUihwbmwubmV0Mi5kLCBzY2FsZSA9IDI1MikNCiAgICAgIA0KICAgICAgZ3Jvc3MuQ1IgPC0gbXlDYWxtYXJSYXRpbyhwbmwuZ3Jvc3MuZCwgc2NhbGUgPSAyNTIpDQogICAgICBncm9zcy5DUjIgPC0gbXlDYWxtYXJSYXRpbyhwbmwuZ3Jvc3MyLmQsIHNjYWxlID0gMjUyKQ0KICAgICAgbmV0LkNSIDwtIG15Q2FsbWFyUmF0aW8ocG5sLm5ldC5kLCBzY2FsZSA9IDI1MikNCiAgICAgIG5ldC5DUjIgPC0gbXlDYWxtYXJSYXRpbyhwbmwubmV0Mi5kLCBzY2FsZSA9IDI1MikNCiAgICAgIA0KICAgICAgZ3Jvc3MuUG5MIDwtIHN1bShwbmwuZ3Jvc3MuZCwgbmEucm0gPSBUUlVFKQ0KICAgICAgZ3Jvc3MuUG5MMiA8LSBzdW0ocG5sLmdyb3NzMi5kLCBuYS5ybSA9IFRSVUUpDQogICAgICBuZXQuUG5MIDwtIHN1bShwbmwubmV0LmQsIG5hLnJtID0gVFJVRSkNCiAgICAgIG5ldC5QbkwyIDwtIHN1bShwbmwubmV0Mi5kLCBuYS5ybSA9IFRSVUUpDQogICAgICANCiAgICAgIGF2LmRhaWx5Lm50cmFucyA8LSBtZWFuKG50cmFucy5kLCBuYS5ybSA9IFRSVUUpDQogICAgICBhdi5kYWlseS5udHJhbnMyIDwtIG1lYW4obnRyYW5zMi5kLCBuYS5ybSA9IFRSVUUpIA0KICAgICAgDQogICAgICBzdGF0ID0gbmV0LkNSICogbWF4KDAsIGxvZyhhYnMobmV0LlBuTC8xMDAwKSkpDQogICAgICBzdGF0MiA9IG5ldC5DUjIgKiBtYXgoMCwgbG9nKGFicyhuZXQuUG5MMi8xMDAwKSkpDQogICAgICANCiAgICAgICMgY29sbGVjdGluZyBhbGwgc3RhdGlzdGljcyBmb3IgYSBwYXJ0aWN1bGFyIHF1YXJ0ZXINCiAgICAgIGlmKHZvbGF0LnNkID09IDE4MCAmIG1fID09IDEpIHsNCiAgICAgICAgcXVhcnRlcl9zdGF0cyA8LSBkYXRhLmZyYW1lKHF1YXJ0ZXIgPSBzZWxlY3RlZF9xdWFydGVyLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXNzZXRzLmdyb3VwID0gMiwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyb3NzLlNSLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV0LlNSLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3Jvc3MuQ1IsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXQuQ1IsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm9zcy5QbkwsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXQuUG5MLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXYuZGFpbHkubnRyYW5zLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdCwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cmluZ3NBc0ZhY3RvcnMgPSBGQUxTRQ0KICAgICAgICApDQogICAgICAgIA0KICAgICAgICBxdWFydGVyX3N0YXRzMiA8LSBkYXRhLmZyYW1lKHF1YXJ0ZXIgPSBzZWxlY3RlZF9xdWFydGVyLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXNzZXRzLmdyb3VwID0gMiwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyb3NzLlNSMiwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ldC5TUjIsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm9zcy5DUjIsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXQuQ1IyLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3Jvc3MuUG5MMiwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ldC5QbkwyLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXYuZGFpbHkubnRyYW5zMiwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXQyLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyaW5nc0FzRmFjdG9ycyA9IEZBTFNFDQogICAgICAgICkNCiAgICAgICAgDQogICAgICAgICMgY29sbGVjdCBzdW1tYXJpZXMgZm9yIGFsbCBxdWFydGVycw0KICAgICAgICBpZighZXhpc3RzKCJxdWFydGVyX3N0YXRzLmFsbC5ncm91cDIiKSkgcXVhcnRlcl9zdGF0cy5hbGwuZ3JvdXAyIDwtIHF1YXJ0ZXJfc3RhdHMgZWxzZQ0KICAgICAgICAgIHF1YXJ0ZXJfc3RhdHMuYWxsLmdyb3VwMiA8LSByYmluZChxdWFydGVyX3N0YXRzLmFsbC5ncm91cDIsIHF1YXJ0ZXJfc3RhdHMpDQogICAgICAgIA0KICAgICAgICBpZighZXhpc3RzKCJxdWFydGVyX3N0YXRzMi5hbGwuZ3JvdXAyIikpIHF1YXJ0ZXJfc3RhdHMyLmFsbC5ncm91cDIgPC0gcXVhcnRlcl9zdGF0czIgZWxzZQ0KICAgICAgICAgIHF1YXJ0ZXJfc3RhdHMyLmFsbC5ncm91cDIgPC0gcmJpbmQocXVhcnRlcl9zdGF0czIuYWxsLmdyb3VwMiwgcXVhcnRlcl9zdGF0czIpDQogICAgICAgIA0KICAgICAgICAjIGNyZWF0ZSBhIHBsb3Qgb2YgZ3Jvc3MgYW5kIG5ldCBwbmwgYW5kIHNhdmUgaXQgdG8gcG5nIGZpbGUNCiAgICAgICAgeV9yYW5nZSA8LSByYW5nZShjKGN1bXN1bShwbmwuZ3Jvc3MuZCksIGN1bXN1bShwbmwubmV0LmQpKSkNCg0KICAgICAgICBwcmludCggIyB3aGVuIHBsb3R0aW5nIGluIGEgbG9vcCB5b3UgaGF2ZSB0byB1c2UgcHJpbnQoKQ0KICAgICAgICAgIHBsb3QoY3Vtc3VtKHBubC5ncm9zcy5kKSwNCiAgICAgICAgICAgICAgIHR5cGUgPSAibCIsDQogICAgICAgICAgICAgICBtYWluID0gcGFzdGUwKCJHcm9zcyBhbmQgbmV0IFBuTCBmb3IgYXNzZXQgZ3JvdXAgMiBcbiBxdWFydGVyICIsIHNlbGVjdGVkX3F1YXJ0ZXIpLA0KICAgICAgICAgICAgICAgY29sID0gIiMzNzdFQjgiLA0KICAgICAgICAgICAgICAgeGxhYiA9ICJUaW1lIiwNCiAgICAgICAgICAgICAgIHlsYWIgPSAiQ3VtdWxhdGl2ZSBQbkwiLA0KICAgICAgICAgICAgICAgeWxpbSA9IHlfcmFuZ2UNCiAgICAgICAgICApDQogICAgICAgICkNCiAgICAgICAgbGluZXMoY3Vtc3VtKHBubC5uZXQuZCksIGNvbCA9ICIjRTQxQTFDIikNCiAgICAgICAgbGVnZW5kKCJ0b3BsZWZ0IiwgbGVnZW5kID0gYygiR3Jvc3MgUG5MIiwgIk5ldCBQbkwiKSwgY29sID0gYygiIzM3N0VCOCIsICIjRTQxQTFDIiksIGx0eSA9IDEsIGNleCA9IDEpDQogICAgICB9DQogICAgICANCiAgICAgICMgc3VtbWFyeSBvZiBhIHBhcnRpY3VsYXIgc3RyYXRlZ3kNCiAgICAgIHN1bW1hcnlfIDwtIGRhdGEuZnJhbWUoc3ByZWFkID0gImF2LnJhdGlvIiwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdm9sYXQuc2QgPSB2b2xhdC5zZCwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbSA9IG1fLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwZXJpb2QgPSBzZWxlY3RlZF9xdWFydGVyLCAjICIyMDE2LTA4LTE2IC0gMjAxNi0xMSIsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyb3NzLlNSLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXQuU1IsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyb3NzLlBuTCwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV0LlBuTCwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXYuZGFpbHkubnRyYW5zLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJpbmdzQXNGYWN0b3JzID0gRkFMU0UpDQoNCiAgICAgIHN1bW1hcnkyXyA8LSBkYXRhLmZyYW1lKHNwcmVhZCA9ICJzZHMucmF0aW8iLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdm9sYXQuc2QgPSB2b2xhdC5zZCwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG0gPSBtXywNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBlcmlvZCA9IHNlbGVjdGVkX3F1YXJ0ZXIsICMgIjIwMTYtMDgtMTYgLSAyMDE2LTExIiwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyb3NzLlNSID0gZ3Jvc3MuU1IyLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV0LlNSID0gbmV0LlNSMiwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyb3NzLlBuTCA9IGdyb3NzLlBuTDIsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXQuUG5MID0gbmV0LlBuTDIsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdi5kYWlseS5udHJhbnMgPSBhdi5kYWlseS5udHJhbnMyLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyaW5nc0FzRmFjdG9ycyA9IEZBTFNFKQ0KDQogICAgICAjIHB1dHRpbmcgYWxsIHN1bW1hcmllcyB0b2dldGhlcg0KDQogICAgICBpZighZXhpc3RzKCJzdW1tYXJ5LnBhaXIudHJhZGluZyIpKSBzdW1tYXJ5LnBhaXIudHJhZGluZyA8LSByYmluZChzdW1tYXJ5Xywgc3VtbWFyeTJfKSBlbHNlDQogICAgICAgIHN1bW1hcnkucGFpci50cmFkaW5nIDwtIHJiaW5kKHN1bW1hcnkucGFpci50cmFkaW5nLCBzdW1tYXJ5Xywgc3VtbWFyeTJfKQ0KICAgICAgDQogICAgICAjIGRlbGV0aW5nIHdvcmtpbmcgZmlsZXMgbm90IG5lZWRlZCBhbnkgbW9yZQ0KICAgICAgcm0oZ3Jvc3MuU1IsIGdyb3NzLlNSMiwgbmV0LlNSLCBuZXQuU1IyLCBuZXQuQ1IsIG5ldC5DUjIsDQogICAgICAgICBncm9zcy5QbkwsIGdyb3NzLlBuTDIsIG5ldC5QbkwsIG5ldC5QbkwyLA0KICAgICAgICAgYXYuZGFpbHkubnRyYW5zLCBhdi5kYWlseS5udHJhbnMyLCBzdGF0LCBzdGF0MiwNCiAgICAgICAgIHBubC5ncm9zcy5kLCBwbmwuZ3Jvc3MyLmQsIHBubC5uZXQuZCwgcG5sLm5ldDIuZCwgDQogICAgICAgICBudHJhbnMuZCwgbnRyYW5zMi5kLA0KICAgICAgICAgcG5sLmdyb3NzLCBwbmwuZ3Jvc3MyLCBwbmwubmV0LCBwbmwubmV0MiwgDQogICAgICAgICBudHJhbnMsIG50cmFuczIsDQogICAgICAgICBwb3MubXIsIHBvcy5tcjIsIHN1bW1hcnlfLCBzdW1tYXJ5Ml8sDQogICAgICAgICBYQVVfcHJpY2UsIFhBR19wcmljZSwNCiAgICAgICAgIHNpZ25hbCwgc2lnbmFsMiwgbG93ZXIsIGxvd2VyMiwgdXBwZXIsIHVwcGVyMikNCiAgICAgIA0KICAgIH0gIyBlbmQgb2YgbG9vcCBmb3IgbV8NCiAgfSAjIGVuZCBvZiBsb29wIGZvciB2b2xhdGlsaXR5ICANCiAgDQogIA0KICAjIHJlc3VsdHMgb24gdGhlIGhlYXRtYXAgZ3JhcGgNCiAgDQogICMgbmV0LlNSIC0gc3ByZWFkIGF2X3JhdGlvDQogIGhlYXRtYXBfc3IgPC0gcGxvdEhlYXRtYXAoZGF0YV9wbG90ID0gc3VtbWFyeS5wYWlyLnRyYWRpbmdbc3VtbWFyeS5wYWlyLnRyYWRpbmckc3ByZWFkID09ICJhdi5yYXRpbyIsXSwgIyBkYXRhc2V0IChkYXRhLmZyYW1lKSB3aXRoIGNhbGN1bGF0aW9ucw0KICAgICAgICAgICAgICBjb2xfdmxhYmVscyA9ICJ2b2xhdC5zZCIsICMgY29sdW1uIG5hbWUgd2l0aCB0aGUgbGFiZWxzIGZvciBhIHZlcnRpY2FsIGF4aXMgKHN0cmluZykNCiAgICAgICAgICAgICAgY29sX2hsYWJlbHMgPSAibSIsICMgY29sdW1uIG5hbWUgd2l0aCB0aGUgbGFiZWxzIGZvciBhIGhvcml6b250YWwgYXhpcyAoc3RyaW5nKQ0KICAgICAgICAgICAgICBjb2xfdmFyaWFibGUgPSAibmV0LlNSIiwgIyBjb2x1bW4gbmFtZSB3aXRoIHRoZSB2YXJpYWJsZSB0byBzaG93IChzdHJpbmcpDQogICAgICAgICAgICAgIG1haW4gPSBwYXN0ZShzZWxlY3RlZF9xdWFydGVyLCAiU2Vuc2l0aXZpdHkgYW5hbHlzaXMgZm9yIHBhaXIgdHJhZGluZyAtIHNwcmVhZCBiYXNlZCBvbiBwcmljZXMgcmF0aW8iLCBzZXAgPSAiOiAiKSwNCiAgICAgICAgICAgICAgbGFiZWxfc2l6ZSA9IDMpDQogIA0KICBoZWF0bWFwX3NyMiA8LSBwbG90SGVhdG1hcChkYXRhX3Bsb3QgPSBzdW1tYXJ5LnBhaXIudHJhZGluZ1tzdW1tYXJ5LnBhaXIudHJhZGluZyRzcHJlYWQgPT0gInNkcy5yYXRpbyIsXSwgIyBkYXRhc2V0IChkYXRhLmZyYW1lKSB3aXRoIGNhbGN1bGF0aW9ucw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbF92bGFiZWxzID0gInZvbGF0LnNkIiwgIyBjb2x1bW4gbmFtZSB3aXRoIHRoZSBsYWJlbHMgZm9yIGEgdmVydGljYWwgYXhpcyAoc3RyaW5nKQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbF9obGFiZWxzID0gIm0iLCAjIGNvbHVtbiBuYW1lIHdpdGggdGhlIGxhYmVscyBmb3IgYSBob3Jpem9udGFsIGF4aXMgKHN0cmluZykNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xfdmFyaWFibGUgPSAibmV0LlNSIiwgIyBjb2x1bW4gbmFtZSB3aXRoIHRoZSB2YXJpYWJsZSB0byBzaG93IChzdHJpbmcpDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFpbiA9IHBhc3RlKHNlbGVjdGVkX3F1YXJ0ZXIsICJTZW5zaXRpdml0eSBhbmFseXNpcyBmb3IgcGFpciB0cmFkaW5nIC0gc3ByZWFkIGJhc2VkIG9uIHJldHVybnMgcmF0aW8iLCBzZXAgPSAiOiAiKSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbF9zaXplID0gMykNCiAgDQogIHNlbnNpdGl2aXRpZXNbW3NlbGVjdGVkX3F1YXJ0ZXJdXSA8LSBzdW1tYXJ5LnBhaXIudHJhZGluZ1tzdW1tYXJ5LnBhaXIudHJhZGluZyRzcHJlYWQgPT0gImF2LnJhdGlvIixdDQogIHNlbnNpdGl2aXRpZXMyW1tzZWxlY3RlZF9xdWFydGVyXV0gPC0gc3VtbWFyeS5wYWlyLnRyYWRpbmdbc3VtbWFyeS5wYWlyLnRyYWRpbmckc3ByZWFkID09ICJzZHMucmF0aW8iLF0NCiAgcm0oc3VtbWFyeS5wYWlyLnRyYWRpbmcpDQogIA0KICBoZWF0bWFwX2xpc3RbW3NlbGVjdGVkX3F1YXJ0ZXJdXSA8LSBoZWF0bWFwX3NyDQogIGhlYXRtYXBfbGlzdDJbW3NlbGVjdGVkX3F1YXJ0ZXJdXSA8LSBoZWF0bWFwX3NyMg0KfQ0KYGBgDQoNClRoZSByZXN1bHRzIHdlcmUgZGVwaWN0ZWQgdXNpbmcgaGVhdG1hcHMgY29udGFpbmluZyBTaGFycGUgcmF0aW9zLCBjb25zaWRlcmluZyB0aGUgcmV0dXJuIHBlciB1bml0IG9mIHZvbGF0aWxpdHkuIFRoZSBsYXJnZXN0IHZhbHVlIGluZGljYXRlZCB3aGljaCBwYXJhbWV0ZXIgY29tYmluYXRpb24gZ2VuZXJhdGVkIHRoZSBiZXN0IHBlcmZvcm1hbmNlIG9uIHRoZSBpbi1zYW1wbGUgZGF0YS4NCg0KVGhlIG9wdGltYWwgc3RyYXRlZ3kgd2FzIHZvbGF0aWxpdHkgYnJlYWtvdXQgdXNpbmcgbGV2ZWxzIHdoZXJlIHZvbGF0aWxpdHkgbWVtb3J5IHdhcyAxODAgZGF5cyBhbmQgdGhlIG11bHRpcGxpZXIgd2FzIDEuIFRoZSBQJkwgZ3JhcGhzIGFib3ZlIGRpc3BsYXkgdGhlIHBlcmZvcm1hbmNlIG9mIHRoaXMgcGFydGljdWxhciBzdHJhdGVneS4NCg0KSGVhdG1hcHMgc3VwcG9ydGluZyB0aGUgY2hvaWNlIG9mIHN0cmF0ZWd5IGFyZSBzaG93biBiZWxvdy4gUXVhcnRlcmx5IG91dHB1dHMsIGFzIHdlbGwgYXMgdGhlIG1lYW4gYWNyb3NzIHF1YXJ0ZXJzIGFyZSBzaG93bi4NCg0KIyMgVm9sYXRpbGl0eSBCcmVha291dCAtIExldmVscw0KVm9sYXRpbGl0eSBicmVha291dCB1c2luZyBwcmljZSBsZXZlbHMgZ2VuZXJhdGVkIHBvc2l0aXZlIFNoYXJwZSByYXRpb3MgYWNyb3NzIGFsbCBjb21iaW5hdGlvbnMuIFRoZSBiZXN0IHN0cmF0ZWd5IHdhcyBjaG9zZW4gaW4gdGhpcyBhcHByb2FjaDogMTgwIGRheXMgdm9sYXRpbGl0eSBtZW1vcnkgYW5kIGEgbXVsdGlwbGllciBvZiAxIHByb2R1Y2VkIGEgU2hhcnBlIHJhdGlvIG9mIDEuMTQuDQoNCmBgYHtyLCB3YXJuaW5nID0gRiwgbWVzc2FnZSA9IEZ9DQojIENvbWJpbmVkDQpmb3IgKG91dHB1dCBpbiBoZWF0bWFwX2xpc3QpIHsNCiAgcHJpbnQob3V0cHV0KQ0KfQ0KDQojIE1lYW4NCm5ldF9zcnMgPC0gbGlzdCgpDQoNCmZvcihpIGluIDE6bGVuZ3RoKHNlbnNpdGl2aXRpZXMpKSB7DQogIG5ldF9zcnNbW2ldXSA8LSBhcy5saXN0KHNlbnNpdGl2aXRpZXNbW2ldXVtjKCJuZXQuU1IiKV0pW1sxXV0NCn0NCg0KYXZlcmFnZV9uZXRfc3IgPC0gc2FwcGx5KHNlcV9hbG9uZyhuZXRfc3JzW1sxXV0pLCBmdW5jdGlvbihpKSB7DQogIG1lYW4oc2FwcGx5KG5ldF9zcnMsIGZ1bmN0aW9uKHgpIHhbW2ldXSkpDQp9KQ0KYXZlcmFnZV9uZXRfc3IgPC0gZGF0YS5mcmFtZShuZXQuU1IgPSBhdmVyYWdlX25ldF9zcikNCg0Kc2Vuc2l0aXZpdGllc19hdmVyYWdlIDwtIHNlbnNpdGl2aXRpZXNbWzFdXVtjKCJzcHJlYWQiLCAidm9sYXQuc2QiLCAibSIpXQ0Kc2Vuc2l0aXZpdGllc19hdmVyYWdlIDwtIGNiaW5kKHNlbnNpdGl2aXRpZXNfYXZlcmFnZSwgIm5ldC5TUiIgPSBhdmVyYWdlX25ldF9zcikNCg0KaGVhdG1hcF9zcl9tZWFuIDwtIHBsb3RIZWF0bWFwKGRhdGFfcGxvdCA9IHNlbnNpdGl2aXRpZXNfYXZlcmFnZSwgIyBkYXRhc2V0IChkYXRhLmZyYW1lKSB3aXRoIGNhbGN1bGF0aW9ucw0KICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xfdmxhYmVscyA9ICJ2b2xhdC5zZCIsICMgY29sdW1uIG5hbWUgd2l0aCB0aGUgbGFiZWxzIGZvciBhIHZlcnRpY2FsIGF4aXMgKHN0cmluZykNCiAgICAgICAgICAgICAgICAgICAgICAgICAgY29sX2hsYWJlbHMgPSAibSIsICMgY29sdW1uIG5hbWUgd2l0aCB0aGUgbGFiZWxzIGZvciBhIGhvcml6b250YWwgYXhpcyAoc3RyaW5nKQ0KICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xfdmFyaWFibGUgPSAibmV0LlNSIiwgIyBjb2x1bW4gbmFtZSB3aXRoIHRoZSB2YXJpYWJsZSB0byBzaG93IChzdHJpbmcpDQogICAgICAgICAgICAgICAgICAgICAgICAgIG1haW4gPSBwYXN0ZSgiTWVhbiIsICJTZW5zaXRpdml0eSBhbmFseXNpcyBmb3IgcGFpciB0cmFkaW5nIC0gc3ByZWFkIGJhc2VkIG9uIHByaWNlcyByYXRpbyIsIHNlcCA9ICI6ICIpLA0KICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbF9zaXplID0gMykNCg0KaGVhdG1hcF9zcl9tZWFuDQpgYGANCg0KIyMgVm9sYXRpbGl0eSBCcmVha291dCAtIFJldHVybnMNClZvbGF0aWxpdHkgYnJlYWtvdXQgdXNpbmcgcmV0dXJucyB5aWVsZGVkIHdvcnNlIFNoYXJwZSByYXRpb3MsIHBhcnRpY3VsYXJseSBhdCBsb3cgbGV2ZWxzIG9mIHRoZSBtdWx0aXBsaWVyLg0KDQpgYGB7ciwgd2FybmluZyA9IEYsIG1lc3NhZ2UgPSBGfQ0KIyBDb21iaW5lZA0KZm9yIChvdXRwdXQgaW4gaGVhdG1hcF9saXN0Mikgew0KICBwcmludChvdXRwdXQpDQp9DQoNCiMgTWVhbg0KbmV0X3NyczIgPC0gbGlzdCgpDQoNCmZvcihpIGluIDE6bGVuZ3RoKHNlbnNpdGl2aXRpZXMyKSkgew0KICBuZXRfc3JzMltbaV1dIDwtIGFzLmxpc3Qoc2Vuc2l0aXZpdGllczJbW2ldXVtjKCJuZXQuU1IiKV0pW1sxXV0NCn0NCg0KYXZlcmFnZV9uZXRfc3IyIDwtIHNhcHBseShzZXFfYWxvbmcobmV0X3NyczJbWzFdXSksIGZ1bmN0aW9uKGkpIHsNCiAgbWVhbihzYXBwbHkobmV0X3NyczIsIGZ1bmN0aW9uKHgpIHhbW2ldXSkpDQp9KQ0KYXZlcmFnZV9uZXRfc3IyIDwtIGRhdGEuZnJhbWUobmV0LlNSID0gYXZlcmFnZV9uZXRfc3IyKQ0KDQpzZW5zaXRpdml0aWVzX2F2ZXJhZ2UyIDwtIHNlbnNpdGl2aXRpZXMyW1sxXV1bYygic3ByZWFkIiwgInZvbGF0LnNkIiwgIm0iKV0NCnNlbnNpdGl2aXRpZXNfYXZlcmFnZTIgPC0gY2JpbmQoc2Vuc2l0aXZpdGllc19hdmVyYWdlMiwgIm5ldC5TUiIgPSBhdmVyYWdlX25ldF9zcjIpDQoNCmhlYXRtYXBfc3JfbWVhbjIgPC0gcGxvdEhlYXRtYXAoZGF0YV9wbG90ID0gc2Vuc2l0aXZpdGllc19hdmVyYWdlMiwgIyBkYXRhc2V0IChkYXRhLmZyYW1lKSB3aXRoIGNhbGN1bGF0aW9ucw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbF92bGFiZWxzID0gInZvbGF0LnNkIiwgIyBjb2x1bW4gbmFtZSB3aXRoIHRoZSBsYWJlbHMgZm9yIGEgdmVydGljYWwgYXhpcyAoc3RyaW5nKQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbF9obGFiZWxzID0gIm0iLCAjIGNvbHVtbiBuYW1lIHdpdGggdGhlIGxhYmVscyBmb3IgYSBob3Jpem9udGFsIGF4aXMgKHN0cmluZykNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xfdmFyaWFibGUgPSAibmV0LlNSIiwgIyBjb2x1bW4gbmFtZSB3aXRoIHRoZSB2YXJpYWJsZSB0byBzaG93IChzdHJpbmcpDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFpbiA9IHBhc3RlKCJNZWFuIiwgIlNlbnNpdGl2aXR5IGFuYWx5c2lzIGZvciBwYWlyIHRyYWRpbmcgLSBzcHJlYWQgYmFzZWQgb24gcmV0dXJucyByYXRpbyIsIHNlcCA9ICI6ICIpLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsX3NpemUgPSAzKQ0KDQpoZWF0bWFwX3NyX21lYW4yDQpgYGANCg0KIyBDb25jbHVzaW9uDQoNCiMjIEdyb3VwIDENClRoZSBiZXN0IHN0cmF0ZWd5IGZvciBncm91cCAxIHdhcyBjcm9zc292ZXIgRU1BIG1vbWVudHVtIHdpdGggYSBmYXN0IEVNQSBvZiA2MCBkYXlzIGFuZCBzbG93IEVNQSBvZiA3MCBkYXlzLiBUaGVyZSB3ZXJlIHF1YXJ0ZXJzIGluIHdoaWNoIG1vc3QgY29tYmluYXRpb25zIChldmVuIHRob3NlIGNvbnRhaW5pbmcgZmV3ZXIgZGF5cykgZ2VuZXJhdGVkIHBvc2l0aXZlIFNoYXJwZSByYXRpb3MuIFRoaXMgd2FzIGluIGxpbmUgd2l0aCBjb250aW51aW5nIGJ1bGwgbWFya2V0cyB0aHJvdWdob3V0IHN1Y2ggcGVyaW9kcy4gSW4gZ2VuZXJhbCwgc2hvcnRlciBFTUEgcGVyaW9kcyAocGFydGljdWxhcmx5IDEwIGRheXMpIG9mdGVuIHlpZWxkZWQgbmVnYXRpdmUgU2hhcnBlIHJhdGlvcywgYXMgdGhlIG1hcmtldCB0ZW5kZWQgdG8gcmV2ZXJ0IGFmdGVyIHN1Y2ggc2hvcnQgYnVsbGlzaCBzaWduYWxzLiBBIGxvbmdlci10ZXJtIHZpZXcgaXMgYmVuZWZpY2lhbCB3aXRoIHRoZSBTJlA1MDAsIGFzIHN1cHBvcnRlZCBieSB0aGUgc3RyYXRlZ3kgb2YgY2hvaWNlOiBhIGxvbmctdGVybSBzaWduYWwgcmVsYXRpdmUgdG8gYW4gZXZlbiBsb25nZXIgdGltZSBob3Jpem9uIGluZGljYXRlZCB0aGVyZSB3YXMgYSBzdXN0YWluZWQgdHJhZGluZyBvcHBvcnR1bml0eSAtIGFib3V0ICoqMC45NSoqIFNoYXJwZSByYXRpbyBvbiBhdmVyYWdlIGFjcm9zcyBhbGwgcXVhcnRlcnMuIFRoZSBzaW5nbGUgRU1BIGVudHJ5IGFuZCBleGl0IGFwcHJvYWNoIHBlcmZvcm1lZCB3b3JzZSwgYXMgaXQgd2FzIGZhbHNlbHkgaWRlbnRpZnlpbmcgYnVsbC9iZWFyIG1hcmtldHMgYmFzZWQgb24gcHJpY2UgY2hhbmdlcyByZWxhdGl2ZSB0byBvbmUgRU1BLiBNZWFuIHJldmVyc2lvbiBhbHNvIHBlcmZvcm1lZCB3b3JzZSBmb3IgYWxsIHZhcmlhbnRzLg0KDQpgYGB7ciwgd2FybmluZyA9IEYsIG1lc3NhZ2UgPSBGfQ0KcXVhcnRlcl9zdGF0cy5hbGwuZ3JvdXAxDQpgYGANCg0KQ3VtdWxhdGl2ZSBuZXQgUCZMIGFtb3VudGVkIHRvICoqJDI1LDU1NCoqIGFuZCBjdW11bGF0aXZlIHN1bW1hcnkgc3RhdGlzdGljIHdhcyAqKjY2LjQqKiB1c2luZyBpbi1zYW1wbGUgZGF0YS4NCg0KIyMgR3JvdXAgMg0KVGhlIG9wdGltYWwgc3RyYXRlZ3kgZm9yIGdyb3VwIDIgd2FzIHZvbGF0aWxpdHkgYnJlYWtvdXQgdXNpbmcgbGV2ZWxzIHdpdGggMTgwIGRheXMgb2Ygdm9sYXRpbGl0eSBtZW1vcnkgYW5kIGEgbXVsdGlwbGllciBvZiAxLiBBbGwgY29tYmluYXRpb25zIHdlcmUgZ2VuZXJhbGx5IHByb2ZpdGFibGUsIGluZGljYXRpbmcgZ29pbmcgYWdhaW5zdCBhbiBpbmNyZWFzaW5nIHNwcmVhZCBiZXR3ZWVuIGdvbGQgYW5kIHNpbHZlciBpcyBhIGdvb2Qgc3RyYXRlZ3kuIFRoZXJlIHdlcmUsIGhvd2V2ZXIsIHNvbWUgcXVhcnRlcnMgd2hlcmUgdGhpcyB3YXMgbm90IHRydWUgYW5kIHRoZSBkaXZlcmdlbmNlIGNvbnRpbnVlZC4gVGhlIGNvbWJpbmF0aW9uIHRoYXQgY29uc2lzdGVudGx5IGRlbGl2ZXJlZCB0aGUgYmVzdCByZXN1bHRzIGdlbmVyYXRlZCBhIFNoYXJwZSByYXRpbyBvZiAqKjEuMTQqKi4gSXQgaW5kaWNhdGVkIGl0IHdhcyB3b3J0aCB0YWtpbmcgYSBsb25nZXIgdmlldyBvZiB2b2xhdGlsaXR5IGFuZCBhIGxvd2VyIG11bHRpcGxpZXIsIG1lYW5pbmcgd2hlbmV2ZXIgdGhlIHNpZ25hbCBtb3ZlZCByZWxhdGl2ZWx5IGxpdHRsZSBvdXRzaWRlIHRoZSBsb25nLXRlcm0gYm91bmRzLCBhIHRyYWRpbmcgb3Bwb3J0dW5pdHkgd2FzIHdvcnRod2hpbGUuIFRoZXJlIHdlcmUgYWxzbyBmZXdlciB0cmFkZXMgcGVyIGRheSAoaGVuY2UgbG93ZXIgdHJhZGluZyBjb3N0cykgd2l0aCB0aGUgc2VsZWN0ZWQgc3RyYXRlZ3kgaW4gZ3JvdXAgMi4gVGhlIHJldHVybi1iYXNlZCB2b2xhdGlsaXR5IGJyZWFrb3V0IGVudHJ5IGFuZCBleGl0IGFwcHJvYWNoIHBlcmZvcm1lZCB3b3JzZSwgYXMgaXQgd2FzIHVuYWJsZSB0byBpZGVudGlmeSBnZW51aW5lIG1vdmVzIGF3YXkgZnJvbSBnb2xkIGFuZCBzaWx2ZXIncyBtZWFuIHRvIHRyYWRlIGFnYWluc3QsIHBhcnRpY3VsYXJseSBhdCBsb3cgbXVsdGlwbGllciB2YWx1ZXMgd2hlbiB0aGUgYm91bmRzIHdlcmUgbW9yZSByZXN0cmljdGl2ZS4NCg0KYGBge3IsIHdhcm5pbmcgPSBGLCBtZXNzYWdlID0gRn0NCm9wdGlvbnMoZGlnaXRzPTIpDQpxdWFydGVyX3N0YXRzLmFsbC5ncm91cDINCmBgYA0KDQpDdW11bGF0aXZlIG5ldCBQJkwgYW1vdW50ZWQgdG8gKiokNCw3MDUsMzczKiogYW5kIGN1bXVsYXRpdmUgc3VtbWFyeSBzdGF0aXN0aWMgd2FzICoqMTY1LjgqKiB1c2luZyBpbi1zYW1wbGUgZGF0YS4NCg0KVGhlIHJlc3VsdHMgZm9yIHRoZSBiZXN0IG1vZGVscyBmb3IgZ3JvdXBzIDEgYW5kIDIgY2FuIGJlIHNhdmVkIGFzIGNzdiAtIHRoZSBmb2xsb3dpbmcgbGluZXMgbmVlZCB0byBiZSB1bmNvbW1lbnRlZC4NCg0KYGBge3IsIHdhcm5pbmcgPSBGLCBtZXNzYWdlID0gRn0NCiMgd3JpdGUuY3N2KHF1YXJ0ZXJfc3RhdHMuYWxsLmdyb3VwMSwgDQojICAgICAgICAgICAicXVhcnRlcl9zdGF0cy5hbGwuZ3JvdXAxLmNzdiIsDQojICAgICAgICAgICByb3cubmFtZXMgPSBGQUxTRSkxDQoNCiMgd3JpdGUuY3N2KHF1YXJ0ZXJfc3RhdHMuYWxsLmdyb3VwMiwgDQojICAgICAgICAgICAicXVhcnRlcl9zdGF0cy5hbGwuZ3JvdXAyLmNzdiIsDQojICAgICAgICAgICByb3cubmFtZXMgPSBGQUxTRSkNCmBgYA0KDQojIE91dC1vZi1TYW1wbGUNClRoZSBhZm9yZW1lbnRpb25lZCBvcHRpbWFsIHN0cmF0ZWdpZXMgd2VyZSBydW4gb24gb3V0LW9mLXNhbXBsZSBkYXRhLg0KDQojIyBHcm91cCAxDQoNCmBgYHtyLCB3YXJuaW5nID0gRiwgbWVzc2FnZSA9IEZ9DQpmb3IgKHNlbGVjdGVkX3F1YXJ0ZXIgaW4gT09TX3F1YXJ0ZXJzKSB7DQogIA0KICBtZXNzYWdlKHNlbGVjdGVkX3F1YXJ0ZXIpDQogIA0KICBmaWxlbmFtZV8gPC0gcGFzdGUwKCJkYXRhL2RhdGExXyIsIHNlbGVjdGVkX3F1YXJ0ZXIsICIuUkRhdGEiKQ0KICBsb2FkKGZpbGVuYW1lXykNCiAgDQogICMgY3JlYXRlIGluZGV4IG9mIHRpbWVzIGZvciB0aGlzIHF1YXJ0ZXINCiAgZGF0YS5ncm91cDEub29zIDwtIGdldChwYXN0ZTAoImRhdGExXyIsIHNlbGVjdGVkX3F1YXJ0ZXIpKQ0KICB0aW1lc18gPC0gc3Vic3RyKGluZGV4KGRhdGEuZ3JvdXAxLm9vcyksIDEyLCAxOSkNCiAgDQogICMgS2VlcCBTJlA1MDANCiAgZGF0YS5ncm91cDEub29zIDwtIGRhdGEuZ3JvdXAxLm9vc1ssICFjb2xuYW1lcyhkYXRhLmdyb3VwMS5vb3MpICVpbiUgYygiTlEiKV0NCiAgDQogICMgdGhlIGZvbGxvd2luZyBjb21tb24gYXNzdW1wdGlvbnMgd2VyZSBkZWZpbmVkOg0KICAjIDEuCWRvIG5vdCB1c2UgaW4gY2FsY3VsYXRpb25zIHRoZSBkYXRhIGZyb20gdGhlIGZpcnN0IA0KICAjIGFuZCBsYXN0IDEwIG1pbnV0ZXMgb2YgdGhlIHNlc3Npb24gKDk6MzEtLTk6NDAgYW5kIDE1OjUxLS0xNjowMCkNCiAgIyDigJMgcHV0IG1pc3NpbmcgdmFsdWVzIHRoZXJlLA0KICANCiAgIyBsZXRzIHB1dCBtaXNzaW5nIHZhbHVlcyBmb3IgdGhlc2UgcGVyaW9kcw0KICBkYXRhLmdyb3VwMS5vb3NbIlQwOTozMS9UMDk6NDAiLF0gPC0gTkEgDQogIGRhdGEuZ3JvdXAxLm9vc1siVDE1OjUxL1QxNjowMCIsXSA8LU5BDQogIA0KICBteVRoZW1lIDwtIGNoYXJ0X3RoZW1lKCkNCiAgbXlUaGVtZSRjb2wkbGluZS5jb2wgPC0gImRhcmtibHVlIg0KICBsYXlvdXQobWF0cml4KDE6MSwgMSwgMSkpDQogIHByaW50KGNoYXJ0X1NlcmllcyhkYXRhLmdyb3VwMS5vb3MkU1AsIHRoZW1lID0gbXlUaGVtZSkpDQogIGxheW91dChtYXRyaXgoMSkpDQoNCg0KICAjIE1vbWVudHVtDQogIA0KICAjIEVNQSBDcm9zc292ZXINCiAgDQogIEVNQV9wYWlycyA9IGxpc3QoYyg2MCwgNzApKQ0KICANCiAgZGF0YS5ncm91cDFiLm9vcyA8LSBkYXRhLmdyb3VwMS5vb3MNCiAgDQogICMgcGFpciA8LSBjKDYwLCA3MCkNCiAgZm9yIChwYWlyIGluIEVNQV9wYWlycykgew0KICAgICMgbGV0cyBjYWxjdWxhdGUgRU1BZmFzdCBhbmQgRU1Bc2xvdyBmb3IgU1ANCiAgICBkYXRhLmdyb3VwMWIub29zJFNQX0VNQWZhc3QgPC0gRU1BKG5hLmxvY2YoZGF0YS5ncm91cDFiLm9vcyRTUCksIHBhaXJbMV0pDQogICAgZGF0YS5ncm91cDFiLm9vcyRTUF9FTUFzbG93IDwtIEVNQShuYS5sb2NmKGRhdGEuZ3JvdXAxYi5vb3MkU1ApLCBwYWlyWzJdKQ0KICAgIA0KICAgICMgcHV0IG1pc3NpbmcgdmFsdWUgd2hlbmV2ZXIgdGhlIG9yaWdpbmFsIHByaWNlIGlzIG1pc3NpbmcNCiAgICBkYXRhLmdyb3VwMWIub29zJFNQX0VNQWZhc3RbaXMubmEoZGF0YS5ncm91cDFiLm9vcyRTUCldIDwtIE5BDQogICAgZGF0YS5ncm91cDFiLm9vcyRTUF9FTUFzbG93W2lzLm5hKGRhdGEuZ3JvdXAxYi5vb3MkU1ApXSA8LSBOQQ0KICAgIA0KICAgICMgbGV0cyBjYWxjdWxhdGUgdGhlIHBvc2l0aW9uIGZvciB0aGUgTU9NRU5UVU0gc3RyYXRlZ3kNCiAgICAjIGlmIGZhc3QgTUEodC0xKSA+IHNsb3cgTUEodC0xKSA9PiBwb3ModCkgPSAxIFtsb25nXQ0KICAgICMgaWYgZmFzdCBNQSh0LTEpIDw9IHNsb3cgTUEodC0xKSA9PiBwb3ModCkgPSAtMSBbc2hvcnRdDQogICAgIyB0aGlzIHN0cmF0ZWd5IGlzIGFsd2F5cyBpbiB0aGUgbWFya2V0DQogICAgZGF0YS5ncm91cDFiLm9vcyRwb3NpdGlvblNQLm1vbSA8LSBpZmVsc2UobGFnLnh0cyhkYXRhLmdyb3VwMWIub29zJFNQX0VNQWZhc3QpID4NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFnLnh0cyhkYXRhLmdyb3VwMWIub29zJFNQX0VNQXNsb3cpLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMSwgLTEpDQogICAgDQogICAgIyBsZXRzIGFwcGx5IHRoZSByZW1haW5pbmcgYXNzdW1wdGlvbnMNCiAgICAjIC0gZXhpdCBhbGwgcG9zaXRpb25zIDIwIG1pbnV0ZXMgYmVmb3JlIHRoZSBzZXNzaW9uIGVuZCwgaS5lLiBhdCAxNTo0MA0KICAgICMgLSBkbyBub3QgdHJhZGUgd2l0aGluIHRoZSBmaXJzdCAyNSBtaW51dGVzIG9mIHN0b2NrcyBxdW90YXRpb25zICh1bnRpbCA5OjU1KQ0KICAgIGRhdGEuZ3JvdXAxYi5vb3MkcG9zaXRpb25TUC5tb21bdGltZXModGltZXNfKSA8PSB0aW1lcygiMDk6NTU6MDAiKSB8IA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVzKHRpbWVzXykgPiB0aW1lcygiMTU6NDA6MDAiKV0gPC0gMA0KICAgIA0KICAgIA0KICAgICMgbGV0cyBhbHNvIGZpbGwgZXZlcnkgbWlzc2luZyBwb3NpdGlvbiB3aXRoIHRoZSBwcmV2aW91cyBvbmUNCiAgICANCiAgICBkYXRhLmdyb3VwMWIub29zJHBvc2l0aW9uU1AubW9tIDwtIG5hLmxvY2YoZGF0YS5ncm91cDFiLm9vcyRwb3NpdGlvblNQLm1vbSwgbmEucm0gPSBGQUxTRSkNCiAgICANCiAgICAjIGNhbGN1bGF0aW5nIGdyb3NzIHBubA0KICAgIA0KICAgIGRhdGEuZ3JvdXAxYi5vb3MkcG5sX2dyb3NzU1AubW9tIDwtIGRhdGEuZ3JvdXAxYi5vb3MkcG9zaXRpb25TUC5tb20gKiBkaWZmLnh0cyhkYXRhLmdyb3VwMWIub29zJFNQKSAqIDUwDQogICAgDQogICAgDQogICAgIyBudW1iZXIgb2YgdHJhbnNhY3Rpb25zDQogICAgZGF0YS5ncm91cDFiLm9vcyRudHJhbnNTUC5tb20gPC0gYWJzKGRpZmYueHRzKGRhdGEuZ3JvdXAxYi5vb3MkcG9zaXRpb25TUC5tb20pKQ0KICAgIA0KICAgIGRhdGEuZ3JvdXAxYi5vb3MkbnRyYW5zU1AubW9tWzFdIDwtIDANCiAgICANCiAgICAjIG5ldCBwbmwNCiAgICBkYXRhLmdyb3VwMWIub29zJHBubF9uZXRTUC5tb20gPC0gZGF0YS5ncm91cDFiLm9vcyRwbmxfZ3Jvc3NTUC5tb20gIC0NCiAgICAgIGRhdGEuZ3JvdXAxYi5vb3MkbnRyYW5zU1AubW9tICogMTAgIyAkMTAgcGVyIHRyYW5zYWN0aW9uDQogICAgDQogICAgIyB0b3RhbCBmb3Igc3RyYXRlZ3kNCiAgICANCiAgICBkYXRhLmdyb3VwMWIub29zJHBubF9ncm9zcy5tb20gPC0gZGF0YS5ncm91cDFiLm9vcyRwbmxfZ3Jvc3NTUC5tb20NCiAgICBkYXRhLmdyb3VwMWIub29zJHBubF9uZXQubW9tIDwtIGRhdGEuZ3JvdXAxYi5vb3MkcG5sX25ldFNQLm1vbQ0KICAgIA0KICAgIA0KICAgICMgYWdncmVnYXRlIHBubHMgYW5kIG51bWJlciBvZiB0cmFuc2FjdGlvbnMgdG8gZGFpbHkNCiAgICBteS5lbmRwb2ludHMgPC0gZW5kcG9pbnRzKGRhdGEuZ3JvdXAxYi5vb3MsICJkYXlzIikNCiAgICANCiAgICBkYXRhLmdyb3VwMWIub29zLmRhaWx5IDwtIHBlcmlvZC5hcHBseShkYXRhLmdyb3VwMWIub29zWyxjKGdyZXAoInBubCIsIG5hbWVzKGRhdGEuZ3JvdXAxYi5vb3MpKSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncmVwKCJudHJhbnMiLCBuYW1lcyhkYXRhLmdyb3VwMWIub29zKSkpXSwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIElOREVYID0gbXkuZW5kcG9pbnRzLCANCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEZVTiA9IGZ1bmN0aW9uKHgpIGNvbFN1bXMoeCwgbmEucm0gPSBUUlVFKSkNCiAgICANCiAgICAjIHN1bW1hcml6ZSB0aGUgc3RyYXRlZ3kgZm9yIHRoaXMgcXVhcnRlcg0KICAgIA0KICAgICMgU1INCiAgICBncm9zc1NSID0gbXlTUih4ID0gZGF0YS5ncm91cDFiLm9vcy5kYWlseSRwbmxfZ3Jvc3MubW9tLCBzY2FsZSA9IDI1MikNCiAgICBuZXRTUiA9IG15U1IoeCA9IGRhdGEuZ3JvdXAxYi5vb3MuZGFpbHkkcG5sX25ldC5tb20sIHNjYWxlID0gMjUyKQ0KICAgICMgQ1INCiAgICBncm9zc0NSID0gbXlDYWxtYXJSYXRpbyh4ID0gZGF0YS5ncm91cDFiLm9vcy5kYWlseSRwbmxfZ3Jvc3MubW9tLCBzY2FsZSA9IDI1MikNCiAgICBuZXRDUiA9IG15Q2FsbWFyUmF0aW8oeCA9IGRhdGEuZ3JvdXAxYi5vb3MuZGFpbHkkcG5sX25ldC5tb20sIHNjYWxlID0gMjUyKQ0KICAgIA0KICAgICMgYXZlcmFnZSBudW1iZXIgb2YgdHJhbnNhY3Rpb25zDQogICAgYXYuZGFpbHkubnRyYWRlcyA9IG1lYW4oZGF0YS5ncm91cDFiLm9vcy5kYWlseSRudHJhbnNTUC5tb20sIG5hLnJtID0gVFJVRSkNCiAgICAjIFBuTA0KICAgIGdyb3NzUG5MID0gc3VtKGRhdGEuZ3JvdXAxYi5vb3MuZGFpbHkkcG5sX2dyb3NzLm1vbSkNCiAgICBuZXRQbkwgPSBzdW0oZGF0YS5ncm91cDFiLm9vcy5kYWlseSRwbmxfbmV0Lm1vbSkNCiAgICAjIHN0YXQNCiAgICBzdGF0ID0gbmV0Q1IgKiBtYXgoMCwgbG9nKGFicyhuZXRQbkwvMTAwMCkpKQ0KICAgIA0KICAgICMgY29sbGVjdGluZyBhbGwgc3RhdGlzdGljcyBmb3IgYSBwYXJ0aWN1bGFyIHF1YXJ0ZXINCiAgICBpZihwYWlyWzFdID09IDYwICYgcGFpclsyXSA9PSA3MCkgew0KICAgICAgcXVhcnRlcl9zdGF0cyA8LSBkYXRhLmZyYW1lKHF1YXJ0ZXIgPSBzZWxlY3RlZF9xdWFydGVyLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2V0cy5ncm91cCA9IDEsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3Jvc3MuU1IgPSBncm9zc1NSLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ldC5TUiA9IG5ldFNSLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyb3NzLkNSID0gZ3Jvc3NDUiwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXQuQ1IgPSBuZXRDUiwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm9zcy5QbkwgPSBncm9zc1BuTCwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXQuUG5MID0gbmV0UG5MLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF2LmRhaWx5Lm50cmFucyA9IGF2LmRhaWx5Lm50cmFkZXMsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdCwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJpbmdzQXNGYWN0b3JzID0gRkFMU0UNCiAgICAgICkNCiAgICAgIA0KICAgICAgIyBjb2xsZWN0IHN1bW1hcmllcyBmb3IgYWxsIHF1YXJ0ZXJzDQogICAgICBpZighZXhpc3RzKCJxdWFydGVyX3N0YXRzLmFsbC5ncm91cDEub29zIikpIHF1YXJ0ZXJfc3RhdHMuYWxsLmdyb3VwMS5vb3MgPC0gcXVhcnRlcl9zdGF0cyBlbHNlDQogICAgICAgIHF1YXJ0ZXJfc3RhdHMuYWxsLmdyb3VwMS5vb3MgPC0gcmJpbmQocXVhcnRlcl9zdGF0cy5hbGwuZ3JvdXAxLm9vcywgcXVhcnRlcl9zdGF0cykNCiAgICAgIA0KICAgICAgIyBjcmVhdGUgYSBwbG90IG9mIGdyb3MgYW5kIG5ldCBwbmwgYW5kIHNhdmUgaXQgdG8gcG5nIGZpbGUNCiAgICAgIHByaW50KCAjIHdoZW4gcGxvdHRpbmcgaW4gYSBsb29wIHlvdSBoYXZlIHRvIHVzZSBwcmludCgpDQogICAgICAgIHBsb3QoY2JpbmQoY3Vtc3VtKGRhdGEuZ3JvdXAxYi5vb3MuZGFpbHkkcG5sX2dyb3NzLm1vbSksDQogICAgICAgICAgICAgICAgICAgY3Vtc3VtKGRhdGEuZ3JvdXAxYi5vb3MuZGFpbHkkcG5sX25ldC5tb20pKSwNCiAgICAgICAgICAgICBtdWx0aS5wYW5lbCA9IEZBTFNFLA0KICAgICAgICAgICAgIG1haW4gPSBwYXN0ZTAoIkdyb3NzIGFuZCBuZXQgUG5MIGZvciBhc3NldCBncm91cCAxIFxuIHF1YXJ0ZXIgIiwgc2VsZWN0ZWRfcXVhcnRlciksIA0KICAgICAgICAgICAgIGNvbCA9IGMoIiMzNzdFQjgiLCAiI0U0MUExQyIpLA0KICAgICAgICAgICAgIG1ham9yLnRpY2tzID0gIndlZWtzIiwgDQogICAgICAgICAgICAgZ3JpZC50aWNrcy5vbiA9ICJ3ZWVrcyIsDQogICAgICAgICAgICAgZ3JpZC50aWNrcy5sdHkgPSAzLA0KICAgICAgICAgICAgIGxlZ2VuZC5sb2MgPSAidG9wbGVmdCIsDQogICAgICAgICAgICAgY2V4ID0gMC4zKQ0KICAgICAgKQ0KDQogICAgICAjIHJlbW92ZSBhbGwgdW5uZWVkZWQgb2JqZWN0cyBmb3IgZ3JvdXAgMQ0KICAgICAgcm0ocG5sLmdyb3NzLmQsIHBubC5uZXQuZCwgcXVhcnRlcl9zdGF0cykNCiAgICAgIA0KICAgICAgZ2MoKQ0KICAgIH0NCiAgICANCiAgICAjIHN1bW1hcnkgb2YgYSBwYXJ0aWN1bGFyIHN0cmF0ZWd5DQogICAgc3VtbWFyeV8gPC0gZGF0YS5mcmFtZShFTUEuZmFzdCA9IHBhaXJbMV0sDQogICAgICAgICAgICAgICAgICAgICAgICAgICBFTUEuc2xvdyA9IHBhaXJbMl0sDQogICAgICAgICAgICAgICAgICAgICAgICAgICBwZXJpb2QgPSBzZWxlY3RlZF9xdWFydGVyLCAjICIyMDE2LTA4LTE2IC0gMjAxNi0xMSIsDQogICAgICAgICAgICAgICAgICAgICAgICAgICBncm9zcy5TUiA9IGdyb3NzU1IsDQogICAgICAgICAgICAgICAgICAgICAgICAgICBuZXQuU1IgPSBuZXRTUiwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyb3NzLlBuTCA9IGdyb3NzUG5MLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV0LlBuTCA9IG5ldFBuTCwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgIGF2LmRhaWx5Lm50cmFucyA9IGF2LmRhaWx5Lm50cmFkZXMsDQogICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJpbmdzQXNGYWN0b3JzID0gRkFMU0UpDQogICAgDQogICAgIyBwdXR0aW5nIGFsbCBzdW1tYXJpZXMgdG9nZXRoZXINCiAgICANCiAgICBpZighZXhpc3RzKCJzdW1tYXJ5LnBhaXIudHJhZGluZyIpKSBzdW1tYXJ5LnBhaXIudHJhZGluZyA8LSBzdW1tYXJ5XyBlbHNlDQogICAgICBzdW1tYXJ5LnBhaXIudHJhZGluZyA8LSByYmluZChzdW1tYXJ5LnBhaXIudHJhZGluZywgc3VtbWFyeV8pDQogICAgDQogICAgIyBkZWxldGluZyB3b3JraW5nIGZpbGVzIG5vdCBuZWVkZWQgYW55IG1vcmUNCiAgICBybShncm9zc1NSLCBuZXRTUiwgbmV0Q1IsDQogICAgICAgZ3Jvc3NQbkwsIG5ldFBuTCwNCiAgICAgICBhdi5kYWlseS5udHJhZGVzLCBzdGF0LA0KICAgICAgIHN1bW1hcnlfKQ0KICB9DQogIA0KICBybShzdW1tYXJ5LnBhaXIudHJhZGluZykNCn0NCmBgYA0KDQojIyBHcm91cCAyDQoNCmBgYHtyLCB3YXJuaW5nID0gRiwgbWVzc2FnZSA9IEZ9DQpmb3IgKHNlbGVjdGVkX3F1YXJ0ZXIgaW4gT09TX3F1YXJ0ZXJzKSB7DQogIA0KICBtZXNzYWdlKHNlbGVjdGVkX3F1YXJ0ZXIpDQogIA0KICBmaWxlbmFtZV8gPC0gcGFzdGUwKCJkYXRhL2RhdGEyXyIsIHNlbGVjdGVkX3F1YXJ0ZXIsICIuUkRhdGEiKQ0KICBsb2FkKGZpbGVuYW1lXykNCiAgDQogIGRhdGEuZ3JvdXAyLm9vcyA8LSBnZXQocGFzdGUwKCJkYXRhMl8iLCBzZWxlY3RlZF9xdWFydGVyKSkNCiAgdGltZXNfIDwtIHN1YnN0cihpbmRleChkYXRhLmdyb3VwMi5vb3MpLCAxMiwgMTkpDQogIA0KICAjIEtlZXAgZ29sZCBhbmQgc2lsdmVyDQogIGRhdGEuZ3JvdXAyLm9vcyA8LSBkYXRhLmdyb3VwMi5vb3NbLCAhY29sbmFtZXMoZGF0YS5ncm91cDIub29zKSAlaW4lIGMoIkFVRCIsIkNBRCIpXQ0KICBuYW1lcyhkYXRhLmdyb3VwMi5vb3MpWzE6Ml0gPC0gYygiWEFHLmNsb3NlIiwiWEFVLmNsb3NlIikNCiAgDQogIGRhdGEuZ3JvdXAyLm9vcyA8LSBkYXRhLmdyb3VwMi5vb3NbLCBjKCJYQUcuY2xvc2UiLCAiWEFVLmNsb3NlIildDQogIA0KICBteVRoZW1lIDwtIGNoYXJ0X3RoZW1lKCkNCiAgbXlUaGVtZSRjb2wkbGluZS5jb2wgPC0gImRhcmtibHVlIg0KDQogICMgdGhlIGZvbGxvd2luZyBjb21tb24gYXNzdW1wdGlvbnMgd2VyZSBkZWZpbmVkOg0KICAjIDEuCWRvIG5vdCB1c2UgaW4gY2FsY3VsYXRpb25zIHRoZSBkYXRhIGZyb20gdGhlIGZpcnN0IGFuZCBsYXN0IDEwIG1pbnV0ZXMgb2YgdGhlIHNlc3Npb24gKDE4OjAxLS0xODoxMCBhbmQgMTY6NTEtLTE3OjAwKSDigJMgcHV0IG1pc3NpbmcgdmFsdWVzIHRoZXJlLA0KICANCiAgIyBsZXRzIHB1dCBtaXNzaW5nIHZhbHVlcyBmb3IgdGhlc2UgcGVyaW9kcw0KICBkYXRhLmdyb3VwMi5vb3NbIlQxODowMS9UMTg6MTAiLF0gPC0gTkEgDQogIGRhdGEuZ3JvdXAyLm9vc1siVDE2OjUxL1QxNzowMCIsXSA8LSBOQQ0KICANCiAgbGF5b3V0KG1hdHJpeCgxOjIsIDIsIDEpKQ0KICBwcmludChjaGFydF9TZXJpZXMoZGF0YS5ncm91cDIub29zJFhBRy5jbG9zZSwgdGhlbWUgPSBteVRoZW1lKSkNCiAgcHJpbnQoY2hhcnRfU2VyaWVzKGRhdGEuZ3JvdXAyLm9vcyRYQVUuY2xvc2UsIHRoZW1lID0gbXlUaGVtZSkpDQogIGxheW91dChtYXRyaXgoMSkpDQogIA0KICAjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjDQogICMgZm9ybXVsYXRlIGEgc3ByZWFkOiBQMSAtIG0gKiBQMiAoUF9YQVUgLSBtICogUF9YQUcpIA0KICAjIHdoZXJlIG0gPSBtMS9tMiBpcyBiYXNlZCBvbiBhdmVyYWdlIHJhdGlvIGJldHdlZW4gdGhlIHByaWNlcw0KICAjIG9uIHRoZSBQUkVWSU9VUyBkYXkNCiAgDQogICMgc3ByZWFkIGlzIGEgc2lnbmFsIHRvIG91ciBtb2RlbCwgd2hpY2ggc2hvd3Mgd2hldGhlciB0byB0YWtlIA0KICAjIHBvc2l0aW9uIG9yIG5vdCAodm9sYXRpbGl0eSBiYW5kcyBhcm91bmQgdGhlIHNwcmVhZCkNCiAgDQogICMgd2UgYXNzdW1lIHRoZSBtZWFuIHJldmVydGluZyBiZWhhdmlvciBvZiB0aGUgc3ByZWFkDQogIA0KICAjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIw0KICAjIGxldHMgY2FsY3VsYXRlIGF2ZXJhZ2UgcmF0aW8gb2YgcHJpY2VzIG9uIHRoZSBkYWlseSBiYXNpcw0KICANCiAgaW5kZXhfcG9zaXggPC0gaW5kZXgoZGF0YS5ncm91cDIub29zKQ0KICB0aW1lX2NvbXBvbmVudCA8LSBmb3JtYXQoaW5kZXhfcG9zaXgsIGZvcm1hdCA9ICIlSDolTTolUyIpDQogIHRhcmdldF90aW1lIDwtICIxNzowMDowMCINCiAgaW5kaWNlcyA8LSB3aGljaCh0aW1lX2NvbXBvbmVudCA9PSB0YXJnZXRfdGltZSkNCg0KICBjbWQuYXYucmF0aW8gPC0gcGVyaW9kLmFwcGx5KGRhdGEuZ3JvdXAyLm9vcywNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIElOREVYID0gaW5kaWNlcywNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uKHgpIG1lYW4oeCRYQVUuY2xvc2UveCRYQUcuY2xvc2UsIA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYS5ybSA9IFRSVUUpDQogICkNCiAgDQogIG5hbWVzKGNtZC5hdi5yYXRpbykgPC0gImF2LnJhdGlvIg0KICANCiAgIyBhYm91dCA2NC03NCBYQUcgdW5pdHMgcGVyIGVhY2ggdW5pdCBvZiBYQVUgKGZ1dHVyZSkNCiAgDQogICMgY2FsY3VsYXRpb25zIGJhc2VkIG9uIHRoZSBmaXJzdCBkYXkNCiAgIyB3aWxsIGJlIHVzZWQgb24gdGhlIHNlY29uZCBkYXksIGV0Yy4NCiAgIyBtb3ZlIHRoZSB0aW1lIGluZGV4IHRvIDE4OjAwIG9mIHRoZSBuZXh0IHRyYWRpbmcgZGF5IChzYW1lIGRheSkNCg0KICAjIHNvbWUgb2YgdGhlIGRhdGVzIG1pZ2h0IGJlIEZyaWRheXMgYW5kIGluIHRoaXMgY2FzZQ0KICAjIHdlIHdvdWxkIG1vdmUgdGhlIGluZGV4IHRvIDE4OjAwIG9uIFN1bmRheQ0KICAjIDYgPSBGcmlkYXkNCiAgIyB1c2UgaWZfZWxzZSgpIGZyb20gZHBseXIgaW5zdGVhZA0KDQogIGluZGV4KGNtZC5hdi5yYXRpbykgPC0gDQogICAgY2VpbGluZ19kYXRlKGluZGV4KGNtZC5hdi5yYXRpbyksICJkYXkiKSAtIA0KICAgIGhvdXJzKDYpICsgDQogICAgbWludXRlcygwKSArDQogICAgaWZfZWxzZSh3ZGF5KGluZGV4KGNtZC5hdi5yYXRpbykpID09IDYsIA0KICAgICAgICAgICAgZGF5cygyKSwNCiAgICAgICAgICAgIGRheXMoMCkpICANCiAgDQogICMgbWVyZ2Ugb3VyIGJhc2ljIDUgbWluIGRhdGEgd2l0aCBkYWlseSBjYWxjdWxhdGlvbnMNCiAgDQogIGRhdGEuZ3JvdXAyYi5vb3MgPC0gbWVyZ2UoZGF0YS5ncm91cDIub29zLA0KICAgICAgICAgICAgICAgICAgICBjbWQuYXYucmF0aW8pDQogIA0KICAjIG1pc3NpbmdzIGluIGEgdGhlIGxhc3QgMiBjb2x1bW5zDQogICMgd2hpY2ggc2hvdWxkIGJlIGZpbGxlZCB3aXRoIHRoZSBsYXN0IG5vbi1taXNzaW5nIHZhbHVlDQogICMgKGxhc3QgbXVsdGlwbGllciBpcyB1c2VkIHVudGlsIHRoZXJlIGlzIGEgbmV3IG9uZSkNCiAgDQogIGRhdGEuZ3JvdXAyYi5vb3MkYXYucmF0aW8gPC0gbmEubG9jZihkYXRhLmdyb3VwMmIub29zJGF2LnJhdGlvLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hLnJtID0gRkFMU0UpDQoNCiAgIyBleGNsdWRlIHdlZWtlbmRzIGZyb20gZGF0YQ0KICANCiAgdGFibGUod2RheShkYXRhLmdyb3VwMmIub29zKSkNCiAgDQogICMgdGhlcmUgYXJlIG5vIHJvd3Mgd2l0aCA3IChTYXR1cmRheSkNCiAgDQogICMgY2FsY3VsYXRlIHRoZSBzcHJlYWQgKGluIDIgdmFyaWFudHMpDQogIGRhdGEuZ3JvdXAyYi5vb3Mkc3ByZWFkX2F2cmF0aW8gPC0gDQogICAgZGF0YS5ncm91cDJiLm9vcyRYQVUuY2xvc2UgLQ0KICAgIGRhdGEuZ3JvdXAyYi5vb3MkYXYucmF0aW8gKiBkYXRhLmdyb3VwMmIub29zJFhBRy5jbG9zZQ0KICANCiAgIyBhc3N1bWUgd2UgZG8gbm90IHRyYWRlIHdpdGhpbiB0aGUgZmlyc3QgMTAtbWlucyBvZiB0aGUgZGF5DQogICMgYW5kIGV4aXQgYWxsIHBvc2l0aW9ucyAxMCBtaW51dGVzIGJlZm9yZSB0aGUgZW5kIG9mIHF1b3RhdGlvbnMNCiAgDQogICMgY3JlYXRlIGEgcG9zX2ZsYXQgdmVjdG9yIGFuZCBmaWxsIGl0IHdpdGggMHMNCiAgcG9zX2ZsYXQgPC0geHRzKHJlcCgwLCBucm93KGRhdGEuZ3JvdXAyYi5vb3MpKSwgaW5kZXgoZGF0YS5ncm91cDJiLm9vcykpDQogIA0KICAjIHdlIGRvIG5vdCB0cmFkZSB3aXRoaW4gdGhlIGZpcnN0IDEwIG1pbnMgKDE4OjAwLTE4OjEwKSANCiAgIyBidXQgYWxzbyBiZWZvcmUgdGhhdCB0aW1lIHdoZW4gc2Vzc2lvbiB3YXMgaW5hY3RpdmUNCiAgIyBhbmQgbGFzdCAxMCBtaW5zIG9mIHRoZSBzZXNzaW9uICgxNjo1MS0xNzowMCkNCiAgIyBidXQgYWxzbyBhZnRlciB0aGlzIHRpbWUgd2hlbiBzZXNzaW9uIHdhcyBpbmFjdGl2ZQ0KICANCiAgcG9zX2ZsYXRbIlQxNjo1MS9UMTg6MTAiXSA8LSAxDQogIA0KICAjIG5vdGUgdGhpcyBjb3ZlcnMgRnJpZGF5cyBhbmQgU3VuZGF5cyBhcyB0aGUgc2VyaWVzIGdvZXMgZnJvbSAxNzowMCBGcmlkYXkgdG8gMTc6MDUgU3VuZGF5DQogIA0KICAjIGFwcGx5IHZvbGF0aWxpdHkgYnJlYWtvdXQgbW9kZWwgaW4gYSBsb29wIGZvciBzcHJlYWQgYW5kIHNwcmVhZDINCg0KICBmb3Iodm9sYXQuc2QgaW4gYygxODApKSB7ICMgZGlmZmVyZW50IHZvbGF0aWxpdHkgbWVtb3JpZXMNCiAgICBmb3IobV8gaW4gYygxKSkgeyAjIGRpZmZlcmVudCBtdWx0aXBsaWVycw0KICAgICAgDQogICAgICBtZXNzYWdlKHBhc3RlMCgidm9sYXQuc2QgPSAiLCB2b2xhdC5zZCwNCiAgICAgICAgICAgICAgICAgICAgICIsIG1fID0gIiwgbV8pKSANCiAgICAgIA0KICAgICAgIyBjYWxjdWxhdGluZyBlbGVtZW50cyBvZiB0aGUgc3RyYXRlZ3kNCiAgICAgIFhBVV9wcmljZSA8LSBjb3JlZGF0YShkYXRhLmdyb3VwMmIub29zJFhBVS5jbG9zZSkNCiAgICAgIFhBR19wcmljZSA8LSBjb3JlZGF0YShkYXRhLmdyb3VwMmIub29zJFhBRy5jbG9zZSkNCiAgICAgIA0KICAgICAgc2lnbmFsIDwtIGNvcmVkYXRhKGRhdGEuZ3JvdXAyYi5vb3Mkc3ByZWFkX2F2cmF0aW8pDQoNCiAgICAgIHVwcGVyIDwtIG1fICogcnVuc2Qoc2lnbmFsLCB2b2xhdC5zZCwgDQogICAgICAgICAgICAgICAgICAgICAgICAgIGVuZHJ1bGUgPSAiTkEiLCANCiAgICAgICAgICAgICAgICAgICAgICAgICAgYWxpZ24gPSAicmlnaHQiKQ0KICAgICAgbG93ZXIgPC0gLW1fICogcnVuc2Qoc2lnbmFsLCB2b2xhdC5zZCwgDQogICAgICAgICAgICAgICAgICAgICAgICAgICBlbmRydWxlID0gIk5BIiwgDQogICAgICAgICAgICAgICAgICAgICAgICAgICBhbGlnbiA9ICJyaWdodCIpDQogICAgICANCiAgICAgICMgcG9zaXRpb24gZm9yIG1lYW4tcmV2ZXJ0aW5nIHN0cmF0ZWd5DQogICAgICBwb3MubXIgPC0gcG9zaXRpb25WQl9uZXcoc2lnbmFsLCBsb3dlciwgdXBwZXIsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zX2ZsYXQgPSBwb3NfZmxhdCwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJhdGVneSA9ICJtciINCiAgICAgICkNCiAgICAgICMgbnVtYmVyIG9mIHRyYW5zYWN0aW9ucw0KICAgICAgbnRyYW5zIDwtIGFicyhkaWZmLnh0cyhwb3MubXIpKQ0KDQogICAgICAjIGdyb3NzIHBubA0KICAgICAgZ3Jvc3MucG5sIDwtIChwb3MubXIpICoNCiAgICAgICAgKGRpZmYueHRzKFhBVV9wcmljZSkgKiAxMDAgIyBwb2ludCB2YWx1ZSBmb3IgWEFVDQogICAgICAgICAtIGNvcmVkYXRhKGRhdGEuZ3JvdXAyYi5vb3MkYXYucmF0aW8pICogZGlmZi54dHMoWEFHX3ByaWNlKSAqIDUwMDApICMgcG9pbnQgdmFsdWUgZm9yIFhBRw0KDQogICAgICAjIHBubCBhZnRlciAgY29zdHMNCiAgICAgICMgY29zdHMgPSAkNyBmb3IgWEFHIGFuZCAkMTIgZm9yIFhBVSA9ICgxMittKjcpIGluIHRvdGFsDQogICAgICAjIGNvc3RzIGFyZSBhbHdheXMgcG9zaXRpdmUNCiAgICAgIA0KICAgICAgbmV0LnBubCA8LSBncm9zcy5wbmwgLSBudHJhbnMgKiAoMTIgKyBjb3JlZGF0YShkYXRhLmdyb3VwMmIub29zJGF2LnJhdGlvKSAqIDcpDQoNCiAgICAgICMgYWdncmVnYXRlIHRvIGRhaWx5DQoNCiAgICAgIHBubC5ncm9zcy5kIDwtIHBlcmlvZC5hcHBseShncm9zcy5wbmwsIElOREVYID0gaW5kaWNlcywgDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgRlVOID0gZnVuY3Rpb24oeCkgc3VtKHgsIG5hLnJtID0gVFJVRSkpDQogICAgICBwbmwubmV0LmQgPC0gcGVyaW9kLmFwcGx5KG5ldC5wbmwsIElOREVYID0gaW5kaWNlcywNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgRlVOID0gZnVuY3Rpb24oeCkgc3VtKHgsIG5hLnJtID0gVFJVRSkpDQogICAgICBudHJhbnMuZCA8LSBwZXJpb2QuYXBwbHkobnRyYW5zLCBJTkRFWCA9IGluZGljZXMsIA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEZVTiA9IGZ1bmN0aW9uKHgpIHN1bSh4LCBuYS5ybSA9IFRSVUUpKQ0KDQogICAgICAjIGNhbGN1bGF0ZSBzdW1tYXJ5IG1lYXN1cmVzDQogICAgICBncm9zcy5TUiA8LSBteVNSKHBubC5ncm9zcy5kLCBzY2FsZSA9IDI1MikNCiAgICAgIG5ldC5TUiA8LSBteVNSKHBubC5uZXQuZCwgc2NhbGUgPSAyNTIpDQoNCiAgICAgIGdyb3NzLkNSIDwtIG15Q2FsbWFyUmF0aW8ocG5sLmdyb3NzLmQsIHNjYWxlID0gMjUyKQ0KICAgICAgbmV0LkNSIDwtIG15Q2FsbWFyUmF0aW8ocG5sLm5ldC5kLCBzY2FsZSA9IDI1MikNCg0KICAgICAgZ3Jvc3MuUG5MIDwtIHN1bShwbmwuZ3Jvc3MuZCwgbmEucm0gPSBUUlVFKQ0KICAgICAgbmV0LlBuTCA8LSBzdW0ocG5sLm5ldC5kLCBuYS5ybSA9IFRSVUUpDQoNCiAgICAgIGF2LmRhaWx5Lm50cmFucyA8LSBtZWFuKG50cmFucy5kLCBuYS5ybSA9IFRSVUUpDQoNCiAgICAgIHN0YXQgPSBuZXQuQ1IgKiBtYXgoMCwgbG9nKGFicyhuZXQuUG5MLzEwMDApKSkNCg0KICAgICAgIyBjb2xsZWN0aW5nIGFsbCBzdGF0aXN0aWNzIGZvciBhIHBhcnRpY3VsYXIgcXVhcnRlcg0KICAgICAgaWYodm9sYXQuc2QgPT0gMTgwICYgbV8gPT0gMSkgew0KICAgICAgICBxdWFydGVyX3N0YXRzIDwtIGRhdGEuZnJhbWUocXVhcnRlciA9IHNlbGVjdGVkX3F1YXJ0ZXIsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhc3NldHMuZ3JvdXAgPSAyLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3Jvc3MuU1IsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXQuU1IsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm9zcy5DUiwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ldC5DUiwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyb3NzLlBuTCwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ldC5QbkwsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdi5kYWlseS5udHJhbnMsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0LA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyaW5nc0FzRmFjdG9ycyA9IEZBTFNFDQogICAgICAgICkNCiAgDQogICAgICAgICMgY29sbGVjdCBzdW1tYXJpZXMgZm9yIGFsbCBxdWFydGVycw0KICAgICAgICBpZighZXhpc3RzKCJxdWFydGVyX3N0YXRzLmFsbC5ncm91cDIub29zIikpIHF1YXJ0ZXJfc3RhdHMuYWxsLmdyb3VwMi5vb3MgPC0gcXVhcnRlcl9zdGF0cyBlbHNlDQogICAgICAgICAgcXVhcnRlcl9zdGF0cy5hbGwuZ3JvdXAyLm9vcyA8LSByYmluZChxdWFydGVyX3N0YXRzLmFsbC5ncm91cDIub29zLCBxdWFydGVyX3N0YXRzKQ0KICAgICAgICANCiAgICAgICAgIyBjcmVhdGUgYSBwbG90IG9mIGdyb3NzIGFuZCBuZXQgcG5sIGFuZCBzYXZlIGl0IHRvIHBuZyBmaWxlDQogICAgICAgIHlfcmFuZ2UgPC0gcmFuZ2UoYyhjdW1zdW0ocG5sLmdyb3NzLmQpLCBjdW1zdW0ocG5sLm5ldC5kKSkpDQoNCiAgICAgICAgcHJpbnQoICMgd2hlbiBwbG90dGluZyBpbiBhIGxvb3AgeW91IGhhdmUgdG8gdXNlIHByaW50KCkNCiAgICAgICAgICBwbG90KGN1bXN1bShwbmwuZ3Jvc3MuZCksDQogICAgICAgICAgICAgICB0eXBlID0gImwiLA0KICAgICAgICAgICAgICAgbWFpbiA9IHBhc3RlMCgiR3Jvc3MgYW5kIG5ldCBQbkwgZm9yIGFzc2V0IGdyb3VwIDIgXG4gcXVhcnRlciAiLCBzZWxlY3RlZF9xdWFydGVyKSwNCiAgICAgICAgICAgICAgIGNvbCA9ICIjMzc3RUI4IiwNCiAgICAgICAgICAgICAgIHhsYWIgPSAiVGltZSIsDQogICAgICAgICAgICAgICB5bGFiID0gIkN1bXVsYXRpdmUgUG5MIiwNCiAgICAgICAgICAgICAgIHlsaW0gPSB5X3JhbmdlDQogICAgICAgICAgKQ0KICAgICAgICApDQogICAgICAgIGxpbmVzKGN1bXN1bShwbmwubmV0LmQpLCBjb2wgPSAiI0U0MUExQyIpDQogICAgICAgIGxlZ2VuZCgidG9wbGVmdCIsIGxlZ2VuZCA9IGMoIkdyb3NzIFBuTCIsICJOZXQgUG5MIiksIGNvbCA9IGMoIiMzNzdFQjgiLCAiI0U0MUExQyIpLCBsdHkgPSAxLCBjZXggPSAxKQ0KICAgICAgfQ0KICAgICAgDQogICAgICAjIHN1bW1hcnkgb2YgYSBwYXJ0aWN1bGFyIHN0cmF0ZWd5DQogICAgICBzdW1tYXJ5XyA8LSBkYXRhLmZyYW1lKHNwcmVhZCA9ICJhdi5yYXRpbyIsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZvbGF0LnNkID0gdm9sYXQuc2QsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgIG0gPSBtXywNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGVyaW9kID0gc2VsZWN0ZWRfcXVhcnRlciwgIyAiMjAxNi0wOC0xNiAtIDIwMTYtMTEiLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm9zcy5TUiwNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV0LlNSLA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm9zcy5QbkwsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ldC5QbkwsDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF2LmRhaWx5Lm50cmFucywNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyaW5nc0FzRmFjdG9ycyA9IEZBTFNFKQ0KDQogICAgICAjIHB1dHRpbmcgYWxsIHN1bW1hcmllcyB0b2dldGhlcg0KDQogICAgICBpZighZXhpc3RzKCJzdW1tYXJ5LnBhaXIudHJhZGluZyIpKSBzdW1tYXJ5LnBhaXIudHJhZGluZyA8LSBzdW1tYXJ5XyBlbHNlDQogICAgICAgIHN1bW1hcnkucGFpci50cmFkaW5nIDwtIHJiaW5kKHN1bW1hcnkucGFpci50cmFkaW5nLCBzdW1tYXJ5XykNCiAgICAgIA0KICAgICAgIyBkZWxldGluZyB3b3JraW5nIGZpbGVzIG5vdCBuZWVkZWQgYW55IG1vcmUNCiAgICAgIHJtKGdyb3NzLlNSLCBuZXQuU1IsIG5ldC5DUiwNCiAgICAgICAgIGdyb3NzLlBuTCwgbmV0LlBuTCwNCiAgICAgICAgIGF2LmRhaWx5Lm50cmFucywgc3RhdCwNCiAgICAgICAgIHBubC5ncm9zcy5kLCBwbmwubmV0LmQsIA0KICAgICAgICAgbnRyYW5zLmQsDQogICAgICAgICBwbmwuZ3Jvc3MsIHBubC5uZXQsIA0KICAgICAgICAgbnRyYW5zLA0KICAgICAgICAgcG9zLm1yLCBzdW1tYXJ5XywNCiAgICAgICAgIFhBVV9wcmljZSwgWEFHX3ByaWNlLA0KICAgICAgICAgc2lnbmFsLCBsb3dlciwgdXBwZXIpDQogICAgICANCiAgICB9ICMgZW5kIG9mIGxvb3AgZm9yIG1fDQogIH0gIyBlbmQgb2YgbG9vcCBmb3Igdm9sYXRpbGl0eSAgDQogIA0KICBybShzdW1tYXJ5LnBhaXIudHJhZGluZykNCn0NCmBgYA0KDQojIyBQZXJmb3JtYW5jZQ0KR3JvdXAgMSBwZXJmb3JtZWQgd29yc2Ugb24gb3V0LW9mLXNhbXBsZSBkYXRhLCBwcm9kdWNpbmcgYW4gYXZlcmFnZSBTaGFycGUgcmF0aW8gb2YgKiotMC4zNyoqLCBjdW11bGF0aXZlIG5ldCBQJkwgb2YgKiotJDQsMzc1KiogYW5kIGN1bXVsYXRpdmUgc3VtbWFyeSBzdGF0aXN0aWMgb2YgKioxMC4zKiouIFRoZSByZXN1bHQgd2FzIHJlZmxlY3RpdmUgb2YgY2hhbmdpbmcgbWFya2V0IGVudmlyb25tZW50IGFuZCB0aGVyZWZvcmUgYXNzZXQgcHJpY2Ugc2hvcnRseSBhZnRlciB0aGUgcmVsYXRpdmVseSBsb25nIEVNQSBkYXlzIHVzZWQgaW4gdGhlIHNpZ25hbCwgYXMgd2VsbCBtZWFuaW5nZnVsIHRyYWRpbmcgY29zdHMuDQoNCkdyb3VwIDIgcmVwZWF0ZWQgaXRzIHN0cm9uZyBwZXJmb3JtYW5jZSBvbiBvdXQtb2Ytc2FtcGxlIGRhdGEsIHByb2R1Y2luZyBhbiBhdmVyYWdlIFNoYXJwZSByYXRpbyBvZiAqKjEuMTMqKiwgY3VtdWxhdGl2ZSBuZXQgUCZMIG9mICoqJDIsOTI4LDE1NyoqIGFuZCBjdW11bGF0aXZlIHN1bW1hcnkgc3RhdGlzdGljIG9mICoqMTMzLjAqKi4gVGhpcyBpbmRpY2F0ZWQgc3VjY2Vzc2Z1bCByZXZlcnNpb24gb2YgdGhlIGdvbGQtc2lsdmVyIHNwcmVhZCB0b3dhcmRzIGl0cyBsb25nLXRlcm0gdHJlbmQsIGV2ZW4gYXQgbG93IGRpdmVyZ2VuY2UgbGV2ZWxzLiBUcmFkaW5nIGZyZXF1ZW5jeSB3YXMgYWxzbyBsb3csIHRodXMgaW5jdXJyaW5nIHJlbGF0aXZlbHkgbG93ZXIgY29zdHMuDQoNCk92ZXJhbGwsIHRoZSBwZXJmb3JtYW5jZSBvZiBHcm91cCAyIHJlbmRlcmVkIG92ZXJhbGwgcmVzdWx0cyBzYXRpc2ZhY3RvcnksIGdlbmVyYXRpbmcgYSBzdWJzdGFudGlhbCBQJkwgYW5kIGdvb2QgcmV3YXJkIHRvIHJpc2sgdHJhZGUtb2ZmLg0KDQpgYGB7ciwgd2FybmluZyA9IEYsIG1lc3NhZ2UgPSBGfQ0Kb3B0aW9ucyhkaWdpdHM9MikNCnF1YXJ0ZXJfc3RhdHMuYWxsLmdyb3VwMS5vb3MNCmBgYA0KDQpgYGB7ciwgd2FybmluZyA9IEYsIG1lc3NhZ2UgPSBGfQ0Kb3B0aW9ucyhkaWdpdHM9MikNCnF1YXJ0ZXJfc3RhdHMuYWxsLmdyb3VwMi5vb3MNCmBgYA0KDQpUaGUgb3V0LW9mLXNhbXBsZSByZXN1bHRzIGZvciB0aGUgYmVzdCBtb2RlbHMgZm9yIGdyb3VwcyAxIGFuZCAyIGNhbiBiZSBzYXZlZCBhcyBjc3YgLSB0aGUgZm9sbG93aW5nIGxpbmVzIG5lZWQgdG8gYmUgdW5jb21tZW50ZWQuDQoNCmBgYHtyLCB3YXJuaW5nID0gRiwgbWVzc2FnZSA9IEZ9DQojIHdyaXRlLmNzdihxdWFydGVyX3N0YXRzLmFsbC5ncm91cDEub29zLCANCiMgICAgICAgICAgICJxdWFydGVyX3N0YXRzLmFsbC5ncm91cDEub29zLmNzdiIsDQojICAgICAgICAgICByb3cubmFtZXMgPSBGQUxTRSkxDQoNCiMgd3JpdGUuY3N2KHF1YXJ0ZXJfc3RhdHMuYWxsLmdyb3VwMi5vb3MsIA0KIyAgICAgICAgICAgInF1YXJ0ZXJfc3RhdHMuYWxsLmdyb3VwMi5vb3MuY3N2IiwNCiMgICAgICAgICAgIHJvdy5uYW1lcyA9IEZBTFNFKQ0KYGBgDQo=</div>


</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeSourceEmbed("QSHFD_Foster_Staniszewski_Final.Rmd");
  window.initializeCodeFolding("show" === "show");
});
</script>

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
